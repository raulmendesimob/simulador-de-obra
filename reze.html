<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Simulador Imobili√°rio</title>

<!-- jsPDF (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:#f4f6f5;
    color:#222;
  }

  /* ===== TOPO ===== */
  .painel-topo{
    background:#fff;
    border-bottom:1px solid #e0e0e0;
    padding:16px;
  }
  .painel-topo h1{
    text-align:center;
    color:#0b6e3b;
    margin:0 0 16px;
    font-size:22px;
  }

  .grid-topo{
    max-width:900px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  .campo label{
    display:block;
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
  }
  .campo input,.campo select{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    background:#fff;
  }
  .campo-full{grid-column:1/-1}

  @media(min-width:768px){
    .grid-topo{grid-template-columns:repeat(2,1fr)}
  }

  /* ===== CONTAINER ===== */
  .container{
    max-width:900px;
    margin:24px auto;
    padding:0 16px 40px;
  }

  /* ===== BLOCOS ===== */
  .bloco{
    background:#fff;
    border-radius:14px;
    border:1px solid #ddd;
    overflow:hidden;
    margin-bottom:14px;
  }
  .bloco-header{
    color:#fff;
    padding:14px 16px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .header-entrada{background:#0b6e3b}
  .header-juros{background:#d97706}
  .header-pdf{background:#2563eb}

  .toggle-icon{
    background:rgba(255,255,255,.2);
    border-radius:6px;
    width:22px;
    height:22px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
  }
  .bloco-conteudo{display:none;padding:18px}

  .subgrid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  @media(min-width:768px){
    .subgrid{grid-template-columns:repeat(2,1fr)}
    .span2{grid-column:1/-1}
  }

  .divider{
    height:1px;
    background:#e9e9e9;
    margin:16px 0;
  }

  .bloco-inter{background:#f3faf6;padding:12px;border-radius:10px}
  .bloco-pos{background:#f2f6fb;padding:12px;border-radius:10px}

  /* ===== BOT√ïES ===== */
  button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:10px;
    color:#fff;
    font-size:15px;
    cursor:pointer;
    margin-top:12px;
  }
  .btn-entrada{background:#0b6e3b}
  .btn-juros{background:#d97706}
  .btn-pdf{background:#2563eb}

  .btn-limpar{
    background:#c62828;
    width:auto;
    padding:10px 14px;
    font-size:13px;
    border-radius:8px;
  }

  .box-limpar{
    display:none;
    margin:12px 0 18px;
    justify-content:center;
  }

  /* ===== RESULTADOS (VERDE/AMARELO/VERMELHO) ===== */
  .resultado{
    display:none;
    padding:16px;
    border-radius:12px;
    margin-top:12px;
    border:1px solid rgba(0,0,0,.08);
  }
  .resultado.verde{background:#eaf7ee;border-color:#bfe6c9}
  .resultado.amarelo{background:#fff7da;border-color:#f0dc8a}
  .resultado.vermelho{background:#ffe3e3;border-color:#ffb7b7}

  .alerta{color:#8b1e1e;font-weight:800}
  .obs{font-style:italic;color:#333;margin-top:10px;display:block}
  .muted{opacity:.78}

  /* ===== INTERMEDI√ÅRIAS ===== */
  .inter-list{display:flex;flex-direction:column;gap:10px}
  .inter-row{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    background:#fff;
    border:1px solid #e6efe9;
    padding:10px;
    border-radius:10px;
  }
  @media(min-width:768px){
    .inter-row{grid-template-columns:1fr 1fr}
  }

  /* ===== JUROS - TABELA ===== */
  .tabela-wrap{
    overflow:auto;
    border:1px solid #e5e5e5;
    border-radius:12px;
    background:#fff;
    margin-top:12px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    min-width:560px;
  }
  th, td{
    padding:10px 12px;
    border-bottom:1px solid #eee;
    text-align:center;
    font-size:14px;
  }
  th{
    position:sticky;
    top:0;
    background:#fafafa;
    z-index:1;
    font-weight:800;
  }
  tr:last-child td{border-bottom:none}

  .notas{
    margin-top:10px;
    font-size:13px;
    color:#222;
    line-height:1.35;
  }

  /* ===== PDF: SIM/N√ÉO ===== */
  .inline-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .chip{
    display:inline-block;
    padding:6px 10px;
    border:1px solid #ddd;
    border-radius:999px;
    background:#fff;
    font-size:13px;
    cursor:pointer;
    user-select:none;
  }
  .chip input{margin-right:6px;cursor:pointer}
</style>
</head>

<body>

<!-- TOPO (CABE√áALHO) -->
<div class="painel-topo">
  <h1>Simulador Imobili√°rio</h1>

  <div class="grid-topo">

    <div class="campo">
      <label>üè¢ Empreendimento</label>
      <input id="empreendimento" placeholder="">
    </div>

    <div class="campo">
      <label>üè† Unidade / Bloco / Andar</label>
      <input id="unidade" placeholder="">
    </div>

    <div class="campo">
      <label>üè† Valor do Im√≥vel (R$)</label>
      <input id="valorImovel" oninput="formatarMoeda(this)">
    </div>

    <div class="campo">
      <label>üè¶ Valor do Financiamento (R$)</label>
      <input id="valorFinanciamento" oninput="formatarMoeda(this)">
    </div>

    <div class="campo">
      <label>üí∞ Vai utilizar FGTS?</label>
      <select id="usaFgts" onchange="toggleFGTS()">
        <option value="nao">N√£o</option>
        <option value="sim">Sim</option>
      </select>
    </div>

    <div class="campo" id="boxFGTS" style="display:none;">
      <label>üí∞ FGTS (R$)</label>
      <input id="fgts" oninput="formatarMoeda(this)" placeholder="">
    </div>

    <div class="campo">
      <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Renda Familiar Mensal (R$)</label>
      <input id="renda" oninput="formatarMoeda(this); updateMCMV();">
    </div>

    <div class="campo campo-full">
      <label>üìÖ Previs√£o de Entrega (m√™s/ano)</label>
      <select id="entregaSelect"></select>
    </div>

  </div>
</div>

<div class="container">

  <!-- ===== ENTRADA ===== -->
  <div class="bloco">
    <div class="bloco-header header-entrada" onclick="toggleBloco(this)">
      <span>üí∞ Entrada / Fluxo Inicial</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">

      <div class="subgrid">
        <div class="campo">
          <label>üí∏ Valor do Ato (R$)</label>
          <input id="ato" oninput="formatarMoeda(this)">
        </div>

        <div class="campo">
          <label>üóìÔ∏è MESES / PARCELAS</label>
          <input id="parcelasEntrada" type="number" min="1">
        </div>
      </div>

      <div class="divider"></div>

      <!-- INTERMEDI√ÅRIAS -->
      <div class="bloco-inter">
        <div class="subgrid">
          <div class="campo span2">
            <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
            <select id="temInter" onchange="toggleInter()">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>

          <div class="campo span2" id="boxInterQtd" style="display:none;">
            <label>Quantidade</label>
            <input id="qtdInter" type="number" min="1" max="8" value="1" onchange="renderInterRows()">
          </div>

          <div class="campo span2" id="boxInterRows" style="display:none;">
            <div class="inter-list" id="interList"></div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- P√ìS-CHAVES -->
      <div class="bloco-pos">
        <div class="subgrid">
          <div class="campo span2">
            <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
            <select id="aceitaPos">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>
        </div>
      </div>

      <button class="btn-entrada" onclick="calcularEntrada()">Calcular Entrada</button>
    </div>
  </div>

  <!-- RESULTADO ENTRADA (persistente) -->
  <div id="resultadoEntrada" class="resultado"></div>
  <div id="limparEntradaBox" class="box-limpar">
    <button class="btn-limpar" onclick="limparEntrada()">Limpar fluxo de entrada</button>
  </div>

  <!-- ===== JUROS DE OBRA ===== -->
  <div class="bloco">
    <div class="bloco-header header-juros" onclick="toggleBloco(this)">
      <span>üèóÔ∏è Juros de Obra</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">

      <!-- Fluxo progressivo -->
      <div class="subgrid">

        <div class="campo span2">
          <label>üß≠ Regi√£o do Brasil</label>
          <select id="regiao" onchange="onChangeRegiao()">
            <option value="">Selecione...</option>
            <option value="no_ne">NO/NE</option>
            <option value="sul_se_co">SUL/SE/CO</option>
          </select>
        </div>

        <div class="campo span2" id="boxCotista" style="display:none;">
          <label>üßæ Cotista ou N√£o Cotista?</label>
          <select id="cotista" onchange="onChangeCotista()">
            <option value="">Selecione...</option>
            <option value="cotista">Cotista (+3 anos CLT)</option>
            <option value="nao_cotista">N√£o Cotista</option>
          </select>
        </div>

        <div class="campo" id="boxFaixa" style="display:none;">
          <label>üè∑Ô∏è Faixa Minha Casa Minha Vida</label>
          <input id="faixaMCMV" readonly>
          <!-- pill removida conforme pedido -->
        </div>

        <div class="campo" id="boxJurosEf" style="display:none;">
          <label>üìà Juros efetivos do financiamento (a.a.)</label>
          <input id="jurosEfetivo" placeholder="Ex.: 5,64">
        </div>

      </div>

      <div class="divider"></div>

      <!-- Tabela -->
      <div class="subgrid">
        <div class="campo">
          <label>Intervalo da tabela</label>
          <select id="passoTabela">
            <option value="3">3 em 3%</option>
            <option value="5">5 em 5%</option>
            <option value="10" selected>10 em 10%</option>
          </select>
        </div>

        <div class="campo">
          <label>Taxa de Juros Anual (%)</label>
          <input id="jurosAnual" type="number" min="0" step="0.01" placeholder="Preenchido automaticamente (edit√°vel)">
        </div>

        <div class="campo">
          <label>TR (%) <small style="font-weight:normal;opacity:.8;">‚Äì valor m√©dio 0,17%</small></label>
          <input id="tr" type="number" step="0.01" value="0.17">
        </div>

        <div class="campo">
          <label>Taxas e Seguros (R$) <small style="font-weight:normal;opacity:.8;">‚Äì usado valor m√©dio R$ 65</small></label>
          <input id="taxas" value="R$ 65,00" oninput="formatarMoeda(this)">
        </div>

        <div class="campo span2">
          <button class="btn-juros" onclick="calcularJurosTabela()">Calcular Juros de Obra (Tabela)</button>
        </div>
      </div>

    </div>
  </div>

  <!-- RESULTADO JUROS (persistente e separado) -->
  <div id="resultadoJuros" class="resultado amarelo"></div>
  <div id="limparJurosBox" class="box-limpar">
    <button class="btn-limpar" onclick="limparJuros()">Limpar juros de obra</button>
  </div>

  <!-- ===== GERAR PDF ===== -->
  <div class="bloco">
    <div class="bloco-header header-pdf" onclick="toggleBloco(this)">
      <span>üìÑ Gerar PDF</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">
      <div class="subgrid">

        <div class="campo">
          <label>üë§ Cliente</label>
          <input id="pdfCliente" placeholder="">
        </div>

        <div class="campo">
          <label>üìû Telefone</label>
          <input id="pdfClienteFone" inputmode="tel" oninput="formatarTelefone(this)" placeholder="">
        </div>

        <div class="campo">
          <label>üßë‚Äçüíº Corretor(a)</label>
          <input id="pdfCorretor" placeholder="">
        </div>

        <div class="campo">
          <label>üìû Telefone</label>
          <input id="pdfCorretorFone" inputmode="tel" oninput="formatarTelefone(this)" placeholder="">
        </div>

        <div class="campo span2">
          <label>Incluir estimativa de INCC?</label>
          <div class="inline-row">
            <label class="chip"><input type="radio" name="inccOpt" value="nao" checked onchange="toggleINCC()"> N√£o</label>
            <label class="chip"><input type="radio" name="inccOpt" value="sim" onchange="toggleINCC()"> Sim</label>
          </div>
        </div>

        <div class="campo span2" id="boxINCCValor" style="display:none;">
          <label>INCC (m√©dia mensal) %</label>
          <input id="inccValor" value="0,5" inputmode="decimal">
        </div>

        <div class="campo span2">
          <label>Incluir Juros de Obra?</label>
          <div class="inline-row">
            <label class="chip"><input type="radio" name="pdfJurosOpt" value="nao" checked> N√£o</label>
            <label class="chip"><input type="radio" name="pdfJurosOpt" value="sim"> Sim</label>
          </div>
        </div>

        <div class="campo span2" style="font-size:13px;color:#444;">
          <b>Data do documento:</b> <span id="pdfDataDoc"></span>
        </div>

      </div>

      <button class="btn-pdf" onclick="gerarPDF()">Gerar PDF da Simula√ß√£o</button>
    </div>
  </div>

</div>

<script>
  /* =========================
     UTIL
  ========================= */
  function formatarMoeda(c){
    let v=(c.value||"").replace(/\D/g,"")
    if(!v){c.value=""; return}
    v=(parseInt(v)/100).toFixed(2).replace(".",",")
    v=v.replace(/\B(?=(\d{3})+(?!\d))/g,".")
    c.value="R$ "+v
  }
  function limparMoeda(v){
    return parseFloat((v||"").replace(/[R$\.\s]/g,"").replace(",", "."))||0
  }
  function moeda(n){
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
  }
  function formatarTelefone(input){
    let v = (input.value||"").replace(/\D/g,"").slice(0,11)
    if(v.length<=2){ input.value=v; return }
    const ddd = v.slice(0,2)
    const rest = v.slice(2)
    if(rest.length<=4){ input.value = `(${ddd}) ${rest}`; return }
    if(rest.length<=8){ input.value = `(${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`; return }
    input.value = `(${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`
  }
  function normalizarPercentBR(v){
    const s = String(v||"").trim().replace("%","").replace(",",".")
    const n = parseFloat(s)
    return Number.isFinite(n) ? n : null
  }

  /* =========================
     MESES/ANO
  ========================= */
  function gerarMesAno(){
    const h=new Date()
    const arr=[]
    const m=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]
    for(let i=0;i<48;i++){
      const d=new Date(h.getFullYear(),h.getMonth()+i,1)
      arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`)
    }
    return arr
  }
  (function(){
    const s=document.getElementById("entregaSelect")
    gerarMesAno().forEach(t=>{
      const o=document.createElement("option")
      o.textContent=t
      s.appendChild(o)
    })
  })()

  /* =========================
     UI
  ========================= */
  function toggleBloco(el){
    const c=el.nextElementSibling
    const i=el.querySelector(".toggle-icon")
    const aberto=c.style.display==="block"
    c.style.display=aberto?"none":"block"
    i.textContent=aberto?"+":"‚Äì"
  }
  function toggleFGTS(){
    const usa = document.getElementById("usaFgts").value
    const box = document.getElementById("boxFGTS")
    if(usa==="sim"){
      box.style.display="block"
    } else {
      box.style.display="none"
      document.getElementById("fgts").value=""
    }
  }
  function toggleINCC(){
    const val = document.querySelector('input[name="inccOpt"]:checked')?.value || "nao"
    document.getElementById("boxINCCValor").style.display = (val==="sim") ? "block" : "none"
  }

  /* =========================
     INTERMEDI√ÅRIAS
  ========================= */
  function toggleInter(){
    const tem = document.getElementById("temInter").value
    const boxQtd = document.getElementById("boxInterQtd")
    const boxRows = document.getElementById("boxInterRows")
    if(tem==="sim"){
      boxQtd.style.display="block"
      boxRows.style.display="block"
      renderInterRows()
    } else {
      boxQtd.style.display="none"
      boxRows.style.display="none"
      document.getElementById("interList").innerHTML=""
      document.getElementById("qtdInter").value = 1
    }
  }
  function renderInterRows(){
    const q=parseInt(document.getElementById("qtdInter").value)||0
    const interList=document.getElementById("interList")
    interList.innerHTML=""
    if(q<=0) return

    const meses=gerarMesAno()
    for(let i=1;i<=q;i++){
      const r=document.createElement("div")
      r.className="inter-row"
      r.innerHTML=`
        <div>
          <label>${i}¬∫ pagamento (Intermedi√°ria/Anual/Refor√ßo/Chaves)</label>
          <select>${meses.map(m=>`<option>${m}</option>`).join("")}</select>
        </div>
        <div>
          <label>Valor (R$) <span class="muted">(obrigat√≥rio)</span></label>
          <input oninput="formatarMoeda(this)" placeholder="Ex.: R$ 5.000,00">
        </div>
      `
      interList.appendChild(r)
    }
  }

  /* =========================
     MCMV (Faixa + Taxa)
     - faixa por renda
     - taxa por regi√£o + cotista
     - casos onde a tabela n√£o diferencia regi√£o: taxa √∫nica
  ========================= */
  const MCMV_RANGES = [
    { faixa:"Faixa 1", min:0,       max:2160.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.07:4.33) : (reg==="no_ne"?4.59:4.84) },
    { faixa:"Faixa 1", min:2160.01, max:2850.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.33:4.59) : (reg==="no_ne"?4.84:5.12) },

    { faixa:"Faixa 2", min:2850.01, max:3500.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.84:5.12) : (reg==="no_ne"?5.38:5.64) },

    // taxa √∫nica (sem distin√ß√£o por regi√£o na tabela)
    { faixa:"Faixa 2", min:3500.01, max:4000.00,  rate:(isCotista, reg)=> isCotista ? 5.64 : 6.17 },
    { faixa:"Faixa 2", min:4000.01, max:4700.00,  rate:(isCotista, reg)=> isCotista ? 6.70 : 7.23 },

    { faixa:"Faixa 3", min:4700.01, max:8600.00,  rate:(isCotista, reg)=> isCotista ? 7.93 : 8.46 },
    { faixa:"Faixa 4", min:8600.01, max:12000.00, rate:(isCotista, reg)=> 11.03 },
  ]
  function findFaixaByRenda(renda){
    return MCMV_RANGES.find(r => renda >= r.min && renda <= r.max) || null
  }

  function onChangeRegiao(){
    const reg = document.getElementById("regiao").value
    document.getElementById("cotista").value = ""
    document.getElementById("boxCotista").style.display = reg ? "block" : "none"
    hideMcmvBoxes()
    updateMCMV()
  }
  function onChangeCotista(){
    hideMcmvBoxes()
    updateMCMV()
  }
  function hideMcmvBoxes(){
    document.getElementById("boxFaixa").style.display = "none"
    document.getElementById("boxJurosEf").style.display = "none"
  }

  let __jurosManual = false
  let __jurosEfManual = false

  function updateMCMV(){
    const renda = limparMoeda(document.getElementById("renda").value)
    const reg = document.getElementById("regiao").value
    const cot = document.getElementById("cotista").value

    // s√≥ mostra quando regi√£o + cotista selecionados
    if(!reg || !cot) return

    document.getElementById("boxFaixa").style.display = "block"
    document.getElementById("boxJurosEf").style.display = "block"

    const faixaEl = document.getElementById("faixaMCMV")
    const jurosEfEl = document.getElementById("jurosEfetivo")

    if(!renda || renda<=0){
      faixaEl.value = ""
      if(!__jurosEfManual) jurosEfEl.value = ""
      syncTaxaParaJurosObra()
      return
    }

    const faixaObj = findFaixaByRenda(renda)
    if(!faixaObj){
      faixaEl.value = "Fora da tabela"
      if(!__jurosEfManual) jurosEfEl.value = ""
      syncTaxaParaJurosObra()
      return
    }

    faixaEl.value = faixaObj.faixa

    const isCotista = (cot === "cotista")
    const taxa = faixaObj.rate(isCotista, reg)

    if(!__jurosEfManual){
      jurosEfEl.value = String(taxa).replace(".", ",")
    }

    syncTaxaParaJurosObra()
  }

  function syncTaxaParaJurosObra(){
    if(__jurosManual) return
    const taxa = normalizarPercentBR(document.getElementById("jurosEfetivo").value)
    if(taxa!==null) document.getElementById("jurosAnual").value = taxa
  }

  (function(){
    document.getElementById("jurosAnual").addEventListener("input", ()=>{ __jurosManual = true })
    document.getElementById("jurosEfetivo").addEventListener("input", ()=>{
      __jurosEfManual = true
      __jurosManual = false
      syncTaxaParaJurosObra()
    })
  })()

  /* =========================
     ENTRADA (RESULTADOS)
  ========================= */
  function setResultadoEntrada(tipo, html){
    const out=document.getElementById("resultadoEntrada")
    out.className = "resultado " + tipo
    out.innerHTML = html
    out.style.display = "block"
    document.getElementById("limparEntradaBox").style.display = "flex"
  }

  function calcularEntrada(){
    const im=limparMoeda(document.getElementById("valorImovel").value)
    const fi=limparMoeda(document.getElementById("valorFinanciamento").value)

    const usaFgts = document.getElementById("usaFgts").value === "sim"
    const fg = usaFgts ? limparMoeda(document.getElementById("fgts").value) : 0

    const at=limparMoeda(document.getElementById("ato").value)
    const re=limparMoeda(document.getElementById("renda").value)
    const p=parseInt(document.getElementById("parcelasEntrada").value)||0

    if(!im || !fi || !re || !p){
      setResultadoEntrada("vermelho",
        `<h3>Entrada / Fluxo Inicial</h3>
         <p class="alerta">Preencha os campos obrigat√≥rios: Valor do Im√≥vel, Financiamento, Renda e Meses/Parcelas.</p>`
      )
      return
    }

    const entrada = im - fi - fg

    const temInter = document.getElementById("temInter").value === "sim"
    const interVals = []
    const interMeta = []

    if(temInter){
      const rows = document.querySelectorAll("#interList .inter-row")
      if(!rows.length){
        setResultadoEntrada("vermelho",
          `<h3>Entrada / Fluxo Inicial</h3>
           <p class="alerta">Voc√™ marcou Intermedi√°rias/Anuais/Refor√ßos/Chaves, mas n√£o informou a quantidade.</p>`
        )
        return
      }

      let faltando = false
      rows.forEach((row) => {
        const sel = row.querySelector("select")
        const inp = row.querySelector("input")
        const data = sel ? sel.value : "-"
        const mesesAte = sel ? sel.selectedIndex : 0
        const v = limparMoeda(inp ? inp.value : "")
        if(!v || v<=0) faltando = true
        interVals.push(v)
        interMeta.push({ data, mesesAte, valorBase:v })
      })

      if(faltando){
        setResultadoEntrada("vermelho",
          `<h3>Entrada / Fluxo Inicial</h3>
           <p class="alerta">Preencha o valor de todas as Intermedi√°rias/Anuais/Refor√ßos/Chaves (campo obrigat√≥rio).</p>`
        )
        return
      }
    }

    const somaInter = interVals.reduce((a,b)=>a+b,0)
    let saldo = entrada - at - somaInter

    const entregaTxt = document.getElementById("entregaSelect").value

    // Se ato + inter cobrem tudo, mensais 0
    if(saldo <= 0){
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: 0,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: 0,
        status: "verde"
      }

      const interHtml = (temInter && somaInter>0)
        ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
        : ``

      setResultadoEntrada("verde",
        `<h3>‚úÖ Entrada dentro dos limites</h3>
         <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
         <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
         <div class="divider"></div>
         <p>Ato: <b>${moeda(at)}</b></p>
         ${interHtml}
         <p>Mensais (${p}x): <b>${moeda(0)}</b></p>
         <span class="obs">Considerado limite de 30% da renda familiar para parcelas mensais.</span>`
      )
      return
    }

    // Mensais limitadas a 30% renda
    const limiteMensal = re * 0.30
    let mensal = saldo / p
    let resto = 0

    if(mensal > limiteMensal){
      mensal = limiteMensal
      resto = saldo - (mensal * p)
    }

    const interHtml = (temInter && somaInter>0)
      ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
      : ``

    const baseHTML = `
      <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
      <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
      <div class="divider"></div>
      <p>Ato: <b>${moeda(at)}</b></p>
      ${interHtml}
      <p>Mensais (${p}x): <b>${moeda(mensal)}</b></p>
      <span class="obs">Considerado limite de 30% da renda familiar para parcelas mensais.</span>
    `

    // Verde
    if(resto <= 0){
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: mensal,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: 0,
        status: "verde"
      }
      setResultadoEntrada("verde", `<h3>‚úÖ Entrada dentro dos limites</h3>${baseHTML}`)
      return
    }

    const aceitaPos = document.getElementById("aceitaPos").value === "sim"

    // Amarelo
    if(aceitaPos){
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: mensal,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: resto,
        status: "amarelo"
      }
      setResultadoEntrada("amarelo",
        `<h3>‚ö†Ô∏è Entrada com saldo restante</h3>
         ${baseHTML}
         <div class="divider"></div>
         <p><b>Saldo restante:</b> ${moeda(resto)}</p>
         <p><b>Saldo restante para verificar parcelamento com a construtora.</b></p>`
      )
      return
    }

    // Vermelho (ajustes de texto conforme pedido)
    window.__lastEntradaCalc = {
      entradaTotal: entrada,
      ato: at,
      parcelas: p,
      mensal: mensal,
      interVals: interVals,
      interMeta: interMeta,
      saldoRestante: resto,
      status: "vermelho"
    }

    setResultadoEntrada("vermelho",
      `<h3>Verificar saldo restante p√≥s per√≠odo de obras</h3>
       ${baseHTML}
       <div class="divider"></div>
       <p><b>Saldo restante:</b> ${moeda(resto)}</p>
       <p class="alerta"><b>Valor de entrada ultrapassa os limites de parcelamento dentro do per√≠odo de obras.</b></p>`
    )
  }

  function limparEntrada(){
    const out = document.getElementById("resultadoEntrada")
    out.style.display="none"
    out.innerHTML=""
    out.className="resultado"
    document.getElementById("limparEntradaBox").style.display="none"
    window.__lastEntradaCalc = null
  }

  /* =========================
     JUROS DE OBRA (TABELA)
     - resultado persistente fora do bloco
     - tabela 4 colunas: %/parcela | %/parcela
     - sem "saldo liberado"
     - observa√ß√£o com "*"
  ========================= */
  function setResultadoJuros(tipo, html){
    const out=document.getElementById("resultadoJuros")
    out.className = "resultado " + tipo
    out.innerHTML = html
    out.style.display = "block"
    document.getElementById("limparJurosBox").style.display = "flex"
  }

  function buildPercList(passo){
    const list=[]
    for(let p=passo; p<=100; p+=passo) list.push(p)
    if(list[list.length-1] !== 100) list.push(100)
    return list
  }

  function calcularJurosTabela(){
    const financiamento = limparMoeda(document.getElementById("valorFinanciamento").value)
    const jurosAnual = parseFloat(document.getElementById("jurosAnual").value)||0
    const tr = parseFloat(document.getElementById("tr").value)||0
    const taxas = limparMoeda(document.getElementById("taxas").value)
    const passo = parseInt(document.getElementById("passoTabela").value)||10

    if(!financiamento || !jurosAnual){
      setResultadoJuros("vermelho",
        `<h3>Juros de Obra (Tabela)</h3>
         <p class="alerta">Preencha o Valor do Financiamento (no cabe√ßalho) e a Taxa de Juros Anual (%).</p>`
      )
      window.__lastJurosTabela = null
      return
    }

    const jurosMensal = (jurosAnual/100)/12
    const trMensal = (tr/100)
    const percList = buildPercList(passo)

    const rows = percList.map(perc=>{
      const liberado = financiamento * (perc/100)
      const parcela = (liberado*jurosMensal) + (liberado*trMensal) + taxas
      return { perc, parcela }
    })

    // guardar para PDF
    window.__lastJurosTabela = {
      financiamento, jurosAnual, tr, taxas, passo,
      rows
    }

    // montar tabela 4 colunas (duas listas lado a lado)
    const half = Math.ceil(rows.length/2)
    const leftRows = rows.slice(0, half)
    const rightRows = rows.slice(half)

    let table = `
      <h3 style="margin:0 0 10px;">Tabela de Juros de Obra (Estimativa)</h3>
      <div class="tabela-wrap">
        <table>
          <thead>
            <tr>
              <th>% da Obra</th>
              <th>Parcela Estimada (m√™s)</th>
              <th>% da Obra</th>
              <th>Parcela Estimada (m√™s)</th>
            </tr>
          </thead>
          <tbody>
    `

    for(let i=0;i<half;i++){
      const L = leftRows[i]
      const R = rightRows[i]
      table += `
        <tr>
          <td>${L ? `<b>${L.perc}%</b>` : ""}</td>
          <td>${L ? moeda(L.parcela) : ""}</td>
          <td>${R ? `<b>${R.perc}%</b>` : ""}</td>
          <td>${R ? moeda(R.parcela) : ""}</td>
        </tr>
      `
    }

    table += `
          </tbody>
        </table>
      </div>
      <div class="notas">
        * Valores aproximados para fins de simula√ß√£o e entendimento.
      </div>
    `

    setResultadoJuros("amarelo", table)
  }

  function limparJuros(){
    const out = document.getElementById("resultadoJuros")
    out.style.display="none"
    out.innerHTML=""
    out.className="resultado amarelo"
    document.getElementById("limparJurosBox").style.display="none"
    window.__lastJurosTabela = null
  }

  /* =========================
     PDF
  ========================= */
  function setDataDoc(){
    document.getElementById("pdfDataDoc").textContent = new Date().toLocaleDateString("pt-BR")
  }
  setDataDoc()

  async function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert("Biblioteca do PDF n√£o carregou. Verifique sua conex√£o (jsPDF).")
      return
    }

    // data SEMPRE do dia (atualiza no clique)
    setDataDoc()

    const { jsPDF } = window.jspdf
    const doc = new jsPDF({ unit: "mm", format: "a4" })

    const dataDoc = new Date().toLocaleDateString("pt-BR")

    const incluirINCC = (document.querySelector('input[name="inccOpt"]:checked')?.value === "sim")
    const incluirJuros = (document.querySelector('input[name="pdfJurosOpt"]:checked')?.value === "sim")

    const inccVal = normalizarPercentBR(document.getElementById("inccValor").value) // ex: 0.5

    // Cabe√ßalho
    const empreendimento = (document.getElementById("empreendimento").value || "").trim() || "-"
    const unidade = (document.getElementById("unidade").value || "").trim() || "-"

    const valorImovelTxt = document.getElementById("valorImovel").value || "-"
    const valorFinTxt = document.getElementById("valorFinanciamento").value || "-"

    const usaFgts = document.getElementById("usaFgts").value === "sim"
    const fgtsTxt = usaFgts ? (document.getElementById("fgts").value || "R$ 0,00") : "R$ 0,00"

    const rendaTxt = document.getElementById("renda").value || "R$ 0,00"
    const entregaTxt = document.getElementById("entregaSelect").value || "-"

    // PDF dados
    const pdfCliente = (document.getElementById("pdfCliente").value || "").trim() || "-"
    const pdfClienteFone = (document.getElementById("pdfClienteFone").value || "").trim() || "-"
    const pdfCorretor = (document.getElementById("pdfCorretor").value || "").trim() || "-"
    const pdfCorretorFone = (document.getElementById("pdfCorretorFone").value || "").trim() || "-"

    // Juros (enquadramento)
    const reg = document.getElementById("regiao").value || ""
    const cot = document.getElementById("cotista").value || ""
    const faixaTxt = (document.getElementById("faixaMCMV").value || "").trim() || "-"
    const jurosEfTxt = (document.getElementById("jurosEfetivo").value || "").trim() || "-"
    const vincTxt =
      cot === "cotista" ? "Cotista (+3 anos CLT)" :
      cot === "nao_cotista" ? "N√£o Cotista" : "-"
    const regTxt =
      reg === "no_ne" ? "NO/NE" :
      reg === "sul_se_co" ? "SUL/SE/CO" : "-"

    // Entrada
    const atoTxt = document.getElementById("ato").value || "R$ 0,00"
    const parcelasTxt = document.getElementById("parcelasEntrada").value || "-"
    const aceitaPosTxt = (document.getElementById("aceitaPos").value === "sim") ? "Sim" : "N√£o"

    const writeWrap = (text, x, y, maxW, lineH) => {
      const lines = doc.splitTextToSize(text, maxW)
      doc.text(lines, x, y)
      return y + (lines.length * lineH)
    }

    let y = 14
    const left = 14
    const right = 196
    const maxW = right - left

    doc.setFont("helvetica","bold")
    doc.setFontSize(14)
    doc.text("SIMULA√á√ÉO FINANCEIRA ‚Äì IM√ìVEL NA PLANTA", 105, y, { align:"center" })
    y += 7

    doc.setDrawColor(200)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Identifica√ß√£o", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(`Cliente: ${pdfCliente} | Tel: ${pdfClienteFone}`, left, y, maxW, 5)
    y = writeWrap(`Corretor(a): ${pdfCorretor} | Tel: ${pdfCorretorFone}`, left, y, maxW, 5)
    y = writeWrap(`Empreendimento: ${empreendimento}`, left, y, maxW, 5)
    y = writeWrap(`Unidade/Bloco/Andar: ${unidade}`, left, y, maxW, 5)
    y = writeWrap(`Data do documento: ${dataDoc}`, left, y, maxW, 5)

    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Resumo Financeiro", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(`Valor do im√≥vel: ${valorImovelTxt}`, left, y, maxW, 5)
    y = writeWrap(`Valor do financiamento: ${valorFinTxt}`, left, y, maxW, 5)
    y = writeWrap(`FGTS considerado: ${fgtsTxt}`, left, y, maxW, 5)
    y = writeWrap(`Renda familiar: ${rendaTxt}`, left, y, maxW, 5)
    y = writeWrap(`Previs√£o de entrega: ${entregaTxt}`, left, y, maxW, 5)

    y += 2
    y = writeWrap(`Enquadramento MCMV (estimado): ${faixaTxt} | Regi√£o: ${regTxt} | V√≠nculo: ${vincTxt}`, left, y, maxW, 5)
    y = writeWrap(`Taxa efetiva (a.a.) usada para Juros de Obra: ${jurosEfTxt}${jurosEfTxt !== "-" && jurosEfTxt !== "" ? "%" : ""}`, left, y, maxW, 5)

    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Fluxo de Pagamento ‚Äì Entrada", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)

    const entradaCalc = window.__lastEntradaCalc
    if(!entradaCalc){
      y = writeWrap("Fluxo n√£o calculado no simulador. Gere o c√°lculo de entrada antes de gerar o PDF.", left, y, maxW, 5)
    } else {
      y = writeWrap(`Entrada Total: ${moeda(entradaCalc.entradaTotal)}`, left, y, maxW, 5)
      y = writeWrap(`Ato: ${atoTxt}`, left, y, maxW, 5)
      y = writeWrap(`Meses/Parcelas (entrada): ${parcelasTxt}`, left, y, maxW, 5)

      if(entradaCalc.interVals && entradaCalc.interVals.length){
        const totalInter = entradaCalc.interVals.reduce((a,b)=>a+b,0)
        y = writeWrap(`Pagamentos extras: ${moeda(totalInter)}`, left, y, maxW, 5)
      }

      y = writeWrap(`Mensais (${entradaCalc.parcelas}x): ${moeda(entradaCalc.mensal)}`, left, y, maxW, 5)

      if(entradaCalc.saldoRestante && entradaCalc.saldoRestante > 0){
        y = writeWrap(`Saldo restante: ${moeda(entradaCalc.saldoRestante)} (P√≥s-Chaves/Pr√≥-Soluto: ${aceitaPosTxt})`, left, y, maxW, 5)
        y = writeWrap(`Saldo restante para verificar parcelamento com a construtora.`, left, y, maxW, 5)
      }

      y += 2
      y = writeWrap("Observa√ß√£o: Considerado limite de 30% da renda familiar para parcelas mensais.", left, y, maxW, 5)
    }

    // INCC (Sim/N√£o + valor)
    if(incluirINCC){
      if(y > 250){ doc.addPage(); y = 14 }
      y += 2
      doc.setDrawColor(220)
      doc.line(left, y, right, y)
      y += 6

      doc.setFont("helvetica","bold")
      doc.setFontSize(11)
      doc.text("Estimativa de INCC", left, y)
      y += 6

      doc.setFont("helvetica","normal")
      doc.setFontSize(10)

      const taxa = (inccVal !== null ? (inccVal/100) : 0.005) // default 0,5%
      y = writeWrap(`INCC (m√©dia mensal): ${((taxa*100).toFixed(2)).replace(".",",")}%`, left, y, maxW, 5)
      y = writeWrap("* Valores aproximados para fins de simula√ß√£o e entendimento.", left, y, maxW, 5)

      // (mantemos a l√≥gica anterior de proje√ß√£o simples se a entrada j√° foi calculada)
      if(entradaCalc){
        const mesesMensais = Math.max(0, (entradaCalc.parcelas || 0) - 1)
        const projMensal = entradaCalc.mensal * Math.pow(1+taxa, mesesMensais)
        y = writeWrap(`√öltima parcela mensal estimada (com INCC): ${moeda(projMensal)}`, left, y, maxW, 5)

        if(entradaCalc.interMeta && entradaCalc.interMeta.length){
          y = writeWrap("Pagamentos extras estimados (com INCC):", left, y, maxW, 5)
          entradaCalc.interMeta.forEach((it, i) => {
            const proj = it.valorBase * Math.pow(1+taxa, it.mesesAte)
            y = writeWrap(`- ${i+1}¬∫ pagamento (${it.data}): ${moeda(proj)}`, left, y, maxW, 5)
          })
        }
      } else {
        y = writeWrap("Para aplicar INCC em valores, gere o c√°lculo de entrada antes.", left, y, maxW, 5)
      }
    }

    // Juros de Obra (Sim/N√£o)
    if(incluirJuros){
      if(y > 240){ doc.addPage(); y = 14 }
      y += 2
      doc.setDrawColor(220)
      doc.line(left, y, right, y)
      y += 6

      doc.setFont("helvetica","bold")
      doc.setFontSize(11)
      doc.text("Juros de Obra ‚Äì Tabela", left, y)
      y += 6

      doc.setFont("helvetica","normal")
      doc.setFontSize(10)

      const jt = window.__lastJurosTabela
      if(!jt || !jt.rows || !jt.rows.length){
        y = writeWrap("Tabela n√£o calculada no simulador. Gere o c√°lculo de Juros de Obra antes de incluir no PDF.", left, y, maxW, 5)
      } else {
        y = writeWrap(`Intervalo: ${jt.passo} em ${jt.passo}% | TR(%): ${jt.tr} | Taxas/Seguros: ${moeda(jt.taxas)} | Juros anual(%): ${jt.jurosAnual}`, left, y, maxW, 5)

        // 4 colunas (% | parcela) x 2
        const rows = jt.rows
        const half = Math.ceil(rows.length/2)
        const leftRows = rows.slice(0, half)
        const rightRows = rows.slice(half)

        const colX = [left, left+35, left+95, left+130]
        doc.setFont("helvetica","bold")
        doc.text("%", colX[0], y)
        doc.text("Parcela", colX[1], y)
        doc.text("%", colX[2], y)
        doc.text("Parcela", colX[3], y)
        y += 6
        doc.setFont("helvetica","normal")

        for(let i=0;i<half;i++){
          const L = leftRows[i]
          const R = rightRows[i]

          if(L){
            doc.text(`${L.perc}%`, colX[0], y)
            doc.text(`${moeda(L.parcela)}`, colX[1], y)
          }
          if(R){
            doc.text(`${R.perc}%`, colX[2], y)
            doc.text(`${moeda(R.parcela)}`, colX[3], y)
          }

          y += 5
          if(y > 280){
            doc.addPage(); y = 14
          }
        }

        y += 2
        y = writeWrap("* Valores aproximados para fins de simula√ß√£o e entendimento.", left, y, maxW, 5)
      }
    }

    // Observa√ß√µes finais
    if(y > 245){ doc.addPage(); y = 14 }
    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Observa√ß√µes", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(
      "Os valores apresentados s√£o estimativas para fins de simula√ß√£o. Podem variar conforme evolu√ß√£o da obra, √≠ndices oficiais (INCC/TR), pol√≠ticas do banco e condi√ß√µes contratuais da construtora.",
      left, y, maxW, 5
    )

    doc.save("simulacao-imobiliaria.pdf")
  }

  /* =========================
     INIT
  ========================= */
  (function(){
    document.getElementById("limparEntradaBox").style.display = "none"
    document.getElementById("limparJurosBox").style.display = "none"
    toggleFGTS()
    toggleINCC()
  })()
</script>

</body>
</html>
