<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Simulador Imobili√°rio</title>

<!-- jsPDF (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:#f4f6f5;
    color:#222;
  }

  /* ===== TOPO ===== */
  .painel-topo{
    background:#fff;
    border-bottom:1px solid #e0e0e0;
    padding:16px;
  }
  .painel-topo h1{
    text-align:center;
    color:#0b6e3b;
    margin:0 0 16px;
    font-size:22px;
  }

  .grid-topo{
    max-width:900px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  .campo label{
    display:block;
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
  }
  .campo input,.campo select{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    background:#fff;
  }
  .campo-full{grid-column:1/-1}

  @media(min-width:768px){
    .grid-topo{grid-template-columns:repeat(2,1fr)}
  }

  .mini-hint{
    font-size:12px;
    color:#555;
    margin-top:6px;
    line-height:1.3;
  }
  .mini-hint b{color:#222}

  /* ===== CONTAINER ===== */
  .container{
    max-width:900px;
    margin:24px auto;
    padding:0 16px 40px;
  }

  /* ===== BLOCOS ===== */
  .bloco{
    background:#fff;
    border-radius:14px;
    border:1px solid #ddd;
    overflow:hidden;
    margin-bottom:14px;
  }
  .bloco-header{
    color:#fff;
    padding:14px 16px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .header-entrada{background:#0b6e3b}
  .header-juros{background:#d97706}
  .header-pdf{background:#2563eb}

  .toggle-icon{
    background:rgba(255,255,255,.2);
    border-radius:6px;
    width:22px;
    height:22px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
  }
  .bloco-conteudo{display:none;padding:18px}

  .subgrid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  @media(min-width:768px){
    .subgrid{grid-template-columns:repeat(2,1fr)}
    .span2{grid-column:1/-1}
  }

  .divider{
    height:1px;
    background:#e9e9e9;
    margin:16px 0;
  }

  .bloco-inter{background:#f3faf6;padding:12px;border-radius:10px}
  .bloco-pos{background:#f2f6fb;padding:12px;border-radius:10px}

  /* ===== BOT√ïES ===== */
  button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:10px;
    color:#fff;
    font-size:15px;
    cursor:pointer;
    margin-top:12px;
  }
  .btn-entrada{background:#0b6e3b}
  .btn-juros{background:#d97706}
  .btn-pdf{background:#2563eb}

  .btn-limpar{
    background:#c62828;
    width:auto;
    padding:10px 14px;
    font-size:13px;
    border-radius:8px;
  }

  .box-limpar{
    display:none;
    margin-top:14px;
    justify-content:center;
  }

  /* ===== RESULTADOS (VERDE/AMARELO/VERMELHO) ===== */
  .resultado{
    display:none;
    padding:16px;
    border-radius:12px;
    margin-top:12px;
    border:1px solid rgba(0,0,0,.08);
  }
  .resultado.verde{
    background:#eaf7ee;            /* verde claro */
    border-color:#bfe6c9;
  }
  .resultado.amarelo{
    background:#fff7da;            /* amarelo claro */
    border-color:#f0dc8a;
  }
  .resultado.vermelho{
    background:#ffe3e3;            /* vermelho claro */
    border-color:#ffb7b7;
  }

  .alerta{color:#8b1e1e;font-weight:800}
  .obs{font-style:italic;color:#333;margin-top:10px;display:block}
  .pill{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:#eef3ef;
    border:1px solid #dfe9df;
    font-size:12px;
    color:#2a2a2a;
    margin-top:6px;
  }
  .pill.warn{
    background:#fff3f3;
    border-color:#ffd2d2;
    color:#7a1b1b;
  }
  .muted{opacity:.78}

  /* ===== INTERMEDI√ÅRIAS ===== */
  .inter-list{display:flex;flex-direction:column;gap:10px}
  .inter-row{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    background:#fff;
    border:1px solid #e6efe9;
    padding:10px;
    border-radius:10px;
  }
  @media(min-width:768px){
    .inter-row{grid-template-columns:1fr 1fr}
  }

  /* ===== CHECKBOX PADR√ÉO (PDF) ===== */
  .check-row{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:600;
    cursor:pointer;
    user-select:none;
  }
  .check-row input{
    width:18px;
    height:18px;
    margin:0;
    accent-color:#2563eb;
  }
  .check-hint{
    display:block;
    font-weight:normal;
    opacity:.75;
    font-size:12px;
    margin-top:2px;
  }
</style>
</head>

<body>

<!-- TOPO (CABE√áALHO ENXUTO) -->
<div class="painel-topo">
  <h1>Simulador Imobili√°rio</h1>

  <div class="grid-topo">

    <div class="campo">
      <label>üßë‚Äçüíº Corretor(a)</label>
      <input id="corretorNome" placeholder="">
    </div>

    <div class="campo">
      <label>üè¢ Empreendimento</label>
      <input id="empreendimento" placeholder="">
    </div>

    <div class="campo">
      <label>üè† Unidade / Bloco / Andar</label>
      <input id="unidade" placeholder="">
    </div>

    <div class="campo">
      <label>üè† Valor do Im√≥vel (R$)</label>
      <input id="valorImovel" oninput="formatarMoeda(this)">
    </div>

    <div class="campo">
      <label>üè¶ Valor do Financiamento (R$)</label>
      <input id="valorFinanciamento" oninput="formatarMoeda(this)">
    </div>

    <div class="campo">
      <label>üí∞ Vai utilizar FGTS?</label>
      <select id="usaFgts" onchange="toggleFGTS()">
        <option value="nao">N√£o</option>
        <option value="sim">Sim</option>
      </select>
      <div class="mini-hint">Se <b>Sim</b>, informe o valor abaixo.</div>
    </div>

    <div class="campo" id="boxFGTS" style="display:none;">
      <label>üí∞ FGTS (R$)</label>
      <input id="fgts" oninput="formatarMoeda(this)" placeholder="">
    </div>

    <div class="campo">
      <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Renda Familiar Mensal (R$)</label>
      <input id="renda" oninput="formatarMoeda(this); updateMCMV(false);">
      <div class="mini-hint">Usada para identificar a <b>faixa MCMV</b> e sugerir a taxa no m√≥dulo <b>Juros de Obra</b>.</div>
    </div>

    <div class="campo campo-full">
      <label>üìÖ Previs√£o de Entrega (m√™s/ano)</label>
      <select id="entregaSelect"></select>
    </div>

  </div>
</div>

<div class="container">

  <!-- ===== ENTRADA ===== -->
  <div class="bloco">
    <div class="bloco-header header-entrada" onclick="toggleBloco(this)">
      <span>üí∞ Entrada / Fluxo Inicial</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">

      <div class="subgrid">
        <div class="campo">
          <label>üí∏ Valor do Ato (R$)</label>
          <input id="ato" oninput="formatarMoeda(this)">
        </div>

        <div class="campo">
          <label>üóìÔ∏è MESES / PARCELAS</label>
          <input id="parcelasEntrada" type="number" min="1">
        </div>
      </div>

      <div class="divider"></div>

      <!-- INTERMEDI√ÅRIAS -->
      <div class="bloco-inter">
        <div class="subgrid">
          <div class="campo span2">
            <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
            <select id="temInter" onchange="toggleInter()">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
            <div class="mini-hint">Se marcar <b>Sim</b>, o preenchimento dos valores √© <b>obrigat√≥rio</b>.</div>
          </div>

          <div class="campo span2" id="boxInterQtd" style="display:none;">
            <label>Quantidade</label>
            <input id="qtdInter" type="number" min="1" max="6" value="1" onchange="renderInterRows()">
          </div>

          <div class="campo span2" id="boxInterRows" style="display:none;">
            <div class="inter-list" id="interList"></div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- P√ìS-CHAVES -->
      <div class="bloco-pos">
        <div class="subgrid">
          <div class="campo span2">
            <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
            <select id="aceitaPos">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
            <div class="mini-hint">Se houver saldo restante, o resultado ser√° classificado conforme esta op√ß√£o.</div>
          </div>
        </div>
      </div>

      <button class="btn-entrada" onclick="calcularEntrada()">Calcular Entrada</button>
    </div>
  </div>

  <!-- RESULTADO ENTRADA -->
  <div id="resultadoEntrada" class="resultado"></div>
  <div id="limparEntradaBox" class="box-limpar">
    <button class="btn-limpar" onclick="limparEntrada()">Limpar fluxo de entrada</button>
  </div>

  <!-- ===== JUROS DE OBRA ===== -->
  <div class="bloco">
    <div class="bloco-header header-juros" onclick="toggleBloco(this)">
      <span>üèóÔ∏è Juros de Obra</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">

      <!-- ENQUADRAMENTO (progressivo) -->
      <div class="subgrid">

        <div class="campo span2">
          <label>üß≠ Regi√£o do Brasil</label>
          <select id="regiao" onchange="onChangeRegiao()">
            <option value="">Selecione...</option>
            <option value="no_ne">NO/NE</option>
            <option value="sul_se_co">SUL/SE/CO</option>
          </select>
          <div class="mini-hint">Ap√≥s selecionar a regi√£o, o campo de cotista aparecer√°.</div>
        </div>

        <div class="campo span2" id="boxCotista" style="display:none;">
          <label>üßæ Cotista ou N√£o Cotista?</label>
          <select id="cotista" onchange="onChangeCotista()">
            <option value="">Selecione...</option>
            <option value="cotista">Cotista (+3 anos CLT)</option>
            <option value="nao_cotista">N√£o Cotista</option>
          </select>
          <div class="mini-hint">Usado para sugerir a taxa efetiva do financiamento.</div>
        </div>

        <div class="campo" id="boxFaixa" style="display:none;">
          <label>üè∑Ô∏è Faixa Minha Casa Minha Vida</label>
          <input id="faixaMCMV" readonly>
          <span id="faixaPill" class="pill" style="display:none;"></span>
        </div>

        <div class="campo" id="boxJurosEf" style="display:none;">
          <label>üìà Juros efetivos do financiamento (a.a.)</label>
          <input id="jurosEfetivo" placeholder="Ex.: 5,64">
          <div class="mini-hint">Preenche automaticamente a taxa anual abaixo (edit√°vel).</div>
          <span id="mcmvWarn" class="pill warn" style="display:none;"></span>
        </div>

      </div>

      <div class="divider"></div>

      <!-- C√ÅLCULO JUROS DE OBRA -->
      <div class="subgrid">
        <div class="campo">
          <label>% da Obra (liberado)</label>
          <input id="percObra" type="number" min="0" step="0.1" placeholder="Ex.: 30">
        </div>

        <div class="campo">
          <label>Taxa de Juros Anual (%)</label>
          <input id="jurosAnual" type="number" min="0" step="0.01" placeholder="Preenchido automaticamente (edit√°vel)">
          <div class="mini-hint">Se voc√™ editar aqui, o sistema n√£o sobrescreve automaticamente.</div>
        </div>

        <div class="campo">
          <label>TR (%) <small style="font-weight:normal;opacity:.8;">‚Äì valor m√©dio 0,17%</small></label>
          <input id="tr" type="number" step="0.01" value="0.17">
        </div>

        <div class="campo">
          <label>Taxas e Seguros (R$) <small style="font-weight:normal;opacity:.8;">‚Äì usado valor m√©dio R$ 65</small></label>
          <input id="taxas" value="R$ 65,00" oninput="formatarMoeda(this)">
        </div>
      </div>

      <button class="btn-juros" onclick="calcularJuros()">Calcular Juros de Obra</button>
    </div>
  </div>

  <!-- RESULTADO JUROS -->
  <div id="resultadoJuros" class="resultado"></div>
  <div id="limparJurosBox" class="box-limpar">
    <button class="btn-limpar" onclick="limparJuros()">Limpar juros de obra</button>
  </div>

  <!-- ===== GERAR PDF ===== -->
  <div class="bloco">
    <div class="bloco-header header-pdf" onclick="toggleBloco(this)">
      <span>üìÑ Gerar PDF</span>
      <span class="toggle-icon">+</span>
    </div>

    <div class="bloco-conteudo">
      <div class="subgrid">

        <!-- Cliente + Telefones s√≥ no PDF -->
        <div class="campo">
          <label>üë§ Cliente (somente para PDF)</label>
          <input id="pdfCliente" placeholder="">
        </div>

        <div class="campo">
          <label>üìû Telefone (Cliente) ‚Äì somente para PDF</label>
          <input id="pdfClienteFone" inputmode="tel" oninput="formatarTelefone(this)" placeholder="">
        </div>

        <div class="campo span2">
          <label>üìû Telefone (Corretor(a)) ‚Äì somente para PDF</label>
          <input id="pdfCorretorFone" inputmode="tel" oninput="formatarTelefone(this)" placeholder="">
          <div class="mini-hint">O nome do corretor(a) √© puxado do cabe√ßalho.</div>
        </div>

        <div class="campo span2">
          <label class="check-row" for="pdfChkINCC">
            <input type="checkbox" id="pdfChkINCC">
            <span>
              Incluir estimativa de INCC
              <span class="check-hint">(0,5% ao m√™s)</span>
            </span>
          </label>
        </div>

        <div class="campo span2">
          <label class="check-row" for="pdfChkJurosTabela">
            <input type="checkbox" id="pdfChkJurosTabela">
            <span>
              Exibir tabela de Juros de Obra
              <span class="check-hint">(10% em 10%)</span>
            </span>
          </label>
        </div>

        <div class="campo span2" style="font-size:13px;color:#444;">
          <b>Data do documento:</b> <span id="pdfDataDoc"></span>
        </div>
      </div>

      <button class="btn-pdf" onclick="gerarPDF()">Gerar PDF da Simula√ß√£o</button>
    </div>
  </div>

</div>

<script>
  // ===== util =====
  function formatarMoeda(c){
    let v=(c.value||"").replace(/\D/g,"")
    if(!v){c.value=""; return}
    v=(parseInt(v)/100).toFixed(2).replace(".",",")
    v=v.replace(/\B(?=(\d{3})+(?!\d))/g,".")
    c.value="R$ "+v
  }
  function limparMoeda(v){
    return parseFloat((v||"").replace(/[R$\.\s]/g,"").replace(",", "."))||0
  }
  function moeda(n){
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
  }
  function formatarTelefone(input){
    let v = (input.value||"").replace(/\D/g,"").slice(0,11)
    if(v.length<=2){ input.value=v; return }
    const ddd = v.slice(0,2)
    const rest = v.slice(2)
    if(rest.length<=4){ input.value = `(${ddd}) ${rest}`; return }
    if(rest.length<=8){ input.value = `(${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`; return }
    input.value = `(${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`
  }
  function normalizarPercentBR(v){
    const s = String(v||"").trim().replace("%","").replace(",",".")
    const n = parseFloat(s)
    return Number.isFinite(n) ? n : null
  }

  // ===== meses/ano =====
  function gerarMesAno(){
    const h=new Date()
    const arr=[]
    const m=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]
    for(let i=0;i<48;i++){
      const d=new Date(h.getFullYear(),h.getMonth()+i,1)
      arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`)
    }
    return arr
  }
  (function(){
    const s=document.getElementById("entregaSelect")
    gerarMesAno().forEach(t=>{
      const o=document.createElement("option")
      o.textContent=t
      s.appendChild(o)
    })
  })()

  // ===== toggles =====
  function toggleBloco(el){
    const c=el.nextElementSibling
    const i=el.querySelector(".toggle-icon")
    const aberto=c.style.display==="block"
    c.style.display=aberto?"none":"block"
    i.textContent=aberto?"+":"‚Äì"
  }

  function toggleFGTS(){
    const usa = document.getElementById("usaFgts").value
    const box = document.getElementById("boxFGTS")
    if(usa==="sim"){
      box.style.display="block"
    } else {
      box.style.display="none"
      const fg = document.getElementById("fgts")
      if(fg) fg.value=""
    }
  }

  function toggleInter(){
    const tem = document.getElementById("temInter").value
    const boxQtd = document.getElementById("boxInterQtd")
    const boxRows = document.getElementById("boxInterRows")
    if(tem==="sim"){
      boxQtd.style.display="block"
      boxRows.style.display="block"
      renderInterRows()
    } else {
      boxQtd.style.display="none"
      boxRows.style.display="none"
      document.getElementById("interList").innerHTML=""
      document.getElementById("qtdInter").value = 1
    }
  }

  function renderInterRows(){
    const q=parseInt(document.getElementById("qtdInter").value)||0
    const interList=document.getElementById("interList")
    interList.innerHTML=""
    if(q<=0) return

    const meses=gerarMesAno()
    for(let i=1;i<=q;i++){
      const r=document.createElement("div")
      r.className="inter-row"
      r.innerHTML=`
        <div>
          <label>${i}¬∫ pagamento (Intermedi√°ria/Anual/Refor√ßo/Chaves)</label>
          <select>${meses.map(m=>`<option>${m}</option>`).join("")}</select>
        </div>
        <div>
          <label>Valor (R$) <span class="muted">(obrigat√≥rio)</span></label>
          <input oninput="formatarMoeda(this)" placeholder="Ex.: R$ 5.000,00">
        </div>
      `
      interList.appendChild(r)
    }
  }

  // ===== MCMV (tabela + l√≥gica corrigida) =====
  // Regras importantes:
  // - A faixa √© determinada pela RENDA.
  // - A taxa pode variar por (Cotista/N√£o) e por Regi√£o.
  // - Quando a tabela n√£o diferencia regi√£o para uma subfaixa (campo ‚Äúvazio‚Äù), a taxa √© √öNICA (vale para todas as regi√µes).
  const MCMV_RANGES = [
    // Faixa 1
    { faixa:"Faixa 1", min:0,       max:2160.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.07:4.33) : (reg==="no_ne"?4.59:4.84) },
    { faixa:"Faixa 1", min:2160.01, max:2850.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.33:4.59) : (reg==="no_ne"?4.84:5.12) },

    // Faixa 2
    { faixa:"Faixa 2", min:2850.01, max:3500.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.84:5.12) : (reg==="no_ne"?5.38:5.64) },

    // Faixa 2 (3.500,01 a 4.000) ‚Äî taxa √öNICA (sem distin√ß√£o por regi√£o na tabela)
    { faixa:"Faixa 2", min:3500.01, max:4000.00,  rate:(isCotista, reg)=> isCotista ? 5.64 : 6.17 },

    // Faixa 2 (4.000,01 a 4.700) ‚Äî taxa √öNICA (sem distin√ß√£o por regi√£o na tabela)
    { faixa:"Faixa 2", min:4000.01, max:4700.00,  rate:(isCotista, reg)=> isCotista ? 6.70 : 7.23 },

    // Faixa 3 ‚Äî taxa √∫nica por cotista/n√£o cotista (sem distin√ß√£o por regi√£o na sua tabela)
    { faixa:"Faixa 3", min:4700.01, max:8600.00,  rate:(isCotista, reg)=> isCotista ? 7.93 : 8.46 },

    // Faixa 4 ‚Äî taxa √∫nica
    { faixa:"Faixa 4", min:8600.01, max:12000.00, rate:(isCotista, reg)=> 11.03 },
  ]

  function findFaixaByRenda(renda){
    return MCMV_RANGES.find(r => renda >= r.min && renda <= r.max) || null
  }

  // Fluxo progressivo
  function onChangeRegiao(){
    const reg = document.getElementById("regiao").value
    const boxCot = document.getElementById("boxCotista")
    const cotEl = document.getElementById("cotista")

    // Reset de baixo para cima
    cotEl.value = ""
    boxCot.style.display = reg ? "block" : "none"

    hideMcmvBoxes()
    updateMCMV(false)
  }

  function onChangeCotista(){
    hideMcmvBoxes()
    updateMCMV(false)
  }

  function hideMcmvBoxes(){
    document.getElementById("boxFaixa").style.display = "none"
    document.getElementById("boxJurosEf").style.display = "none"
    document.getElementById("faixaPill").style.display = "none"
    document.getElementById("mcmvWarn").style.display = "none"
  }

  let __jurosManualNoModulo = false
  let __jurosEfManual = false

  function updateMCMV(force){
    const renda = limparMoeda(document.getElementById("renda").value)
    const reg = document.getElementById("regiao").value
    const cot = document.getElementById("cotista").value

    const faixaEl = document.getElementById("faixaMCMV")
    const jurosEfEl = document.getElementById("jurosEfetivo")
    const warnEl = document.getElementById("mcmvWarn")
    const pillEl = document.getElementById("faixaPill")

    warnEl.style.display="none"
    pillEl.style.display="none"

    // S√≥ mostra Faixa/Juros depois que houver regi√£o e cotista selecionados
    if(!reg || !cot){
      return
    }

    // Agora podemos mostrar os boxes
    document.getElementById("boxFaixa").style.display = "block"
    document.getElementById("boxJurosEf").style.display = "block"

    if(!renda || renda<=0){
      faixaEl.value = ""
      if(!__jurosEfManual) jurosEfEl.value = ""
      warnEl.textContent = "Preencha a renda no cabe√ßalho para identificar faixa e taxa."
      warnEl.style.display = "inline-block"
      syncJurosObraFromHeader(false)
      return
    }

    const faixaObj = findFaixaByRenda(renda)
    if(!faixaObj){
      faixaEl.value = "Fora da tabela"
      pillEl.textContent = "Fora da tabela"
      pillEl.style.display = "inline-block"

      if(!__jurosEfManual) jurosEfEl.value = ""
      warnEl.textContent = "Renda fora do intervalo informado (at√© R$ 12.000). Informe a taxa manualmente."
      warnEl.style.display = "inline-block"
      syncJurosObraFromHeader(false)
      return
    }

    // Preenche faixa
    faixaEl.value = faixaObj.faixa
    pillEl.textContent = faixaObj.faixa
    pillEl.style.display = "inline-block"

    // Preenche juros efetivo (a menos que corretor tenha editado manualmente)
    const isCotista = (cot === "cotista")
    const taxa = faixaObj.rate(isCotista, reg)

    if(!__jurosEfManual){
      jurosEfEl.value = String(taxa).replace(".", ",")
    }

    syncJurosObraFromHeader(false)
  }

  function syncJurosObraFromHeader(force){
    const headerVal = document.getElementById("jurosEfetivo").value
    const jHeader = normalizarPercentBR(headerVal)
    const jurosAnualEl = document.getElementById("jurosAnual")
    if(!jurosAnualEl) return

    if(force){
      if(jHeader !== null) jurosAnualEl.value = jHeader
      return
    }

    if(__jurosManualNoModulo) return
    if(jHeader !== null) jurosAnualEl.value = jHeader
  }

  // Travar auto-sync se corretor editar manualmente no m√≥dulo Juros de Obra
  (function(){
    const j = document.getElementById("jurosAnual")
    if(!j) return
    j.addEventListener("input", () => { __jurosManualNoModulo = true })
  })()

  // Se editar juros efetivo manualmente, n√£o sobrescrever depois
  (function(){
    const je = document.getElementById("jurosEfetivo")
    if(!je) return
    je.addEventListener("input", () => {
      __jurosEfManual = true
      syncJurosObraFromHeader(true)
    })
  })()

  // ===== C√ÅLCULO ENTRADA (VERDE/AMARELO/VERMELHO) =====
  function setResultadoEntrada(tipo, html){
    const out=document.getElementById("resultadoEntrada")
    out.className = "resultado " + tipo
    out.innerHTML = html
    out.style.display = "block"
    document.getElementById("limparEntradaBox").style.display = "flex"
  }

  function calcularEntrada(){
    const im=limparMoeda(document.getElementById("valorImovel").value)
    const fi=limparMoeda(document.getElementById("valorFinanciamento").value)

    const usaFgts = document.getElementById("usaFgts").value === "sim"
    const fg = usaFgts ? limparMoeda(document.getElementById("fgts").value) : 0

    const at=limparMoeda(document.getElementById("ato").value)
    const re=limparMoeda(document.getElementById("renda").value)
    const p=parseInt(document.getElementById("parcelasEntrada").value)||0

    if(!im || !fi || !re || !p){
      setResultadoEntrada("vermelho",
        `<h3>Entrada / Fluxo Inicial</h3>
         <p class="alerta">Preencha os campos obrigat√≥rios: Valor do Im√≥vel, Financiamento, Renda e Meses/Parcelas.</p>`
      )
      return
    }

    // Entrada total
    const entrada = im - fi - fg

    // Intermedi√°rias (obrigat√≥rias se ativadas)
    const temInter = document.getElementById("temInter").value === "sim"
    const interVals = []
    const interMeta = []

    if(temInter){
      const rows = document.querySelectorAll("#interList .inter-row")
      if(!rows.length){
        setResultadoEntrada("vermelho",
          `<h3>Entrada / Fluxo Inicial</h3>
           <p class="alerta">Voc√™ marcou que tem Intermedi√°rias/Anuais/Refor√ßos/Chaves, mas n√£o informou a quantidade.</p>`
        )
        return
      }

      let faltando = false
      rows.forEach((row, idx) => {
        const sel = row.querySelector("select")
        const inp = row.querySelector("input")
        const data = sel ? sel.value : "-"
        const mesesAte = sel ? sel.selectedIndex : 0
        const v = limparMoeda(inp ? inp.value : "")
        if(!v || v<=0) faltando = true
        interVals.push(v)
        interMeta.push({ data, mesesAte, valorBase:v })
      })

      if(faltando){
        setResultadoEntrada("vermelho",
          `<h3>Entrada / Fluxo Inicial</h3>
           <p class="alerta">Preencha o valor de todas as Intermedi√°rias/Anuais/Refor√ßos/Chaves (campo obrigat√≥rio).</p>`
        )
        return
      }
    }

    // Saldo ap√≥s Ato e Intermedi√°rias
    const somaInter = interVals.reduce((a,b)=>a+b,0)
    let saldo = entrada - at - somaInter

    // Se ato + intermedi√°rias j√° cobrem tudo
    if(saldo <= 0){
      // Mensais 0, sem saldo restante
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: 0,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: 0,
        status: "verde"
      }

      setResultadoEntrada("verde",
        `<h3>‚úÖ Entrada dentro dos limites</h3>
         <p>üìÖ Previs√£o de entrega: <b>${document.getElementById("entregaSelect").value}</b></p>
         <p>Entrada total (Im√≥vel - Financiamento - FGTS): <b>${moeda(entrada)}</b></p>
         <div class="divider"></div>
         <p>Ato: <b>${moeda(at)}</b></p>
         ${temInter ? `<p>Pagamentos (Intermedi√°rias/Anuais/Refor√ßos/Chaves): <b>${moeda(somaInter)}</b></p>` : `<p>Pagamentos extras: <b>n√£o informados</b></p>`}
         <p>Mensais (${p}x): <b>${moeda(0)}</b></p>
         <span class="obs">Considerado limite de 30% da renda familiar para parcelas mensais.</span>`
      )
      return
    }

    // Mensais com limite 30% renda
    const limiteMensal = re * 0.30
    let mensal = saldo / p
    let resto = 0

    if(mensal > limiteMensal){
      mensal = limiteMensal
      resto = saldo - (mensal * p)
      // resto aqui √© o saldo ‚Äúpara verificar com construtora‚Äù
    }

    // Montar texto de pagamentos extras
    let interTexto = ""
    if(temInter && interVals.length){
      interTexto = `<p>Pagamentos (Intermedi√°rias/Anuais/Refor√ßos/Chaves): <b>${moeda(somaInter)}</b></p>`
    } else {
      interTexto = `<p>Pagamentos extras: <b>n√£o informados</b></p>`
    }

    const baseHTML = `
      <p>üìÖ Previs√£o de entrega: <b>${document.getElementById("entregaSelect").value}</b></p>
      <p>Entrada total (Im√≥vel - Financiamento - FGTS): <b>${moeda(entrada)}</b></p>
      <div class="divider"></div>
      <p>Ato: <b>${moeda(at)}</b></p>
      ${interTexto}
      <p>Mensais (${p}x): <b>${moeda(mensal)}</b></p>
      <span class="obs">Considerado limite de 30% da renda familiar para parcelas mensais.</span>
    `

    // Classifica√ß√£o verde / amarelo / vermelho
    if(resto <= 0){
      // VERDE
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: mensal,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: 0,
        status: "verde"
      }
      setResultadoEntrada("verde",
        `<h3>‚úÖ Entrada dentro dos limites</h3>
         ${baseHTML}`
      )
      return
    }

    // Se sobrou, depende do P√≥s-Chaves
    const aceitaPos = document.getElementById("aceitaPos").value === "sim"

    if(aceitaPos){
      // AMARELO
      window.__lastEntradaCalc = {
        entradaTotal: entrada,
        ato: at,
        parcelas: p,
        mensal: mensal,
        interVals: interVals,
        interMeta: interMeta,
        saldoRestante: resto,
        status: "amarelo"
      }
      setResultadoEntrada("amarelo",
        `<h3>‚ö†Ô∏è Entrada com saldo restante</h3>
         ${baseHTML}
         <div class="divider"></div>
         <p><b>Saldo restante:</b> ${moeda(resto)}</p>
         <p><b>Saldo restante para verificar parcelamento com a construtora.</b></p>`
      )
      return
    }

    // VERMELHO
    window.__lastEntradaCalc = {
      entradaTotal: entrada,
      ato: at,
      parcelas: p,
      mensal: mensal,
      interVals: interVals,
      interMeta: interMeta,
      saldoRestante: resto,
      status: "vermelho"
    }

    setResultadoEntrada("vermelho",
      `<h3>‚õî Entrada fora das condi√ß√µes informadas</h3>
       ${baseHTML}
       <div class="divider"></div>
       <p><b>Saldo restante:</b> ${moeda(resto)}</p>
       <p class="alerta"><b>A construtora n√£o aceita saldo P√≥s-Chaves / Pr√≥-Soluto.</b> Com esse fluxo, a entrada n√£o fecha dentro das condi√ß√µes apresentadas.</p>`
    )
  }

  function limparEntrada(){
    const out = document.getElementById("resultadoEntrada")
    out.style.display="none"
    out.innerHTML=""
    out.className="resultado"
    document.getElementById("limparEntradaBox").style.display="none"
    window.__lastEntradaCalc = null
  }

  // ===== JUROS DE OBRA =====
  function setResultadoJuros(tipo, html){
    const out=document.getElementById("resultadoJuros")
    out.className = "resultado " + tipo
    out.innerHTML = html
    out.style.display = "block"
    document.getElementById("limparJurosBox").style.display = "flex"
  }

  function calcularJuros(){
    const financiamento = limparMoeda(document.getElementById("valorFinanciamento").value)
    const perc = parseFloat(document.getElementById("percObra").value)||0
    const jurosAnual = parseFloat(document.getElementById("jurosAnual").value)||0
    const tr = parseFloat(document.getElementById("tr").value)||0
    const taxas = limparMoeda(document.getElementById("taxas").value)

    window.__lastJurosInputs = { financiamento, jurosAnual, tr, taxas }

    if(!financiamento || !perc || !jurosAnual){
      setResultadoJuros("vermelho",
        `<h3>Juros de Obra (Estimativa)</h3>
         <p class="alerta">Preencha os campos obrigat√≥rios: Financiamento, % da obra e taxa de juros anual.</p>`
      )
      return
    }

    const liberado = financiamento*(perc/100)
    const parcela = (liberado*((jurosAnual/100)/12)) + (liberado*(tr/100)) + taxas

    setResultadoJuros("amarelo",
      `<h3>Juros de Obra (Estimativa)</h3>
       <p>Percentual da obra considerado: <b>${perc}%</b></p>
       <p>Taxa anual usada: <b>${jurosAnual}%</b></p>
       <p>Parcela estimada mensal: <b>${moeda(parcela)}</b></p>
       <span class="obs">Valor aproximado para fins de simula√ß√£o. Pode variar conforme TR mensal e pol√≠ticas do banco.</span>`
    )
  }

  function limparJuros(){
    const out = document.getElementById("resultadoJuros")
    out.style.display="none"
    out.innerHTML=""
    out.className="resultado"
    document.getElementById("limparJurosBox").style.display="none"
  }

  // ===== PDF =====
  (function(){
    const el = document.getElementById("pdfDataDoc")
    if(el) el.textContent = new Date().toLocaleDateString("pt-BR")
  })()

  async function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert("Biblioteca do PDF n√£o carregou. Verifique sua conex√£o com a internet (jsPDF).")
      return
    }

    const { jsPDF } = window.jspdf
    const doc = new jsPDF({ unit: "mm", format: "a4" })

    const hoje = new Date()
    const dataDoc = hoje.toLocaleDateString("pt-BR")

    const incluirINCC = !!document.getElementById("pdfChkINCC")?.checked
    const incluirTabelaJuros = !!document.getElementById("pdfChkJurosTabela")?.checked

    // Cabe√ßalho
    const corretorNome = (document.getElementById("corretorNome")?.value || "").trim() || "-"
    const empreendimento = (document.getElementById("empreendimento")?.value || "").trim() || "-"
    const unidade = (document.getElementById("unidade")?.value || "").trim() || "-"

    const valorImovelTxt = document.getElementById("valorImovel")?.value || "-"
    const valorFinTxt = document.getElementById("valorFinanciamento")?.value || "-"
    const usaFgts = document.getElementById("usaFgts")?.value === "sim"
    const fgtsTxt = usaFgts ? (document.getElementById("fgts")?.value || "R$ 0,00") : "R$ 0,00"
    const rendaTxt = document.getElementById("renda")?.value || "R$ 0,00"
    const entregaTxt = document.getElementById("entregaSelect")?.value || "-"

    // PDF extras (cliente/telefones)
    const pdfCliente = (document.getElementById("pdfCliente")?.value || "").trim() || "-"
    const pdfClienteFone = (document.getElementById("pdfClienteFone")?.value || "").trim() || "-"
    const pdfCorretorFone = (document.getElementById("pdfCorretorFone")?.value || "").trim() || "-"

    // Juros (enquadramento)
    const reg = document.getElementById("regiao")?.value || ""
    const cot = document.getElementById("cotista")?.value || ""
    const faixaTxt = (document.getElementById("faixaMCMV")?.value || "").trim() || "-"
    const jurosEfTxt = (document.getElementById("jurosEfetivo")?.value || "").trim() || "-"
    const vincTxt =
      cot === "cotista" ? "Cotista (+3 anos CLT)" :
      cot === "nao_cotista" ? "N√£o Cotista" : "-"
    const regTxt =
      reg === "no_ne" ? "NO/NE" :
      reg === "sul_se_co" ? "SUL/SE/CO" : "-"

    // Entrada
    const atoTxt = document.getElementById("ato")?.value || "R$ 0,00"
    const parcelasTxt = document.getElementById("parcelasEntrada")?.value || "-"
    const aceitaPosTxt = (document.getElementById("aceitaPos")?.value === "sim") ? "Sim" : "N√£o"

    const writeWrap = (text, x, y, maxW, lineH) => {
      const lines = doc.splitTextToSize(text, maxW)
      doc.text(lines, x, y)
      return y + (lines.length * lineH)
    }

    let y = 14
    const left = 14
    const right = 196
    const maxW = right - left

    doc.setFont("helvetica","bold")
    doc.setFontSize(14)
    doc.text("SIMULA√á√ÉO FINANCEIRA ‚Äì IM√ìVEL NA PLANTA", 105, y, { align:"center" })
    y += 7

    doc.setDrawColor(200)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Identifica√ß√£o (PDF)", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(`Cliente: ${pdfCliente} | Tel: ${pdfClienteFone}`, left, y, maxW, 5)
    y = writeWrap(`Corretor(a): ${corretorNome} | Tel: ${pdfCorretorFone}`, left, y, maxW, 5)
    y = writeWrap(`Empreendimento: ${empreendimento}`, left, y, maxW, 5)
    y = writeWrap(`Unidade/Bloco/Andar: ${unidade}`, left, y, maxW, 5)
    y = writeWrap(`Data do documento: ${dataDoc}`, left, y, maxW, 5)

    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Resumo Financeiro (Cabe√ßalho)", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(`Valor do im√≥vel: ${valorImovelTxt}`, left, y, maxW, 5)
    y = writeWrap(`Valor do financiamento: ${valorFinTxt}`, left, y, maxW, 5)
    y = writeWrap(`FGTS considerado: ${fgtsTxt}`, left, y, maxW, 5)
    y = writeWrap(`Renda familiar: ${rendaTxt}`, left, y, maxW, 5)
    y = writeWrap(`Previs√£o de entrega: ${entregaTxt}`, left, y, maxW, 5)

    y += 2
    y = writeWrap(`Enquadramento MCMV (estimado): ${faixaTxt} | Regi√£o: ${regTxt} | V√≠nculo: ${vincTxt}`, left, y, maxW, 5)
    y = writeWrap(`Taxa efetiva (a.a.) usada para Juros de Obra: ${jurosEfTxt}${jurosEfTxt !== "-" ? "%" : ""}`, left, y, maxW, 5)

    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Fluxo de Pagamento ‚Äì Entrada", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)

    const entradaCalc = window.__lastEntradaCalc
    if(!entradaCalc){
      y = writeWrap("Fluxo n√£o calculado no simulador. Gere o c√°lculo de entrada antes de gerar o PDF.", left, y, maxW, 5)
    } else {
      y = writeWrap(`Entrada total (Im√≥vel - Financiamento - FGTS): ${moeda(entradaCalc.entradaTotal)}`, left, y, maxW, 5)
      y = writeWrap(`Ato: ${atoTxt}`, left, y, maxW, 5)
      y = writeWrap(`Meses/Parcelas (entrada): ${parcelasTxt}`, left, y, maxW, 5)

      if(entradaCalc.interVals && entradaCalc.interVals.length){
        const totalInter = entradaCalc.interVals.reduce((a,b)=>a+b,0)
        y = writeWrap(`Pagamentos extras (Intermedi√°rias/Anuais/Refor√ßos/Chaves): ${moeda(totalInter)}`, left, y, maxW, 5)
      } else {
        y = writeWrap(`Pagamentos extras: n√£o informados`, left, y, maxW, 5)
      }

      y = writeWrap(`Mensais (${entradaCalc.parcelas}x): ${moeda(entradaCalc.mensal)}`, left, y, maxW, 5)

      if(entradaCalc.saldoRestante && entradaCalc.saldoRestante > 0){
        y = writeWrap(`Saldo restante: ${moeda(entradaCalc.saldoRestante)} (${aceitaPosTxt === "Sim" ? "Construtora aceita P√≥s-Chaves/Pr√≥-Soluto" : "Construtora N√ÉO aceita P√≥s-Chaves/Pr√≥-Soluto"})`, left, y, maxW, 5)
        y = writeWrap(`Saldo restante para verificar parcelamento com a construtora.`, left, y, maxW, 5)
      }

      y += 2
      y = writeWrap("Observa√ß√£o: Considerado limite de 30% da renda familiar para parcelas mensais.", left, y, maxW, 5)
    }

    if(incluirINCC){
      if(y > 250){ doc.addPage(); y = 14 }
      y += 2
      doc.setDrawColor(220)
      doc.line(left, y, right, y)
      y += 6

      doc.setFont("helvetica","bold")
      doc.setFontSize(11)
      doc.text("Estimativa de INCC", left, y)
      y += 6

      doc.setFont("helvetica","normal")
      doc.setFontSize(10)

      const taxa = 0.005
      if(entradaCalc){
        y = writeWrap("Base utilizada: m√©dia mensal estimada de 0,5% (para simula√ß√£o).", left, y, maxW, 5)

        const mesesMensais = Math.max(0, (entradaCalc.parcelas || 0) - 1)
        const projMensal = entradaCalc.mensal * Math.pow(1+taxa, mesesMensais)
        y = writeWrap(`√öltima parcela mensal estimada (com INCC): ${moeda(projMensal)}`, left, y, maxW, 5)

        if(entradaCalc.interMeta && entradaCalc.interMeta.length){
          y = writeWrap("Pagamentos extras estimados (com INCC):", left, y, maxW, 5)
          entradaCalc.interMeta.forEach((it, i) => {
            const proj = it.valorBase * Math.pow(1+taxa, it.mesesAte)
            y = writeWrap(`- ${i+1}¬∫ pagamento (${it.data}): ${moeda(proj)}`, left, y, maxW, 5)
          })
        }
      } else {
        y = writeWrap("Gere o c√°lculo de entrada antes para aplicar a estimativa de INCC no PDF.", left, y, maxW, 5)
      }
    }

    if(incluirTabelaJuros){
      if(y > 240){ doc.addPage(); y = 14 }
      y += 2
      doc.setDrawColor(220)
      doc.line(left, y, right, y)
      y += 6

      doc.setFont("helvetica","bold")
      doc.setFontSize(11)
      doc.text("Juros de Obra ‚Äì Tabela (10% em 10%)", left, y)
      y += 6

      doc.setFont("helvetica","normal")
      doc.setFontSize(10)

      const fin = limparMoeda(document.getElementById("valorFinanciamento")?.value)
      const jurosAnual = parseFloat(document.getElementById("jurosAnual")?.value)||0
      const tr = parseFloat(document.getElementById("tr")?.value)||0.17
      const taxas = limparMoeda(document.getElementById("taxas")?.value) || 65

      y = writeWrap(`Base: TR(%) ${tr} | Taxas/Seguros ${moeda(taxas)} | Juros anual(%) ${jurosAnual || "(n√£o informado)"}`, left, y, maxW, 5)

      if(!fin || !jurosAnual){
        y = writeWrap("Para montar a tabela, preencha o Valor do Financiamento (no cabe√ßalho) e a Taxa de Juros Anual no m√≥dulo de Juros de Obra.", left, y, maxW, 5)
      } else {
        const jurosMensal = (jurosAnual/100)/12
        const trMensal = (tr/100)

        const colsX = [left, left+60]
        doc.setFont("helvetica","bold")
        doc.text("% da Obra", colsX[0], y)
        doc.text("Parcela Estimada", colsX[1], y)
        y += 6
        doc.setFont("helvetica","normal")

        for(let perc=10; perc<=100; perc+=10){
          const liberado = fin * (perc/100)
          const parcela = (liberado*jurosMensal) + (liberado*trMensal) + taxas
          doc.text(`${perc}%`, colsX[0], y)
          doc.text(`${moeda(parcela)}`, colsX[1], y)
          y += 5
          if(y > 280){
            doc.addPage(); y = 14
          }
        }
      }
    }

    if(y > 245){ doc.addPage(); y = 14 }
    y += 2
    doc.setDrawColor(220)
    doc.line(left, y, right, y)
    y += 6

    doc.setFont("helvetica","bold")
    doc.setFontSize(11)
    doc.text("Observa√ß√µes", left, y)
    y += 6

    doc.setFont("helvetica","normal")
    doc.setFontSize(10)
    y = writeWrap(
      "Os valores apresentados neste documento s√£o estimativas para fins de simula√ß√£o. Podem sofrer varia√ß√µes conforme evolu√ß√£o da obra, √≠ndices oficiais (INCC/TR), pol√≠ticas do banco e condi√ß√µes contratuais da construtora. Este material n√£o substitui propostas ou contratos oficiais.",
      left, y, maxW, 5
    )

    doc.save("simulacao-imobiliaria.pdf")
  }

  // ===== init =====
  (function(){
    const a = document.getElementById("limparEntradaBox")
    const j = document.getElementById("limparJurosBox")
    if(a) a.style.display = "none"
    if(j) j.style.display = "none"

    toggleFGTS()

    // Quando renda muda, se j√° tiver regiao + cotista, recalcula faixa/taxa (sem sobrescrever jurosEf se manual)
    // updateMCMV j√° √© chamado no oninput da renda
  })()
</script>

</body>
</html>
