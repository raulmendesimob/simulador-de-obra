<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFH ‚Äî SBPE (Financiamento P√≥s-Obra)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f5;
      color: #222;
    }

    /* ===== TOP FIXO ===== */
    .painel-topo {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px;
    }
    .painel-topo h1 {
      text-align: center;
      color: #1e3a8a;
      margin: 0 0 6px;
      font-size: 22px;
    }
    .painel-topo .sub {
      text-align: center;
      margin: 0 0 16px;
      font-size: 13px;
      color: #444;
      line-height: 1.35;
    }

    .grid-topo {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .grid-topo { grid-template-columns: repeat(2, 1fr); }
    }

    .campo label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .campo input, .campo select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      background: #fff;
    }
    .campo-full { grid-column: 1 / -1; }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    /* ===== BLOCOS ===== */
    .bloco {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #ddd;
      overflow: hidden;
      margin-bottom: 14px;
    }
    .bloco-header {
      color: #fff;
      padding: 14px 16px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-entrada { background: #1e3a8a; }
    .header-pdf     { background: #2563eb; }

    .toggle-icon {
      background: rgba(255,255,255,.18);
      border-radius: 6px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }
    .bloco-conteudo {
      display: none;
      padding: 18px;
    }

    .subgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .subgrid { grid-template-columns: repeat(2, 1fr); }
      .span2 { grid-column: 1 / -1; }
    }

    .divider {
      height: 1px;
      background: #e9e9e9;
      margin: 16px 0;
    }

    /* ===== CAIXAS CLARAS (igual MCMV) ===== */
    .box-claro {
      background: #f6f9f7;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e6efe9;
    }
    .box-claro.azul {
      background: #f2f6fb;
      border-color: #dbe6f7;
    }
    .box-claro.amarelo {
      background: #fffbe8;
      border-color: #f3e7b3;
    }

    /* ===== BOT√ïES ===== */
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-entrada { background: #1e3a8a; }
    .btn-pdf     { background: #2563eb; }
    .btn-limpar  {
      background: #c62828;
      margin-top: 14px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    @media (min-width: 768px) {
      button {
        width: 50%;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
    }

    /* ===== RESULTADOS ===== */
    .resultado {
      display: none;
      padding: 16px;
      border-radius: 12px;
      margin: 12px 0 14px;
      border: 1px solid rgba(0,0,0,.08);
    }
    .resultado.verde   { background: #eaf7ee; border-color: #bfe6c9; }
    .resultado.amarelo { background: #fff7da; border-color: #f0dc8a; }
    .resultado.vermelho{ background: #ffe3e3; border-color: #ffb7b7; }

    .alerta { color: #8b1e1e; font-weight: 900; }

    .obs {
      margin-top: 10px;
      font-style: italic;
      font-size: 13px;
      color: #222;
      line-height: 1.35;
    }

    /* ===== INTERMEDI√ÅRIAS ===== */
    .inter-list { display: flex; flex-direction: column; gap: 10px; }
    .inter-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      background: #fff;
      border: 1px solid #e6efe9;
      padding: 10px;
      border-radius: 10px;
    }
    @media (min-width: 768px) {
      .inter-row { grid-template-columns: 1fr 1fr; }
    }

    /* ===== PDF layout (igual MCMV) ===== */
    .linha-flex {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .linha-flex .campo {
      flex: 1 1 280px;
      margin: 0;
    }
    .helpbox {
      margin-top: 10px;
      font-style: italic;
      font-size: 13px;
      line-height: 1.35;
      color: #222;
    }
  </style>
</head>

<body>

  <!-- =========================
       CABE√áALHO (mesmo padr√£o)
  ========================== -->
  <div class="painel-topo">
    <h1>Simulador Imobili√°rio ‚Äî SFH / SBPE</h1>
    <p class="sub">
      Financiamento contratado <b>ap√≥s a conclus√£o</b> do empreendimento (P√≥s-Obra).<br/>
      A estrutura de entrada segue o mesmo padr√£o do simulador principal.
    </p>

    <div class="grid-topo">
      <div class="campo">
        <label>üè¢ Empreendimento</label>
        <input id="empreendimento" />
      </div>

      <div class="campo">
        <label>üè† Unidade / Bloco / Andar</label>
        <input id="unidade" />
      </div>

      <div class="campo">
        <label>üè† Valor do Im√≥vel (R$)</label>
        <input id="valorImovel" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üè¶ Valor Previsto para Financiamento (R$)</label>
        <input id="valorFinanciamento" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Renda Familiar Mensal (R$)</label>
        <input id="renda" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo campo-full">
        <label>üìÖ Previs√£o de Entrega (m√™s/ano)</label>
        <select id="entregaSelect"></select>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- =========================
         ENTRADA (IGUAL AO MCMV)
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-entrada" onclick="toggleBloco(this)">
        <span>üí∞ Entrada / Fluxo Inicial</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">
        <div class="subgrid">
          <div class="campo">
            <label>üí∏ Valor do Ato (R$)</label>
            <input id="ato" oninput="formatarMoeda(this)" />
          </div>

          <div class="campo">
            <label>üóìÔ∏è Meses / Parcelas</label>
            <input id="parcelasEntrada" type="number" min="1" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro">
          <div class="subgrid">
            <div class="campo span2">
              <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
              <select id="temInter" onchange="toggleInter()">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo span2" id="boxInterQtd" style="display:none;">
              <label>Quantidade</label>
              <input id="qtdInter" type="number" min="1" max="12" value="1" onchange="renderInterRows()" />
            </div>

            <div class="campo span2" id="boxInterRows" style="display:none;">
              <div class="inter-list" id="interList"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro azul">
          <div class="subgrid">
            <div class="campo span2">
              <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
              <select id="aceitaPos">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>
          </div>
        </div>

        <button class="btn-entrada" onclick="calcularEntrada()">Calcular Entrada</button>
      </div>
    </div>

    <!-- RESULTADO ENTRADA (persistente) -->
    <div id="resultadoEntrada" class="resultado"></div>

    <!-- =========================
         PDF (IGUAL AO MCMV, SEM JUROS)
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-pdf" onclick="toggleBloco(this)">
        <span>üìÑ Gerar PDF</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">
        <div class="subgrid">
          <div class="campo">
            <label>üë§ Cliente</label>
            <input id="pdfCliente" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfClienteFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>

          <div class="campo">
            <label>üßë‚Äçüíº Corretor(a)</label>
            <input id="pdfCorretor" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfCorretorFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>

          <!-- FUTURO: INCC SOBRE SALDO DEVEDOR (desativado propositalmente)
          <div class="campo span2">
            <div class="box-claro">
              <label>üìà Incluir estimativa de INCC sobre saldo devedor?</label>
              <select id="pdfINCCSaldo">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
              <div class="helpbox">
                * Corre√ß√£o estimada (ex.: 0,5% a.m) aplicada sobre o saldo a financiar at√© a assinatura.
              </div>
            </div>
          </div>
          -->
        </div>

        <button class="btn-pdf" onclick="gerarPDF()">Gerar PDF da Simula√ß√£o</button>
      </div>
    </div>

  </div>

  <script>
    /* =========================
       UTIL
    ========================== */
    function formatarMoeda(c){
      let v = (c.value || "").replace(/\D/g, "");
      if(!v){ c.value = ""; return; }
      v = (parseInt(v,10) / 100).toFixed(2).replace(".", ",");
      v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      c.value = "R$ " + v;
    }
    function limparMoeda(v){
      return parseFloat((v||"").replace(/[R$\.\s]/g,"").replace(",", ".")) || 0;
    }
    function moeda(n){
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function formatarTelefone(input){
      let v = (input.value||"").replace(/\D/g,"").slice(0,11);
      if(v.length<=2){ input.value=v; return; }
      const ddd=v.slice(0,2);
      const rest=v.slice(2);
      if(rest.length<=4){ input.value=`(${ddd}) ${rest}`; return; }
      if(rest.length<=8){ input.value=`(${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`; return; }
      input.value=`(${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`;
    }

    /* =========================
       MESES/ANO (igual ao MCMV)
    ========================== */
    function gerarMesAno(){
      const h = new Date();
      const arr = [];
      const m = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      for(let i=0;i<48;i++){
        const d = new Date(h.getFullYear(), h.getMonth()+i, 1);
        arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
      }
      return arr;
    }
    (function(){
      const s = document.getElementById("entregaSelect");
      gerarMesAno().forEach(t=>{
        const o=document.createElement("option");
        o.textContent=t;
        s.appendChild(o);
      });
    })();

    /* =========================
       UI
    ========================== */
    function toggleBloco(el){
      const c = el.nextElementSibling;
      const i = el.querySelector(".toggle-icon");
      const aberto = c.style.display === "block";
      c.style.display = aberto ? "none" : "block";
      i.textContent = aberto ? "+" : "‚Äì";
    }

    /* =========================
       INTERMEDI√ÅRIAS (igual ao MCMV)
    ========================== */
    function toggleInter(){
      const tem = document.getElementById("temInter").value;
      document.getElementById("boxInterQtd").style.display = (tem==="sim") ? "block" : "none";
      document.getElementById("boxInterRows").style.display = (tem==="sim") ? "block" : "none";
      if(tem==="sim"){ renderInterRows(); }
      else {
        document.getElementById("interList").innerHTML = "";
        document.getElementById("qtdInter").value = 1;
      }
    }

    function renderInterRows(){
      const q = parseInt(document.getElementById("qtdInter").value,10) || 0;
      const interList = document.getElementById("interList");
      interList.innerHTML = "";
      if(q<=0) return;

      const meses = gerarMesAno();
      for(let i=1;i<=q;i++){
        const r=document.createElement("div");
        r.className="inter-row";
        r.innerHTML=`
          <div>
            <label>${i}¬∫ pagamento</label>
            <select>${meses.map(mm=>`<option>${mm}</option>`).join("")}</select>
          </div>
          <div>
            <label>Valor (R$) <span style="opacity:.7;font-weight:600;">(obrigat√≥rio)</span></label>
            <input oninput="formatarMoeda(this)">
          </div>
        `;
        interList.appendChild(r);
      }
    }

    /* =========================
       ENTRADA (copiado do MCMV)
    ========================== */
    function setResultadoEntrada(tipo, html){
      const out = document.getElementById("resultadoEntrada");
      out.className = "resultado " + tipo;
      out.innerHTML = html;
      out.style.display = "block";
    }

    function calcularEntrada(){
      const im = limparMoeda(document.getElementById("valorImovel").value);
      const fi = limparMoeda(document.getElementById("valorFinanciamento").value);

      const at = limparMoeda(document.getElementById("ato").value);
      const re = limparMoeda(document.getElementById("renda").value);
      const p  = parseInt(document.getElementById("parcelasEntrada").value,10) || 0;

      if(!im || !fi || !re || !p){
        setResultadoEntrada("vermelho",
          `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
           <p class="alerta">Preencha: Valor do Im√≥vel, Valor Previsto para Financiamento, Renda e Meses/Parcelas.</p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const entrada = im - fi;
      const temInter = document.getElementById("temInter").value === "sim";
      const interVals = [];
      const interMeta = [];

      if(temInter){
        const rows = document.querySelectorAll("#interList .inter-row");
        if(!rows.length){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Voc√™ marcou pagamentos extras, mas n√£o informou a quantidade.</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }

        let faltando=false;
        rows.forEach((row)=>{
          const sel=row.querySelector("select");
          const inp=row.querySelector("input");
          const data=sel ? sel.value : "-";
          const mesesAte=sel ? sel.selectedIndex : 0;
          const v=limparMoeda(inp ? inp.value : "");
          if(!v || v<=0) faltando=true;
          interVals.push(v);
          interMeta.push({ data, mesesAte, valorBase:v });
        });

        if(faltando){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Preencha o valor de todos os pagamentos extras (campo obrigat√≥rio).</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }
      }

      const somaInter = interVals.reduce((a,b)=>a+b,0);
      let saldo = entrada - at - somaInter;

      const entregaTxt = document.getElementById("entregaSelect").value;

      // Se ato + extras cobrem tudo
      if(saldo <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal: 0,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        const interHtml = (temInter && somaInter>0)
          ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
          : ``;

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada</h3>
           <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
           <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
           <div class="divider"></div>
           <p>Ato: <b>${moeda(at)}</b></p>
           ${interHtml}
           <p>Mensais (${p}x): <b>${moeda(0)}</b></p>
           <div class="obs">* Estrutura para financiamento <b>p√≥s-obra</b> (SBPE).</div>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      // Mensais limitadas a 30%
      const limiteMensal = re * 0.30;
      let mensal = saldo / p;
      let resto = 0;

      if(mensal > limiteMensal){
        mensal = limiteMensal;
        resto = saldo - (mensal * p);
      }

      const interHtml = (temInter && somaInter>0)
        ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
        : ``;

      const baseHTML = `
        <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
        <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
        <div class="divider"></div>
        <p>Ato: <b>${moeda(at)}</b></p>
        ${interHtml}
        <p>Mensais (${p}x): <b>${moeda(mensal)}</b></p>
        <div class="obs"><i>* Considerado limite de 30% da renda familiar para parcelas mensais.</i></div>
        <div class="obs"><i>* Estrutura para financiamento <b>p√≥s-obra</b> (SBPE).</i></div>
      `;

      // Verde: dentro do limite e sem resto
      if(resto <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada</h3>
           ${baseHTML}
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const aceitaPos = document.getElementById("aceitaPos").value === "sim";

      // Amarelo: com saldo restante e construtora aceita
      if(aceitaPos){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: resto, status: "amarelo"
        };

        setResultadoEntrada("amarelo",
          `<h3>‚ö†Ô∏è Entrada com saldo restante</h3>
           ${baseHTML}
           <div class="divider"></div>
           <p><b>Saldo restante:</b> ${moeda(resto)}</p>
           <p><b>Saldo restante a ser financiado no p√≥s-obra (SBPE).</b></p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      // Vermelho: saldo restante e construtora n√£o aceita
      window.__lastEntradaCalc = {
        entradaTotal: entrada, ato: at, parcelas: p, mensal,
        interVals, interMeta, saldoRestante: resto, status: "vermelho"
      };

      setResultadoEntrada("vermelho",
        `<h3>Verificar saldo restante p√≥s per√≠odo</h3>
         ${baseHTML}
         <div class="divider"></div>
         <p><b>Saldo restante:</b> ${moeda(resto)}</p>
         <p class="alerta"><b>Valor de entrada ultrapassa os limites de parcelamento dentro do per√≠odo informado.</b></p>
         <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
      );
    }

    function limparEntrada(){
      const out=document.getElementById("resultadoEntrada");
      out.style.display="none";
      out.innerHTML="";
      out.className="resultado";
      window.__lastEntradaCalc=null;
    }

    /* =========================
       PDF (mesma estrutura do MCMV, sem juros)
    ========================== */
    function writeWrap(doc, text, x, y, maxW, lineH){
      const lines = doc.splitTextToSize(text, maxW);
      doc.text(lines, x, y);
      return y + (lines.length * lineH);
    }

    async function gerarPDF(){
      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("Biblioteca do PDF n√£o carregou.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });

      const dataDoc = new Date().toLocaleDateString("pt-BR");

      const empreendimento = (document.getElementById("empreendimento").value || "").trim() || "-";
      const unidade = (document.getElementById("unidade").value || "").trim() || "-";
      const valorImovelTxt = document.getElementById("valorImovel").value || "-";
      const valorFinTxt = document.getElementById("valorFinanciamento").value || "-";
      const rendaTxt = document.getElementById("renda").value || "R$ 0,00";
      const entregaTxt = document.getElementById("entregaSelect").value || "-";

      const pdfCliente = (document.getElementById("pdfCliente").value || "").trim() || "-";
      const pdfClienteFone = (document.getElementById("pdfClienteFone").value || "").trim() || "-";
      const pdfCorretor = (document.getElementById("pdfCorretor").value || "").trim() || "-";
      const pdfCorretorFone = (document.getElementById("pdfCorretorFone").value || "").trim() || "-";

      const atoTxt = document.getElementById("ato").value || "R$ 0,00";
      const parcelasTxt = document.getElementById("parcelasEntrada").value || "-";
      const aceitaPosTxt = (document.getElementById("aceitaPos").value === "sim") ? "Sim" : "N√£o";

      let y = 14;
      const left = 14;
      const right = 196;
      const maxW = right - left;

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text("SIMULA√á√ÉO FINANCEIRA ‚Äì SBPE (P√ìS-OBRA)", 105, y, { align:"center" });
      y += 7;

      doc.setDrawColor(200);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Identifica√ß√£o", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      y = writeWrap(doc, `Cliente: ${pdfCliente} | Tel: ${pdfClienteFone}`, left, y, maxW, 5);
      y = writeWrap(doc, `Corretor(a): ${pdfCorretor} | Tel: ${pdfCorretorFone}`, left, y, maxW, 5);
      y = writeWrap(doc, `Empreendimento: ${empreendimento}`, left, y, maxW, 5);
      y = writeWrap(doc, `Unidade/Bloco/Andar: ${unidade}`, left, y, maxW, 5);
      y = writeWrap(doc, `Data do documento: ${dataDoc}`, left, y, maxW, 5);

      y += 2;
      doc.setDrawColor(220);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Resumo Financeiro", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      y = writeWrap(doc, `Valor do im√≥vel: ${valorImovelTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Valor previsto para financiamento (p√≥s-obra): ${valorFinTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Renda familiar: ${rendaTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Previs√£o de entrega: ${entregaTxt}`, left, y, maxW, 5);

      y += 2;
      doc.setDrawColor(220);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Fluxo de Pagamento ‚Äì Entrada", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      const entradaCalc = window.__lastEntradaCalc;
      if(!entradaCalc){
        y = writeWrap(doc, "Fluxo n√£o calculado no simulador. Gere o c√°lculo de entrada antes de gerar o PDF.", left, y, maxW, 5);
      } else {
        y = writeWrap(doc, `Entrada Total: ${moeda(entradaCalc.entradaTotal)}`, left, y, maxW, 5);
        y = writeWrap(doc, `Ato: ${atoTxt}`, left, y, maxW, 5);
        y = writeWrap(doc, `Meses/Parcelas (entrada): ${parcelasTxt}`, left, y, maxW, 5);

        if(entradaCalc.interVals && entradaCalc.interVals.length){
          const totalInter = entradaCalc.interVals.reduce((a,b)=>a+b,0);
          y = writeWrap(doc, `Pagamentos extras: ${moeda(totalInter)}`, left, y, maxW, 5);
        }

        y = writeWrap(doc, `Mensais (${entradaCalc.parcelas}x): ${moeda(entradaCalc.mensal)}`, left, y, maxW, 5);

        if(entradaCalc.saldoRestante && entradaCalc.saldoRestante > 0){
          y = writeWrap(doc, `Saldo restante: ${moeda(entradaCalc.saldoRestante)} (P√≥s-Chaves/Pr√≥-Soluto: ${aceitaPosTxt})`, left, y, maxW, 5);
          y = writeWrap(doc, `Saldo restante previsto para financiamento p√≥s-obra (SBPE).`, left, y, maxW, 5);
        }

        y = writeWrap(doc, "Observa√ß√£o: Considerado limite de 30% da renda familiar para parcelas mensais.", left, y, maxW, 5);
        y = writeWrap(doc, "Observa√ß√£o: Simula√ß√£o voltada para financiamento contratado ap√≥s a conclus√£o do empreendimento (SBPE p√≥s-obra).", left, y, maxW, 5);
      }

      doc.save("simulacao-sbpe-pos-obra.pdf");
    }

    /* =========================
       INIT
    ========================== */
    (function(){
      toggleInter(); // garante estado inicial correto
    })();
  </script>
</body>
</html>
