<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFH ‚Äî SBPE (Financiamento P√≥s-Obra)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f5;
      color: #222;
    }

    /* ===== TOP FIXO ===== */
    .painel-topo {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px;
    }
    .painel-topo h1 {
      text-align: center;
      color: #1e3a8a;
      margin: 0 0 6px;
      font-size: 22px;
    }
    .painel-topo .sub {
      text-align: center;
      margin: 0 0 16px;
      font-size: 13px;
      color: #444;
      line-height: 1.35;
    }

    .grid-topo {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .grid-topo { grid-template-columns: repeat(2, 1fr); }
    }

    .campo label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .campo input, .campo select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      background: #fff;
    }
    .campo-full { grid-column: 1 / -1; }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    /* ===== BLOCOS ===== */
    .bloco {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #ddd;
      overflow: hidden;
      margin-bottom: 14px;
    }
    .bloco-header {
      color: #fff;
      padding: 14px 16px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-entrada { background: #1e3a8a; }
    .header-pdf     { background: #2563eb; }

    .toggle-icon {
      background: rgba(255,255,255,.18);
      border-radius: 6px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }
    .bloco-conteudo {
      display: none;
      padding: 18px;
    }

    .subgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .subgrid { grid-template-columns: repeat(2, 1fr); }
      .span2 { grid-column: 1 / -1; }
    }

    .divider {
      height: 1px;
      background: #e9e9e9;
      margin: 16px 0;
    }

    /* ===== CAIXAS CLARAS ===== */
    .box-claro {
      background: #f6f9f7;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e6efe9;
    }
    .box-claro.azul {
      background: #f2f6fb;
      border-color: #dbe6f7;
    }
    .box-claro.amarelo {
      background: #fffbe8;
      border-color: #f3e7b3;
    }

    /* ===== BOT√ïES ===== */
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-entrada { background: #1e3a8a; }
    .btn-pdf     { background: #2563eb; }
    .btn-limpar  {
      background: #c62828;
      margin-top: 14px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    @media (min-width: 768px) {
      button {
        width: 50%;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
    }

    /* ===== RESULTADOS ===== */
    .resultado {
      display: none;
      padding: 16px;
      border-radius: 12px;
      margin: 12px 0 14px;
      border: 1px solid rgba(0,0,0,.08);
    }
    .resultado.verde   { background: #eaf7ee; border-color: #bfe6c9; }
    .resultado.amarelo { background: #fff7da; border-color: #f0dc8a; }
    .resultado.vermelho{ background: #ffe3e3; border-color: #ffb7b7; }

    .alerta { color: #8b1e1e; font-weight: 900; }

    .obs {
      margin-top: 10px;
      font-style: italic;
      font-size: 13px;
      color: #222;
      line-height: 1.35;
    }

    /* ===== INTERMEDI√ÅRIAS ===== */
    .inter-list { display: flex; flex-direction: column; gap: 10px; }
    .inter-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      background: #fff;
      border: 1px solid #e6efe9;
      padding: 10px;
      border-radius: 10px;
    }
    @media (min-width: 768px) {
      .inter-row { grid-template-columns: 1fr 1fr; }
    }

    /* ===== INCC UI ===== */
    .incc-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: end;
    }
    @media (min-width: 768px) {
      .incc-row { grid-template-columns: 1fr 1fr; }
    }
    .incc-inline {
      display: none;
    }
    .link-peq {
      font-size: 12px;
      color: #1e40af;
      margin-top: 8px;
      word-break: break-word;
    }
    .link-peq a { color: #1e40af; text-decoration: underline; }
  </style>
</head>

<body>

  <!-- =========================
       CABE√áALHO
  ========================== -->
  <div class="painel-topo">
    <h1>Simulador Imobili√°rio ‚Äî SFH / SBPE</h1>
    <p class="sub">
      Financiamento contratado <b>ap√≥s a conclus√£o</b> do empreendimento (P√≥s-Obra).<br/>
      A estrutura de entrada segue o mesmo padr√£o do simulador principal.
    </p>

    <div class="grid-topo">
      <div class="campo">
        <label>üè¢ Empreendimento</label>
        <input id="empreendimento" />
      </div>

      <div class="campo">
        <label>üè† Unidade / Bloco / Andar</label>
        <input id="unidade" />
      </div>

      <div class="campo">
        <label>üè† Valor do Im√≥vel (R$)</label>
        <input id="valorImovel" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üè¶ Valor Previsto para Financiamento (R$)</label>
        <input id="valorFinanciamento" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Renda Familiar Mensal (R$)</label>
        <input id="renda" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo campo-full">
        <label>üìÖ Previs√£o de Entrega (m√™s/ano)</label>
        <select id="entregaSelect"></select>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- =========================
         ENTRADA
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-entrada" onclick="toggleBloco(this)">
        <span>üí∞ Entrada / Fluxo Inicial</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">
        <div class="subgrid">
          <div class="campo">
            <label>üí∏ Valor do Ato (R$)</label>
            <input id="ato" oninput="formatarMoeda(this)" />
          </div>

          <div class="campo">
            <label>üóìÔ∏è Meses / Parcelas</label>
            <input id="parcelasEntrada" type="number" min="1" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro">
          <div class="subgrid">
            <div class="campo span2">
              <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
              <select id="temInter" onchange="toggleInter()">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo span2" id="boxInterQtd" style="display:none;">
              <label>Quantidade</label>
              <input id="qtdInter" type="number" min="1" max="12" value="1" onchange="renderInterRows()" />
            </div>

            <div class="campo span2" id="boxInterRows" style="display:none;">
              <div class="inter-list" id="interList"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro azul">
          <div class="subgrid">
            <div class="campo span2">
              <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
              <select id="aceitaPos">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>
          </div>
        </div>

        <button class="btn-entrada" onclick="calcularEntrada()">Calcular Entrada</button>
      </div>
    </div>

    <!-- RESULTADO ENTRADA -->
    <div id="resultadoEntrada" class="resultado"></div>

    <!-- =========================
         PDF (com escolhas de INCC)
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-pdf" onclick="toggleBloco(this)">
        <span>üìÑ Gerar PDF</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">

        <div class="subgrid">
          <div class="campo">
            <label>üë§ Cliente</label>
            <input id="pdfCliente" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfClienteFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>

          <div class="campo">
            <label>üßë‚Äçüíº Corretor(a)</label>
            <input id="pdfCorretor" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfCorretorFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>
        </div>

        <div class="divider"></div>

        <!-- INCC: escolha principal + taxa na mesma linha -->
        <div class="box-claro">
          <div class="incc-row">
            <div class="campo">
              <label>üìà Deseja incluir estimativa do INCC?</label>
              <select id="pdfINCCIncluir" onchange="toggleINCC()">
                <option value="nao" selected>N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo incc-inline" id="boxINCCtaxa">
              <label>üìå INCC (m√©dia mensal) %</label>
              <input id="pdfINCCtaxa" value="0,5" inputmode="decimal" />
              <div class="link-peq">
                üìå INCC atualizado dispon√≠vel em:
                <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank" rel="noopener">portal.fgv.br/noticias/incc-m-2025</a>
              </div>
            </div>
          </div>

          <div class="divider" id="divINCCsub" style="display:none;"></div>

          <div class="subgrid" id="boxINCCsub" style="display:none;">
            <div class="campo">
              <label>Incluir na Entrada?</label>
              <select id="pdfINCCEntrada">
                <option value="nao" selected>N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo">
              <label>Incluir no Saldo Devedor (Financiamento)?</label>
              <select id="pdfINCCSaldo">
                <option value="nao" selected>N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo span2">
              <div class="obs">
                * O INCC √© uma <b>estimativa m√©dia</b> e pode variar mensalmente. Os valores s√£o educativos.
              </div>
            </div>
          </div>
        </div>

        <button class="btn-pdf" onclick="gerarPDF()">Gerar PDF da Simula√ß√£o</button>
      </div>
    </div>

  </div>

  <script>
    /* =========================
       UTIL
    ========================== */
    function formatarMoeda(c){
      let v = (c.value || "").replace(/\D/g, "");
      if(!v){ c.value = ""; return; }
      v = (parseInt(v,10) / 100).toFixed(2).replace(".", ",");
      v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      c.value = "R$ " + v;
    }
    function limparMoeda(v){
      return parseFloat((v||"").replace(/[R$\.\s]/g,"").replace(",", ".")) || 0;
    }
    function moeda(n){
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function formatarTelefone(input){
      let v = (input.value||"").replace(/\D/g,"").slice(0,11);
      if(v.length<=2){ input.value=v; return; }
      const ddd=v.slice(0,2);
      const rest=v.slice(2);
      if(rest.length<=4){ input.value=`(${ddd}) ${rest}`; return; }
      if(rest.length<=8){ input.value=`(${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`; return; }
      input.value=`(${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`;
    }
    function parsePercentToMonthlyRate(){
      const raw = (document.getElementById("pdfINCCtaxa").value || "0").trim()
        .replace("%","").replace(/\s+/g,"").replace(",", ".");
      const p = parseFloat(raw);
      if(!isFinite(p) || p < 0) return 0;
      return p / 100; // 0,5 -> 0.005
    }

    /* =========================
       MESES/ANO
    ========================== */
    function gerarMesAno(){
      const h = new Date();
      const arr = [];
      const m = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      for(let i=0;i<48;i++){
        const d = new Date(h.getFullYear(), h.getMonth()+i, 1);
        arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
      }
      return arr;
    }
    (function(){
      const s = document.getElementById("entregaSelect");
      gerarMesAno().forEach(t=>{
        const o=document.createElement("option");
        o.textContent=t;
        s.appendChild(o);
      });
    })();

    /* =========================
       UI
    ========================== */
    function toggleBloco(el){
      const c = el.nextElementSibling;
      const i = el.querySelector(".toggle-icon");
      const aberto = c.style.display === "block";
      c.style.display = aberto ? "none" : "block";
      i.textContent = aberto ? "+" : "‚Äì";
    }

    /* =========================
       INCC UI (antes do PDF)
    ========================== */
    function toggleINCC(){
      const incluir = document.getElementById("pdfINCCIncluir").value === "sim";
      document.getElementById("boxINCCtaxa").style.display = incluir ? "block" : "none";
      document.getElementById("divINCCsub").style.display = incluir ? "block" : "none";
      document.getElementById("boxINCCsub").style.display = incluir ? "grid" : "none";

      if(!incluir){
        document.getElementById("pdfINCCtaxa").value = "0,5";
        document.getElementById("pdfINCCEntrada").value = "nao";
        document.getElementById("pdfINCCSaldo").value = "nao";
      }
    }

    /* =========================
       INTERMEDI√ÅRIAS
    ========================== */
    function toggleInter(){
      const tem = document.getElementById("temInter").value;
      document.getElementById("boxInterQtd").style.display = (tem==="sim") ? "block" : "none";
      document.getElementById("boxInterRows").style.display = (tem==="sim") ? "block" : "none";
      if(tem==="sim"){ renderInterRows(); }
      else {
        document.getElementById("interList").innerHTML = "";
        document.getElementById("qtdInter").value = 1;
      }
    }

    function renderInterRows(){
      const q = parseInt(document.getElementById("qtdInter").value,10) || 0;
      const interList = document.getElementById("interList");
      interList.innerHTML = "";
      if(q<=0) return;

      const meses = gerarMesAno();
      for(let i=1;i<=q;i++){
        const r=document.createElement("div");
        r.className="inter-row";
        r.innerHTML=`
          <div>
            <label>${i}¬∫ pagamento</label>
            <select>${meses.map(mm=>`<option>${mm}</option>`).join("")}</select>
          </div>
          <div>
            <label>Valor (R$) <span style="opacity:.7;font-weight:600;">(obrigat√≥rio)</span></label>
            <input oninput="formatarMoeda(this)">
          </div>
        `;
        interList.appendChild(r);
      }
    }

    /* =========================
       ENTRADA
    ========================== */
    function setResultadoEntrada(tipo, html){
      const out = document.getElementById("resultadoEntrada");
      out.className = "resultado " + tipo;
      out.innerHTML = html;
      out.style.display = "block";
    }

    function calcularEntrada(){
      const im = limparMoeda(document.getElementById("valorImovel").value);
      const fi = limparMoeda(document.getElementById("valorFinanciamento").value);
      const at = limparMoeda(document.getElementById("ato").value);
      const re = limparMoeda(document.getElementById("renda").value);
      const p  = parseInt(document.getElementById("parcelasEntrada").value,10) || 0;

      if(!im || !fi || !re || !p){
        setResultadoEntrada("vermelho",
          `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
           <p class="alerta">Preencha: Valor do Im√≥vel, Valor Previsto para Financiamento, Renda e Meses/Parcelas.</p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const entrada = im - fi;
      const temInter = document.getElementById("temInter").value === "sim";
      const interVals = [];
      const interMeta = [];

      if(temInter){
        const rows = document.querySelectorAll("#interList .inter-row");
        if(!rows.length){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Voc√™ marcou pagamentos extras, mas n√£o informou a quantidade.</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }

        let faltando=false;
        rows.forEach((row)=>{
          const sel=row.querySelector("select");
          const inp=row.querySelector("input");
          const data=sel ? sel.value : "-";
          const mesesAte=sel ? sel.selectedIndex : 0; // 0 = m√™s atual da lista
          const v=limparMoeda(inp ? inp.value : "");
          if(!v || v<=0) faltando=true;
          interVals.push(v);
          interMeta.push({ data, mesesAte, valorBase:v });
        });

        if(faltando){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Preencha o valor de todos os pagamentos extras (campo obrigat√≥rio).</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }
      }

      const somaInter = interVals.reduce((a,b)=>a+b,0);
      let saldo = entrada - at - somaInter;
      const entregaTxt = document.getElementById("entregaSelect").value;

      // Ato + extras cobrem tudo
      if(saldo <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal: 0,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        const interHtml = (temInter && somaInter>0)
          ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
          : ``;

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada</h3>
           <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
           <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
           <div class="divider"></div>
           <p>Ato: <b>${moeda(at)}</b></p>
           ${interHtml}
           <p>Mensais (${p}x): <b>${moeda(0)}</b></p>
           <div class="obs">* Estrutura para financiamento <b>p√≥s-obra</b> (SBPE).</div>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const limiteMensal = re * 0.30;
      let mensal = saldo / p;
      let resto = 0;

      if(mensal > limiteMensal){
        mensal = limiteMensal;
        resto = saldo - (mensal * p);
      }

      const interHtml = (temInter && somaInter>0)
        ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
        : ``;

      const baseHTML = `
        <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
        <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
        <div class="divider"></div>
        <p>Ato: <b>${moeda(at)}</b></p>
        ${interHtml}
        <p>Mensais (${p}x): <b>${moeda(mensal)}</b></p>
        <div class="obs"><i>* Considerado limite de 30% da renda familiar para parcelas mensais.</i></div>
        <div class="obs"><i>* Estrutura para financiamento <b>p√≥s-obra</b> (SBPE).</i></div>
      `;

      if(resto <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada</h3>
           ${baseHTML}
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const aceitaPos = document.getElementById("aceitaPos").value === "sim";

      if(aceitaPos){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: resto, status: "amarelo"
        };

        setResultadoEntrada("amarelo",
          `<h3>‚ö†Ô∏è Entrada com saldo restante</h3>
           ${baseHTML}
           <div class="divider"></div>
           <p><b>Saldo restante:</b> ${moeda(resto)}</p>
           <p><b>Saldo restante a ser financiado no p√≥s-obra (SBPE).</b></p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      window.__lastEntradaCalc = {
        entradaTotal: entrada, ato: at, parcelas: p, mensal,
        interVals, interMeta, saldoRestante: resto, status: "vermelho"
      };

      setResultadoEntrada("vermelho",
        `<h3>Verificar saldo restante p√≥s per√≠odo</h3>
         ${baseHTML}
         <div class="divider"></div>
         <p><b>Saldo restante:</b> ${moeda(resto)}</p>
         <p class="alerta"><b>Valor de entrada ultrapassa os limites de parcelamento dentro do per√≠odo informado.</b></p>
         <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
      );
    }

    function limparEntrada(){
      const out=document.getElementById("resultadoEntrada");
      out.style.display="none";
      out.innerHTML="";
      out.className="resultado";
      window.__lastEntradaCalc=null;
    }

    /* =========================
       INCC: C√ÅLCULOS ESTIMADOS
    ========================== */
    function monthsToEntrega(){
      // entregaSelect lista a partir do m√™s atual
      const idx = document.getElementById("entregaSelect").selectedIndex;
      return Math.max(0, idx);
    }

    function calcGeometricSum(base, rate, n){
      // base * (1 + (1+r) + ... + (1+r)^(n-1))
      if(n <= 0) return 0;
      if(rate === 0) return base * n;
      return base * ((Math.pow(1+rate, n) - 1) / rate);
    }

    function calcINCCEntradaEstimado(entradaObj, rate){
      // Mensais: s√©rie geom√©trica sobre "mensal"
      const p = entradaObj.parcelas || 0;
      const mensal = entradaObj.mensal || 0;

      const totalMensaisCorrig = calcGeometricSum(mensal, rate, p);

      // Intermedi√°rias: cada uma corrigida por (1+rate)^(mesesAte)
      let totalInterBase = 0;
      let totalInterCorrig = 0;

      if(entradaObj.interMeta && entradaObj.interMeta.length){
        entradaObj.interMeta.forEach(it=>{
          const v = it.valorBase || 0;
          const m = Math.max(0, it.mesesAte || 0);
          totalInterBase += v;
          totalInterCorrig += v * Math.pow(1+rate, m);
        });
      }

      return {
        mensalBaseTotal: (mensal * p),
        mensalCorrigTotal: totalMensaisCorrig,
        interBaseTotal: totalInterBase,
        interCorrigTotal: totalInterCorrig,
        entradaCorrigTotal: (entradaObj.ato || 0) + totalMensaisCorrig + totalInterCorrig
      };
    }

    function calcINCCSaldoDevedor(financiamentoValor, rate, meses){
      // juros compostos: FV = PV*(1+rate)^meses
      const pv = financiamentoValor || 0;
      const m = Math.max(0, meses || 0);
      return pv * Math.pow(1+rate, m);
    }

    /* =========================
       PDF (layout alinhado + INCC opcional)
    ========================== */
    async function gerarPDF(){
      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("Biblioteca do PDF n√£o carregou.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      // Layout fixo (anti-torto)
      const left = 14;
      const right = 196;
      const pageW = right - left;
      const colA = left + 6;
      const colB = left + 98;
      const line = 6;

      let y = 10;

      const azul = [30, 58, 138];
      const cinza = [240, 242, 245];
      const amarelo = [255, 249, 196];

      const hoje = new Date().toLocaleDateString("pt-BR");

      const entrada = window.__lastEntradaCalc || null;

      // DADOS
      const empreendimentoTxt = (document.getElementById("empreendimento").value || "-").trim() || "-";
      const unidadeTxt = (document.getElementById("unidade").value || "-").trim() || "-";
      const valorImovelTxt = document.getElementById("valorImovel").value || "-";
      const valorFinTxt = document.getElementById("valorFinanciamento").value || "-";
      const rendaTxt = document.getElementById("renda").value || "-";
      const entregaTxt = document.getElementById("entregaSelect").value || "-";

      const pdfCliente = (document.getElementById("pdfCliente").value || "-").trim() || "-";
      const pdfClienteFone = (document.getElementById("pdfClienteFone").value || "-").trim() || "-";
      const pdfCorretor = (document.getElementById("pdfCorretor").value || "-").trim() || "-";
      const pdfCorretorFone = (document.getElementById("pdfCorretorFone").value || "-").trim() || "-";

      const atoTxt = document.getElementById("ato").value || "R$ 0,00";
      const parcelasTxt = document.getElementById("parcelasEntrada").value || "-";

      // INCC escolhas
      const incluirINCC = document.getElementById("pdfINCCIncluir").value === "sim";
      const inccRate = incluirINCC ? parsePercentToMonthlyRate() : 0;
      const inccEntrada = incluirINCC && (document.getElementById("pdfINCCEntrada").value === "sim");
      const inccSaldo = incluirINCC && (document.getElementById("pdfINCCSaldo").value === "sim");

      // Valores num√©ricos
      const financiamentoNum = limparMoeda(document.getElementById("valorFinanciamento").value);

      /* =========================
         CABE√áALHO
      ========================== */
      doc.setFillColor(...azul);
      doc.rect(0, 0, 210, 26, "F");

      doc.setTextColor(255,255,255);
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("SIMULA√á√ÉO FINANCEIRA ‚Äì SBPE", 105, 14, { align: "center" });

      doc.setFontSize(10);
      doc.setFont("helvetica","normal");
      doc.text("Financiamento Pr√≥prio P√≥s-Obra", 105, 20, { align: "center" });

      y = 34;
      doc.setTextColor(0,0,0);

      function card(titulo, altura){
        doc.setFillColor(...cinza);
        doc.setDrawColor(220);
        doc.roundedRect(left, y, pageW, altura, 4, 4, "F");

        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text(titulo, left + 4, y + 7);

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
      }

      /* =========================
         IDENTIFICA√á√ÉO
      ========================== */
      card("Identifica√ß√£o", 36);
      let ty = y + 14;

      doc.setFont("helvetica","bold");
      doc.text("Cliente:", colA, ty);
      doc.setFont("helvetica","normal");
      doc.text(pdfCliente, colA + 26, ty);

      doc.setFont("helvetica","bold");
      doc.text("Telefone:", colB, ty);
      doc.setFont("helvetica","normal");
      doc.text(pdfClienteFone, colB + 28, ty);

      ty += line;
      doc.setFont("helvetica","bold");
      doc.text("Corretor(a):", colA, ty);
      doc.setFont("helvetica","normal");
      doc.text(pdfCorretor, colA + 26, ty);

      doc.setFont("helvetica","bold");
      doc.text("Telefone:", colB, ty);
      doc.setFont("helvetica","normal");
      doc.text(pdfCorretorFone, colB + 28, ty);

      ty += line;
      doc.setFont("helvetica","bold");
      doc.text("Empreendimento:", colA, ty);
      doc.setFont("helvetica","normal");
      doc.text(empreendimentoTxt, colA + 36, ty);

      ty += line;
      doc.setFont("helvetica","bold");
      doc.text("Unidade:", colA, ty);
      doc.setFont("helvetica","normal");
      doc.text(unidadeTxt, colA + 26, ty);

      doc.setFont("helvetica","bold");
      doc.text("Data:", colB, ty);
      doc.setFont("helvetica","normal");
      doc.text(hoje, colB + 18, ty);

      y += 44;

      /* =========================
         RESUMO FINANCEIRO
      ========================== */
      card("Resumo Financeiro", 36);
      ty = y + 14;

      doc.setFont("helvetica","bold");
      doc.text("Valor do im√≥vel:", colA, ty);
      doc.text(valorImovelTxt, colB, ty);

      ty += line;
      doc.text("Entrada total:", colA, ty);
      doc.text(entrada ? moeda(entrada.entradaTotal) : "-", colB, ty);

      ty += line;
      doc.text("Valor previsto p/ financiamento:", colA, ty);
      doc.text(valorFinTxt, colB, ty);

      ty += line;
      doc.text("Renda familiar:", colA, ty);
      doc.text(rendaTxt, colB, ty);

      ty += line;
      doc.text("Previs√£o de entrega:", colA, ty);
      doc.text(entregaTxt, colB, ty);

      y += 44;

      /* =========================
         FLUXO DE PAGAMENTO
      ========================== */
      card("Fluxo de Pagamento ‚Äì Entrada", 40);
      ty = y + 14;

      doc.setFont("helvetica","bold");
      doc.text("Ato:", colA, ty);
      doc.setFont("helvetica","normal");
      doc.text(atoTxt, colB, ty);

      if(entrada){
        ty += line;
        doc.setFont("helvetica","bold");
        doc.text(`Mensais (${entrada.parcelas}x):`, colA, ty);
        doc.setFont("helvetica","normal");
        doc.text(moeda(entrada.mensal), colB, ty);

        if(entrada.interVals && entrada.interVals.length){
          const totalInter = entrada.interVals.reduce((a,b)=>a+b,0);
          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Pagamentos extras:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(moeda(totalInter), colB, ty);
        }

        if(entrada.saldoRestante > 0){
          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Saldo restante:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(moeda(entrada.saldoRestante), colB, ty);
        }
      }

      ty += line;
      doc.setFontSize(9);
      doc.setFont("helvetica","normal");
      doc.text("* Considerado limite de 30% da renda familiar para parcelas mensais.", colA, ty);

      y += 50;

      /* =========================
         INCC (SELE√á√ïES)
      ========================== */
      if(incluirINCC && (inccEntrada || inccSaldo)){
        // altura din√¢mica simples (1 p√°gina)
        card("Estimativa de INCC (opcional)", inccSaldo && inccEntrada ? 44 : 36);
        ty = y + 14;

        const taxaPctTxt = (document.getElementById("pdfINCCtaxa").value || "0").trim() + "%";
        doc.setFont("helvetica","bold");
        doc.setFontSize(10);
        doc.text("Taxa considerada:", colA, ty);
        doc.setFont("helvetica","normal");
        doc.text(taxaPctTxt + " a.m", colB, ty);

        ty += line;

        doc.setFontSize(10);
        if(inccEntrada && entrada){
          const est = calcINCCEntradaEstimado(entrada, inccRate);

          doc.setFont("helvetica","bold");
          doc.text("INCC na Entrada:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text("Sim", colB, ty);

          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Mensais (total):", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(moeda(est.mensalCorrigTotal), colB, ty);

          if(entrada.interMeta && entrada.interMeta.length){
            ty += line;
            doc.setFont("helvetica","bold");
            doc.text("Extras (total):", colA, ty);
            doc.setFont("helvetica","normal");
            doc.text(moeda(est.interCorrigTotal), colB, ty);
          }

          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Entrada estimada corrigida:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(moeda(est.entradaCorrigTotal), colB, ty);

          ty += line;
          doc.setFontSize(9);
          doc.setFont("helvetica","normal");
          doc.text("* Estimativa aplicada sobre mensais e intermedi√°rias.", colA, ty);
          doc.setFontSize(10);

          ty += line;
        } else {
          // Se escolheu INCC entrada mas n√£o calculou entrada
          if(inccEntrada && !entrada){
            doc.setFont("helvetica","bold");
            doc.text("INCC na Entrada:", colA, ty);
            doc.setFont("helvetica","normal");
            doc.text("Sim (fluxo n√£o calculado)", colB, ty);
            ty += line;
          }
        }

        if(inccSaldo){
          const m = monthsToEntrega();
          const fv = calcINCCSaldoDevedor(financiamentoNum, inccRate, m);

          doc.setFont("helvetica","bold");
          doc.text("INCC no Saldo Devedor:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text("Sim", colB, ty);

          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Meses at√© entrega:", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(String(m), colB, ty);

          ty += line;
          doc.setFont("helvetica","bold");
          doc.text("Financiamento corrigido (estimado):", colA, ty);
          doc.setFont("helvetica","normal");
          doc.text(moeda(fv), colB, ty);

          ty += line;
          doc.setFontSize(9);
          doc.text("* Corre√ß√£o por juros compostos at√© a entrega.", colA, ty);
          doc.setFontSize(10);
        }

        y += (inccSaldo && inccEntrada) ? 52 : 44;
      }

      /* =========================
         ALERTA SALDO RESTANTE
      ========================== */
      if(entrada && entrada.saldoRestante > 0){
        doc.setFillColor(...amarelo);
        doc.roundedRect(left, y, pageW, 18, 4, 4, "F");

        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text("‚ö† Aten√ß√£o", colA, y + 7);

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text(
          "Existe saldo restante previsto para financiamento no p√≥s-obra (SBPE).",
          colA,
          y + 13
        );

        y += 26;
      }

      /* =========================
         RODAP√â
      ========================== */
      doc.setFontSize(9);
      doc.setTextColor(90);
      doc.text(
        "Simulador Imobili√°rio ‚Ä¢ Uso educativo ‚Ä¢ Valores estimados ‚Ä¢ N√£o substitui an√°lise banc√°ria",
        105,
        288,
        { align: "center" }
      );

      doc.save("simulacao-sbpe-pos-obra.pdf");
    }

    /* =========================
       INIT
    ========================== */
    (function(){
      toggleInter();
      toggleINCC();
    })();
  </script>
</body>
</html>
