<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Imobili√°rio Pro v16.1 - Raul Mendes Imob</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #ecfdf5;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --orange: #d97706;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius-lg: 24px;
            --radius-md: 14px;
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.03), 0 8px 10px -6px rgba(0,0,0,0.01);
            
            --bg-bloco-1: #f8fafc;
            --bg-bloco-2: #fffcf5;
            --bg-bloco-3: #f7fff9;
            --bg-diagnostico: #f9f8ff;
            --bg-simulacao-estimada: #d1fae5;
            --bg-simulacao-detalhada: #bfdbfe;
            
            --bg-sub-container: #ffffff;
            --bg-inter-bloco: #fffbeb;
            --bg-pos-bloco: #f0f9ff;
            --bg-subsidio-bloco: #fef3c7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: var(--text-main); line-height: 1.6; min-height: 100vh; padding: 20px 16px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        /* Bloco de Consentimento */
        #consentBlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; overflow-y: auto; padding: 40px 20px; }
        .consent-wrapper { max-width: 600px; margin: 0 auto; }
        .consent-card { background: #fff; padding: clamp(24px, 5vw, 40px); border-radius: var(--radius-lg); box-shadow: 0 20px 50px rgba(0,0,0,0.08); text-align: center; border: 1px solid #f1f5f9; }
        .consent-card h2 { font-family: 'Poppins'; color: var(--danger); margin-bottom: 24px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 24px; }
        .consent-card p { font-size: 15px; color: var(--text-main); margin-bottom: 15px; text-align: left; }
        .consent-card ul { text-align: left; margin-bottom: 30px; padding-left: 20px; list-style: none; }
        .consent-card li { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; position: relative; padding-left: 24px; }
        .consent-card li::before { content: '‚úì'; position: absolute; left: 0; color: var(--primary); font-weight: bold; }
        .consent-footer { margin-top: 30px; font-size: 13px; color: var(--text-muted); border-top: 1px solid #f1f5f9; padding-top: 20px; }
        .consent-footer a { color: var(--secondary); text-decoration: none; font-weight: 600; }

        header { text-align: center; margin-bottom: 32px; }
        header h1 { font-family: 'Poppins', sans-serif; font-size: clamp(22px, 6vw, 32px); color: var(--primary-dark); margin-bottom: 4px; }
        header p { color: var(--text-muted); font-size: 14px; }

        .card { background: #fff; border-radius: var(--radius-lg); padding: clamp(20px, 5vw, 32px); box-shadow: var(--shadow-lg); margin-bottom: 24px; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
        .bloco-1 { background-color: var(--bg-bloco-1); }
        .bloco-2 { background-color: var(--bg-bloco-2); }
        .bloco-3 { background-color: var(--bg-bloco-3); }
        .bloco-diagnostico { background-color: var(--bg-diagnostico); border: 2px solid #eef2ff; }
        
        .bloco-simulacao-estimada { background-color: var(--bg-simulacao-estimada); border: 2px solid #6ee7b7; }
        .bloco-simulacao-detalhada { background-color: var(--bg-simulacao-detalhada); border: 2px solid #93c5fd; }

        .section-title { font-family: 'Poppins', sans-serif; font-size: 17px; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary); width: 22px; height: 22px; }
        .obs-italico { font-size: 12px; font-style: italic; color: var(--text-muted); font-weight: 400; margin-left: 4px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
        @media (min-width: 500px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper i { position: absolute; left: 16px; color: var(--text-muted); width: 18px; height: 18px; pointer-events: none; }
        input, select { width: 100%; padding: 12px 16px; padding-left: 48px; border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); font-size: 15px; font-family: inherit; color: var(--text-main); background: #fff; transition: all 0.2s ease; outline: none; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; width: 100%; }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .btn-warning { background: var(--orange); color: #fff; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.15); }
        .btn-success { background: #10b981; color: #fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15); }
        .btn-success:hover { background: #059669; transform: translateY(-1px); }
        .btn-purple { background: #9333ea; color: #fff; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.15); }
        .btn-purple:hover { background: #7e22ce; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        .btn-outline-secondary { background: transparent; border: 1.5px solid var(--secondary); color: var(--secondary); }
        .btn-outline-secondary:hover { background: #eff6ff; }
        .btn-danger-real { background: var(--danger); color: #fff; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15); margin-top: 20px; }

        /* Cards de Escolha v15 */
        .choice-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 24px; }
        @media (min-width: 600px) { .choice-grid { grid-template-columns: 1fr 1fr; } }
        .choice-card { border: 2px solid #e2e8f0; border-radius: var(--radius-lg); padding: 28px 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .choice-card.estimada { background: var(--bg-simulacao-estimada); border-color: #6ee7b7; }
        .choice-card.detalhada { background: var(--bg-simulacao-detalhada); border-color: #93c5fd; }
        .choice-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .choice-card h4 { font-family: 'Poppins'; font-size: 22px; color: var(--text-main); font-weight: 800; margin-top: 8px; }
        .choice-card span { font-size: 13px; font-weight: 700; text-transform: uppercase; }
        .choice-card.estimada span { color: var(--primary); }
        .choice-card.detalhada span { color: var(--secondary); }
        .choice-card p { font-size: 14px; color: var(--text-muted); line-height: 1.5; margin-top: 4px; }

        .diag-container { display: flex; flex-direction: column; gap: 12px; }
        .diag-item { background: #fff; border-left: 4px solid var(--secondary); padding: 16px; border-radius: 0 var(--radius-md) var(--radius-md) 0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .diag-item.destaque { border-left-color: var(--primary); background: #f0fdf4; }
        .diag-item.subsidio { border-left-color: var(--warning); background: #fffbeb; }
        .diag-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px; }
        .diag-value { font-size: 15px; color: var(--text-main); }

        .fluxo-card { background: #fff; border-radius: var(--radius-lg); overflow: hidden; border: 1px solid #e2e8f0; margin-top: 24px; box-shadow: var(--shadow-lg); }
        .fluxo-header { background: #f8fafc; padding: 20px; border-bottom: 1px solid #e2e8f0; text-align: center; }
        .fluxo-header h4 { font-family: 'Poppins'; color: var(--text-main); font-size: 18px; }
        .fluxo-header p { font-size: 13px; color: var(--text-muted); }
        .fluxo-body { padding: 24px; }
        .fluxo-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; font-size: 14px; }
        .fluxo-label { color: var(--text-muted); }
        .fluxo-valor { font-weight: 700; }
        .fluxo-secao { background: #f8fafc; padding: 16px; border-radius: var(--radius-md); margin: 16px 0; border: 1px solid #e2e8f0; }
        .fluxo-secao-titulo { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--secondary); margin-bottom: 12px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .fluxo-destaque { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: var(--radius-md); margin: 16px 0; text-align: center; }
        .fluxo-destaque .label { font-weight: 700; color: var(--primary-dark); font-size: 13px; }
        .fluxo-destaque .valor { color: var(--primary); font-size: 28px; font-weight: 800; display: block; margin-top: 4px; }

        .alerta-box { padding: 14px; border-radius: var(--radius-md); margin-top: 16px; text-align: center; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .alerta-box.sucesso { background: #f0fdf4; color: var(--primary-dark); border: 1px solid #bbf7d0; }
        .alerta-box.aviso { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        .prazo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 8px; }
        .prazo-btn { padding: 12px; border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); background: #fff; cursor: pointer; text-align: center; transition: all 0.2s; }
        .prazo-btn span { display: block; font-weight: 700; font-size: 14px; }
        .prazo-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }

        /* Estilos v12 */
        .sub-container { background: var(--bg-sub-container); border: 1px solid #e2e8f0; border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; }
        .mini-bloco { border-radius: var(--radius-md); padding: 16px; margin-top: 12px; border: 1px solid #e2e8f0; }
        .mini-bloco.inter { background: var(--bg-inter-bloco); border-top: 3px solid var(--warning); }
        .mini-bloco.pos { background: var(--bg-pos-bloco); border-top: 3px solid var(--secondary); }
        .mini-bloco.subsidio { background: var(--bg-subsidio-bloco); border-top: 3px solid var(--warning); }
        .mini-bloco-titulo { font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .inter-item { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #ffffff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #edf2f7; }
        @media (max-width: 500px) { .inter-item { grid-template-columns: 1fr; } }

        /* Blocos Expans√≠veis v13 */
        .bloco-expansivel { background: #fff; border-radius: var(--radius-lg); overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 16px; box-shadow: var(--shadow-lg); }
        .bloco-header-exp { padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .bloco-header-exp:hover { background: #f8fafc; }
        .bloco-header-exp.incc { background: #fffbeb; border-bottom: 2px solid var(--warning); }
        .bloco-header-exp.juros { background: #fff7ed; border-bottom: 2px solid var(--orange); }
        .bloco-header-exp.pdf { background: #eff6ff; border-bottom: 2px solid var(--secondary); }
        .bloco-header-exp h4 { font-family: 'Poppins'; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .bloco-header-exp i { width: 20px; height: 20px; }
        .toggle-icon { font-size: 20px; font-weight: bold; transition: transform 0.3s; }
        .toggle-icon.open { transform: rotate(180deg); }
        .bloco-conteudo-exp { display: none; padding: 20px; background: #fafafa; }
        .bloco-conteudo-exp.open { display: block; }

        /* Tabela de Juros */
        .juros-table { width: 70%; max-width: 600px; border-collapse: collapse; margin: 16px auto; }
        .juros-table th, .juros-table td { padding: 12px 20px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .juros-table th { background: #f8fafc; font-weight: 700; font-size: 13px; text-transform: uppercase; color: var(--text-muted); }
        .juros-table td { font-size: 14px; }
        .juros-table td:first-child { font-weight: 600; color: var(--secondary); }
        @media (max-width: 768px) { .juros-table { width: 100%; } }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .color-azul { color: #3b82f6 !important; }
        .color-laranja { color: #f59e0b !important; }

        .obs-box { background: #fffbeb; border: 1px solid #fde68a; padding: 12px; border-radius: var(--radius-md); font-size: 13px; color: var(--text-main); margin-top: 12px; line-height: 1.5; }
        .obs-box a { color: var(--secondary); text-decoration: none; font-weight: 600; }
        .obs-box a:hover { text-decoration: underline; }
        .obs-box ul { margin-left: 18px; margin-top: 6px; }
        .obs-box li { margin-bottom: 4px; }
        
        /* INCC Result Sections v14 */
        .incc-secao { background: #fff; border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
        .incc-secao-titulo { font-size: 12px; text-transform: uppercase; font-weight: 700; color: var(--orange); margin-bottom: 12px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .incc-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
        .incc-row:last-child { border-bottom: none; }
        .incc-label { color: var(--text-muted); }
        .incc-valor { font-weight: 700; color: var(--text-main); }
    </style>
</head>
<body>

<!-- BLOCO DE CONSENTIMENTO -->
<div id="consentBlock">
    <div class="consent-wrapper">
        <header>
            <h1>Simulador Imobili√°rio</h1>
            <p>M√≥dulo Comprador - Raul Mendes Imob</p>
        </header>
        <div class="consent-card">
            <h2><i data-lucide="alert-triangle"></i> ATEN√á√ÉO</h2>
            <p>Antes de prosseguir, esteja ciente de que:</p>
            <ul>
                <li>Este √© um simulador apenas para <strong>fins educativos e estimativas financeiras</strong> referente √† aquisi√ß√£o de im√≥veis na planta pelo programa Minha Casa Minha Vida;</li>
                <li>Usamos <strong>c√°lculos e f√≥rmulas</strong> pr√©-estabelecidas com intuito de se aproximar da realidade;</li>
                <li>Usamos como base de c√°lculos <strong>Tabela Price</strong> de Financiamento via Minha Casa Minha Vida;</li>
                <li>Valores reais, condi√ß√µes de pagamento e detalhes dever√£o ser <strong>verificados diretamente com o seu corretor</strong> respons√°vel.</li>
            </ul>
            <button id="btnConcordo" class="btn btn-primary">Sim. De acordo</button>
            <div class="consent-footer">
                <p>Siga no Instagram: <a href="https://instagram.com/raulmendes.imob" target="_blank">@raulmendes.imob</a></p>
                <p>D√∫vidas? <a href="mailto:suporte@suporte.com">suporte@suporte.com</a></p>
            </div>
        </div>
    </div>
</div>

<div class="container hidden" id="mainContent">
    <header>
        <h1>Simulador Imobili√°rio</h1>
        <p>M√≥dulo Comprador - Minha Casa Minha Vida (Oficial)</p>
    </header>

    <main id="app">
        <!-- BLOCO 1: Identifica√ß√£o -->
        <section class="card bloco-1 fade-in">
            <h3 class="section-title"><i data-lucide="user"></i> Bloco 1 - Identifica√ß√£o</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="compraCom">1. Quem participar√° da compra? <span class="obs-italico">(Em conjunto = Namorada(o), noivo(a), c√¥njuge, familiar...)</span></label>
                    <div class="input-wrapper">
                        <select id="compraCom">
                            <option value="">Selecione...</option>
                            <option value="sozinho">Comprar Sozinho(a)</option>
                            <option value="conjunto">Comprar em Conjunto</option>
                        </select>
                    </div>
                </div>
                <div id="boxIdades" class="grid grid-2 hidden">
                    <div class="form-group">
                        <label id="labelIdade1" for="idade1">Sua Idade</label>
                        <div class="input-wrapper"><select id="idade1" class="select-idade"></select></div>
                    </div>
                    <div id="boxIdade2" class="form-group hidden">
                        <label for="idade2">Idade do 2¬∫ Comprador</label>
                        <div class="input-wrapper"><select id="idade2" class="select-idade"></select></div>
                    </div>
                </div>
                <div id="boxEstado" class="form-group hidden">
                    <label for="estado">3. Estado da Compra</label>
                    <div class="input-wrapper">
                        <select id="estado">
                            <option value="">Selecione o estado...</option>
                            <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option><option value="ES">Esp√≠rito Santo</option><option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option><option value="PA">Par√°</option><option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option><option value="PE">Pernambuco</option><option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- BLOCO 2: Financeiro -->
        <section id="stepFinanceiro" class="card bloco-2 fade-in hidden">
            <h3 class="section-title"><i data-lucide="dollar-sign"></i> Bloco 2 - Informa√ß√µes Financeiras</h3>
            <div class="grid">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label id="labelRenda1" for="renda1">Sua Renda Mensal</label>
                        <div class="input-wrapper"><input type="text" id="renda1" class="money-mask" placeholder="R$ 0,00"></div>
                    </div>
                    <div id="boxRenda2" class="form-group hidden">
                        <label for="renda2">Renda do 2¬∫ Comprador</label>
                        <div class="input-wrapper"><input type="text" id="renda2" class="money-mask" placeholder="R$ 0,00"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="temGuardado">Possui algum valor guardado para entrada?</label>
                    <div class="input-wrapper">
                        <select id="temGuardado">
                            <option value="">Selecione...</option>
                            <option value="sim">Sim, possuo</option>
                            <option value="nao">N√£o possuo</option>
                        </select>
                    </div>
                </div>
                <div id="boxValorGuardado" class="form-group hidden">
                    <label for="valorGuardado">Qual o valor guardado?</label>
                    <div class="input-wrapper"><input type="text" id="valorGuardado" class="money-mask" placeholder="R$ 0,00"></div>
                </div>
            </div>
        </section>

        <!-- BLOCO 3: Trabalho -->
        <section id="stepTrabalho" class="card bloco-3 fade-in hidden">
            <h3 class="section-title"><i data-lucide="briefcase"></i> Bloco 3 - Regime de Trabalho</h3>
            <div class="grid">
                <div class="form-group">
                    <label id="labelRegime">Qual seu regime de trabalho?</label>
                    <div class="input-wrapper">
                        <select id="regimeTrabalho">
                            <option value="">Selecione...</option>
                            <option value="clt3">CLT (Mais de 3 anos de FGTS)</option>
                            <option value="cltmenos">CLT (Menos de 3 anos de FGTS)</option>
                            <option value="pj">Aut√¥nomo / PJ / Outros</option>
                        </select>
                    </div>
                </div>
                <div id="boxUsaFgts" class="form-group hidden">
                    <label for="usaFgts">Possui FGTS e pretende usar na compra?</label>
                    <div class="input-wrapper">
                        <select id="usaFgts">
                            <option value="">Selecione...</option>
                            <option value="sim">Sim, pretendo usar</option>
                            <option value="nao">N√£o pretendo usar</option>
                        </select>
                    </div>
                </div>
                <div id="boxFgtsVal" class="form-group hidden">
                    <label for="fgtsVal">Valor dispon√≠vel no FGTS</label>
                    <div class="input-wrapper"><input type="text" id="fgtsVal" class="money-mask" placeholder="R$ 0,00"></div>
                </div>
            </div>
            <div style="margin-top: 24px;"><button id="btnGerarDiagnostico" class="btn btn-primary hidden"><i data-lucide="bar-chart-3"></i> GERAR AN√ÅLISE DE PERFIL</button></div>
        </section>

        <!-- RESULTADO DO DIAGN√ìSTICO -->
        <div id="diagnosticoContainer" class="hidden">
            <section class="card bloco-diagnostico fade-in">
                <h3 class="section-title"><i data-lucide="check-circle"></i> üìä Sua An√°lise de Perfil MCMV</h3>
                <div id="diagnosticoResumo" class="diag-container"></div>
            </section>

            <!-- ESCOLHA DO TIPO DE SIMULA√á√ÉO v15 -->
            <section id="blocoEscolha" class="card fade-in">
                <h3 class="section-title"><i data-lucide="layers"></i> Escolha o tipo de simula√ß√£o</h3>
                <div class="choice-grid">
                    <div class="choice-card estimada" onclick="selectSimType('estimada')">
                        <span>Simula√ß√£o Estimada</span>
                        <h4>üîç Quero apenas ter uma ideia</h4>
                        <p>Ideal para quem est√° come√ßando a pesquisar e ainda n√£o tem um im√≥vel definido.</p>
                        <button class="btn btn-outline">Selecionar</button>
                    </div>
                    <div class="choice-card detalhada" onclick="selectSimType('detalhada')">
                        <span>Simula√ß√£o Detalhada</span>
                        <h4>üéØ J√° conhe√ßo o empreendimento</h4>
                        <p>Ideal para quem j√° est√° em negocia√ß√£o e possui os valores reais.</p>
                        <button class="btn btn-outline-secondary">Selecionar</button>
                    </div>
                </div>
            </section>

            <!-- BLOCO DE SIMULA√á√ÉO ESTIMADA v15 -->
            <section id="blocoSimulacaoEstimada" class="card bloco-simulacao-estimada fade-in hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 class="section-title" style="margin-bottom: 0;"><i data-lucide="calculator"></i> Simula√ß√£o Estimada</h3>
                    <button class="btn btn-outline-secondary" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="backToChoice()"><i data-lucide="arrow-left"></i> Voltar</button>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label for="valorImovel">üí∞ Valor do Im√≥vel Pretendido</label>
                        <div class="input-wrapper"><input type="text" id="valorImovel" class="money-mask" placeholder="R$ 0,00"></div>
                        <div id="avisoTetoImovel" style="font-size: 11px; color: var(--danger); font-weight: 600; margin-top: 4px; display: none;"></div>
                    </div>
                    <div class="form-group" style="background: #f0f9ff; padding: 15px; border-radius: var(--radius-md); border: 1px solid #bae6fd;">
                        <label for="valorAto">üí≥ Valor do Ato (1¬™ Parcela) <span class="obs-italico">Valor Guardado p/ Entrada</span></label>
                        <div class="input-wrapper"><input type="text" id="valorAto" class="money-mask" placeholder="R$ 0,00"></div>
                    </div>
                    <div class="form-group">
                        <label>‚è±Ô∏è Prazo estimado de entrega da obra:</label>
                        <div class="prazo-grid">
                            <button class="prazo-btn" data-meses="12"><span>12 meses</span></button>
                            <button class="prazo-btn" data-meses="18"><span>18 meses</span></button>
                            <button class="prazo-btn" data-meses="24"><span>24 meses</span></button>
                            <button class="prazo-btn" data-meses="30"><span>30 meses</span></button>
                            <button class="prazo-btn" data-meses="36"><span>36 meses</span></button>
                        </div>
                    </div>
                    <button id="btnCalcularEstimada" class="btn btn-primary">CALCULAR FLUXO ESTIMADO</button>
                </div>
            </section>

            <!-- BLOCO DE SIMULA√á√ÉO DETALHADA v15 -->
            <section id="blocoSimulacaoDetalhada" class="card bloco-simulacao-detalhada fade-in hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 class="section-title" style="margin-bottom: 0;"><i data-lucide="target"></i> Simula√ß√£o Detalhada</h3>
                    <button class="btn btn-outline" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="backToChoice()"><i data-lucide="arrow-left"></i> Voltar</button>
                </div>
                <div class="grid">
                    <!-- Container de Valores do Im√≥vel v15 -->
                    <div class="sub-container">
                        <div class="grid">
                            <div class="form-group">
                                <label for="valorReal">üè† Valor Real do Im√≥vel (Venda)</label>
                                <div class="input-wrapper"><input type="text" id="valorReal" class="money-mask" placeholder="R$ 0,00"></div>
                            </div>
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="valorAvaliacao">üìã Valor de Avalia√ß√£o</label>
                                    <div class="input-wrapper"><input type="text" id="valorAvaliacao" class="money-mask" placeholder="R$ 0,00"></div>
                                    <div id="avisoTetoAval" style="font-size: 11px; color: var(--danger); font-weight: 600; margin-top: 4px; display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="financiamentoAprovado">üí∞ Financiamento</label>
                                    <div class="input-wrapper"><input type="text" id="financiamentoAprovado" class="money-mask" placeholder="R$ 0,00"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SUBS√çDIO v15 -->
                    <div class="mini-bloco subsidio">
                        <div class="form-group">
                            <label>üéÅ Tem subs√≠dio do governo?</label>
                            <div class="input-wrapper">
                                <select id="temSubsidio">
                                    <option value="nao">N√£o</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                        </div>
                        <div id="boxSubsidioVal" class="form-group hidden" style="margin-top: 10px;">
                            <label>Valor do Subs√≠dio</label>
                            <div class="input-wrapper"><input type="text" id="subsidioVal" class="money-mask" placeholder="R$ 0,00"></div>
                        </div>
                    </div>
                    
                    <!-- ENTRADA / FLUXO INICIAL -->
                    <div class="mini-bloco" style="background: #f8fafc; border-top: 4px solid var(--primary);">
                        <div class="mini-bloco-titulo"><i data-lucide="banknote"></i> Entrada / Fluxo Inicial</div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="valorAtoDet">üí∞ Valor do Ato (R$)</label>
                                <div class="input-wrapper"><input type="text" id="valorAtoDet" class="money-mask" placeholder="R$ 0,00"></div>
                            </div>
                            <div class="form-group">
                                <label for="prazoObraDet">üìÖ Meses / Parcelas</label>
                                <div class="input-wrapper">
                                    <select id="prazoObraDet">
                                        <!-- Populado via JS -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- INTERMEDI√ÅRIAS -->
                        <div class="mini-bloco inter">
                            <div class="form-group">
                                <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
                                <div class="input-wrapper">
                                    <select id="temInterDet">
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                            </div>
                            <div id="boxQtdInter" class="form-group hidden" style="margin-top: 10px;">
                                <label>Quantidade</label>
                                <div class="input-wrapper">
                                    <select id="qtdInterDet">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                    </select>
                                </div>
                            </div>
                            <div id="containerInterItems" class="hidden" style="margin-top: 10px;">
                                <!-- Gerado dinamicamente -->
                            </div>
                        </div>

                        <!-- P√ìS CHAVES -->
                        <div class="mini-bloco pos">
                            <div class="form-group">
                                <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
                                <div class="input-wrapper">
                                    <select id="aceitaPosChaves">
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="btnCalcularDetalhada" class="btn btn-primary" style="margin-top: 10px;">CALCULAR ENTRADA</button>
                </div>
            </section>

            <div id="fluxoResultado" class="hidden"></div>

            <!-- BLOCOS EXPANS√çVEIS: INCC, JUROS E PDF -->
            <div id="blocosExtras" class="hidden">
                <!-- INCC -->
                <div class="bloco-expansivel">
                    <div class="bloco-header-exp incc" onclick="toggleBloco('incc')">
                        <h4><i data-lucide="trending-up"></i> Estimativa de INCC</h4>
                        <span class="toggle-icon" id="toggleINCC">‚ñº</span>
                    </div>
                    <div class="bloco-conteudo-exp" id="conteudoINCC">
                        <div class="grid">
                            <div class="form-group">
                                <label for="inccTaxa">Taxa m√©dia mensal do INCC (%)</label>
                                <input type="number" id="inccTaxa" step="0.01" value="0.50" style="padding-left: 16px;">
                                <small style="display: block; margin-top: 4px; color: #666; font-size: 0.85em;">* INCC atualizado dispon√≠vel em: <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank" style="color: #0066cc;">portal.fgv.br/noticias/incc-m-2025</a></small>
                            </div>
                            <button class="btn btn-primary" onclick="calcularINCC()"><i data-lucide="calculator"></i> CALCULAR INCC</button>
                        </div>
                        <div id="resultadoINCC" class="hidden" style="margin-top: 16px;"></div>
                    </div>
                </div>

                <!-- JUROS DE OBRA -->
                <div class="bloco-expansivel">
                    <div class="bloco-header-exp juros" onclick="toggleBloco('juros')">
                        <h4><i data-lucide="percent"></i> Juros de Obra (Tabela)</h4>
                        <span class="toggle-icon" id="toggleJuros">‚ñº</span>
                    </div>
                    <div class="bloco-conteudo-exp" id="conteudoJuros">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="trTaxa">TR (%)</label>
                                <input type="number" id="trTaxa" step="0.01" value="0.17" style="padding-left: 16px;">
                                <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">* Consulta da TR atualizada: <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank" style="color: #059669;">debit.com.br/tabelas/tr-bacen</a></small>
                            </div>
                            <div class="form-group">
                                <label for="taxasAdm">Taxas Adm + Seguros (R$) <span style="font-size: 11px; color: #666; font-weight: 400;">(Valor M√©dio)</span></label>
                                <input type="text" id="taxasAdm" class="money-mask" placeholder="R$ 0,00">
                            </div>
                            <div class="form-group">
                                <label for="passoTabela">Intervalo da Tabela</label>
                                <select id="passoTabela" style="padding-left: 16px;">
                                    <option value="3">3 em 3%</option>
                                    <option value="5" selected>5 em 5%</option>
                                    <option value="10">10 em 10%</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-purple" onclick="calcularJuros()"><i data-lucide="calculator"></i> CALCULAR JUROS DE OBRA</button>
                        <div id="resultadoJuros" class="hidden" style="margin-top: 16px;"></div>
                    </div>
                </div>

                <!-- GERAR PDF -->
                <div id="blocoPDF" class="bloco-expansivel">
                    <div class="bloco-header-exp pdf" onclick="toggleBloco('pdf')">
                        <h4><i data-lucide="file-text"></i> Gerar PDF da Simula√ß√£o</h4>
                        <span class="toggle-icon" id="togglePDF">‚ñº</span>
                    </div>
                    <div class="bloco-conteudo-exp" id="conteudoPDF">
                        <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Gere um documento profissional com todos os detalhes da simula√ß√£o para enviar ao seu cliente.</p>
                        <button class="btn btn-success" onclick="gerarPDF()"><i data-lucide="download"></i> BAIXAR PDF COMPLETO</button>
                    </div>
                </div>
                        <button class="btn btn-secondary" onclick="gerarPDF()"><i data-lucide="download"></i> GERAR PDF COMPLETO</button>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-bottom: 40px;">
            <button id="btnLimpar" class="btn btn-danger-real" style="max-width: 400px;">üóëÔ∏è REINICIAR SIMULADOR</button>
        </div>
    </main>
</div>

<script>
    const CONFIG = {
        REGIOES_S_SE_CO: ["SP", "RJ", "MG", "ES", "PR", "SC", "RS", "DF", "GO", "MT", "MS"],
        COMPROMETIMENTO: 0.30,
        LTV_MAX: 0.80,
        PRAZO_MAX_PADRAO: 420,
        IDADE_LIMITE_CAIXA: 80.5
    };

    let state = { 
        dadosDiagnostico: null, 
        prazoSelecionado: null, 
        simType: 'estimada', 
        ultimoCalculo: null,
        inccCalculado: false,
        jurosCalculado: false
    };

    document.addEventListener('DOMContentLoaded', () => { 
        lucide.createIcons(); 
        popularIdades(); 
        popularPrazosObra();
        setupEventListeners(); 
        setupMasks(); 
        document.getElementById('taxasAdm').value = formatMoney(65);
    });

    function popularIdades() {
        const selects = document.querySelectorAll('.select-idade');
        selects.forEach(select => {
            select.innerHTML = '<option value="">Selecione...</option>';
            for (let i = 18; i <= 70; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.textContent = i + ' anos'; select.appendChild(opt);
            }
        });
    }

    function popularPrazosObra() {
        const select = document.getElementById('prazoObraDet');
        select.innerHTML = '<option value="">Selecione...</option>';
        for (let i = 1; i <= 40; i++) {
            const opt = document.createElement('option'); opt.value = i; opt.textContent = i; select.appendChild(opt);
        }
    }

    function generateDateOptions() {
        const options = [];
        const hoje = new Date();
        const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        for (let i = 1; i <= 60; i++) {
            const d = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
            const label = `${mesesNomes[d.getMonth()]}/${d.getFullYear().toString().substr(-2)}`;
            options.push(`<option value="${label}">${label}</option>`);
        }
        return options.join('');
    }

    function setupEventListeners() {
        document.getElementById('btnConcordo').onclick = () => { document.getElementById('consentBlock').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); window.scrollTo(0,0); };
        document.getElementById('compraCom').addEventListener('change', (e) => {
            const val = e.target.value; const isConjunto = val === 'conjunto';
            document.getElementById('boxIdades').classList.toggle('hidden', !val);
            document.getElementById('boxIdade2').classList.toggle('hidden', !isConjunto);
            document.getElementById('labelIdade1').textContent = isConjunto ? 'Idade Comprador 1' : 'Sua Idade';
            document.getElementById('labelRegime').textContent = isConjunto ? 'Algum dos compradores trabalha em Regime CLT h√° mais de 3 anos?' : 'Qual seu regime de trabalho?';
            checkStepFinanceiro();
        });
        ['idade1', 'idade2', 'estado'].forEach(id => { document.getElementById(id).addEventListener('change', checkStepFinanceiro); });
        ['renda1', 'renda2', 'temGuardado', 'valorGuardado'].forEach(id => { 
            document.getElementById(id).addEventListener('input', () => { checkStepTrabalho(); atualizarBotaoDiagnostico(); }); 
            document.getElementById(id).addEventListener('change', () => { checkStepTrabalho(); atualizarBotaoDiagnostico(); }); 
        });
        document.getElementById('temGuardado').addEventListener('change', (e) => { document.getElementById('boxValorGuardado').classList.toggle('hidden', e.target.value !== 'sim'); });
        
        document.getElementById('regimeTrabalho').addEventListener('change', (e) => {
            const isClt3 = e.target.value === 'clt3';
            document.getElementById('boxUsaFgts').classList.toggle('hidden', !isClt3);
            if(!isClt3) {
                document.getElementById('usaFgts').value = 'nao';
                document.getElementById('boxFgtsVal').classList.add('hidden');
                document.getElementById('fgtsVal').value = '';
            }
        });
        document.getElementById('usaFgts').addEventListener('change', (e) => { 
            document.getElementById('boxFgtsVal').classList.toggle('hidden', e.target.value !== 'sim'); 
            atualizarBotaoDiagnostico();
        });
        document.getElementById('fgtsVal').addEventListener('input', atualizarBotaoDiagnostico);
        document.getElementById('fgtsVal').addEventListener('change', atualizarBotaoDiagnostico);
        document.getElementById('regimeTrabalho').addEventListener('change', atualizarBotaoDiagnostico);
        
        document.getElementById('btnGerarDiagnostico').addEventListener('click', gerarDiagnostico);
        document.querySelectorAll('.prazo-btn').forEach(btn => {
            btn.addEventListener('click', () => { document.querySelectorAll('.prazo-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); state.prazoSelecionado = parseInt(btn.dataset.meses); });
        });
        
        document.getElementById('temInterDet').addEventListener('change', (e) => {
            const sim = e.target.value === 'sim';
            document.getElementById('boxQtdInter').classList.toggle('hidden', !sim);
            document.getElementById('containerInterItems').classList.toggle('hidden', !sim);
            if(sim) updateInterItems();
        });
        document.getElementById('qtdInterDet').addEventListener('change', updateInterItems);
        
        document.getElementById('temSubsidio').addEventListener('change', (e) => {
            document.getElementById('boxSubsidioVal').classList.toggle('hidden', e.target.value !== 'sim');
        });
        
        document.getElementById('valorAvaliacao').addEventListener('blur', (e) => {
            if (!state.dadosDiagnostico) return;
            let val = parseMoney(e.target.value);
            if (val > state.dadosDiagnostico.teto) {
                e.target.value = formatMoney(state.dadosDiagnostico.teto);
                document.getElementById('avisoTetoAval').style.display = 'block';
                document.getElementById('avisoTetoAval').textContent = `‚ö†Ô∏è Valor limitado ao teto da faixa (${formatMoney(state.dadosDiagnostico.teto)})`;
            } else {
                document.getElementById('avisoTetoAval').style.display = 'none';
            }
            
            // Preenche o financiamento apenas se estiver vazio (sugest√£o inicial)
            const campoFin = document.getElementById('financiamentoAprovado');
            if (!campoFin.value || parseMoney(campoFin.value) === 0) {
                const finEst = Math.min(val * CONFIG.LTV_MAX, state.dadosDiagnostico.capFinanciamento, state.dadosDiagnostico.teto);
                campoFin.value = formatMoney(finEst);
            }
        });
        
        // Valida√ß√£o do Financiamento (edit√°vel)
        document.getElementById('financiamentoAprovado').addEventListener('blur', (e) => {
            if (!state.dadosDiagnostico) return;
            const valorAval = parseMoney(document.getElementById('valorAvaliacao').value);
            if (!valorAval) return;
            
            const finDigitado = parseMoney(e.target.value);
            const limiteMax = Math.min(valorAval * CONFIG.LTV_MAX, state.dadosDiagnostico.capFinanciamento, state.dadosDiagnostico.teto);
            
            if (finDigitado > limiteMax) {
                e.target.value = formatMoney(limiteMax);
                alert(`‚ö†Ô∏è O financiamento aprovado n√£o pode ultrapassar:\n\n‚Ä¢ 80% da Avalia√ß√£o: ${formatMoney(valorAval * CONFIG.LTV_MAX)}\n‚Ä¢ Capacidade pela Renda: ${formatMoney(state.dadosDiagnostico.capFinanciamento)}\n‚Ä¢ Teto da Faixa: ${formatMoney(state.dadosDiagnostico.teto)}\n\nValor ajustado para: ${formatMoney(limiteMax)}`);
            }
        });
        
        document.getElementById('valorImovel').addEventListener('blur', (e) => {
            if (!state.dadosDiagnostico) return;
            let val = parseMoney(e.target.value);
            if (val > state.dadosDiagnostico.teto) {
                e.target.value = formatMoney(state.dadosDiagnostico.teto);
                document.getElementById('avisoTetoImovel').style.display = 'block';
                document.getElementById('avisoTetoImovel').textContent = `‚ö†Ô∏è Valor limitado ao teto da faixa (${formatMoney(state.dadosDiagnostico.teto)}). Para valores maiores, use a Simula√ß√£o Detalhada.`;
            } else {
                document.getElementById('avisoTetoImovel').style.display = 'none';
            }
        });

        document.getElementById('btnCalcularEstimada').addEventListener('click', calcularFluxoEstimado);
        document.getElementById('btnCalcularDetalhada').addEventListener('click', calcularFluxoDetalhado);
        document.getElementById('btnLimpar').addEventListener('click', () => { if(confirm('Deseja realmente reiniciar?')) location.reload(); });
    }

    function updateInterItems() {
        const qtd = parseInt(document.getElementById('qtdInterDet').value);
        const container = document.getElementById('containerInterItems');
        const dateOpts = generateDateOptions();
        let html = '';
        for (let i = 1; i <= qtd; i++) {
            html += `
                <div class="inter-item">
                    <div class="form-group">
                        <label>${i}¬∫ pagamento</label>
                        <select class="inter-date">${dateOpts}</select>
                    </div>
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="text" class="money-mask inter-val" placeholder="R$ 0,00">
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
        setupMasks();
    }

    function selectSimType(type) {
        state.simType = type;
        document.getElementById('blocoEscolha').classList.add('hidden');
        document.getElementById('blocoSimulacaoEstimada').classList.toggle('hidden', type !== 'estimada');
        document.getElementById('blocoSimulacaoDetalhada').classList.toggle('hidden', type !== 'detalhada');
        const target = type === 'estimada' ? 'blocoSimulacaoEstimada' : 'blocoSimulacaoDetalhada';
        document.getElementById(target).scrollIntoView({ behavior: 'smooth' });
    }

    function backToChoice() {
        document.getElementById('blocoSimulacaoEstimada').classList.add('hidden');
        document.getElementById('blocoSimulacaoDetalhada').classList.add('hidden');
        document.getElementById('blocoEscolha').classList.remove('hidden');
        document.getElementById('fluxoResultado').classList.add('hidden');
        document.getElementById('blocosExtras').classList.add('hidden');
        state.inccCalculado = false;
        state.jurosCalculado = false;
    }

    function checkStepFinanceiro() {
        const comp = document.getElementById('compraCom').value; const i1 = document.getElementById('idade1').value; const i2 = document.getElementById('idade2').value;
        let valid = comp && i1; if (comp === 'conjunto') valid = valid && i2;
        document.getElementById('boxEstado').classList.toggle('hidden', !valid);
        const est = document.getElementById('estado').value; document.getElementById('stepFinanceiro').classList.toggle('hidden', !(valid && est));
    }

    function checkStepTrabalho() {
        const r1 = parseMoney(document.getElementById('renda1').value); const comp = document.getElementById('compraCom').value; const r2 = parseMoney(document.getElementById('renda2').value);
        const temG = document.getElementById('temGuardado').value; const valG = parseMoney(document.getElementById('valorGuardado').value);
        let valid = r1 > 0 && temG; if (comp === 'conjunto') valid = valid && r2 > 0; if (temG === 'sim') valid = valid && valG > 0;
        document.getElementById('stepTrabalho').classList.toggle('hidden', !valid);
        document.getElementById('boxRenda2').classList.toggle('hidden', comp !== 'conjunto');
    }

    function getMCMVData(rendaTotal, cotista, uf) {
        const isS_SE_CO = CONFIG.REGIOES_S_SE_CO.includes(uf);
        let faixa, teto, taxa;
        if (rendaTotal <= 2850) {
            faixa = 1; teto = 190000;
            if (rendaTotal <= 2160) { taxa = isS_SE_CO ? (cotista ? 4.33 : 4.84) : (cotista ? 4.07 : 4.59); }
            else { taxa = isS_SE_CO ? (cotista ? 4.59 : 5.12) : (cotista ? 4.33 : 4.84); }
        } else if (rendaTotal <= 4700) {
            faixa = 2; teto = 264000;
            if (rendaTotal <= 3500) { taxa = isS_SE_CO ? (cotista ? 5.12 : 5.64) : (cotista ? 4.84 : 5.38); }
            else if (rendaTotal <= 4000) { taxa = cotista ? 5.64 : 6.17; }
            else { taxa = cotista ? 6.70 : 7.23; }
        } else if (rendaTotal <= 8600) { faixa = 3; teto = 350000; taxa = cotista ? 7.93 : 8.46; }
        else if (rendaTotal <= 12000) { faixa = 4; teto = 500000; taxa = 11.03; }
        else return null;
        return { faixa, teto, taxa };
    }

    function gerarDiagnostico() {
        const r1 = parseMoney(document.getElementById('renda1').value);
        const r2 = parseMoney(document.getElementById('renda2').value);
        const i1 = parseInt(document.getElementById('idade1').value);
        const i2 = parseInt(document.getElementById('idade2').value) || 0;
        const uf = document.getElementById('estado').value;
        const cotista = document.getElementById('regimeTrabalho').value === 'clt3';
        const fgts = parseMoney(document.getElementById('fgtsVal').value);
        const guardado = parseMoney(document.getElementById('valorGuardado').value);

        const rendaTotal = r1 + r2;
        const data = getMCMVData(rendaTotal, cotista, uf);
        if (!data) return alert("Renda fora dos limites do programa.");

        const { faixa, teto, taxa } = data;
        const idadeMedia = i2 > 0 ? Math.round((i1 + i2) / 2) : i1;
        const prazoMaximoIdade = Math.floor((CONFIG.IDADE_LIMITE_CAIXA - idadeMedia) * 12);
        const prazoFinalFinanciamento = Math.min(CONFIG.PRAZO_MAX_PADRAO, prazoMaximoIdade);

        if (prazoFinalFinanciamento <= 0) return alert("Idade incompat√≠vel com financiamento.");

        const parcelaMax = rendaTotal * CONFIG.COMPROMETIMENTO;
        const taxaMensal = Math.pow(1 + (taxa / 100), 1 / 12) - 1;
        const capFinanciamento = (parcelaMax * (Math.pow(1 + taxaMensal, prazoFinalFinanciamento) - 1)) / (taxaMensal * Math.pow(1 + taxaMensal, prazoFinalFinanciamento));

        state.dadosDiagnostico = { faixa, taxa, rendaTotal, capFinanciamento, teto, fgts, guardado, parcelaMax, prazoFinalFinanciamento };

        let html = `
            <div class="diag-item"><div class="diag-label">üè† Faixa do Minha Casa Minha Vida</div><div class="diag-value">Voc√™ faz parte da <strong>Faixa ${faixa}</strong> do Programa.</div></div>
            <div class="diag-item"><div class="diag-label">üí∞ Teto do Programa</div><div class="diag-value">Na sua faixa, √© poss√≠vel adquirir im√≥veis de <strong>at√© ${formatMoney(teto)} de avalia√ß√£o</strong>.</div></div>
            <div class="diag-item destaque"><div class="diag-label">üìà Taxa de Juros e Prazo</div><div class="diag-value">Taxa de <strong>${taxa.toFixed(2)}% ao ano</strong> com prazo m√°ximo de <strong>${prazoFinalFinanciamento} meses</strong>.</div></div>
            <div class="diag-item"><div class="diag-label">üìä Parcela</div><div class="diag-value">A sua parcela m√°xima de pagamento mensal do financiamento √© de <strong>${formatMoney(parcelaMax)}</strong>, a ser paga ap√≥s a finaliza√ß√£o da obra.</div></div>
        `;
        if (faixa <= 2) html += `<div class="diag-item subsidio"><div class="diag-label">üéÅ Subs√≠dio do Governo</div><div class="diag-value">Voc√™ pode ter direito a <strong>subs√≠dio</strong> (A ser verificado durante An√°lise Caixa).</div></div>`;

        document.getElementById('diagnosticoResumo').innerHTML = html;
        document.getElementById('diagnosticoContainer').classList.remove('hidden');
        document.getElementById('diagnosticoContainer').scrollIntoView({ behavior: 'smooth' });
        if (guardado > 0) {
            document.getElementById('valorAto').value = formatMoney(guardado);
            document.getElementById('valorAtoDet').value = formatMoney(guardado);
        }
        
        lucide.createIcons();
    }

    function calcularFluxoEstimado() {
        limparResultadosINCC_Juros(); // Limpa INCC e Juros ao recalcular
        const d = state.dadosDiagnostico;
        if (!d) return alert('Gere a an√°lise de perfil primeiro.');
        if (!state.prazoSelecionado) return alert('Selecione o prazo de entrega');

        const valorImovel = parseMoney(document.getElementById('valorImovel').value);
        let valorAto = parseMoney(document.getElementById('valorAto').value);
        const usouAtoDefault = valorAto === 0;
        if (valorAto === 0) valorAto = 1000;
        
        if (!valorImovel) return alert('Informe o valor do im√≥vel');

        // Financiamento = menor entre: 80% avalia√ß√£o, capacidade renda, teto (mesma l√≥gica da detalhada)
        const financiamentoEstimado = Math.min(valorImovel * CONFIG.LTV_MAX, d.capFinanciamento, d.teto);
        const entradaTotal = valorImovel - financiamentoEstimado - d.fgts;
        
        // Valida√ß√£o: Se entrada total for negativa ou zero, significa que os inputs ultrapassam o valor do im√≥vel
        const inputsTotal = financiamentoEstimado + d.fgts;
        const entradaUltrapassa = inputsTotal >= valorImovel;
        
        const prazo = state.prazoSelecionado;
        let qtdInter = 0;
        if (prazo === 12) qtdInter = 1;
        else if (prazo === 18 || prazo === 24) qtdInter = 2;
        else if (prazo === 30 || prazo === 36) qtdInter = 3;
        
        const valorInter = qtdInter > 0 ? d.rendaTotal : 0;
        const totalInter = valorInter * qtdInter;
        
        const saldoParaMensais = entradaTotal - valorAto - totalInter;
        const parcelaMensalCalculada = Math.max(0, saldoParaMensais / prazo);
        const limiteMensal = d.rendaTotal * 0.30;
        
        const parcelaMensal = Math.min(parcelaMensalCalculada, limiteMensal);
        const ultrapassa = parcelaMensalCalculada > limiteMensal;
        const saldoRestante = ultrapassa ? (parcelaMensalCalculada - limiteMensal) * prazo : 0;

        state.ultimoCalculo = {
            valorImovel, financiamento: financiamentoEstimado, fgts: d.fgts, entradaTotal, 
            ato: valorAto, mensal: parcelaMensal, prazo, ultrapassa,
            intermediarias: [], qtdInter, valorInter, saldoRestante, usouAtoDefault, entradaUltrapassa
        };

        renderResultadoEstimado(valorImovel, financiamentoEstimado, d.fgts, entradaTotal, valorAto, parcelaMensal, prazo, qtdInter, valorInter, ultrapassa, saldoRestante, usouAtoDefault, entradaUltrapassa);
    }

    function renderResultadoEstimado(valorImovel, financiamento, fgts, entradaTotal, ato, mensal, prazo, qtdInter, valorInter, ultrapassa, saldoRestante, usouAtoDefault, entradaUltrapassa) {
        const resDiv = document.getElementById('fluxoResultado');
        const hoje = new Date();
        const previsao = new Date(hoje.getFullYear(), hoje.getMonth() + prazo, 1);
        const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const previsaoTexto = `${mesesNomes[previsao.getMonth()]}/${previsao.getFullYear().toString().substr(-2)}`;

        let interHtml = '';
        if (qtdInter > 0) {
            interHtml = `<div class="fluxo-row"><span class="fluxo-label">Intermedi√°rias/Anuais (${qtdInter}x)</span><span class="fluxo-valor">${formatMoney(valorInter)}</span></div>`;
        }

        resDiv.innerHTML = `
            <div class="fluxo-card fade-in">
                <div class="fluxo-header">
                    <h4>üìã Fluxo de Pagamento - ${prazo} meses</h4>
                    <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
                </div>
                <div class="fluxo-body">
                    <div class="fluxo-row"><span class="fluxo-label">Valor do Im√≥vel</span><span class="fluxo-valor" style="color: #000;">${formatMoney(valorImovel)}</span></div>
                    <div class="fluxo-row"><span class="fluxo-label">Financiamento Estimado</span><span class="fluxo-valor color-laranja">${formatMoney(financiamento)}</span></div>
                    ${fgts > 0 ? `<div class="fluxo-row"><span class="fluxo-label">FGTS</span><span class="fluxo-valor color-laranja">${formatMoney(fgts)}</span></div>` : ''}
                    
                    <div class="fluxo-destaque">
                        <span class="label">Entrada Total - Parcelamento no Per√≠odo de Obras</span>
                        <span class="valor">${formatMoney(entradaTotal)}</span>
                    </div>

                    <div class="fluxo-secao">
                        <div class="fluxo-secao-titulo"><i data-lucide="credit-card"></i> Divis√£o do Pagamento</div>
                        <div class="fluxo-row"><span class="fluxo-label">Ato (Sinal)</span><span class="fluxo-valor">${formatMoney(ato)}</span></div>
                        ${interHtml}
                        <div class="fluxo-row"><span class="fluxo-label">Parcelas Mensais (${prazo}x)</span><span class="fluxo-valor">${entradaUltrapassa ? 'R$ 0,00' : formatMoney(mensal)}</span></div>
                        ${saldoRestante > 0 && !entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante (P√≥s-Chaves)</span><span class="fluxo-valor" style="color: var(--danger)">${formatMoney(saldoRestante)}</span></div>` : ''}
                        ${entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger); font-weight: 700;">Verificar P√≥s-Chaves</span></div>` : ''}
                    </div>
                    
                    ${entradaUltrapassa ? `<div class="alerta-box" style="background: #fee2e2; border-color: #ef4444;">
                        <i data-lucide="alert-triangle" style="color: #ef4444;"></i>
                        <span style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è Fluxo de Entrada Ultrapassa o valor do im√≥vel. Verificar</span>
                    </div>` : ''}

                    <div class="alerta-box ${ultrapassa && !entradaUltrapassa ? 'aviso' : (!entradaUltrapassa ? 'sucesso' : '')}" ${entradaUltrapassa ? 'style="display: none;"' : ''}>
                        <i data-lucide="${ultrapassa ? 'alert-circle' : 'check-circle'}"></i>
                        ${ultrapassa 
                            ? '‚ö†Ô∏è Fluxo de Pagamento da Entrada ultrapassa o Per√≠odo de Obras. Verifique com corretor/construtora a possibilidade de Pagamento P√≥s-Chaves.' 
                            : '‚úÖ Fluxo de Pagamento da Entrada dentro do Per√≠odo de Obras.'}
                    </div>
                    
                    <div class="obs-box">
                        <strong>üìå Observa√ß√µes:</strong>
                        <ul>
                            <li>Utilizando como limitadores: <strong>30% da renda</strong> para parcelas mensais e <strong>100% da renda</strong> para parcelas intermedi√°rias/anuais.</li>
                            ${usouAtoDefault ? '<li>Estipulado <strong>R$ 1.000,00</strong> de ato (valor m√≠nimo sugerido).</li>' : ''}
                            <li>Valores s√£o estimativas e para fins educativos. <strong>Consulte seu corretor para valores reais</strong>.</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <button id="btnResetarFluxo" class="btn btn-danger-real" style="max-width: 300px;">üîÑ RESETAR FLUXO</button>
                    </div>
                </div>
            </div>
        `;
        resDiv.classList.remove('hidden');
        document.getElementById('blocosExtras').classList.remove('hidden');
        resDiv.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
        
        // Reanexa o event listener do bot√£o resetar
        const btnReset = document.getElementById('btnResetarFluxo');
        if (btnReset) {
            btnReset.onclick = resetarFluxo;
        }
    }

    function calcularFluxoDetalhado() {
        limparResultadosINCC_Juros(); // Limpa INCC e Juros ao recalcular
        const d = state.dadosDiagnostico;
        if (!d) return alert('Gere a an√°lise de perfil primeiro.');

        const valorReal = parseMoney(document.getElementById('valorReal').value);
        const valorAval = parseMoney(document.getElementById('valorAvaliacao').value);
        const financiamentoAprovado = parseMoney(document.getElementById('financiamentoAprovado').value);
        const subsidio = document.getElementById('temSubsidio').value === 'sim' ? parseMoney(document.getElementById('subsidioVal').value) : 0;
        let valorAto = parseMoney(document.getElementById('valorAtoDet').value);
        const atoOriginal = valorAto;
        const atoAjustado = valorAto === 0;
        if (valorAto === 0) valorAto = 1000; // M√≠nimo de R$ 1.000
        const prazo = parseInt(document.getElementById('prazoObraDet').value);
        const temInterm = document.getElementById('temInterDet').value === 'sim';
        const aceitaPos = document.getElementById('aceitaPosChaves').value === 'sim';

        if (!valorReal || !financiamentoAprovado || !prazo) return alert('Preencha os valores e selecione o prazo');

        const entradaTotal = valorReal - financiamentoAprovado - d.fgts - subsidio;
        
        // Valida√ß√£o: Se entrada total for negativa ou zero, significa que os inputs ultrapassam o valor do im√≥vel
        const inputsTotal = financiamentoAprovado + d.fgts + subsidio;
        const entradaUltrapassa = inputsTotal >= valorReal;
        
        let somaInter = 0;
        let intermediarias = [];
        if (temInterm) {
            const dates = document.querySelectorAll('.inter-date');
            const vals = document.querySelectorAll('.inter-val');
            dates.forEach((dateEl, idx) => {
                const val = parseMoney(vals[idx].value);
                somaInter += val;
                intermediarias.push({ data: dateEl.value, valor: val });
            });
        }

        const saldoParaMensais = entradaTotal - valorAto - somaInter;
        const parcelaMensalCalculada = Math.max(0, saldoParaMensais / prazo);
        const limiteMensal = d.rendaTotal * 0.30;
        const parcelaMensal = Math.min(parcelaMensalCalculada, limiteMensal);
        const ultrapassa = parcelaMensalCalculada > limiteMensal;
        const saldoRestante = ultrapassa ? (parcelaMensalCalculada - limiteMensal) * prazo : 0;

        state.ultimoCalculo = {
            valorImovel: valorReal, financiamento: financiamentoAprovado, fgts: d.fgts, subsidio, entradaTotal, 
            ato: valorAto, mensal: parcelaMensal, prazo, ultrapassa, somaInter, aceitaPos, intermediarias, entradaUltrapassa, saldoRestante, atoAjustado
        };

        renderResultadoDetalhado(valorReal, financiamentoAprovado, d.fgts, subsidio, entradaTotal, valorAto, parcelaMensal, prazo, intermediarias, ultrapassa, aceitaPos, entradaUltrapassa, saldoRestante, atoAjustado);
    }

    function renderResultadoDetalhado(valorImovel, financiamento, fgts, subsidio, entradaTotal, ato, mensal, prazo, intermediarias, ultrapassa, aceitaPos, entradaUltrapassa, saldoRestante, atoAjustado) {
        const resDiv = document.getElementById('fluxoResultado');
        const hoje = new Date();
        const previsao = new Date(hoje.getFullYear(), hoje.getMonth() + prazo, 1);
        const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const previsaoTexto = `${mesesNomes[previsao.getMonth()]}/${previsao.getFullYear().toString().substr(-2)}`;

        let interHtml = '';
        if (intermediarias.length > 0) {
            const valores = intermediarias.map(i => i.valor);
            const todosIguais = valores.every(v => v === valores[0]);
            const textoValores = todosIguais ? formatMoney(valores[0]) : valores.map(v => formatMoney(v)).join(' | ');
            interHtml = `<div class="fluxo-row"><span class="fluxo-label">Intermedi√°rias/Anuais (${intermediarias.length}x)</span><span class="fluxo-valor">${textoValores}</span></div>`;
        }

        resDiv.innerHTML = `
            <div class="fluxo-card fade-in">
                <div class="fluxo-header">
                    <h4>üìã Fluxo de Pagamento - ${prazo} meses</h4>
                    <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
                </div>
                <div class="fluxo-body">
                    <div class="fluxo-row"><span class="fluxo-label">Valor do Im√≥vel</span><span class="fluxo-valor" style="color: #000;">${formatMoney(valorImovel)}</span></div>
                    <div class="fluxo-row"><span class="fluxo-label">Financiamento</span><span class="fluxo-valor color-laranja">${formatMoney(financiamento)}</span></div>
                    ${fgts > 0 ? `<div class="fluxo-row"><span class="fluxo-label">FGTS</span><span class="fluxo-valor color-laranja">${formatMoney(fgts)}</span></div>` : ''}
                    ${subsidio > 0 ? `<div class="fluxo-row"><span class="fluxo-label">Subs√≠dio</span><span class="fluxo-valor color-laranja">${formatMoney(subsidio)}</span></div>` : ''}
                    
                    <div class="fluxo-destaque">
                        <span class="label">Entrada Total - Parcelamento no Per√≠odo de Obras</span>
                        <span class="valor">${formatMoney(entradaTotal)}</span>
                    </div>

                    <div class="fluxo-secao">
                        <div class="fluxo-secao-titulo"><i data-lucide="credit-card"></i> Divis√£o do Pagamento</div>
                        ${ato > 0 ? `<div class="fluxo-row"><span class="fluxo-label">Ato (Sinal)</span><span class="fluxo-valor">${formatMoney(ato)}</span></div>` : ''}
                        ${interHtml}
                        <div class="fluxo-row"><span class="fluxo-label">Parcelas Mensais (${prazo}x)</span><span class="fluxo-valor">${entradaUltrapassa ? 'R$ 0,00' : formatMoney(mensal)}</span></div>
                        ${ultrapassa && !entradaUltrapassa && saldoRestante > 0 ? `<div class="fluxo-row"><span class="fluxo-label" style="color: var(--danger)">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger); font-weight: 700;">${formatMoney(saldoRestante)}</span></div>` : ''}
                        ${entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger); font-weight: 700;">Verificar P√≥s-Chaves</span></div>` : ''}
                    </div>
                    
                    ${entradaUltrapassa ? `<div class="alerta-box" style="background: #fee2e2; border-color: #ef4444;">
                        <i data-lucide="alert-triangle" style="color: #ef4444;"></i>
                        <span style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è Fluxo de Entrada Ultrapassa o valor do im√≥vel. Verificar</span>
                    </div>` : ''}

                    <div class="alerta-box ${ultrapassa && !entradaUltrapassa ? 'aviso' : (!entradaUltrapassa ? 'sucesso' : '')}" ${entradaUltrapassa ? 'style="display: none;"' : ''}>
                        <i data-lucide="${ultrapassa ? 'alert-circle' : 'check-circle'}"></i>
                        ${ultrapassa 
                            ? '‚ö†Ô∏è Fluxo de Pagamento da Entrada ultrapassa o Per√≠odo de Obras.<br><span style="font-size: 12px; font-weight: 400; margin-top: 4px; display: block;">Verificar com construtora pagamento no p√≥s-chaves, ou necess√°rio aumentar valor do ato.</span>' 
                            : '‚úÖ Fluxo de Pagamento da Entrada dentro do Per√≠odo de Obras.'}
                    </div>
                    
                    ${atoAjustado ? `<div class="alerta-box" style="background: #eff6ff; border-color: #3b82f6;">
                        <i data-lucide="info" style="color: #3b82f6;"></i>
                        <span style="color: #1e40af; font-size: 12px;">üìå Como o valor do ato estava zerado, foi ajustado para o m√≠nimo de R$ 1.000,00.</span>
                    </div>` : ''}
                    
                    <div class="alerta-box" style="background: #eff6ff; border-color: #3b82f6;">
                        <i data-lucide="info" style="color: #3b82f6;"></i>
                        <span style="color: #1e40af; font-size: 12px;">üìå As parcelas mensais da entrada s√£o limitadas a 30% da renda mensal total.</span>
                    </div>
                    
                    <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <button id="btnResetarFluxo" class="btn btn-danger-real" style="max-width: 300px;">üîÑ RESETAR FLUXO</button>
                    </div>
                </div>
            </div>
        `;
        resDiv.classList.remove('hidden');
        document.getElementById('blocosExtras').classList.remove('hidden');
        resDiv.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
        
        // Reanexa o event listener do bot√£o resetar
        const btnReset = document.getElementById('btnResetarFluxo');
        if (btnReset) {
            btnReset.onclick = resetarFluxo;
        }
    }

    function toggleBloco(tipo) {
        const tipoMap = { 'incc': 'INCC', 'juros': 'Juros', 'pdf': 'PDF' };
        const tipoId = tipoMap[tipo];
        const conteudo = document.getElementById(`conteudo${tipoId}`);
        const toggle = document.getElementById(`toggle${tipoId}`);
        if (conteudo && toggle) {
            conteudo.classList.toggle('open');
            toggle.classList.toggle('open');
        }
    }

    function calcularINCC() {
        if (!state.ultimoCalculo) return alert('Calcule o fluxo de entrada primeiro.');
        
        const taxa = parseFloat(document.getElementById('inccTaxa').value) / 100 || 0.005;
        const { mensal, prazo, intermediarias = [], qtdInter = 0, valorInter = 0, ato, aceitaPos = false } = state.ultimoCalculo;
        
        // C√°lculo INCC Correto: Amortiza√ß√£o sobre Saldo Devedor
        const totalSemCorrecao = mensal * prazo;
        let saldo = totalSemCorrecao;
        let primeiraParcela = 0;
        let ultimaParcela = 0;
        let parcelaAnterior = mensal;
        let somaAumentos = 0;
        
        for (let mes = 1; mes <= prazo; mes++) {
            saldo = saldo * (1 + taxa);
            const parcelaMes = saldo / (prazo - mes + 1);
            if (mes === 1) primeiraParcela = parcelaMes;
            if (mes === prazo) ultimaParcela = parcelaMes;
            
            // Calcular o aumento em rela√ß√£o √† parcela anterior
            const aumentoMes = parcelaMes - parcelaAnterior;
            somaAumentos += aumentoMes;
            parcelaAnterior = parcelaMes;
            
            saldo -= parcelaMes;
        }
        
        // Aumento m√©dio por parcela
        const aumentoMedio = somaAumentos / prazo;
        
        let htmlInter = '';
        let interCorrigidas = [];
        if (intermediarias.length > 0) {
            // L√≥gica de Saldo Devedor Progressivo (Escada de Corre√ß√£o) para Detalhado
            const hoje = new Date();
            const totalInterBase = intermediarias.reduce((s, i) => s + i.valor, 0);
            let saldoDevedorInter = totalInterBase;
            let mesesAnteriores = 0;

            intermediarias.forEach((inter, idx) => {
                const [mesAno, anoAno] = inter.data.split('/');
                const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                const mesIdx = mesesNomes.indexOf(mesAno);
                const ano = 2000 + parseInt(anoAno);
                const dataPgto = new Date(ano, mesIdx, 1);
                
                let mesesAte = (dataPgto.getFullYear() - hoje.getFullYear()) * 12 + (dataPgto.getMonth() - hoje.getMonth());
                mesesAte = Math.max(0, mesesAte);
                
                const diffMeses = mesesAte - mesesAnteriores;
                saldoDevedorInter = saldoDevedorInter * Math.pow(1 + taxa, diffMeses);
                
                const qtdRestante = intermediarias.length - idx;
                const valorParcela = saldoDevedorInter / qtdRestante;
                
                interCorrigidas.push({ ordem: idx + 1, valor: inter.valor, corrigido: valorParcela, meses: mesesAte });
                
                saldoDevedorInter = saldoDevedorInter - valorParcela;
                mesesAnteriores = mesesAte;
            });
            
            // Gerar string com valores em contrato (podem ser diferentes no modo Detalhado)
            const valoresContrato = interCorrigidas.map(ic => formatMoney(ic.valor)).join(' | ');
            
            htmlInter = `
                <div class="incc-secao">
                    <div class="incc-secao-titulo"><i data-lucide="calendar-check"></i> Intermedi√°rias</div>
                    <div class="incc-row"><span class="incc-label">Valor em Contrato</span><span class="incc-valor">${valoresContrato}</span></div>
            `;
            interCorrigidas.forEach(ic => {
                htmlInter += `<div class="incc-row"><span class="incc-label">${ic.ordem}¬™ Parcela Corrigida</span><span class="incc-valor">${formatMoney(ic.corrigido)}</span></div>`;
            });
            htmlInter += `</div>`;
        } else if (qtdInter > 0 && valorInter > 0) {
            // C√°lculo INCC para Intermedi√°rias Autom√°ticas (Modo Estimada)
            let mesesCorrecao = [];
            if (prazo === 12) {
                mesesCorrecao = [12];
            } else if (prazo === 24) {
                mesesCorrecao = [12, 24];
            } else if (prazo === 30) {
                mesesCorrecao = [12, 24, 30];
            } else if (prazo === 36) {
                mesesCorrecao = [12, 24, 36];
            }
            
            // L√≥gica de Saldo Devedor Progressivo (Escada de Corre√ß√£o)
            let totalInterBase = valorInter * qtdInter;
            let saldoDevedorInter = totalInterBase;
            let mesesAnteriores = 0;

            for (let i = 0; i < qtdInter; i++) {
                const mesesAte = mesesCorrecao[i] || (i + 1) * 12;
                const diffMeses = mesesAte - mesesAnteriores;
                
                saldoDevedorInter = saldoDevedorInter * Math.pow(1 + taxa, diffMeses);
                const qtdRestante = qtdInter - i;
                const valorParcela = saldoDevedorInter / qtdRestante;
                
                interCorrigidas.push({ 
                    ordem: i + 1, 
                    valor: valorInter, 
                    corrigido: valorParcela, 
                    meses: mesesAte 
                });
                
                saldoDevedorInter = saldoDevedorInter - valorParcela;
                mesesAnteriores = mesesAte;
            }
            
            // Gerar string com valores em contrato (no Estimado s√£o todos iguais = 100% renda)
            const valoresContrato = interCorrigidas.map(ic => formatMoney(ic.valor)).join(' | ');
            
            htmlInter = `
                <div class="incc-secao">
                    <div class="incc-secao-titulo"><i data-lucide="calendar-check"></i> Intermedi√°rias</div>
                    <div class="incc-row"><span class="incc-label">Valor em Contrato</span><span class="incc-valor">${valoresContrato}</span></div>
            `;
            interCorrigidas.forEach(ic => {
                htmlInter += `<div class="incc-row"><span class="incc-label">${ic.ordem}¬™ Parcela Corrigida (${ic.meses} meses)</span><span class="incc-valor">${formatMoney(ic.corrigido)}</span></div>`;
            });
            htmlInter += `</div>`;
        }
        
        let htmlPosObra = '';
        if (aceitaPos) {
            htmlPosObra = `
                <div class="incc-secao">
                    <div class="incc-secao-titulo"><i data-lucide="home"></i> Saldo P√≥s-Obra</div>
                    <div class="incc-row"><span class="incc-label" style="font-size: 13px;">Verificar com corretor a forma de corre√ß√£o do saldo p√≥s-chaves.</span></div>
                </div>
            `;
        }
        
        const html = `
            <div class="incc-secao">
                <div class="incc-secao-titulo"><i data-lucide="calendar"></i> Parcelas Mensais</div>
                <div class="incc-row"><span class="incc-label">Valor em Contrato (cada)</span><span class="incc-valor">${formatMoney(mensal)}</span></div>
                <div class="incc-row"><span class="incc-label">Aumento m√©dio a cada nova parcela</span><span class="incc-valor">+${formatMoney(aumentoMedio)}</span></div>
                <div class="incc-row"><span class="incc-label">√öltima Parcela Estimada</span><span class="incc-valor">${formatMoney(ultimaParcela)}</span></div>
            </div>
            ${htmlInter}
            ${htmlPosObra}
            <div class="obs-box" style="margin-top: 16px;">
                * Valores aproximados para fins de simula√ß√£o e entendimento.<br>
                * INCC atualizado dispon√≠vel em: <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank">portal.fgv.br/noticias/incc-m-2025</a>
            </div>
        `;
        
        // Armazena os resultados para o PDF
        state.inccResultado = {
            taxa: taxa * 100,
            mensal: { original: mensal, aumentoMedio, ultimaParcela },
            intermediarias: htmlInter ? true : false,
            interValues: interCorrigidas.map(ic => ic.corrigido),
            posObra: htmlPosObra ? true : false
        };
        
        document.getElementById('resultadoINCC').innerHTML = html;
        document.getElementById('resultadoINCC').classList.remove('hidden');
        state.inccCalculado = true;
        checkPDFVisibility();
        lucide.createIcons();
    }

    function calcularJuros() {
        if (!state.ultimoCalculo) return alert('Calcule o fluxo de entrada primeiro.');
        
        const financiamento = state.ultimoCalculo.financiamento;
        const taxaEfetiva = state.dadosDiagnostico.taxa;
        const tr = parseFloat(document.getElementById('trTaxa').value) || 0;
        const taxas = parseMoney(document.getElementById('taxasAdm').value);
        const passo = parseInt(document.getElementById('passoTabela').value) || 10;
        
        const jurosMensal = (taxaEfetiva / 100) / 12;
        const trMensal = tr / 100;
        
        const percList = [];
        for (let p = passo; p <= 100; p += passo) percList.push(p);
        if (percList[percList.length - 1] !== 100) percList.push(100);
        
        const rows = percList.map(perc => {
            const liberado = financiamento * (perc / 100);
            // Aplica TR primeiro
            const liberadoComTR = liberado * (1 + trMensal);
            // Depois aplica a taxa de juros mensal sobre o valor corrigido pela TR
            const juros = liberadoComTR * jurosMensal;
            const parcela = juros + taxas;
            return { perc, parcela };
        });
        
        let html = `
            <table class="juros-table">
                <thead>
                    <tr>
                        <th>% da Obra</th>
                        <th>Parcela Estimada (m√™s)</th>
                    </tr>
                </thead>
                <tbody>
        `;
        rows.forEach(r => {
            html += `<tr><td><strong>${r.perc}%</strong></td><td>${formatMoney(r.parcela)}</td></tr>`;
        });
        html += `
                </tbody>
            </table>
            <div class="obs-box" style="margin-top: 16px;">
                * Valores aproximados para fins de simula√ß√£o e entendimento.<br>
                * Valor estimado de <strong>${formatMoney(taxas)}</strong> para taxas administrativas e seguros obrigat√≥rios (MIP/DFI).<br>
                * A TR possui varia√ß√£o mensal. Valor utilizado apenas para fins estimativos.<br>
                * Consulta da TR atualizada: <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank">debit.com.br/tabelas/tr-bacen</a>
            </div>
        `;
        
        // Armazena os resultados para o PDF
        state.jurosResultado = {
            taxaEfetiva,
            tr,
            taxas,
            passo,
            rows
        };
        
        document.getElementById('resultadoJuros').innerHTML = html;
        document.getElementById('resultadoJuros').classList.remove('hidden');
        state.jurosCalculado = true;
        checkPDFVisibility();
    }

    function checkPDFVisibility() {
        // Bot√£o de PDF agora √© nativo e sempre vis√≠vel
    }
    
    function resetarFluxo() {
        // Limpa os resultados de fluxo, INCC, Juros e PDF
        document.getElementById('fluxoResultado').classList.add('hidden');
        document.getElementById('fluxoResultado').innerHTML = '';
        document.getElementById('blocoINCC').classList.add('hidden');
        document.getElementById('blocoJuros').classList.add('hidden');
        document.getElementById('blocoPDF').classList.add('hidden');
        
        // Reseta os estados
        state.ultimoCalculo = null;
        state.inccCalculado = false;
        state.jurosCalculado = false;
        
        // Limpa os campos de entrada
        document.getElementById('valorImovelEstimado').value = '';
        document.getElementById('valorReal').value = '';
        document.getElementById('valorAvaliacao').value = '';
        document.getElementById('financiamentoAprovado').value = '';
        document.getElementById('valorAto').value = '';
        document.getElementById('prazoObraDet').value = '';
        document.getElementById('temInterDet').value = '';
        document.getElementById('boxQtdInter').classList.add('hidden');
        document.getElementById('containerInterItems').classList.add('hidden');
        document.getElementById('temSubsidio').value = '';
        document.getElementById('boxSubsidioVal').classList.add('hidden');
        document.getElementById('aceitaPosChaves').value = '';
        
        // Scroll para o in√≠cio da se√ß√£o de simula√ß√£o
        document.getElementById('escolhaSimulacao').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function limparResultadosINCC_Juros() {
        // Limpa os resultados de INCC e Juros quando o fluxo √© recalculado
        document.getElementById('resultadoINCC').innerHTML = '';
        document.getElementById('resultadoINCC').classList.add('hidden');
        document.getElementById('resultadoJuros').innerHTML = '';
        document.getElementById('resultadoJuros').classList.add('hidden');
        document.getElementById('blocoPDF').classList.add('hidden');
        
        state.inccCalculado = false;
        state.jurosCalculado = false;
    }

    function gerarPDF() {
        if (!state.ultimoCalculo) return alert('Calcule o fluxo de entrada primeiro.');
        
        // Acesso robusto √† biblioteca jsPDF (UMD)
        const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
        if (!jsPDFLib) return alert('A biblioteca de PDF ainda n√£o foi carregada. Por favor, aguarde um instante ou verifique sua conex√£o.');
        
        const doc = new jsPDFLib({ unit: "mm", format: "a4" });
        
        const dataDoc = new Date().toLocaleDateString("pt-BR");
        const d = state.dadosDiagnostico;
        const calc = state.ultimoCalculo;
        
        // Cores simplificadas
        const azulEscuro = [30, 58, 138];
        const cinzaClaro = [243, 244, 246];
        const cinzaMedio = [156, 163, 175];
        
        let y = 15;
        const left = 14;
        const right = 196;
        const pageWidth = 210;
        
        // ===== CABE√áALHO =====
        doc.setTextColor(...azulEscuro);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("SIMULA√á√ÉO FINANCEIRA - IM√ìVEL NA PLANTA", 105, y, { align: "center" });
        y += 6;
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0);
        doc.text("Programa Minha Casa Minha Vida", 105, y, { align: "center" });
        y += 8;
        
        doc.setFontSize(9);
        doc.text(`${dataDoc}`, 105, y, { align: "center" });
        y += 8;
        
        doc.setDrawColor(...cinzaMedio);
        doc.line(left, y, right, y);
        y += 8;
        
        // ===== BLOCO 1: AN√ÅLISE DE PERFIL MCMV =====
        doc.setTextColor(...azulEscuro);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("1. AN√ÅLISE DE PERFIL MCMV", left, y);
        y += 6;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        doc.setFont("helvetica", "bold"); doc.text("Faixa MCMV:", left + 3, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${d.faixa}`, left + 35, y); y += 5;
        
        doc.setFont("helvetica", "bold"); doc.text("Taxa de Juros:", left + 3, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${d.taxa.toFixed(2)}% ao ano`, left + 35, y); y += 5;
        
        doc.setFont("helvetica", "bold"); doc.text("Teto de Financiamento:", left + 3, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${formatMoney(d.teto)}`, left + 45, y); y += 5;
        
        doc.setFont("helvetica", "bold"); doc.text("Capacidade de Financiamento:", left + 3, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${formatMoney(d.capFinanciamento)}`, left + 55, y); y += 5;
        
        doc.setFont("helvetica", "bold"); doc.text("Renda Total:", left + 3, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${formatMoney(d.rendaTotal)}`, left + 35, y); 
        
        doc.setFont("helvetica", "bold"); doc.text("FGTS Dispon√≠vel:", left + 95, y); 
        doc.setFont("helvetica", "normal"); doc.text(`${formatMoney(d.fgts)}`, left + 125, y); y += 8;
        
        doc.setDrawColor(...cinzaMedio);
        doc.line(left, y, right, y);
        y += 6;
        
        // ===== BLOCO 2: FLUXO DE PAGAMENTO =====
        doc.setTextColor(...azulEscuro);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("2. FLUXO DE PAGAMENTO", left, y);
        y += 6;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        // Valor do Im√≥vel e Financiamento
        const isDetalhada = calc.subsidio !== undefined;
        const labelImovel = `Valor do Im√≥vel ${isDetalhada ? '(Real)' : '(Pretendido)'}:`;
        doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text(labelImovel, left + 3, y);
        doc.setFont("helvetica", "normal"); doc.text(formatMoney(calc.valorImovel), left + 65, y); y += 5;
        
        if (isDetalhada && calc.valorAvaliacao) {
            doc.setFont("helvetica", "bold"); doc.text("Valor de Avalia√ß√£o:", left + 3, y);
            doc.setFont("helvetica", "normal"); doc.text(formatMoney(calc.valorAvaliacao), left + 45, y); y += 5;
        }
        
        const labelFin = `Financiamento ${isDetalhada ? 'Aprovado' : 'Estimado'}:`;
        doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text(labelFin, left + 3, y);
        doc.setFont("helvetica", "normal"); doc.setTextColor(245, 158, 11); doc.text(formatMoney(calc.financiamento), left + 65, y); y += 5;
        
        if (state.inccCalculado) {
            doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text("Financiamento Estimado com INCC:", left + 3, y);
            doc.setFont("helvetica", "normal"); doc.setTextColor(245, 158, 11); doc.text(formatMoney(calc.financiamento), left + 65, y); y += 5;
        }
        
        if (calc.fgts > 0) {
            doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text("FGTS Utilizado:", left + 3, y);
            doc.setFont("helvetica", "normal"); doc.setTextColor(245, 158, 11); doc.text(formatMoney(calc.fgts), left + 65, y); y += 5;
        }
        
        if (calc.subsidio && calc.subsidio > 0) {
            doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text("Subs√≠dio do Governo:", left + 3, y);
            doc.setFont("helvetica", "normal"); doc.setTextColor(245, 158, 11); doc.text(formatMoney(calc.subsidio), left + 65, y); y += 5;
        }
        
        y += 3;
        
        // Destaque para Entrada Total
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text("ENTRADA TOTAL:", left + 3, y);
        doc.setTextColor(5, 150, 105);
        doc.text(formatMoney(calc.entradaTotal), left + 45, y);
        doc.setTextColor(0, 0, 0);
        y += 7;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        // Divis√£o do Pagamento
        doc.setFont("helvetica", "bold");
        doc.text("Divis√£o do Pagamento:", left + 3, y); y += 5;
        doc.setFont("helvetica", "normal");
        
        if (calc.ato > 0) {
            doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text("‚Ä¢ Ato (Sinal):", left + 5, y);
            doc.setFont("helvetica", "normal"); doc.setTextColor(5, 150, 105); doc.text(formatMoney(calc.ato), left + 45, y); y += 5;
        }
        
        // Intermedi√°rias
        if (calc.intermediarias && calc.intermediarias.length > 0) {
            calc.intermediarias.forEach((inter, idx) => {
                doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text(`‚Ä¢ ${idx + 1}¬™ Intermedi√°ria (${inter.data}):`, left + 5, y);
                doc.setFont("helvetica", "normal"); doc.setTextColor(5, 150, 105); doc.text(formatMoney(inter.valor), left + 65, y); y += 5;
            });
        } else if (calc.qtdInter > 0 && calc.valorInter > 0) {
            for (let i = 1; i <= calc.qtdInter; i++) {
                doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text(`‚Ä¢ ${i}¬™ Intermedi√°ria:`, left + 5, y);
                doc.setFont("helvetica", "normal"); doc.setTextColor(5, 150, 105); doc.text(formatMoney(calc.valorInter), left + 65, y); y += 5;
            }
        }
        
        doc.setFont("helvetica", "bold"); doc.setTextColor(0, 0, 0); doc.text(`‚Ä¢ Parcelas Mensais (${calc.prazo}x):`, left + 5, y);
        doc.setFont("helvetica", "normal"); doc.setTextColor(5, 150, 105); doc.text(formatMoney(calc.mensal), left + 65, y); y += 5;
        
        if (calc.saldoRestante && calc.saldoRestante > 0) {
            doc.setFont("helvetica", "bold"); doc.setTextColor(239, 68, 68);
            doc.text(`‚Ä¢ Saldo para P√≥s-Chaves: ${formatMoney(calc.saldoRestante)}`, left + 5, y); y += 5;
            doc.setTextColor(0, 0, 0);
        }
        
        y += 3;
        
        // Continua na pr√≥xima p√°gina se necess√°rio
        if (y > 240) {
            doc.addPage();
            y = 20;
        }
        
        // ===== BLOCO 3: ESTIMATIVA DE INCC =====
        if (state.inccCalculado) {
            doc.setDrawColor(...cinzaMedio);
            doc.line(left, y, right, y);
            y += 6;
            
            doc.setTextColor(...azulEscuro);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text("3. ESTIMATIVA DE INCC", left, y);
            y += 6;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const incc = state.inccResultado;
            doc.text(`Taxa Mensal Utilizada: ${incc.taxa.toFixed(2)}%`, left + 3, y); y += 7;
            
            // Parcelas Mensais
            doc.setFont("helvetica", "bold");
            doc.text("Parcelas Mensais:", left + 3, y); y += 5;
            doc.setFont("helvetica", "normal");
            doc.text(`1¬™ Parcela Mensal: ${formatMoney(incc.mensal.original)}`, left + 5, y); y += 5;
            // Arredondamento para dezena superior na √∫ltima parcela
            const ultimaParcelaArred = Math.ceil(incc.mensal.ultimaParcela / 10) * 10;
            doc.text(`${calc.prazo}¬™ Parcela Mensal (Estimada c/ INCC): ${formatMoney(ultimaParcelaArred)}`, left + 5, y); y += 7;
            
            if (incc.intermediarias) {
                doc.setFont("helvetica", "bold");
                doc.text("Intermedi√°rias/Anuais:", left + 3, y); y += 5;
                doc.setFont("helvetica", "normal");
                
                // Pegamos os valores corrigidos do estado
                const inters = state.inccResultado.interValues || [];
                const interDisplay = inters.map(v => {
                    const vArred = Math.ceil(v / 10) * 10;
                    return formatMoney(vArred);
                }).join(" | ");
                
                doc.text(`Intermedi√°rias/Anuais (Estimada c/ INCC): ${interDisplay}`, left + 5, y); y += 7;
            }
            
            if (incc.posObra) {
                doc.setFont("helvetica", "bold");
                doc.text("P√≥s-Obra: Verificar com corretor a forma de corre√ß√£o", left + 3, y); y += 7;
            }
            
            doc.setFont("helvetica", "italic");
            doc.setFontSize(8);
            doc.text("* Valores aproximados para fins de simula√ß√£o e entendimento.", left + 3, y); y += 8;
        }
        
        // ===== BLOCO 4: JUROS DE OBRA =====
        if (state.jurosCalculado) {
            if (y > 200) {
                doc.addPage();
                y = 20;
            }
            
            doc.setDrawColor(...cinzaMedio);
            doc.line(left, y, right, y);
            y += 6;
            
            doc.setTextColor(...azulEscuro);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text("4. TABELA DE JUROS DE OBRA (5 em 5%)", left, y);
            y += 6;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const juros = state.jurosResultado;
            doc.text(`Taxa Efetiva: ${juros.taxaEfetiva.toFixed(2)}% ao ano | TR: ${juros.tr.toFixed(2)}% | Taxas/Seguros: ${formatMoney(juros.taxas)}`, left + 3, y); y += 7;
            
            // Tabela
            doc.setFont("helvetica", "bold");
            doc.setFontSize(8);
            doc.text("% da Obra", left + 10, y);
            doc.text("Parcela Estimada (m√™s)", left + 100, y);
            y += 4;
            
            doc.setDrawColor(200);
            doc.line(left + 5, y, right - 5, y);
            y += 4;
            
            doc.setFont("helvetica", "normal");
            juros.rows.forEach((row, idx) => {
                // Zebrado
                if (idx % 2 === 0) {
                    doc.setFillColor(...cinzaClaro);
                    doc.rect(left + 5, y - 3, right - left - 10, 5, 'F');
                }
                
                doc.text(`${row.perc}%`, left + 15, y);
                doc.text(formatMoney(row.parcela), left + 100, y);
                y += 5;
                
                // Nova p√°gina se necess√°rio
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            y += 3;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(7);
            doc.text("* Valores aproximados. A TR possui varia√ß√£o mensal.", left + 3, y); y += 5;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(7);
            doc.text("* C√°lculos e estimativas s√£o apenas para fins de consci√™ncia e planejamento financeiro, auxiliando o comprador a evitar surpresas.", left + 3, y); y += 8;
        }
        
        // ===== BLOCO 5: OBSERVA√á√ïES =====
        if (y > 230) {
            doc.addPage();
            y = 20;
        }
        
        doc.setDrawColor(...cinzaMedio);
        doc.line(left, y, right, y);
        y += 6;
        
        doc.setTextColor(...azulEscuro);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("5. OBSERVA√á√ïES", left, y);
        y += 6;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        
        const obs = [
            "‚Ä¢ Este documento √© uma simula√ß√£o para fins educativos e estimativas financeiras.",
            "‚Ä¢ Valores reais, condi√ß√µes de pagamento e detalhes dever√£o ser verificados com o corretor respons√°vel.",
            "‚Ä¢ A aprova√ß√£o do financiamento est√° sujeita √† an√°lise da institui√ß√£o financeira.",
            "‚Ä¢ Valores de INCC e Juros de Obra s√£o estimativas baseadas em taxas m√©dias.",
            "‚Ä¢ Consulte sempre seu corretor para valores atualizados e condi√ß√µes reais do empreendimento."
        ];
        
        obs.forEach(texto => {
            doc.text(texto, left + 3, y); y += 5;
        });
        
        // ===== RODAP√â =====
        y += 5;
        doc.setDrawColor(...cinzaMedio);
        doc.line(left, y, right, y);
        y += 4;
        
        doc.setTextColor(...cinzaMedio);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.text("Raul Mendes Imobili√°ria | Instagram: @raulmendes.imob", 105, y, { align: "center" });
        
        doc.save("Simula√ß√£o Imobiliaria MCMV.pdf");
        alert('‚úÖ PDF gerado com sucesso!');
    }

    function setupMasks() {
        document.querySelectorAll('.money-mask').forEach(input => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (!value) { e.target.value = ''; return; }
                value = (value / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                e.target.value = value;
            });
        });
    }

    function parseMoney(text) { if (!text) return 0; return parseFloat(text.replace(/[^\d,]/g, '').replace(',', '.')) || 0; }
    function formatMoney(value) { return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    
    // Fun√ß√£o para validar se todos os campos necess√°rios est√£o preenchidos
    function validarCamposDiagnostico() {
        const r1 = parseMoney(document.getElementById('renda1').value);
        const estado = document.getElementById('estado').value;
        const regime = document.getElementById('regimeTrabalho').value;
        
        // Valida√ß√µes b√°sicas
        if (!r1 || r1 === 0) return false;
        if (!estado) return false;
        if (!regime) return false;
        
        // Se for CLT +3 anos, precisa validar FGTS
        if (regime === 'clt3') {
            const usaFgts = document.getElementById('usaFgts').value;
            if (!usaFgts) return false; // Precisa escolher sim ou n√£o
            
            // Se escolheu usar FGTS, precisa informar o valor
            if (usaFgts === 'sim') {
                const fgts = parseMoney(document.getElementById('fgtsVal').value);
                if (!fgts || fgts === 0) return false;
            }
        }
        
        return true;
    }
    
    // Fun√ß√£o para atualizar a visibilidade do bot√£o
    function atualizarBotaoDiagnostico() {
        const btn = document.getElementById('btnGerarDiagnostico');
        if (validarCamposDiagnostico()) {
            btn.classList.remove('hidden');
        } else {
            btn.classList.add('hidden');
        }
    }
</script>
</body>
</html>
