<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador MCMV Pro v1.0 - Raul Mendes Imob</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #ecfdf5;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --orange: #d97706;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius-lg: 24px;
            --radius-md: 14px;
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.03), 0 8px 10px -6px rgba(0,0,0,0.01);
            
            --bg-bloco-1: #f8fafc;
            --bg-bloco-2: #fffcf5;
            --bg-bloco-3: #f7fff9;
            --bg-diagnostico: #f9f8ff;
            --bg-simulacao-estimada: #d1fae5;
            --bg-simulacao-detalhada: #bfdbfe;
            
            --bg-sub-container: #ffffff;
            --bg-inter-bloco: #fffbeb;
            --bg-pos-bloco: #f0f9ff;
            --bg-subsidio-bloco: #fef3c7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: var(--text-main); line-height: 1.6; min-height: 100vh; padding: 20px 16px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 32px; }
        header h1 { font-family: 'Poppins', sans-serif; font-size: clamp(22px, 6vw, 32px); color: var(--primary-dark); margin-bottom: 4px; }
        header p { color: var(--text-muted); font-size: 14px; }

        .card { background: #fff; border-radius: var(--radius-lg); padding: clamp(20px, 5vw, 32px); box-shadow: var(--shadow-lg); margin-bottom: 24px; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
        .bloco-1 { background-color: var(--bg-bloco-1); }
        .bloco-2 { background-color: var(--bg-bloco-2); }
        .bloco-3 { background-color: var(--bg-bloco-3); }
        .bloco-diagnostico { background-color: var(--bg-diagnostico); border: 2px solid #eef2ff; }
        
        .section-title { font-family: 'Poppins', sans-serif; font-size: 17px; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary); width: 22px; height: 22px; }
        .obs-italico { font-size: 12px; font-style: italic; color: var(--text-muted); font-weight: 400; margin-left: 4px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
        @media (min-width: 500px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        
        input, select { width: 100%; padding: 12px 16px;  border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); font-size: 15px; font-family: inherit; color: var(--text-main); background: #fff; transition: all 0.2s ease; outline: none; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; width: 100%; }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .btn-warning { background: var(--orange); color: #fff; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.15); }
        .btn-success { background: #10b981; color: #fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15); }
        .btn-success:hover { background: #059669; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }

        .alerta-box { padding: 14px; border-radius: var(--radius-md); margin-top: 16px; text-align: center; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .alerta-box.sucesso { background: #f0fdf4; color: var(--primary-dark); border: 1px solid #bbf7d0; }
        .alerta-box.aviso { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .alerta-box.erro { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .obs-box { margin-top: 10px; font-style: italic; font-size: 13px; color: var(--text-muted); line-height: 1.35; }
        .obs-box a { color: var(--secondary); text-decoration: none; font-weight: 600; }
        .obs-box a:hover { text-decoration: underline; }

        /* Collapsible Sections */
        .collapsible-header { 
            background: var(--primary); 
            color: #fff; 
            padding: 16px 20px; 
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
            user-select: none;
            transition: all 0.3s ease;
        }
        .collapsible-header:hover { background: var(--primary-dark); }
        .collapsible-header.secondary { background: var(--secondary); }
        .collapsible-header.secondary:hover { background: #1d4ed8; }
        .collapsible-header.warning { background: var(--orange); }
        .collapsible-header.warning:hover { background: #b45309; }
        .toggle-icon { transition: transform 0.3s ease; }
        .toggle-icon.open { transform: rotate(180deg); }

        .collapsible-content { 
            display: none;
            padding: 24px;
            background: #fff;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            border: 1px solid #f1f5f9;
            border-top: none;
        }
        .collapsible-content.open { display: block; }

        /* Intermedi√°rias Grid */
        .inter-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px; }
        .inter-row { background: var(--bg-bloco-1); padding: 16px; border-radius: var(--radius-md); border: 1px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 500px) { .inter-row { grid-template-columns: 1fr; } }

        /* Resultado */
        .resultado { 
            display: none;
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-top: 20px;
            border: 2px solid;
        }
        .resultado.sucesso { background: #f0fdf4; border-color: #86efac; }
        .resultado.aviso { background: #fef3c7; border-color: #fde047; }
        .resultado.erro { background: #fee2e2; border-color: #fca5a5; }

        .resultado h3 { font-family: 'Poppins'; font-size: 18px; margin-bottom: 12px; }
        .resultado p { font-size: 14px; line-height: 1.6; margin-bottom: 8px; }

        /* Tabela de Juros */
        .tabela-wrap { overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        th { background: var(--bg-bloco-1); font-weight: 700; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }

        /* Grid de Juros (Mobile) */
        .juros-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .juros-card { background: var(--bg-bloco-1); padding: 16px; border-radius: var(--radius-md); border: 1px solid #e2e8f0; text-align: center; }
        .juros-card-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .juros-card-value { font-size: 18px; font-weight: 700; color: var(--text-main); margin-top: 8px; }

        .hidden { display: none !important; }

        /* Resultado Info Box */
        .resultado-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .resultado-item { padding: 12px; background: rgba(255,255,255,0.5); border-radius: var(--radius-md); }
        .resultado-item-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .resultado-item-value { font-size: 18px; font-weight: 700; color: var(--text-main); margin-top: 6px; }

        .resultado-item.destaque { background: rgba(5, 150, 105, 0.1); }
        .resultado-item.destaque .resultado-item-value { color: var(--primary); }

        .resultado-item.alerta { background: rgba(239, 68, 68, 0.1); }
        .resultado-item.alerta .resultado-item-value { color: var(--danger); }

        /* Responsive */
        @media (max-width: 500px) {
            .grid-2 { grid-template-columns: 1fr !important; }
            .resultado-info { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>Simulador MCMV Pro</h1>
            <p>Simule seu financiamento com precis√£o</p>
        </header>

        <!-- Bloco 1: Dados Principais -->
        <div class="card bloco-1">
            <div class="section-title">
                Dados do Im√≥vel
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label>Empreendimento</label>
                    <div class="input-wrapper">
                        <input id="empreendimento" type="text">
                    </div>
                </div>

                <div class="form-group">
                    <label>Unidade / Bloco / Andar</label>
                    <div class="input-wrapper">
                        <input id="unidade" type="text">
                    </div>
                </div>

                <div class="form-group">
                    <label>Valor do Im√≥vel</label>
                    <div class="input-wrapper">
                        <input id="valorImovel" type="text" oninput="formatarMoeda(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Valor do Financiamento</label>
                    <div class="input-wrapper">
                        <input id="valorFinanciamento" type="text" oninput="formatarMoeda(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Renda Familiar Mensal</label>
                    <div class="input-wrapper">
                        <input id="renda" type="text" oninput="formatarMoeda(this); updateMCMV();">
                    </div>
                </div>

                <div class="form-group">
                    <label>Previs√£o de Entrega</label>
                    <div class="input-wrapper">
                        <select id="entregaSelect"></select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Usa FGTS?</label>
                    <div class="input-wrapper">
                        <select id="usaFgts" onchange="toggleFGTS()">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                </div>

                <div class="form-group hidden" id="boxFGTS">
                    <label>Valor do FGTS</label>
                    <div class="input-wrapper">
                        <input id="fgts" type="text" oninput="formatarMoeda(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Bloco 2: Entrada e Fluxo -->
        <div class="card bloco-2">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span>Entrada / Fluxo Inicial</span>
                <span class="toggle-icon" data-lucide="chevron-down"></span>
            </div>

            <div class="collapsible-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Valor do Ato</label>
                        <div class="input-wrapper">
                            <input id="ato" type="text" oninput="formatarMoeda(this)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Meses / Parcelas</label>
                        <div class="input-wrapper">
                            <select id="parcelasEntrada">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: #e2e8f0; margin: 20px 0;"></div>

                <div class="form-group">
                    <label>Tem Subs√≠dio?</label>
                    <div class="input-wrapper">
                        <select id="temSubsidio" onchange="toggleSubsidio()">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                </div>

                <div class="hidden" id="boxSubsidioVal">
                    <div class="form-group">
                        <label>Valor do Subs√≠dio</label>
                        <div class="input-wrapper">
                            <input id="subsidio" type="text" oninput="formatarMoeda(this)">
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: #e2e8f0; margin: 20px 0;"></div>

                <div class="form-group">
                    <label>Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
                    <div class="input-wrapper">
                        <select id="temInter" onchange="toggleInter()">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                </div>

                <div class="hidden" id="boxInterQtd">
                    <div class="form-group">
                        <label>Quantidade de Intermedi√°rias</label>
                        <div class="input-wrapper">
                            <input id="qtdInter" type="number" min="1" max="12" value="1" onchange="renderInterRows()">
                        </div>
                    </div>
                </div>

                <div class="hidden inter-grid" id="boxInterRows"></div>

                <div style="height: 1px; background: #e2e8f0; margin: 20px 0;"></div>

                <div class="form-group">
                    <label>Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
                    <div class="input-wrapper">
                        <select id="aceitaPos">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="calcularEntrada()" style="margin-top: 20px;">Calcular Entrada</button>
            </div>
        </div>

        <!-- Resultado Entrada -->
        <div id="resultadoEntrada" class="resultado"></div>

        <!-- Bloco 3: Juros de Obra -->
        <div class="card bloco-3">
            <div class="collapsible-header secondary" onclick="toggleCollapsible(this)">
                <span>Juros de Obra (MCMV)</span>
                <span class="toggle-icon" data-lucide="chevron-down"></span>
            </div>

            <div class="collapsible-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Regi√£o do Brasil</label>
                        <div class="input-wrapper">
                            <select id="regiao" onchange="onChangeRegiao()">
                                <option value="">Selecione...</option>
                                <option value="no_ne">Norte / Nordeste</option>
                                <option value="sul_se_co">Sudeste / Sul / Centro-Oeste</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="boxCotista">
                        <label>Cotista ou N√£o Cotista?</label>
                        <div class="input-wrapper">
                            <select id="cotista" onchange="onChangeCotista()">
                                <option value="">Selecione...</option>
                                <option value="cotista">Cotista (+3 anos CLT)</option>
                                <option value="nao_cotista">N√£o Cotista</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="boxFaixa">
                        <label>Faixa MCMV</label>
                        <div class="input-wrapper">
                            <select id="faixaMCMVSelect">
                                <option value="Faixa 1">Faixa 1</option>
                                <option value="Faixa 2">Faixa 2</option>
                                <option value="Faixa 3">Faixa 3</option>
                                <option value="Faixa 4">Faixa 4</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="boxTaxaEf">
                        <label>Taxa de Juros Efetivos Anual (%)</label>
                        <div class="input-wrapper">
                            <input id="taxaEfetivaAnual" type="number" step="0.01" min="0">
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: #e2e8f0; margin: 20px 0;"></div>

                <div style="background: var(--bg-inter-bloco); padding: 16px; border-radius: var(--radius-md); border: 1px solid #fde68a;">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Intervalo da Tabela</label>
                            <div class="input-wrapper">
                                <select id="passoTabela">
                                    <option value="3">3 em 3%</option>
                                    <option value="5">5 em 5%</option>
                                    <option value="10" selected>10 em 10%</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>TR (%) <span class="obs-italico">Valor m√©dio</span></label>
                            <div class="input-wrapper">
                                <input id="tr" type="number" step="0.01" value="0.17">
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Taxa Administrativa + Seguros <span class="obs-italico">Valor m√©dio</span></label>
                            <div class="input-wrapper">
                                <input id="taxas" type="text" value="R$ 65,00" oninput="formatarMoeda(this)">
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="calcularJurosTabela()" style="margin-top: 20px;">Calcular Juros de Obra</button>
            </div>
        </div>

        <!-- Resultado Juros -->
        <div id="resultadoJuros" class="resultado"></div>

        <!-- Bloco 4: Gerar PDF -->
        <div class="card">
            <div class="collapsible-header warning" onclick="toggleCollapsible(this)">
                <span>Gerar PDF</span>
                <span class="toggle-icon" data-lucide="chevron-down"></span>
            </div>

            <div class="collapsible-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Cliente</label>
                        <div class="input-wrapper">
                            <input id="pdfCliente" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Telefone do Cliente</label>
                        <div class="input-wrapper">
                            <input id="pdfClienteFone" type="tel" oninput="formatarTelefone(this)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Corretor(a)</label>
                        <div class="input-wrapper">
                            <input id="pdfCorretor" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Telefone do Corretor</label>
                        <div class="input-wrapper">
                            <input id="pdfCorretorFone" type="tel" oninput="formatarTelefone(this)">
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Incluir Estimativa de INCC?</label>
                        <div class="input-wrapper">
                            <select id="pdfINCC" onchange="toggleINCC()">
                                <option value="nao">N√£o</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="boxINCCValor">
                        <label>INCC (m√©dia mensal) %</label>
                        <div class="input-wrapper">
                            <input id="inccValor" type="number" step="0.01" value="0.5">
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Incluir Estimativa de Juros de Obra?</label>
                        <div class="input-wrapper">
                            <select id="pdfJuros">
                                <option value="nao">N√£o</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="obs-box" style="margin-top: 16px;">
                    <strong>Refer√™ncias:</strong><br>
                    INCC atualizado: <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank">portal.fgv.br</a><br>
                    TR atualizada: <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank">debit.com.br</a>
                </div>

                <button class="btn btn-warning" onclick="gerarPDF()" style="margin-top: 20px;">Gerar PDF da Simula√ß√£o</button>
            </div>
        </div>

        <div style="height: 40px;"></div>
    </div>

    <script>
        /* ========================= UTILIDADES ========================= */
        function formatarMoeda(input) {
            let v = (input.value || "").replace(/\D/g, "");
            if (!v) { input.value = ""; return; }
            v = (parseInt(v, 10) / 100).toFixed(2).replace(".", ",");
            v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            input.value = "R$ " + v;
        }

        function limparMoeda(v) {
            return parseFloat((v || "").replace(/[R$\.\s]/g, "").replace(",", ".")) || 0;
        }

        function moeda(n) {
            return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function formatarTelefone(input) {
            let v = (input.value || "").replace(/\D/g, "").slice(0, 11);
            if (v.length <= 2) { input.value = v; return; }
            const ddd = v.slice(0, 2);
            const rest = v.slice(2);
            if (rest.length <= 4) { input.value = `(${ddd}) ${rest}`; return; }
            if (rest.length <= 8) { input.value = `(${ddd}) ${rest.slice(0, 4)}-${rest.slice(4)}`; return; }
            input.value = `(${ddd}) ${rest.slice(0, 5)}-${rest.slice(5)}`;
        }

        /* ========================= MESES/ANO ========================= */
        function gerarMesAno() {
            const h = new Date();
            const arr = [];
            const m = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            for (let i = 0; i < 48; i++) {
                const d = new Date(h.getFullYear(), h.getMonth() + i, 1);
                arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
            }
            return arr;
        }

        (function () {
            const s = document.getElementById("entregaSelect");
            gerarMesAno().forEach(t => {
                const o = document.createElement("option");
                o.textContent = t;
                s.appendChild(o);
            });
        })();

        /* ========================= PARCELAS (1-45) ========================= */
        (function () {
            const s = document.getElementById("parcelasEntrada");
            for (let i = 1; i <= 45; i++) {
                const o = document.createElement("option");
                o.value = i;
                o.textContent = i;
                s.appendChild(o);
            }
        })();

        /* ========================= UI ========================= */
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector(".toggle-icon");
            
            if (content.classList.contains("open")) {
                content.classList.remove("open");
                icon.classList.remove("open");
            } else {
                content.classList.add("open");
                icon.classList.add("open");
            }
        }

        function toggleFGTS() {
            const usa = document.getElementById("usaFgts").value;
            const box = document.getElementById("boxFGTS");
            if (usa === "sim") { box.classList.remove("hidden"); }
            else { box.classList.add("hidden"); document.getElementById("fgts").value = ""; }
        }

        function toggleINCC() {
            const val = document.getElementById("pdfINCC").value;
            const box = document.getElementById("boxINCCValor");
            if (val === "sim") { box.classList.remove("hidden"); }
            else { box.classList.add("hidden"); }
        }

        /* ========================= INTERMEDI√ÅRIAS ========================= */
        function toggleInter() {
            const tem = document.getElementById("temInter").value;
            const boxQtd = document.getElementById("boxInterQtd");
            const boxRows = document.getElementById("boxInterRows");
            
            if (tem === "sim") {
                boxQtd.classList.remove("hidden");
                boxRows.classList.remove("hidden");
                renderInterRows();
            } else {
                boxQtd.classList.add("hidden");
                boxRows.classList.add("hidden");
                boxRows.innerHTML = "";
                document.getElementById("qtdInter").value = 1;
            }
        }

        function toggleSubsidio() {
            const tem = document.getElementById("temSubsidio").value;
            const box = document.getElementById("boxSubsidioVal");
            if (tem === "sim") { box.classList.remove("hidden"); }
            else { box.classList.add("hidden"); document.getElementById("subsidio").value = ""; }
        }

        function renderInterRows() {
            const q = parseInt(document.getElementById("qtdInter").value, 10) || 0;
            const interList = document.getElementById("boxInterRows");
            interList.innerHTML = "";
            if (q <= 0) return;

            const meses = gerarMesAno();
            for (let i = 1; i <= q; i++) {
                const r = document.createElement("div");
                r.className = "inter-row";
                r.innerHTML = `
                    <div class="form-group">
                        <label>${i}¬∫ Pagamento</label>
                        <div class="input-wrapper">
                            <select>${meses.map(mm => `<option>${mm}</option>`).join("")}</select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <div class="input-wrapper">
                            <input type="text" oninput="formatarMoeda(this)">
                        </div>
                    </div>
                `;
                interList.appendChild(r);
            }
            lucide.createIcons();
        }

        /* ========================= MCMV ========================= */
        const MCMV_RANGES = [
            { faixa: "Faixa 1", min: 0, max: 2160.00, rate: (isCotista, reg) => isCotista ? (reg === "no_ne" ? 4.07 : 4.33) : (reg === "no_ne" ? 4.59 : 4.84) },
            { faixa: "Faixa 1", min: 2160.01, max: 2850.00, rate: (isCotista, reg) => isCotista ? (reg === "no_ne" ? 4.33 : 4.59) : (reg === "no_ne" ? 4.84 : 5.12) },
            { faixa: "Faixa 2", min: 2850.01, max: 3500.00, rate: (isCotista, reg) => isCotista ? (reg === "no_ne" ? 4.84 : 5.12) : (reg === "no_ne" ? 5.38 : 5.64) },
            { faixa: "Faixa 2", min: 3500.01, max: 4000.00, rate: (isCotista, reg) => isCotista ? 5.64 : 6.17 },
            { faixa: "Faixa 2", min: 4000.01, max: 4700.00, rate: (isCotista, reg) => isCotista ? 6.70 : 7.23 },
            { faixa: "Faixa 3", min: 4700.01, max: 8600.00, rate: (isCotista, reg) => isCotista ? 7.93 : 8.46 },
            { faixa: "Faixa 4", min: 8600.01, max: 12000.00, rate: () => 11.03 },
        ];

        function findRangeByRenda(renda) {
            return MCMV_RANGES.find(r => renda >= r.min && renda <= r.max) || null;
        }

        function findRangeByFaixa(faixa) {
            return MCMV_RANGES.find(r => r.faixa === faixa) || null;
        }

        let __faixaManual = false;
        let __taxaManual = false;

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("faixaMCMVSelect").addEventListener("change", () => {
                __faixaManual = true;
                updateTaxaPorFaixaManual();
            });

            document.getElementById("taxaEfetivaAnual").addEventListener("input", () => {
                __taxaManual = true;
            });
        });

        function onChangeRegiao() {
            const reg = document.getElementById("regiao").value;
            document.getElementById("cotista").value = "";
            const boxCotista = document.getElementById("boxCotista");
            const boxFaixa = document.getElementById("boxFaixa");
            const boxTaxaEf = document.getElementById("boxTaxaEf");
            
            if (reg) { boxCotista.classList.remove("hidden"); }
            else { boxCotista.classList.add("hidden"); }
            boxFaixa.classList.add("hidden");
            boxTaxaEf.classList.add("hidden");
            updateMCMV();
        }

        function onChangeCotista() {
            const boxFaixa = document.getElementById("boxFaixa");
            const boxTaxaEf = document.getElementById("boxTaxaEf");
            boxFaixa.classList.add("hidden");
            boxTaxaEf.classList.add("hidden");
            updateMCMV();
        }

        function updateMCMV() {
            const renda = limparMoeda(document.getElementById("renda").value);
            const reg = document.getElementById("regiao").value;
            const cot = document.getElementById("cotista").value;

            if (!reg || !cot) return;

            document.getElementById("boxFaixa").classList.remove("hidden");
            document.getElementById("boxTaxaEf").classList.remove("hidden");

            const faixaSel = document.getElementById("faixaMCMVSelect");
            const taxaEl = document.getElementById("taxaEfetivaAnual");

            if (!renda || renda <= 0) {
                if (!__faixaManual) faixaSel.value = "Faixa 1";
                if (!__taxaManual) taxaEl.value = "";
                return;
            }

            const range = findRangeByRenda(renda);
            if (range && !__faixaManual) {
                faixaSel.value = range.faixa;
            }

            const isCotista = (cot === "cotista");
            let taxa = null;

            if (__faixaManual) {
                const rF = findRangeByFaixa(faixaSel.value);
                if (rF) taxa = rF.rate(isCotista, reg);
            } else {
                if (range) taxa = range.rate(isCotista, reg);
            }

            if (taxa !== null && !__taxaManual) {
                taxaEl.value = Number(taxa).toFixed(2);
            } else if (taxa === null && !__taxaManual) {
                taxaEl.value = "";
            }
        }

        function updateTaxaPorFaixaManual() {
            const reg = document.getElementById("regiao").value;
            const cot = document.getElementById("cotista").value;
            if (!reg || !cot) return;

            const isCotista = (cot === "cotista");
            const faixaSel = document.getElementById("faixaMCMVSelect").value;
            const rF = findRangeByFaixa(faixaSel);
            if (!rF) return;

            if (!__taxaManual) {
                document.getElementById("taxaEfetivaAnual").value = Number(rF.rate(isCotista, reg)).toFixed(2);
            }
        }

        /* ========================= C√ÅLCULOS ========================= */
        function calcularEntrada() {
            const im = limparMoeda(document.getElementById("valorImovel").value);
            const fi = limparMoeda(document.getElementById("valorFinanciamento").value);
            const usaFgts = document.getElementById("usaFgts").value === "sim";
            const fg = usaFgts ? limparMoeda(document.getElementById("fgts").value) : 0;
            const temSubsidio = document.getElementById("temSubsidio").value === "sim";
            const sub = temSubsidio ? limparMoeda(document.getElementById("subsidio").value) : 0;
            const at = limparMoeda(document.getElementById("ato").value);
            const re = limparMoeda(document.getElementById("renda").value);
            const p = parseInt(document.getElementById("parcelasEntrada").value, 10) || 0;

            if (!im || !fi || !re || !p) {
                setResultado("resultadoEntrada", "erro", 
                    `<h3>‚ö†Ô∏è Dados Incompletos</h3>
                     <p>Preencha: Valor do Im√≥vel, Financiamento, Renda e Meses/Parcelas.</p>`);
                return;
            }

            const entrada = im - fi - fg - sub;
            const temInter = document.getElementById("temInter").value === "sim";
            const aceitaPos = document.getElementById("aceitaPos").value === "sim";
            const interVals = [];
            const interMeta = [];

            if (temInter) {
                const interRows = document.querySelectorAll("#boxInterRows .inter-row");
                interRows.forEach((row, idx) => {
                    const select = row.querySelector("select");
                    const input = row.querySelector("input");
                    const val = limparMoeda(input.value);
                    if (val > 0) {
                        interVals.push(val);
                        interMeta.push(select.value);
                    }
                });
            }

            const somaInter = interVals.reduce((a, b) => a + b, 0);
            const entradaLiq = entrada - somaInter - at;
            
            // Aplicar limite de 30% da renda mensal
            const rendaMensal = re;
            const limiteRenda = rendaMensal * 0.30;
            const parcelaMensal = entradaLiq > 0 ? entradaLiq / p : 0;
            
            // Verificar se a parcela mensal ultrapassa 30% da renda
            const excedeLimite = parcelaMensal > limiteRenda;
            const saldoRestante = excedeLimite ? (parcelaMensal - limiteRenda) * p : 0;
            const parcelaAjustada = excedeLimite ? limiteRenda : parcelaMensal;
            const parcelasAjustadas = excedeLimite ? Math.floor(entradaLiq / limiteRenda) : p;

            // Obter data de entrega
            const entregaSelect = document.getElementById("entregaSelect");
            const entregaTexto = entregaSelect.options[entregaSelect.selectedIndex].text;

            let html = `
                <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px;">
                    <div style="font-family: 'Poppins'; font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px;">Fluxo de Pagamento ‚Äì ${p} meses</div>
                    <div style="font-size: 13px; color: var(--text-muted);">Previs√£o estimada de entrega: ${entregaTexto}</div>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: var(--text-muted); font-size: 14px;">Valor do Im√≥vel</span>
                    <span style="font-weight: 700; color: var(--secondary); font-size: 15px;">${moeda(im)}</span>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: var(--text-muted); font-size: 14px;">Financiamento Estimado</span>
                    <span style="font-weight: 700; color: var(--warning); font-size: 15px;">${moeda(fi)}</span>
                </div>
            `;

            if (fg > 0) {
                html += `<div style="display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #e2e8f0;"><span style="color: var(--text-muted); font-size: 14px;">FGTS</span><span style="font-weight: 700; color: var(--warning); font-size: 15px;">${moeda(fg)}</span></div>`;
            }

            if (sub > 0) {
                html += `<div style="display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #e2e8f0;"><span style="color: var(--text-muted); font-size: 14px;">Subs√≠dio</span><span style="font-weight: 700; color: var(--warning); font-size: 15px;">${moeda(sub)}</span></div>`;
            }

            // Bloco destaque da entrada total
            html += `
                <div style="background: var(--bg-simulacao-estimada); border: 2px solid #6ee7b7; border-radius: var(--radius-md); padding: 24px; text-align: center; margin: 20px 0;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 8px;">Entrada Total - Parcelamento no Per√≠odo de Obras</div>
                    <div style="font-family: 'Poppins'; font-size: 32px; font-weight: 800; color: var(--primary);">${moeda(entrada)}</div>
                </div>
            `;

            // Divis√£o do pagamento
            html += `
                <div style="background: var(--bg-bloco-1); padding: 20px; border-radius: var(--radius-md); margin: 20px 0;">
                    <div style="font-size: 12px; font-weight: 700; color: var(--secondary); text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center; gap: 6px;">
                        <span>üìã Divis√£o do Pagamento</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: var(--text-muted); font-size: 14px;">Ato (Sinal)</span>
                        <span style="font-weight: 700; color: var(--text-main); font-size: 14px;">${moeda(at)}</span>
                    </div>
            `;

            if (temInter && interVals.length > 0) {
                const qtdInter = interVals.length;
                const interDisplay = interVals.map(v => moeda(v)).join(" | ");
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: var(--text-muted); font-size: 14px;">Intermedi√°rias/Anuais (${qtdInter}x)</span>
                        <span style="font-weight: 700; color: var(--text-main); font-size: 14px;">${interDisplay}</span>
                    </div>
                `;
            }

            html += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: var(--text-muted); font-size: 14px;">Parcelas Mensais (${p}x)</span>
                        <span style="font-weight: 700; color: var(--text-main); font-size: 14px;">${moeda(parcelaAjustada)}</span>
                    </div>
            `;

            if (saldoRestante > 0) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                        <span style="color: var(--text-muted); font-size: 14px;">Saldo Restante (P√≥s-Chaves)</span>
                        <span style="font-weight: 700; color: var(--danger); font-size: 14px;">${moeda(saldoRestante)}</span>
                    </div>
                `;
            }

            html += `</div>`;

            // Alerta se fluxo ultrapassa periodo de obras
            if (saldoRestante > 0) {
                html += `<div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: var(--radius-md); padding: 16px; margin: 20px 0; text-align: center;"><div style="font-size: 13px; color: var(--orange); font-weight: 700;">Fluxo de Pagamento da Entrada ultrapassa o Periodo de Obras.</div></div>`;
            }

            // Observa√ß√µes
            html += `
                <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: var(--radius-md); padding: 16px; margin: 20px 0;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--orange); margin-bottom: 8px;">üìå Observa√ß√µes:</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--text-main); line-height: 1.6;">
                        <li>Utilizando como limitador: <strong>30% da renda</strong> para parcelas mensais.</li>
                    </ul>
                </div>
            `;

            setResultado("resultadoEntrada", "sucesso", html);
            lucide.createIcons();
        }

        function calcularJurosTabela() {
            const fi = limparMoeda(document.getElementById("valorFinanciamento").value);
            const taxa = parseFloat(document.getElementById("taxaEfetivaAnual").value) || 0;
            const tr = parseFloat(document.getElementById("tr").value) || 0;
            const taxas = limparMoeda(document.getElementById("taxas").value);
            const passo = parseInt(document.getElementById("passoTabela").value) || 10;

            if (!fi || taxa <= 0) {
                setResultado("resultadoJuros", "erro", 
                    `<h3>‚ö†Ô∏è Dados Incompletos</h3>
                     <p>Preencha o Financiamento e a Taxa de Juros.</p>`);
                return;
            }

            const jurosMensal = (taxa / 100) / 12;
            const trMensal = tr / 100;

            const percList = [];
            for (let p = passo; p <= 100; p += passo) percList.push(p);
            if (percList[percList.length - 1] !== 100) percList.push(100);

            const rows = percList.map(perc => {
                const liberado = fi * (perc / 100);
                const liberadoComTR = liberado * (1 + trMensal);
                const juros = liberadoComTR * jurosMensal;
                const parcela = juros + taxas;
                return { perc, parcela };
            });

            let html = `<h3>üìä Tabela de Juros de Obra</h3>`;
            html += `<div class="tabela-wrap"><table>
                <thead>
                    <tr>
                        <th>% da Obra</th>
                        <th>Parcela Estimada (m√™s)</th>
                    </tr>
                </thead>
                <tbody>`;
            
            rows.forEach(r => {
                html += `<tr><td><strong>${r.perc}%</strong></td><td>${moeda(r.parcela)}</td></tr>`;
            });
            
            html += `</tbody></table></div>`;
            html += `<div class="obs-box" style="margin-top: 16px;">
                <strong>Observa√ß√µes:</strong><br>
                Valores aproximados para fins de simula√ß√£o.<br>
                Taxa Administrativa: ${moeda(taxas)}<br>
                TR utilizada: ${tr.toFixed(2)}%
            </div>`;

            setResultado("resultadoJuros", "sucesso", html);
        }

        function setResultado(elementId, tipo, html) {
            const el = document.getElementById(elementId);
            el.className = "resultado " + tipo;
            el.innerHTML = html;
            el.style.display = "block";
            lucide.createIcons();
        }

        <script>
async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    const margin = 40;
    let y = 60;

    const cliente = document.getElementById("pdfCliente").value || "N√£o informado";
    const corretor = document.getElementById("pdfCorretor").value || "N√£o informado";
    const foneCli = document.getElementById("pdfClienteFone").value || "";
    const foneCor = document.getElementById("pdfCorretorFone").value || "";
    const incluirJuros = document.getElementById("pdfJuros").value === "sim";
    const incluirINCC = document.getElementById("pdfINCC").value === "sim";
    const inccValor = document.getElementById("inccValor").value || "0";

    const resEntrada = document.getElementById("resultadoEntrada").innerText || "Nenhum resultado calculado.";
    const resJuros = document.getElementById("resultadoJuros").innerText || "Nenhum c√°lculo de juros.";

    // Cabe√ßalho
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("Simula√ß√£o MCMV Pro - Relat√≥rio", margin, y);
    y += 30;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Cliente: ${cliente}`, margin, y);
    y += 16;
    doc.text(`Telefone: ${foneCli}`, margin, y);
    y += 16;
    doc.text(`Corretor: ${corretor}`, margin, y);
    y += 16;
    doc.text(`Telefone do Corretor: ${foneCor}`, margin, y);
    y += 30;

    // Bloco Entrada
    doc.setFont("helvetica", "bold");
    doc.text("‚û°Ô∏è Simula√ß√£o de Entrada", margin, y);
    y += 18;

    doc.setFont("helvetica", "normal");
    const splitEntrada = doc.splitTextToSize(resEntrada, 520);
    doc.text(splitEntrada, margin, y);
    y += splitEntrada.length * 14 + 20;

    // Bloco Juros (opcional)
    if (incluirJuros) {
        doc.setFont("helvetica", "bold");
        doc.text("üìä Juros de Obra (estimativa)", margin, y);
        y += 18;
        doc.setFont("helvetica", "normal");
        const splitJuros = doc.splitTextToSize(resJuros, 520);
        doc.text(splitJuros, margin, y);
        y += splitJuros.length * 14 + 20;
    }

    // Bloco INCC (opcional)
    if (incluirINCC) {
        doc.setFont("helvetica", "bold");
        doc.text("üìà Estimativa de INCC", margin, y);
        y += 16;
        doc.setFont("helvetica", "normal");
        doc.text(`INCC m√©dio mensal: ${inccValor}%`, margin, y);
        y += 20;
    }

    // Rodap√©
    const data = new Date().toLocaleDateString("pt-BR");
    doc.setFontSize(10);
    doc.text(`Gerado em ${data} - Simulador MCMV Pro`, margin, 800);

    doc.save(`Simulacao_MCMV_${cliente.replace(/\s+/g, "_")}.pdf`);
}
</script>


        /* ========================= INICIALIZA√á√ÉO ========================= */
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
