<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador Imobili√°rio ‚Äî Vers√£o 1.0</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f5;
      color: #222;
    }

    /* ===== TOP FIXO ===== */
    .painel-topo {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px;
    }
    .painel-topo h1 {
      text-align: center;
      color: #0b6e3b;
      margin: 0 0 16px;
      font-size: 22px;
    }

    .grid-topo {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .grid-topo { grid-template-columns: repeat(2, 1fr); }
    }

    .campo label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .campo input, .campo select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      background: #fff;
    }
    .campo-full { grid-column: 1 / -1; }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    /* ===== BLOCOS ===== */
    .bloco {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #ddd;
      overflow: hidden;
      margin-bottom: 14px;
    }
    .bloco-header {
      color: #fff;
      padding: 14px 16px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-entrada { background: #0b6e3b; }
    .header-juros  { background: #d97706; }
    .header-pdf    { background: #2563eb; }

    .toggle-icon {
      background: rgba(255,255,255,.18);
      border-radius: 6px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }
    .bloco-conteudo {
      display: none;
      padding: 18px;
    }

    .subgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .subgrid { grid-template-columns: repeat(2, 1fr); }
      .span2 { grid-column: 1 / -1; }
    }

    .divider {
      height: 1px;
      background: #e9e9e9;
      margin: 16px 0;
    }

    /* ===== CAIXAS CLARAS (estilo intermedi√°rias/p√≥s-chaves) ===== */
    .box-claro {
      background: #f6f9f7;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e6efe9;
    }
    .box-claro.azul {
      background: #f2f6fb;
      border-color: #dbe6f7;
    }

    /* ‚úÖ amarelo MAIS CLARO (pedido) ‚Äî diferente do amarelo do resultado/tabela */
    .box-claro.amarelo {
      background: #fffbe8;
      border-color: #f3e7b3;
    }

    /* ===== BOT√ïES ===== */
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-entrada { background: #0b6e3b; }
    .btn-juros   { background: #d97706; }
    .btn-pdf     { background: #2563eb; }
    .btn-limpar  {
      background: #c62828;
      margin-top: 14px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    /* ‚úÖ PC: bot√µes com metade do tamanho (50%) e centralizados */
    @media (min-width: 768px) {
      button {
        width: 50%;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
    }

    /* ===== RESULTADOS ===== */
    .resultado {
      display: none;
      padding: 16px;
      border-radius: 12px;
      margin: 12px 0 14px;
      border: 1px solid rgba(0,0,0,.08);
    }
    .resultado.verde   { background: #eaf7ee; border-color: #bfe6c9; }
    .resultado.amarelo { background: #fff7da; border-color: #f0dc8a; } /* mant√©m */
    .resultado.vermelho{ background: #ffe3e3; border-color: #ffb7b7; }

    .alerta { color: #8b1e1e; font-weight: 900; }

    /* Observa√ß√µes/links (it√°lico + clic√°vel azul) */
    .obs {
      margin-top: 10px;
      font-style: italic;
      font-size: 13px;
      color: #222;
      line-height: 1.35;
    }
    .obs a { color: #2563eb; text-decoration: none; }
    .obs a:hover { text-decoration: underline; }

    /* ===== INTERMEDI√ÅRIAS ===== */
    .inter-list { display: flex; flex-direction: column; gap: 10px; }
    .inter-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      background: #fff;
      border: 1px solid #e6efe9;
      padding: 10px;
      border-radius: 10px;
    }
    @media (min-width: 768px) {
      .inter-row { grid-template-columns: 1fr 1fr; }
    }

    /* ===== JUROS (DESKTOP TABELA + MOBILE GRID) ===== */
    .juros-desktop { display: block; }
    .juros-mobile  { display: none; }
    @media (max-width: 767px) {
      .juros-desktop { display: none; }
      .juros-mobile  { display: block; }
    }

    .tabela-wrap {
      overflow: auto;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #fff;
      margin-top: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #fafafa;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:last-child td { border-bottom: none; }

    .juros-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .juros-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .juros-card .p { font-weight: 900; font-size: 15px; }
    .juros-card .v { font-size: 14px; }

    /* ===== PDF layout ===== */
    .linha-flex {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .linha-flex .campo {
      flex: 1 1 280px;
      margin: 0;
    }
    .mini-it {
      font-style: italic;
      font-size: 12px;
      font-weight: 500;
      opacity: .75;
      margin-left: 6px;
    }

    .helpbox {
      margin-top: 10px;
      font-style: italic;
      font-size: 13px;
      line-height: 1.35;
      color: #222;
    }
    .helpbox a { color: #2563eb; text-decoration: none; }
    .helpbox a:hover { text-decoration: underline; }
  </style>
</head>

<body>

  <!-- =========================
       CABE√áALHO
  ========================== -->
  <div class="painel-topo">
    <h1>Simulador Imobili√°rio</h1>

    <div class="grid-topo">
      <div class="campo">
        <label>üè¢ Empreendimento</label>
        <input id="empreendimento" />
      </div>

      <div class="campo">
        <label>üè† Unidade / Bloco / Andar</label>
        <input id="unidade" />
      </div>

      <div class="campo">
        <label>üè† Valor do Im√≥vel (R$)</label>
        <input id="valorImovel" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üè¶ Valor do Financiamento (R$)</label>
        <input id="valorFinanciamento" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üí∞ Vai utilizar FGTS?</label>
        <select id="usaFgts" onchange="toggleFGTS()">
          <option value="nao">N√£o</option>
          <option value="sim">Sim</option>
        </select>
      </div>

      <div class="campo" id="boxFGTS" style="display:none;">
        <label>üí∞ FGTS (R$)</label>
        <input id="fgts" oninput="formatarMoeda(this)" />
      </div>

      <div class="campo">
        <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Renda Familiar Mensal (R$)</label>
        <input id="renda" oninput="formatarMoeda(this); updateMCMV();" />
      </div>

      <div class="campo campo-full">
        <label>üìÖ Previs√£o de Entrega (m√™s/ano)</label>
        <select id="entregaSelect"></select>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- =========================
         ENTRADA
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-entrada" onclick="toggleBloco(this)">
        <span>üí∞ Entrada / Fluxo Inicial</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">
        <div class="subgrid">
          <div class="campo">
            <label>üí∏ Valor do Ato (R$)</label>
            <input id="ato" oninput="formatarMoeda(this)" />
          </div>

          <div class="campo">
            <label>üóìÔ∏è Meses / Parcelas</label>
            <input id="parcelasEntrada" type="number" min="1" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro">
          <div class="subgrid">
            <div class="campo span2">
              <label>üìå Tem Intermedi√°rias / Anuais / Refor√ßos / Chaves?</label>
              <select id="temInter" onchange="toggleInter()">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>

            <div class="campo span2" id="boxInterQtd" style="display:none;">
              <label>Quantidade</label>
              <input id="qtdInter" type="number" min="1" max="12" value="1" onchange="renderInterRows()" />
            </div>

            <div class="campo span2" id="boxInterRows" style="display:none;">
              <div class="inter-list" id="interList"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="box-claro azul">
          <div class="subgrid">
            <div class="campo span2">
              <label>üèóÔ∏è Construtora aceita Saldo P√≥s-Chaves / Pr√≥-Soluto?</label>
              <select id="aceitaPos">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>
          </div>
        </div>

        <button class="btn-entrada" onclick="calcularEntrada()">Calcular Entrada</button>
      </div>
    </div>

    <!-- RESULTADO ENTRADA (persistente) -->
    <div id="resultadoEntrada" class="resultado"></div>

    <!-- =========================
         JUROS DE OBRA
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-juros" onclick="toggleBloco(this)">
        <span>üèóÔ∏è Juros de Obra</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">

        <!-- Fluxo progressivo: Regi√£o -> Cotista -->
        <div class="subgrid">
          <div class="campo span2">
            <label>üß≠ Regi√£o do Brasil</label>
            <select id="regiao" onchange="onChangeRegiao()">
              <option value="">Selecione...</option>
              <option value="no_ne">Norte / Nordeste</option>
              <option value="sul_se_co">Sudeste / Sul / Centro-Oeste</option>
            </select>
          </div>

          <div class="campo span2" id="boxCotista" style="display:none;">
            <label>üßæ Cotista ou N√£o Cotista?</label>
            <select id="cotista" onchange="onChangeCotista()">
              <option value="">Selecione...</option>
              <option value="cotista">Cotista (+3 anos CLT)</option>
              <option value="nao_cotista">N√£o Cotista</option>
            </select>
          </div>

          <div class="campo" id="boxFaixa" style="display:none;">
            <label>üè∑Ô∏è Faixa Minha Casa Minha Vida</label>
            <select id="faixaMCMVSelect">
              <option value="Faixa 1">Faixa 1</option>
              <option value="Faixa 2">Faixa 2</option>
              <option value="Faixa 3">Faixa 3</option>
              <option value="Faixa 4">Faixa 4</option>
            </select>
          </div>

          <div class="campo" id="boxTaxaEf" style="display:none;">
            <label>üìà Taxa de Juros Efetivos Anual (%)</label>
            <input id="taxaEfetivaAnual" type="number" step="0.01" min="0" inputmode="decimal" />
          </div>
        </div>

        <div class="divider"></div>

        <!-- ‚úÖ amarelo mais claro aqui (classe .box-claro.amarelo ajustada no CSS) -->
        <div class="box-claro amarelo">
          <div class="subgrid">
            <div class="campo">
              <label>üìä Intervalo da tabela</label>
              <select id="passoTabela">
                <option value="3">3 em 3%</option>
                <option value="5">5 em 5%</option>
                <option value="10" selected>10 em 10%</option>
              </select>
            </div>

            <div class="campo">
              <label>üìâ TR (%) <span class="mini-it">(Valor m√©dio)</span></label>
              <input id="tr" type="number" step="0.01" value="0.17" inputmode="decimal" />
            </div>

            <div class="campo span2">
              <label>üíº Taxa Administrativa + Seguros <span class="mini-it">(Valor m√©dio)</span></label>
              <input id="taxas" value="R$ 65,00" oninput="formatarMoeda(this)" />
            </div>

            <div class="campo span2">
              <button class="btn-juros" onclick="calcularJurosTabela()">Calcular Juros de Obra (Tabela)</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RESULTADO JUROS (persistente) -->
    <div id="resultadoJuros" class="resultado"></div>

    <!-- =========================
         PDF
    ========================== -->
    <div class="bloco">
      <div class="bloco-header header-pdf" onclick="toggleBloco(this)">
        <span>üìÑ Gerar PDF</span>
        <span class="toggle-icon">+</span>
      </div>

      <div class="bloco-conteudo">
        <div class="subgrid">
          <div class="campo">
            <label>üë§ Cliente</label>
            <input id="pdfCliente" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfClienteFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>

          <div class="campo">
            <label>üßë‚Äçüíº Corretor(a)</label>
            <input id="pdfCorretor" />
          </div>

          <div class="campo">
            <label>üìû Telefone</label>
            <input id="pdfCorretorFone" inputmode="tel" oninput="formatarTelefone(this)" />
          </div>

          <!-- ‚úÖ INCC em BLOCO VERDE CLARINHO -->
          <div class="campo span2">
            <div class="box-claro">
              <div class="linha-flex">
                <div class="campo">
                  <label>üìà Incluir estimativa de INCC?</label>
                  <select id="pdfINCC" onchange="toggleINCC()">
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                  </select>
                </div>

                <div class="campo" id="boxINCCValor" style="display:none;">
                  <label>üìå INCC (m√©dia mensal) %</label>
                  <input id="inccValor" value="0,5" inputmode="decimal" />
                </div>
              </div>

              <div class="helpbox">
                üìå INCC atualizado dispon√≠vel em:
                <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank" rel="noopener noreferrer">
                  portal.fgv.br/noticias/incc-m-2025
                </a>
              </div>
            </div>
          </div>

          <!-- ‚úÖ Juros de obra em BLOCO AMARELO CLARINHO -->
          <div class="campo span2">
            <div class="box-claro amarelo">
              <label>üèóÔ∏è Incluir Estimativa de Juros de Obra?</label>
              <select id="pdfJuros">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>

              <div class="helpbox">
                üìå TR atualizada dispon√≠vel em:
                <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank" rel="noopener noreferrer">
                  debit.com.br/tabelas/tr-bacen
                </a>
              </div>
            </div>
          </div>

        </div>

        <button class="btn-pdf" onclick="gerarPDF()">Gerar PDF da Simula√ß√£o</button>
      </div>
    </div>

  </div>

  <script>
    /* =========================
       UTIL
    ========================== */
    function formatarMoeda(c){
      let v = (c.value || "").replace(/\D/g, "");
      if(!v){ c.value = ""; return; }
      v = (parseInt(v,10) / 100).toFixed(2).replace(".", ",");
      v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      c.value = "R$ " + v;
    }
    function limparMoeda(v){
      return parseFloat((v||"").replace(/[R$\.\s]/g,"").replace(",", ".")) || 0;
    }
    function moeda(n){
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function normalizarPercentBR(v){
      const s = String(v||"").trim().replace("%","").replace(",",".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }
    function formatarTelefone(input){
      let v = (input.value||"").replace(/\D/g,"").slice(0,11);
      if(v.length<=2){ input.value=v; return; }
      const ddd=v.slice(0,2);
      const rest=v.slice(2);
      if(rest.length<=4){ input.value=`(${ddd}) ${rest}`; return; }
      if(rest.length<=8){ input.value=`(${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`; return; }
      input.value=`(${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`;
    }

    /* =========================
       MESES/ANO
    ========================== */
    function gerarMesAno(){
      const h = new Date();
      const arr = [];
      const m = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      for(let i=0;i<48;i++){
        const d = new Date(h.getFullYear(), h.getMonth()+i, 1);
        arr.push(`${m[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
      }
      return arr;
    }
    (function(){
      const s = document.getElementById("entregaSelect");
      gerarMesAno().forEach(t=>{
        const o=document.createElement("option");
        o.textContent=t;
        s.appendChild(o);
      });
    })();

    /* =========================
       UI
    ========================== */
    function toggleBloco(el){
      const c = el.nextElementSibling;
      const i = el.querySelector(".toggle-icon");
      const aberto = c.style.display === "block";
      c.style.display = aberto ? "none" : "block";
      i.textContent = aberto ? "+" : "‚Äì";
    }
    function toggleFGTS(){
      const usa = document.getElementById("usaFgts").value;
      const box = document.getElementById("boxFGTS");
      if(usa==="sim"){ box.style.display="block"; }
      else { box.style.display="none"; document.getElementById("fgts").value=""; }
    }
    function toggleINCC(){
      const val = document.getElementById("pdfINCC").value;
      document.getElementById("boxINCCValor").style.display = (val==="sim") ? "block" : "none";
    }

    /* =========================
       INTERMEDI√ÅRIAS
    ========================== */
    function toggleInter(){
      const tem = document.getElementById("temInter").value;
      document.getElementById("boxInterQtd").style.display = (tem==="sim") ? "block" : "none";
      document.getElementById("boxInterRows").style.display = (tem==="sim") ? "block" : "none";
      if(tem==="sim"){ renderInterRows(); }
      else {
        document.getElementById("interList").innerHTML = "";
        document.getElementById("qtdInter").value = 1;
      }
    }

    function renderInterRows(){
      const q = parseInt(document.getElementById("qtdInter").value,10) || 0;
      const interList = document.getElementById("interList");
      interList.innerHTML = "";
      if(q<=0) return;

      const meses = gerarMesAno();
      for(let i=1;i<=q;i++){
        const r=document.createElement("div");
        r.className="inter-row";
        r.innerHTML=`
          <div>
            <label>${i}¬∫ pagamento</label>
            <select>${meses.map(mm=>`<option>${mm}</option>`).join("")}</select>
          </div>
          <div>
            <label>Valor (R$) <span style="opacity:.7;font-weight:600;">(obrigat√≥rio)</span></label>
            <input oninput="formatarMoeda(this)">
          </div>
        `;
        interList.appendChild(r);
      }
    }

    /* =========================
       MCMV (Faixa + Taxa)
    ========================== */
    const MCMV_RANGES = [
      { faixa:"Faixa 1", min:0,       max:2160.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.07:4.33) : (reg==="no_ne"?4.59:4.84) },
      { faixa:"Faixa 1", min:2160.01, max:2850.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.33:4.59) : (reg==="no_ne"?4.84:5.12) },
      { faixa:"Faixa 2", min:2850.01, max:3500.00,  rate:(isCotista, reg)=> isCotista ? (reg==="no_ne"?4.84:5.12) : (reg==="no_ne"?5.38:5.64) },
      { faixa:"Faixa 2", min:3500.01, max:4000.00,  rate:(isCotista, reg)=> isCotista ? 5.64 : 6.17 },
      { faixa:"Faixa 2", min:4000.01, max:4700.00,  rate:(isCotista, reg)=> isCotista ? 6.70 : 7.23 },
      { faixa:"Faixa 3", min:4700.01, max:8600.00,  rate:(isCotista, reg)=> isCotista ? 7.93 : 8.46 },
      { faixa:"Faixa 4", min:8600.01, max:12000.00, rate:()=> 11.03 },
    ];

    function findRangeByRenda(renda){
      return MCMV_RANGES.find(r => renda >= r.min && renda <= r.max) || null;
    }
    function findRangeByFaixa(faixa){
      return MCMV_RANGES.find(r => r.faixa === faixa) || null;
    }

    let __faixaManual = false;
    let __taxaManual = false;

    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("faixaMCMVSelect").addEventListener("change", ()=>{
        __faixaManual = true;
        updateTaxaPorFaixaManual();
      });

      document.getElementById("taxaEfetivaAnual").addEventListener("input", ()=>{
        __taxaManual = true;
      });
    });

    function onChangeRegiao(){
      const reg = document.getElementById("regiao").value;
      document.getElementById("cotista").value = "";
      document.getElementById("boxCotista").style.display = reg ? "block" : "none";
      document.getElementById("boxFaixa").style.display = "none";
      document.getElementById("boxTaxaEf").style.display = "none";
      updateMCMV();
    }
    function onChangeCotista(){
      document.getElementById("boxFaixa").style.display = "none";
      document.getElementById("boxTaxaEf").style.display = "none";
      updateMCMV();
    }

    function updateMCMV(){
      const renda = limparMoeda(document.getElementById("renda").value);
      const reg = document.getElementById("regiao").value;
      const cot = document.getElementById("cotista").value;

      if(!reg || !cot) return;

      document.getElementById("boxFaixa").style.display = "block";
      document.getElementById("boxTaxaEf").style.display = "block";

      const faixaSel = document.getElementById("faixaMCMVSelect");
      const taxaEl = document.getElementById("taxaEfetivaAnual");

      if(!renda || renda<=0){
        if(!__faixaManual) faixaSel.value = "Faixa 1";
        if(!__taxaManual) taxaEl.value = "";
        return;
      }

      const range = findRangeByRenda(renda);
      if(range && !__faixaManual){
        faixaSel.value = range.faixa;
      }

      const isCotista = (cot === "cotista");
      let taxa = null;

      if(__faixaManual){
        const rF = findRangeByFaixa(faixaSel.value);
        if(rF) taxa = rF.rate(isCotista, reg);
      } else {
        if(range) taxa = range.rate(isCotista, reg);
      }

      if(taxa !== null && !__taxaManual){
        taxaEl.value = Number(taxa).toFixed(2);
      } else if(taxa === null && !__taxaManual){
        taxaEl.value = "";
      }
    }

    function updateTaxaPorFaixaManual(){
      const reg = document.getElementById("regiao").value;
      const cot = document.getElementById("cotista").value;
      if(!reg || !cot) return;

      const isCotista = (cot === "cotista");
      const faixaSel = document.getElementById("faixaMCMVSelect").value;
      const rF = findRangeByFaixa(faixaSel);
      if(!rF) return;

      if(!__taxaManual){
        document.getElementById("taxaEfetivaAnual").value = Number(rF.rate(isCotista, reg)).toFixed(2);
      }
    }

    /* =========================
       ENTRADA (RESULTADOS)
    ========================== */
    function setResultadoEntrada(tipo, html){
      const out = document.getElementById("resultadoEntrada");
      out.className = "resultado " + tipo;
      out.innerHTML = html;
      out.style.display = "block";
    }

    function calcularEntrada(){
      const im = limparMoeda(document.getElementById("valorImovel").value);
      const fi = limparMoeda(document.getElementById("valorFinanciamento").value);

      const usaFgts = document.getElementById("usaFgts").value === "sim";
      const fg = usaFgts ? limparMoeda(document.getElementById("fgts").value) : 0;

      const at = limparMoeda(document.getElementById("ato").value);
      const re = limparMoeda(document.getElementById("renda").value);
      const p  = parseInt(document.getElementById("parcelasEntrada").value,10) || 0;

      if(!im || !fi || !re || !p){
        setResultadoEntrada("vermelho",
          `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
           <p class="alerta">Preencha: Valor do Im√≥vel, Financiamento, Renda e Meses/Parcelas.</p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const entrada = im - fi - fg;
      const temInter = document.getElementById("temInter").value === "sim";
      const interVals = [];
      const interMeta = [];

      if(temInter){
        const rows = document.querySelectorAll("#interList .inter-row");
        if(!rows.length){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Voc√™ marcou pagamentos extras, mas n√£o informou a quantidade.</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }

        let faltando=false;
        rows.forEach((row)=>{
          const sel=row.querySelector("select");
          const inp=row.querySelector("input");
          const data=sel ? sel.value : "-";
          const mesesAte=sel ? sel.selectedIndex : 0;
          const v=limparMoeda(inp ? inp.value : "");
          if(!v || v<=0) faltando=true;
          interVals.push(v);
          interMeta.push({ data, mesesAte, valorBase:v });
        });

        if(faltando){
          setResultadoEntrada("vermelho",
            `<h3>‚ö†Ô∏è Entrada / Fluxo Inicial</h3>
             <p class="alerta">Preencha o valor de todos os pagamentos extras (campo obrigat√≥rio).</p>
             <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
          );
          return;
        }
      }

      const somaInter = interVals.reduce((a,b)=>a+b,0);
      let saldo = entrada - at - somaInter;

      const entregaTxt = document.getElementById("entregaSelect").value;

      // Se ato + extras cobrem tudo
      if(saldo <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal: 0,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        const interHtml = (temInter && somaInter>0)
          ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
          : ``;

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada no Per√≠odo de Obras</h3>
           <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
           <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
           <div class="divider"></div>
           <p>Ato: <b>${moeda(at)}</b></p>
           ${interHtml}
           <p>Mensais (${p}x): <b>${moeda(0)}</b></p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      // Mensais limitadas a 30%
      const limiteMensal = re * 0.30;
      let mensal = saldo / p;
      let resto = 0;

      if(mensal > limiteMensal){
        mensal = limiteMensal;
        resto = saldo - (mensal * p);
      }

      const interHtml = (temInter && somaInter>0)
        ? `<p>Pagamentos extras: <b>${moeda(somaInter)}</b></p>`
        : ``;

      const baseHTML = `
        <p>üìÖ Previs√£o de entrega: <b>${entregaTxt}</b></p>
        <p><b>Entrada Total:</b> ${moeda(entrada)}</p>
        <div class="divider"></div>
        <p>Ato: <b>${moeda(at)}</b></p>
        ${interHtml}
        <p>Mensais (${p}x): <b>${moeda(mensal)}</b></p>
        <div class="obs"><i>* Considerado limite de 30% da renda familiar para parcelas mensais.</i></div>
      `;

      // Verde: dentro do limite e sem resto
      if(resto <= 0){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: 0, status: "verde"
        };

        setResultadoEntrada("verde",
          `<h3>‚úÖ Fluxo de Entrada no Per√≠odo de Obras</h3>
           ${baseHTML}
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      const aceitaPos = document.getElementById("aceitaPos").value === "sim";

      // Amarelo: com saldo restante e construtora aceita
      if(aceitaPos){
        window.__lastEntradaCalc = {
          entradaTotal: entrada, ato: at, parcelas: p, mensal,
          interVals, interMeta, saldoRestante: resto, status: "amarelo"
        };

        setResultadoEntrada("amarelo",
          `<h3>‚ö†Ô∏è Entrada com saldo restante</h3>
           ${baseHTML}
           <div class="divider"></div>
           <p><b>Saldo restante:</b> ${moeda(resto)}</p>
           <p><b>Saldo restante para verificar parcelamento com a construtora.</b></p>
           <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
        );
        return;
      }

      // Vermelho: saldo restante e construtora n√£o aceita
      window.__lastEntradaCalc = {
        entradaTotal: entrada, ato: at, parcelas: p, mensal,
        interVals, interMeta, saldoRestante: resto, status: "vermelho"
      };

      setResultadoEntrada("vermelho",
        `<h3>Verificar saldo restante p√≥s per√≠odo de obras</h3>
         ${baseHTML}
         <div class="divider"></div>
         <p><b>Saldo restante:</b> ${moeda(resto)}</p>
         <p class="alerta"><b>Valor de entrada ultrapassa os limites de parcelamento dentro do per√≠odo de obras.</b></p>
         <button class="btn-limpar" onclick="limparEntrada()">LIMPAR FLUXO DE ENTRADA</button>`
      );
    }

    function limparEntrada(){
      const out=document.getElementById("resultadoEntrada");
      out.style.display="none";
      out.innerHTML="";
      out.className="resultado";
      window.__lastEntradaCalc=null;
    }

    /* =========================
       JUROS DE OBRA (TABELA)
    ========================== */
    function setResultadoJuros(tipo, html){
      const out = document.getElementById("resultadoJuros");
      out.className = "resultado " + tipo;
      out.innerHTML = html;
      out.style.display = "block";
    }

    function buildPercList(passo){
      const list=[];
      for(let p=passo;p<=100;p+=passo) list.push(p);
      if(list[list.length-1]!==100) list.push(100);
      return list;
    }

    function calcularJurosTabela(){
      const financiamento = limparMoeda(document.getElementById("valorFinanciamento").value);
      const taxaEfetiva = parseFloat(document.getElementById("taxaEfetivaAnual").value) || 0;
      const tr = parseFloat(document.getElementById("tr").value) || 0;
      const taxas = limparMoeda(document.getElementById("taxas").value);
      const passo = parseInt(document.getElementById("passoTabela").value,10) || 10;

      if(!financiamento || !taxaEfetiva){
        setResultadoJuros("vermelho",
          `<h3>üèóÔ∏è Juros de Obra</h3>
           <p class="alerta">Preencha o Valor do Financiamento e a Taxa de Juros Efetivos Anual (%).</p>
           <button class="btn-limpar" onclick="limparJuros()">LIMPAR JUROS DE OBRA</button>`
        );
        window.__lastJurosTabela=null;
        return;
      }

      const jurosMensal = (taxaEfetiva/100)/12;
      const trMensal = (tr/100);
      const percList = buildPercList(passo);

      const rows = percList.map(perc=>{
        const liberado = financiamento*(perc/100);
        const parcela = (liberado*jurosMensal) + (liberado*trMensal) + taxas;
        return { perc, parcela };
      });

      window.__lastJurosTabela = { financiamento, taxaEfetiva, tr, taxas, passo, rows };

      // Desktop (4 colunas)
      const half = Math.ceil(rows.length/2);
      const leftRows = rows.slice(0, half);
      const rightRows = rows.slice(half);

      let desktop = `
        <div class="juros-desktop">
          <h3 style="margin:0 0 10px;">üèóÔ∏è Tabela de Juros de Obra (Estimativa)</h3>
          <div class="tabela-wrap">
            <table>
              <thead>
                <tr>
                  <th>% da Obra</th>
                  <th>Parcela Estimada (m√™s)</th>
                  <th>% da Obra</th>
                  <th>Parcela Estimada (m√™s)</th>
                </tr>
              </thead>
              <tbody>
      `;
      for(let i=0;i<half;i++){
        const L=leftRows[i];
        const R=rightRows[i];
        desktop += `
          <tr>
            <td>${L?`<b>${L.perc}%</b>`:""}</td>
            <td>${L?moeda(L.parcela):""}</td>
            <td>${R?`<b>${R.perc}%</b>`:""}</td>
            <td>${R?moeda(R.parcela):""}</td>
          </tr>
        `;
      }
      desktop += `
              </tbody>
            </table>
          </div>
        </div>
      `;

      // Mobile (2 colunas, mostrando tudo at√© 100%)
      let mobile = `
        <div class="juros-mobile">
          <h3 style="margin:0 0 10px;">üèóÔ∏è Tabela de Juros de Obra (Estimativa)</h3>
          <div class="juros-grid">
            ${rows.map(r=>`
              <div class="juros-card">
                <div class="p">${r.perc}% da obra</div>
                <div class="v">${moeda(r.parcela)} / m√™s</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;

      // Observa√ß√µes: it√°lico + links azuis clic√°veis em bloco claro
      const obs = `
        <div class="box-claro amarelo obs">
          * Valores aproximados para fins de simula√ß√£o e entendimento.<br>
          * Valor estimado de <b>${moeda(taxas)}</b> para taxas administrativas e seguros obrigat√≥rios (MIP/DFI).<br>
          * A TR possui varia√ß√£o mensal. Valor utilizado apenas para fins estimativos.<br>
          * Consulta da TR atualizada:
          <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank" rel="noopener noreferrer">
            https://www.debit.com.br/tabelas/tr-bacen
          </a>
        </div>
      `;

      setResultadoJuros("amarelo",
        desktop + mobile + obs +
        `<button class="btn-limpar" onclick="limparJuros()">LIMPAR JUROS DE OBRA</button>`
      );
    }

    function limparJuros(){
      const out=document.getElementById("resultadoJuros");
      out.style.display="none";
      out.innerHTML="";
      out.className="resultado";
      window.__lastJurosTabela=null;
    }

    /* =========================
       PDF
    ========================== */
    function writeWrap(doc, text, x, y, maxW, lineH){
      const lines = doc.splitTextToSize(text, maxW);
      doc.text(lines, x, y);
      return y + (lines.length * lineH);
    }

    async function gerarPDF(){
      const incluirJuros = (document.getElementById("pdfJuros").value === "sim");
      if(incluirJuros && (!window.__lastJurosTabela || !window.__lastJurosTabela.rows || !window.__lastJurosTabela.rows.length)){
        alert("Para incluir a estimativa de Juros de Obra no PDF, √© necess√°rio calcular a tabela antes.");
        return;
      }

      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("Biblioteca do PDF n√£o carregou.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });

      const dataDoc = new Date().toLocaleDateString("pt-BR");
      const incluirINCC = (document.getElementById("pdfINCC").value === "sim");
      const inccVal = normalizarPercentBR(document.getElementById("inccValor").value);

      const empreendimento = (document.getElementById("empreendimento").value || "").trim() || "-";
      const unidade = (document.getElementById("unidade").value || "").trim() || "-";
      const valorImovelTxt = document.getElementById("valorImovel").value || "-";
      const valorFinTxt = document.getElementById("valorFinanciamento").value || "-";
      const rendaTxt = document.getElementById("renda").value || "R$ 0,00";
      const entregaTxt = document.getElementById("entregaSelect").value || "-";

      const usaFgts = document.getElementById("usaFgts").value === "sim";
      const fgtsTxt = usaFgts ? (document.getElementById("fgts").value || "R$ 0,00") : "R$ 0,00";

      const pdfCliente = (document.getElementById("pdfCliente").value || "").trim() || "-";
      const pdfClienteFone = (document.getElementById("pdfClienteFone").value || "").trim() || "-";
      const pdfCorretor = (document.getElementById("pdfCorretor").value || "").trim() || "-";
      const pdfCorretorFone = (document.getElementById("pdfCorretorFone").value || "").trim() || "-";

      const reg = document.getElementById("regiao").value || "";
      const cot = document.getElementById("cotista").value || "";
      const faixaTxt = (document.getElementById("faixaMCMVSelect").value || "").trim() || "-";
      const taxaEfTxt = (document.getElementById("taxaEfetivaAnual").value || "").trim() || "-";

      const vincTxt =
        cot === "cotista" ? "Cotista (+3 anos CLT)" :
        cot === "nao_cotista" ? "N√£o Cotista" : "-";

      const regTxt =
        reg === "no_ne" ? "Norte / Nordeste" :
        reg === "sul_se_co" ? "Sudeste / Sul / Centro-Oeste" : "-";

      const atoTxt = document.getElementById("ato").value || "R$ 0,00";
      const parcelasTxt = document.getElementById("parcelasEntrada").value || "-";
      const aceitaPosTxt = (document.getElementById("aceitaPos").value === "sim") ? "Sim" : "N√£o";

      let y = 14;
      const left = 14;
      const right = 196;
      const maxW = right - left;

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text("SIMULA√á√ÉO FINANCEIRA ‚Äì IM√ìVEL NA PLANTA", 105, y, { align:"center" });
      y += 7;

      doc.setDrawColor(200);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Identifica√ß√£o", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      y = writeWrap(doc, `Cliente: ${pdfCliente} | Tel: ${pdfClienteFone}`, left, y, maxW, 5);
      y = writeWrap(doc, `Corretor(a): ${pdfCorretor} | Tel: ${pdfCorretorFone}`, left, y, maxW, 5);
      y = writeWrap(doc, `Empreendimento: ${empreendimento}`, left, y, maxW, 5);
      y = writeWrap(doc, `Unidade/Bloco/Andar: ${unidade}`, left, y, maxW, 5);
      y = writeWrap(doc, `Data do documento: ${dataDoc}`, left, y, maxW, 5);

      y += 2;
      doc.setDrawColor(220);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Resumo Financeiro", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      y = writeWrap(doc, `Valor do im√≥vel: ${valorImovelTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Valor do financiamento: ${valorFinTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `FGTS considerado: ${fgtsTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Renda familiar: ${rendaTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Previs√£o de entrega: ${entregaTxt}`, left, y, maxW, 5);

      y += 2;
      y = writeWrap(doc, `Enquadramento MCMV (estimado): ${faixaTxt} | Regi√£o: ${regTxt} | V√≠nculo: ${vincTxt}`, left, y, maxW, 5);
      y = writeWrap(doc, `Taxa efetiva anual usada: ${taxaEfTxt}${taxaEfTxt ? "%" : ""}`, left, y, maxW, 5);

      y += 2;
      doc.setDrawColor(220);
      doc.line(left, y, right, y);
      y += 6;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("Fluxo de Pagamento ‚Äì Entrada", left, y);
      y += 6;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      const entradaCalc = window.__lastEntradaCalc;
      if(!entradaCalc){
        y = writeWrap(doc, "Fluxo n√£o calculado no simulador. Gere o c√°lculo de entrada antes de gerar o PDF.", left, y, maxW, 5);
      } else {
        y = writeWrap(doc, `Entrada Total: ${moeda(entradaCalc.entradaTotal)}`, left, y, maxW, 5);
        y = writeWrap(doc, `Ato: ${atoTxt}`, left, y, maxW, 5);
        y = writeWrap(doc, `Meses/Parcelas (entrada): ${parcelasTxt}`, left, y, maxW, 5);

        if(entradaCalc.interVals && entradaCalc.interVals.length){
          const totalInter = entradaCalc.interVals.reduce((a,b)=>a+b,0);
          y = writeWrap(doc, `Pagamentos extras: ${moeda(totalInter)}`, left, y, maxW, 5);
        }

        y = writeWrap(doc, `Mensais (${entradaCalc.parcelas}x): ${moeda(entradaCalc.mensal)}`, left, y, maxW, 5);

        if(entradaCalc.saldoRestante && entradaCalc.saldoRestante > 0){
          y = writeWrap(doc, `Saldo restante: ${moeda(entradaCalc.saldoRestante)} (P√≥s-Chaves/Pr√≥-Soluto: ${aceitaPosTxt})`, left, y, maxW, 5);
          y = writeWrap(doc, `Saldo restante para verificar parcelamento com a construtora.`, left, y, maxW, 5);
        }

        y = writeWrap(doc, "Observa√ß√£o: Considerado limite de 30% da renda familiar para parcelas mensais.", left, y, maxW, 5);
      }

      if(incluirINCC){
        if(y > 250){ doc.addPage(); y = 14; }
        y += 2;
        doc.setDrawColor(220);
        doc.line(left, y, right, y);
        y += 6;

        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text("Estimativa de INCC", left, y);
        y += 6;

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);

        const taxa = (inccVal !== null ? (inccVal/100) : 0.005);
        y = writeWrap(doc, `INCC (m√©dia mensal): ${((taxa*100).toFixed(2)).replace(".",",")}%`, left, y, maxW, 5);
        y = writeWrap(doc, "* Valores aproximados para fins de simula√ß√£o e entendimento.", left, y, maxW, 5);
        y = writeWrap(doc, "INCC atualizado dispon√≠vel em: portal.fgv.br/noticias/incc-m-2025", left, y, maxW, 5);
      }

      if(incluirJuros){
        if(y > 240){ doc.addPage(); y = 14; }
        y += 2;
        doc.setDrawColor(220);
        doc.line(left, y, right, y);
        y += 6;

        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text("Juros de Obra ‚Äì Tabela", left, y);
        y += 6;

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);

        const jt = window.__lastJurosTabela;
        y = writeWrap(doc, `Intervalo: ${jt.passo} em ${jt.passo}% | TR(%): ${jt.tr} | Taxa Adm + Seguros: ${moeda(jt.taxas)} | Taxa efetiva anual(%): ${jt.taxaEfetiva}`, left, y, maxW, 5);

        const rows = jt.rows;
        const half = Math.ceil(rows.length/2);
        const leftRows = rows.slice(0, half);
        const rightRows = rows.slice(half);
        const colX = [left, left+35, left+95, left+130];

        doc.setFont("helvetica","bold");
        doc.text("%", colX[0], y);
        doc.text("Parcela", colX[1], y);
        doc.text("%", colX[2], y);
        doc.text("Parcela", colX[3], y);
        y += 6;

        doc.setFont("helvetica","normal");
        for(let i=0;i<half;i++){
          const L=leftRows[i];
          const R=rightRows[i];
          if(L){
            doc.text(`${L.perc}%`, colX[0], y);
            doc.text(`${moeda(L.parcela)}`, colX[1], y);
          }
          if(R){
            doc.text(`${R.perc}%`, colX[2], y);
            doc.text(`${moeda(R.parcela)}`, colX[3], y);
          }
          y += 5;
          if(y > 280){ doc.addPage(); y = 14; }
        }

        y = writeWrap(doc, "* Valores aproximados para fins de simula√ß√£o e entendimento.", left, y, maxW, 5);
        y = writeWrap(doc, "* A TR possui varia√ß√£o mensal. Consulta da TR atualizada: debit.com.br/tabelas/tr-bacen", left, y, maxW, 5);
      }

      doc.save("simulacao-imobiliaria.pdf");
    }

    /* =========================
       INIT
    ========================== */
    (function(){
      toggleFGTS();
      toggleINCC();
    })();
  </script>
</body>
</html>
