<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Imobili√°rio Pro v7.2 - MCMV Oficial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #ecfdf5;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius-lg: 24px;
            --radius-md: 14px;
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.03), 0 8px 10px -6px rgba(0,0,0,0.01);
            
            --bg-bloco-1: #f8fafc;
            --bg-bloco-2: #fffcf5;
            --bg-bloco-3: #f7fff9;
            --bg-diagnostico: #f9f8ff;
            --bg-simulacao: #f0fdfa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: var(--text-main); line-height: 1.6; min-height: 100vh; padding: 20px 16px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        /* Bloco de Consentimento */
        #consentBlock {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .consent-card {
            max-width: 550px;
            background: #fff;
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #f1f5f9;
        }
        .consent-card h2 { font-family: 'Poppins'; color: var(--danger); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .consent-card p { font-size: 15px; color: var(--text-main); margin-bottom: 15px; text-align: left; }
        .consent-card ul { text-align: left; margin-bottom: 25px; padding-left: 20px; }
        .consent-card li { font-size: 14px; color: var(--text-muted); margin-bottom: 10px; }

        header { text-align: center; margin-bottom: 32px; }
        header h1 { font-family: 'Poppins', sans-serif; font-size: clamp(22px, 6vw, 32px); color: var(--primary-dark); margin-bottom: 4px; }
        header p { color: var(--text-muted); font-size: 14px; }

        .card { background: #fff; border-radius: var(--radius-lg); padding: clamp(20px, 5vw, 32px); box-shadow: var(--shadow-lg); margin-bottom: 24px; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
        .bloco-1 { background-color: var(--bg-bloco-1); }
        .bloco-2 { background-color: var(--bg-bloco-2); }
        .bloco-3 { background-color: var(--bg-bloco-3); }
        .bloco-diagnostico { background-color: var(--bg-diagnostico); border: 2px solid #eef2ff; }
        .bloco-simulacao { background-color: var(--bg-simulacao); border: 2px solid #ccfbf1; }

        .section-title { font-family: 'Poppins', sans-serif; font-size: 17px; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary); width: 22px; height: 22px; }
        .obs-italico { font-size: 12px; font-style: italic; color: var(--text-muted); font-weight: 400; margin-left: 4px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
        @media (min-width: 500px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper i { position: absolute; left: 16px; color: var(--text-muted); width: 18px; height: 18px; pointer-events: none; }
        input, select { width: 100%; padding: 12px 16px; padding-left: 48px; border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); font-size: 15px; font-family: inherit; color: var(--text-main); background: #fff; transition: all 0.2s ease; outline: none; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; width: 100%; }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: transparent; color: var(--text-muted); font-size: 13px; margin-top: 10px; text-decoration: underline; }

        .diag-container { display: flex; flex-direction: column; gap: 12px; }
        .diag-item { background: #fff; border-left: 4px solid var(--secondary); padding: 16px; border-radius: 0 var(--radius-md) var(--radius-md) 0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .diag-item.destaque { border-left-color: var(--primary); background: #f0fdf4; }
        .diag-item.subsidio { border-left-color: var(--warning); background: #fffbeb; }
        .diag-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px; }
        .diag-value { font-size: 15px; color: var(--text-main); }
        .diag-value strong { color: var(--primary-dark); }

        /* Resultado Fluxo v7 */
        .fluxo-card { background: #fff; border-radius: var(--radius-lg); overflow: hidden; border: 1px solid #e2e8f0; margin-top: 24px; box-shadow: var(--shadow-lg); }
        .fluxo-header { background: #f8fafc; padding: 20px; border-bottom: 1px solid #e2e8f0; text-align: center; }
        .fluxo-header h4 { font-family: 'Poppins'; color: var(--text-main); font-size: 18px; }
        .fluxo-header p { font-size: 13px; color: var(--text-muted); }
        .fluxo-body { padding: 24px; }
        .fluxo-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; font-size: 14px; }
        .fluxo-label { color: var(--text-muted); }
        .fluxo-valor { font-weight: 700; }
        .fluxo-divider { height: 1px; background: #f1f5f9; margin: 8px 0; }
        .fluxo-secao { background: #f8fafc; padding: 16px; border-radius: var(--radius-md); margin: 16px 0; border: 1px solid #e2e8f0; }
        .fluxo-secao-titulo { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--secondary); margin-bottom: 12px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .fluxo-destaque { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: var(--radius-md); margin: 16px 0; text-align: center; }
        .fluxo-destaque .label { font-weight: 700; color: var(--primary-dark); font-size: 13px; }
        .fluxo-destaque .valor { color: var(--primary); font-size: 28px; font-weight: 800; display: block; margin-top: 4px; }

        .alerta-box { padding: 14px; border-radius: var(--radius-md); margin-top: 16px; text-align: center; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .alerta-box.sucesso { background: #f0fdf4; color: var(--primary-dark); border: 1px solid #bbf7d0; }
        .alerta-box.erro { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

        .prazo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 8px; }
        .prazo-btn { padding: 12px; border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); background: #fff; cursor: pointer; text-align: center; transition: all 0.2s; }
        .prazo-btn span { display: block; font-weight: 700; font-size: 14px; }
        .prazo-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cores espec√≠ficas solicitadas */
        .color-azul { color: #3b82f6 !important; }
        .color-laranja { color: #f59e0b !important; }
    </style>
</head>
<body>

<!-- BLOCO DE CONSENTIMENTO -->
<div id="consentBlock">
    <div class="consent-card">
        <h2><i data-lucide="alert-triangle"></i> ATEN√á√ÉO</h2>
        <p>Antes de prosseguir, esteja ciente de que:</p>
        <ul style="text-align: left; margin-bottom: 25px; padding-left: 20px;">
            <li style="font-size: 14px; color: var(--text-muted); margin-bottom: 10px;">Este √© um simulador apenas para fins educativos e estimativas financeiras referente √† aquisi√ß√£o de im√≥veis na planta pelo programa Minha Casa Minha Vida;</li>
            <li style="font-size: 14px; color: var(--text-muted); margin-bottom: 10px;">Usamos valores pr√©-programados, como 30% da renda mensal para parcelas da entrada e 100% da renda para intermedi√°rias/anuais/chaves;</li>
            <li style="font-size: 14px; color: var(--text-muted); margin-bottom: 10px;">Valores reais, condi√ß√µes de pagamento e detalhes dever√£o ser verificados diretamente com o seu corretor respons√°vel.</li>
        </ul>
        <button id="btnConcordo" class="btn btn-primary">Sim. De acordo</button>
    </div>
</div>

<div class="container hidden" id="mainContent">
    <header>
        <h1>Simulador Imobili√°rio</h1>
        <p>M√≥dulo Comprador - Minha Casa Minha Vida (Oficial)</p>
    </header>

    <main id="app">
        <!-- BLOCO 1: Identifica√ß√£o -->
        <section class="card bloco-1 fade-in">
            <h3 class="section-title"><i data-lucide="user"></i> Bloco 1 - Identifica√ß√£o</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="compraCom">1. Quem participar√° da compra? <span class="obs-italico">(Em conjunto = Namorada(o), noivo(a), c√¥njuge, familiar...)</span></label>
                    <div class="input-wrapper"><i data-lucide="users"></i>
                        <select id="compraCom">
                            <option value="">Selecione...</option>
                            <option value="sozinho">Comprar Sozinho(a)</option>
                            <option value="conjunto">Comprar em Conjunto</option>
                        </select>
                    </div>
                </div>
                <div id="boxIdades" class="grid grid-2 hidden">
                    <div class="form-group">
                        <label id="labelIdade1" for="idade1">Sua Idade</label>
                        <div class="input-wrapper"><i data-lucide="calendar"></i><select id="idade1" class="select-idade"></select></div>
                    </div>
                    <div id="boxIdade2" class="form-group hidden">
                        <label for="idade2">Idade do 2¬∫ Comprador</label>
                        <div class="input-wrapper"><i data-lucide="calendar"></i><select id="idade2" class="select-idade"></select></div>
                    </div>
                </div>
                <div id="boxEstado" class="form-group hidden">
                    <label for="estado">3. Estado da Compra</label>
                    <div class="input-wrapper"><i data-lucide="map-pin"></i>
                        <select id="estado">
                            <option value="">Selecione o estado...</option>
                            <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option><option value="ES">Esp√≠rito Santo</option><option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option><option value="PA">Par√°</option><option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option><option value="PE">Pernambuco</option><option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- BLOCO 2: Financeiro -->
        <section id="stepFinanceiro" class="card bloco-2 fade-in hidden">
            <h3 class="section-title"><i data-lucide="dollar-sign"></i> Bloco 2 - Informa√ß√µes Financeiras</h3>
            <div class="grid">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label id="labelRenda1" for="renda1">Sua Renda Mensal</label>
                        <div class="input-wrapper"><i data-lucide="banknote"></i><input type="text" id="renda1" class="money-mask" placeholder="R$ 0,00"></div>
                    </div>
                    <div id="boxRenda2" class="form-group hidden">
                        <label for="renda2">Renda do 2¬∫ Comprador</label>
                        <div class="input-wrapper"><i data-lucide="banknote"></i><input type="text" id="renda2" class="money-mask" placeholder="R$ 0,00"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="temGuardado">Possui algum valor guardado para entrada?</label>
                    <div class="input-wrapper"><i data-lucide="help-circle"></i>
                        <select id="temGuardado">
                            <option value="">Selecione...</option>
                            <option value="sim">Sim, possuo</option>
                            <option value="nao">N√£o possuo</option>
                        </select>
                    </div>
                </div>
                <div id="boxValorGuardado" class="form-group hidden">
                    <label for="valorGuardado">Qual o valor guardado?</label>
                    <div class="input-wrapper"><i data-lucide="wallet"></i><input type="text" id="valorGuardado" class="money-mask" placeholder="R$ 0,00"></div>
                </div>
            </div>
        </section>

        <!-- BLOCO 3: Trabalho -->
        <section id="stepTrabalho" class="card bloco-3 fade-in hidden">
            <h3 class="section-title"><i data-lucide="briefcase"></i> Bloco 3 - Regime de Trabalho</h3>
            <div class="grid">
                <div class="form-group">
                    <label id="labelRegime">Qual seu regime de trabalho?</label>
                    <div class="input-wrapper"><i data-lucide="award"></i>
                        <select id="regimeTrabalho">
                            <option value="">Selecione...</option>
                            <option value="clt3">CLT (Mais de 3 anos de FGTS)</option>
                            <option value="cltmenos">CLT (Menos de 3 anos de FGTS)</option>
                            <option value="pj">Aut√¥nomo / PJ / Outros</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="usaFgts">Possui FGTS e pretende usar na compra?</label>
                    <div class="input-wrapper"><i data-lucide="help-circle"></i>
                        <select id="usaFgts">
                            <option value="">Selecione...</option>
                            <option value="sim">Sim, pretendo usar</option>
                            <option value="nao">N√£o pretendo usar</option>
                        </select>
                    </div>
                </div>
                <div id="boxFgtsVal" class="form-group hidden">
                    <label for="fgtsVal">Valor dispon√≠vel no FGTS</label>
                    <div class="input-wrapper"><i data-lucide="piggy-bank"></i><input type="text" id="fgtsVal" class="money-mask" placeholder="R$ 0,00"></div>
                </div>
            </div>
            <div style="margin-top: 24px;"><button id="btnGerarDiagnostico" class="btn btn-primary"><i data-lucide="bar-chart-3"></i> GERAR DIAGN√ìSTICO</button></div>
        </section>

        <!-- RESULTADO DO DIAGN√ìSTICO -->
        <div id="diagnosticoContainer" class="hidden">
            <section class="card bloco-diagnostico fade-in">
                <h3 class="section-title"><i data-lucide="check-circle"></i> üìä Seu Diagn√≥stico MCMV</h3>
                <div id="diagnosticoResumo" class="diag-container"></div>
            </section>

            <!-- BLOCO DE SIMULA√á√ÉO -->
            <section id="blocoSimulacao" class="card bloco-simulacao fade-in">
                <h3 class="section-title"><i data-lucide="calculator"></i> üí° Simular Fluxo de Entrada</h3>
                <div class="grid">
                    <div class="form-group">
                        <label for="valorImovel">üí∞ Valor do Im√≥vel Pretendido</label>
                        <div class="input-wrapper"><i data-lucide="home"></i><input type="text" id="valorImovel" class="money-mask" placeholder="R$ 0,00"></div>
                        <div id="avisoTeto" style="font-size: 12px; color: var(--danger); font-weight: 600; margin-top: 4px; display: none;"></div>
                    </div>
                    
                    <div class="form-group" style="background: #f0f9ff; padding: 15px; border-radius: var(--radius-md); border: 1px solid #bae6fd;">
                        <label for="valorAto">üí≥ Valor do Ato (1¬™ Parcela)</label>
                        <div class="input-wrapper"><i data-lucide="wallet"></i><input type="text" id="valorAto" class="money-mask" placeholder="R$ 0,00"></div>
                        <p style="color: #0369a1; font-weight: 500; font-size: 12px; margin-top: 5px;">üí° Quanto maior o valor do Ato, menor os valores das parcelas mensais.</p>
                    </div>

                    <div class="form-group" style="background: #fffbeb; padding: 15px; border-radius: var(--radius-md); border: 1px solid #fef3c7;">
                        <label for="usaIntermediarias">üìÖ Deseja incluir estimativa com intermedi√°rias/anuais/chaves?</label>
                        <div class="input-wrapper"><i data-lucide="help-circle"></i>
                            <select id="usaIntermediarias">
                                <option value="nao">N√£o. Apenas parcelas mensais</option>
                                <option value="sim">Sim, quero incluir</option>
                            </select>
                        </div>
                        <p style="color: #b45309; font-weight: 500; font-size: 12px; margin-top: 5px;">üí° Valores ser√£o estimados conforme prazo escolhido. Cada empreendimento possui regras pr√≥prias.</p>
                    </div>

                    <div class="form-group">
                        <label>‚è±Ô∏è Prazo estimado de entrega da obra:</label>
                        <div class="prazo-grid">
                            <button class="prazo-btn" data-meses="12"><span>12 meses</span></button>
                            <button class="prazo-btn" data-meses="18"><span>18 meses</span></button>
                            <button class="prazo-btn" data-meses="24"><span>24 meses</span></button>
                            <button class="prazo-btn" data-meses="30"><span>30 meses</span></button>
                            <button class="prazo-btn" data-meses="36"><span>36 meses</span></button>
                        </div>
                    </div>
                    <button id="btnCalcularFluxo" class="btn btn-primary">CALCULAR FLUXO DE ENTRADA</button>
                </div>
            </section>
            <div id="fluxoResultado" class="hidden"></div>
        </div>
        <div style="text-align: center; margin-bottom: 40px;"><button id="btnLimpar" class="btn btn-danger">üóëÔ∏è REINICIAR SIMULADOR</button></div>
    </main>
</div>

<script>
    const CONFIG = {
        REGIOES_S_SE_CO: ["SP", "RJ", "MG", "ES", "PR", "SC", "RS", "DF", "GO", "MT", "MS"],
        COMPROMETIMENTO: 0.30,
        LTV_MAX: 0.80,
        PRAZO_MAX_MESES: 420
    };

    let state = { dadosDiagnostico: null, prazoSelecionado: null };

    document.addEventListener('DOMContentLoaded', () => { 
        lucide.createIcons(); 
        popularIdades(); 
        setupEventListeners(); 
        setupMasks(); 
    });

    function popularIdades() {
        const selects = document.querySelectorAll('.select-idade');
        selects.forEach(select => {
            select.innerHTML = '<option value="">Selecione...</option>';
            for (let i = 18; i <= 70; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.textContent = i + ' anos'; select.appendChild(opt);
            }
        });
    }

    function setupEventListeners() {
        const btnConcordo = document.getElementById('btnConcordo');
        if (btnConcordo) {
            btnConcordo.onclick = () => {
                document.getElementById('consentBlock').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                window.scrollTo(0,0);
            };
        }

        document.getElementById('compraCom').addEventListener('change', (e) => {
            const val = e.target.value; const isConjunto = val === 'conjunto';
            document.getElementById('boxIdades').classList.toggle('hidden', !val);
            document.getElementById('boxIdade2').classList.toggle('hidden', !isConjunto);
            document.getElementById('labelIdade1').textContent = isConjunto ? 'Idade Comprador 1' : 'Sua Idade';
            document.getElementById('labelRegime').textContent = isConjunto ? 'Algum dos compradores trabalha em Regime CLT h√° mais de 3 anos?' : 'Qual seu regime de trabalho?';
            checkStepFinanceiro();
        });
        ['idade1', 'idade2', 'estado'].forEach(id => { document.getElementById(id).addEventListener('change', checkStepFinanceiro); });
        ['renda1', 'renda2', 'temGuardado', 'valorGuardado'].forEach(id => { document.getElementById(id).addEventListener('input', checkStepTrabalho); document.getElementById(id).addEventListener('change', checkStepTrabalho); });
        document.getElementById('temGuardado').addEventListener('change', (e) => { document.getElementById('boxValorGuardado').classList.toggle('hidden', e.target.value !== 'sim'); });
        document.getElementById('usaFgts').addEventListener('change', (e) => { document.getElementById('boxFgtsVal').classList.toggle('hidden', e.target.value !== 'sim'); });
        document.getElementById('btnGerarDiagnostico').addEventListener('click', gerarDiagnostico);
        document.querySelectorAll('.prazo-btn').forEach(btn => {
            btn.addEventListener('click', () => { document.querySelectorAll('.prazo-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); state.prazoSelecionado = parseInt(btn.dataset.meses); });
        });
        document.getElementById('btnCalcularFluxo').addEventListener('click', calcularFluxo);
        document.getElementById('btnLimpar').addEventListener('click', () => { if(confirm('Deseja realmente reiniciar?')) location.reload(); });
    }

    function checkStepFinanceiro() {
        const comp = document.getElementById('compraCom').value; const i1 = document.getElementById('idade1').value; const i2 = document.getElementById('idade2').value;
        let valid = comp && i1; if (comp === 'conjunto') valid = valid && i2;
        document.getElementById('boxEstado').classList.toggle('hidden', !valid);
        const est = document.getElementById('estado').value; document.getElementById('stepFinanceiro').classList.toggle('hidden', !(valid && est));
    }

    function checkStepTrabalho() {
        const r1 = parseMoney(document.getElementById('renda1').value); const comp = document.getElementById('compraCom').value; const r2 = parseMoney(document.getElementById('renda2').value);
        const temG = document.getElementById('temGuardado').value; const valG = parseMoney(document.getElementById('valorGuardado').value);
        let valid = r1 > 0 && temG; if (comp === 'conjunto') valid = valid && r2 > 0; if (temG === 'sim') valid = valid && valG > 0;
        document.getElementById('stepTrabalho').classList.toggle('hidden', !valid);
        document.getElementById('labelRenda1').textContent = (comp === 'conjunto') ? 'Renda Comprador 1' : 'Sua Renda Mensal';
        document.getElementById('boxRenda2').classList.toggle('hidden', comp !== 'conjunto');
    }

    function getMCMVData(rendaTotal, cotista, uf) {
        const isS_SE_CO = CONFIG.REGIOES_S_SE_CO.includes(uf);
        let faixa, teto, taxa;
        if (rendaTotal <= 2850) {
            faixa = 1; teto = 190000;
            if (rendaTotal <= 2160) { taxa = isS_SE_CO ? (cotista ? 4.33 : 4.84) : (cotista ? 4.07 : 4.59); }
            else { taxa = isS_SE_CO ? (cotista ? 4.59 : 5.12) : (cotista ? 4.33 : 4.84); }
        } else if (rendaTotal <= 4700) {
            faixa = 2; teto = 264000;
            if (rendaTotal <= 3500) { taxa = isS_SE_CO ? (cotista ? 5.12 : 5.64) : (cotista ? 4.84 : 5.38); }
            else if (rendaTotal <= 4000) { taxa = cotista ? 5.64 : 6.17; }
            else { taxa = cotista ? 6.70 : 7.23; }
        } else if (rendaTotal <= 8600) { faixa = 3; teto = 350000; taxa = cotista ? 7.93 : 8.46; }
        else if (rendaTotal <= 12000) { faixa = 4; teto = 500000; taxa = 11.03; }
        else return null;
        return { faixa, teto, taxa };
    }

    function gerarDiagnostico() {
        const r1 = parseMoney(document.getElementById('renda1').value);
        const r2 = parseMoney(document.getElementById('renda2').value);
        const i1 = parseInt(document.getElementById('idade1').value);
        const i2 = parseInt(document.getElementById('idade2').value) || 0;
        const uf = document.getElementById('estado').value;
        const cotista = document.getElementById('regimeTrabalho').value === 'clt3';
        const fgts = parseMoney(document.getElementById('fgtsVal').value);
        const guardado = parseMoney(document.getElementById('valorGuardado').value);

        const rendaTotal = r1 + r2;
        const data = getMCMVData(rendaTotal, cotista, uf);
        if (!data) return alert("Renda fora dos limites do programa.");

        const { faixa, teto, taxa } = data;
        const idadeMedia = i2 > 0 ? Math.round((i1 + i2) / 2) : i1;
        const parcelaMax = rendaTotal * CONFIG.COMPROMETIMENTO;
        const taxaMensal = taxa / 100 / 12;
        const n = Math.min(CONFIG.PRAZO_MAX_MESES, (80 - idadeMedia) * 12);
        const capFinanciamento = (parcelaMax * (1 - Math.pow(1 + taxaMensal, -n))) / taxaMensal;

        state.dadosDiagnostico = { faixa, taxa, rendaTotal, capFinanciamento, teto, fgts, guardado, parcelaMax };

        let html = `
            <div class="diag-item"><div class="diag-label">üè† Faixa do Minha Casa Minha Vida</div><div class="diag-value">Voc√™ faz parte da <strong>Faixa ${faixa}</strong> do Programa.</div></div>
            <div class="diag-item"><div class="diag-label">üí∞ Teto do Programa</div><div class="diag-value">Na sua faixa, √© poss√≠vel adquirir im√≥veis de <strong>at√© ${formatMoney(teto)}</strong>.</div></div>
            <div class="diag-item destaque"><div class="diag-label">üìà Taxa de Juros</div><div class="diag-value">Financiamento com taxa estimada de <strong>${taxa.toFixed(2)}% ao ano</strong>.</div></div>
            <div class="diag-item"><div class="diag-label">üìä Parcela M√°xima Mensal</div><div class="diag-value">O limite de comprometimento da sua renda √© de <strong>${formatMoney(parcelaMax)}</strong>.</div></div>
        `;
        if (faixa <= 2) {
            html += `<div class="diag-item subsidio"><div class="diag-label">üéÅ Subs√≠dio do Governo</div><div class="diag-value">Voc√™ pode ter direito a subs√≠dio (A ser verificado durante An√°lise Caixa).</div></div>`;
        }

        document.getElementById('diagnosticoResumo').innerHTML = html;
        document.getElementById('diagnosticoContainer').classList.remove('hidden');
        document.getElementById('diagnosticoContainer').scrollIntoView({ behavior: 'smooth' });
        
        if (guardado > 0) document.getElementById('valorAto').value = formatMoney(guardado);
        lucide.createIcons();
    }

    function calcularFluxo() {
        const valorImovel = parseMoney(document.getElementById('valorImovel').value);
        const valorAto = parseMoney(document.getElementById('valorAto').value) || 1000;
        const usaInter = document.getElementById('usaIntermediarias').value === 'sim';
        
        if (!valorImovel) return alert('Informe o valor do im√≥vel');
        if (!state.prazoSelecionado) return alert('Selecione o prazo de entrega');

        const d = state.dadosDiagnostico;
        if (!d) return alert('Por favor, gere o diagn√≥stico primeiro.');

        if (valorImovel > d.teto) {
            document.getElementById('avisoTeto').textContent = `‚ö†Ô∏è Valor acima do teto (${formatMoney(d.teto)})`;
            document.getElementById('avisoTeto').style.display = 'block';
            return;
        } else document.getElementById('avisoTeto').style.display = 'none';

        const financiamentoEstimado = Math.min(d.capFinanciamento, valorImovel * CONFIG.LTV_MAX);
        const entradaTotal = valorImovel - financiamentoEstimado - d.fgts;
        
        let numInter = 0;
        if (usaInter) {
            if (state.prazoSelecionado <= 12) numInter = 1;
            else if (state.prazoSelecionado <= 24) numInter = 2;
            else numInter = 3;
        }
        
        const valorTotalInter = numInter * d.rendaTotal;
        const faltanteMensal = Math.max(0, entradaTotal - valorAto - valorTotalInter);
        const parcelaMensal = faltanteMensal / state.prazoSelecionado;
        const ultrapassa = parcelaMensal > d.parcelaMax;
        
        let saldoRestante = 0;
        if (ultrapassa) {
            saldoRestante = faltanteMensal - (d.parcelaMax * state.prazoSelecionado);
        }

        const hoje = new Date();
        const previsao = new Date(hoje.getFullYear(), hoje.getMonth() + state.prazoSelecionado, 1);
        const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const previsaoTexto = `${mesesNomes[previsao.getMonth()]}/${previsao.getFullYear().toString().substr(-2)}`;

        const resDiv = document.getElementById('fluxoResultado');
        resDiv.innerHTML = `
            <div class="fluxo-card fade-in">
                <div class="fluxo-header">
                    <h4>üìã Fluxo de Pagamento - ${state.prazoSelecionado} meses</h4>
                    <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
                </div>
                <div class="fluxo-body">
                    <div class="fluxo-row"><span class="fluxo-label">Valor do Im√≥vel Pretendido</span><span class="fluxo-valor color-azul">${formatMoney(valorImovel)}</span></div>
                    <div class="fluxo-row"><span class="fluxo-label">Valor do Financiamento Estimado</span><span class="fluxo-valor color-laranja">${formatMoney(financiamentoEstimado)}</span></div>
                    ${d.fgts > 0 ? `<div class="fluxo-row"><span class="fluxo-label">FGTS</span><span class="fluxo-valor color-laranja">${formatMoney(d.fgts)}</span></div>` : ''}
                    
                    <div class="fluxo-destaque">
                        <span class="label">Entrada Total - Parcelamento no Per√≠odo de Obras</span>
                        <span class="valor">${formatMoney(entradaTotal + d.fgts)}</span>
                    </div>

                    <div class="fluxo-secao">
                        <div class="fluxo-secao-titulo"><i data-lucide="credit-card"></i> Divis√£o do Pagamento</div>
                        <div class="fluxo-row"><span class="fluxo-label">Ato (1¬™ Parcela)</span><span class="fluxo-valor">${formatMoney(valorAto)}</span></div>
                        ${numInter > 0 ? `<div class="fluxo-row"><span class="fluxo-label">Intermedi√°rias (${numInter}x)</span><span class="fluxo-valor">${formatMoney(d.rendaTotal)}</span></div>` : ''}
                        <div class="fluxo-row">
                            <span class="fluxo-label">Parcelas Mensais (${state.prazoSelecionado}x)</span>
                            <span class="fluxo-valor" style="color: ${ultrapassa ? 'var(--danger)' : 'var(--text-main)'}">${formatMoney(parcelaMensal)}</span>
                        </div>
                    </div>

                    ${saldoRestante > 0 ? `
                    <div class="fluxo-row" style="background: #fff1f2; padding: 10px; border-radius: 8px;">
                        <span class="fluxo-label" style="color: var(--danger); font-weight: 700;">‚ö†Ô∏è Saldo Restante</span>
                        <span class="fluxo-valor" style="color: var(--danger);">${formatMoney(saldoRestante)}</span>
                    </div>
                    ` : ''}

                    <div class="alerta-box ${ultrapassa ? 'erro' : 'sucesso'}">
                        <i data-lucide="${ultrapassa ? 'alert-triangle' : 'check-circle'}"></i>
                        ${ultrapassa 
                            ? 'Entrada ultrapassa os valores limites estipulados para parcelamento. Necess√°rio aumentar valor do Ato ou verificar p√≥s-chaves.' 
                            : 'Fluxo aprovado! Parcelas cabem nos 30% da sua renda.'}
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 15px; text-align: center;">* Construtoras exigem um Ato M√≠nimo para formalizar a compra.</p>
                </div>
            </div>
        `;
        resDiv.classList.remove('hidden');
        resDiv.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
    }

    function setupMasks() {
        document.querySelectorAll('.money-mask').forEach(input => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (!value) { e.target.value = ''; return; }
                value = (value / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                e.target.value = value;
            });
        });
    }

    function parseMoney(text) { if (!text) return 0; return parseFloat(text.replace(/[^\d,]/g, '').replace(',', '.')) || 0; }
    function formatMoney(value) { return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
</script>
</body>
</html>
