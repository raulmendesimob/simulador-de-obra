<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulador Minha Casa Minha Vida — Financiamento Máximo</title>

  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f4f4f4;
      padding:24px;
      margin:0
    }
    .container{
      max-width:900px;
      margin:auto;
      background:#fff;
      padding:24px;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.05)
    }
    h1{font-size:22px;margin-bottom:20px}
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px
    }
    label{
      font-size:12px;
      color:#555;
      margin-bottom:6px;
      display:block
    }
    input{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:14px;
      outline:none
    }
    input:focus{border-color:#bbb}
    .buttons{margin-top:16px;display:flex;gap:10px}
    button{
      padding:10px 16px;
      border-radius:8px;
      border:none;
      font-size:14px;
      cursor:pointer
    }
    button.primary{background:#111;color:#fff}
    button.secondary{background:#eaeaea}
    .result{
      margin-top:24px;
      background:#fafafa;
      border-radius:10px;
      padding:16px;
      border:1px solid #eee;
      min-height:28px
    }
    .result-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px
    }
    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:8px;
      padding:12px
    }
    .card strong{font-size:13px;display:block;margin-bottom:4px}
    .note{margin-top:12px;font-size:12px;color:#666;line-height:1.4}
    .error{
      background:#fff6f6;
      border:1px solid #f3c0c0;
      color:#7a1f1f;
      padding:12px;
      border-radius:10px;
      font-size:13px;
      line-height:1.35
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    @media (max-width:720px){
      .grid,.result-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Simulador Minha Casa Minha Vida — Financiamento Máximo</h1>

    <div class="grid">
      <div>
        <label for="renda">Renda familiar (R$)</label>
        <input id="renda" value="6496,27" inputmode="decimal" placeholder="Ex.: 6496,27">
      </div>

      <div>
        <label for="juros">Juros efetivos ao ano (%)</label>
        <input id="juros" value="7,9348" inputmode="decimal" placeholder="Ex.: 7,9348">
      </div>

      <div>
        <label for="prazo">Prazo (meses)</label>
        <input id="prazo" type="number" value="420" min="1" max="480">
      </div>

      <div>
        <label for="imovel">Valor do imóvel (R$)</label>
        <input id="imovel" value="300000" inputmode="decimal" placeholder="Ex.: 300000">
      </div>

      <div>
        <label for="idade">Idade média dos compradores</label>
        <input id="idade" type="number" value="28" min="0" max="120">
      </div>

      <div>
        <label for="comprometimento">Comprometimento máximo da renda (%)</label>
        <input id="comprometimento" value="30" inputmode="decimal" placeholder="Ex.: 30">
      </div>
    </div>

    <div class="buttons">
      <button class="primary" id="btnCalcular" type="button">Calcular</button>
      <button class="secondary" id="btnLimpar" type="button">Limpar</button>
    </div>

    <div class="result" id="resultado" aria-live="polite"></div>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    function parseBR(v){
      if(v===null||v===undefined) return NaN;
      const s=String(v).trim().replace(/\./g,"").replace(",",".");
      const n=Number(s);
      return Number.isFinite(n)?n:NaN;
    }
    function money(v){
      if(!Number.isFinite(v)) return "—";
      return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function renderError(el,messages){
      el.innerHTML=`
        <div class="error">
          <strong>Corrija para calcular:</strong><br>
          ${messages.map(m=>"• "+m).join("<br>")}
        </div>
      `;
    }

    // =========================
    // Seguros (estimativa DFI + MIP)
    // =========================
    function estimateInsurance(pmtTotal, idade){
      if(!Number.isFinite(pmtTotal)||pmtTotal<=0) return 0;

      // taxa aproximada por faixa etária (empírico)
      let rate=0.03;
      if(idade<=30) rate=0.028;
      else if(idade<=40) rate=0.03;
      else if(idade<=50) rate=0.035;
      else rate=0.04;

      return pmtTotal*rate;
    }

    // =========================
    // PRICE
    // =========================
    function pvPrice(pmt, i, n){
      if(i<=0) return pmt*n;
      return pmt*(1-Math.pow(1+i,-n))/i;
    }
    function pmtPrice(pv, i, n){
      if(i<=0) return pv/n;
      return pv*(i/(1-Math.pow(1+i,-n)));
    }

    // =========================
    // Busca binária: PV máximo que respeita a parcela máxima
    // - Usa o mesmo modelo final de seguros e taxa adm
    // - Garante que a parcela do "aprovado" nunca passe do limite
    // =========================
    function maxPVByPaymentLimit(parcelaMaxima, i, n, idade, taxaAdm){
      // teto alto para busca (pode ajustar se quiser)
      let low=0;
      let high=1500000; // 1,5 milhão

      for(let k=0;k<45;k++){ // 45 iterações => precisão excelente
        const mid=(low+high)/2;

        const pmtAJ=pmtPrice(mid,i,n);
        const seguros=estimateInsurance(pmtAJ+taxaAdm,idade);
        const parcelaTotal=pmtAJ+taxaAdm+seguros;

        if(parcelaTotal<=parcelaMaxima) low=mid;
        else high=mid;
      }
      return low;
    }

    // =========================
    // Cálculo principal
    // =========================
    function calcular(){
      const rendaEl=document.getElementById("renda");
      const jurosEl=document.getElementById("juros");
      const prazoEl=document.getElementById("prazo");
      const imovelEl=document.getElementById("imovel");
      const idadeEl=document.getElementById("idade");
      const compEl=document.getElementById("comprometimento");
      const resultadoEl=document.getElementById("resultado");

      const renda=parseBR(rendaEl.value);
      const jurosAA=parseBR(jurosEl.value)/100;
      const prazo=Number(prazoEl.value);
      const valorImovel=parseBR(imovelEl.value);
      const idade=Number(idadeEl.value);
      const comprometimento=parseBR(compEl.value)/100;

      // Constantes do produto
      const TAXA_ADM=25;
      const LTV=0.80;

      // Ajuste empírico (aplicar no PV máximo por renda, antes de comparar com LTV)
      const AJUSTE_CAIXA=1.025;

      // Validações
      const errors=[];
      if(!Number.isFinite(renda)||renda<=0) errors.push("Informe uma renda válida.");
      if(!Number.isFinite(jurosAA)||jurosAA<=0) errors.push("Informe juros válidos (ex.: 5,6408 ou 7,9348).");
      if(!Number.isFinite(prazo)||prazo<=0) errors.push("Informe um prazo válido (meses).");
      if(!Number.isFinite(valorImovel)||valorImovel<=0) errors.push("Informe um valor de imóvel válido.");
      if(!Number.isFinite(idade)||idade<0) errors.push("Informe uma idade válida.");
      if(!Number.isFinite(comprometimento)||comprometimento<=0||comprometimento>1){
        errors.push("Comprometimento deve ser entre 0 e 100 (ex.: 30).");
      }
      if(errors.length){
        renderError(resultadoEl,errors);
        return;
      }

      // Taxa mensal (aprox)
      const i=jurosAA/12;

      // 1) Parcela máxima (limite por renda)
      const parcelaMaxima=renda*comprometimento;

      // 2) PV máximo que cabe pela renda (já considerando seguros + taxa adm do nosso modelo final)
      const pvMaxRendaSemAjuste=maxPVByPaymentLimit(parcelaMaxima, i, prazo, idade, TAXA_ADM);

      // 3) Aplicar ajuste empírico no PV por renda (lugar certo)
      const pvMaxRenda=pvMaxRendaSemAjuste*AJUSTE_CAIXA;

      // 4) Teto por LTV
      const tetoLTV=valorImovel*LTV;

      // 5) Financiamento aprovado
      const financiamento=Math.min(pvMaxRenda, tetoLTV);

      // 6) Entrada necessária
      const entrada=Math.max(0, valorImovel-financiamento);

      // 7) Parcela REAL do cenário aprovado
      const pmtAJ_aprovada=pmtPrice(financiamento, i, prazo);
      const segurosAprovados=estimateInsurance(pmtAJ_aprovada+TAXA_ADM, idade);
      const parcelaReal=pmtAJ_aprovada+TAXA_ADM+segurosAprovados;

      // 8) Informar o limitante
      const limitante =
        (Math.abs(financiamento - tetoLTV) < 0.01)
          ? "Limitante: LTV (80% do valor do imóvel). Por isso a parcela final pode ficar abaixo do limite da renda."
          : "Limitante: capacidade de pagamento pela renda (comprometimento).";

      // 9) Mostrar (extra) o “PV máximo por renda” antes/depois do ajuste
      resultadoEl.innerHTML=`
        <div class="result-grid">
          <div class="card"><strong>Parcela máxima permitida (renda)</strong>${money(parcelaMaxima)}</div>
          <div class="card"><strong>Parcela estimada do financiamento aprovado</strong>${money(parcelaReal)}</div>

          <div class="card"><strong>Capacidade financeira máxima (renda)</strong>${money(pvMaxRenda)}</div>
          <div class="card"><strong>Teto por LTV (80%)</strong>${money(tetoLTV)}</div>

          <div class="card"><strong>Financiamento aprovado</strong>${money(financiamento)}</div>
          <div class="card"><strong>Entrada necessária</strong>${money(entrada)}</div>
        </div>

        <div class="note">
          ${limitante}<br>
          Observação: “Parcela máxima” é um limite. A “parcela do aprovado” é recalculada a partir do PV aprovado
          (PRICE + seguros estimados + taxa adm).<br>
          Ajuste empírico aplicado no PV máximo por renda: <strong class="mono">${AJUSTE_CAIXA}</strong> (simulação estimada).
        </div>
      `;
    }

    function limpar(){
      document.getElementById("resultado").innerHTML="";
    }

    // Eventos
    document.getElementById("btnCalcular").addEventListener("click", calcular);
    document.getElementById("btnLimpar").addEventListener("click", limpar);

    // Auto-cálculo ao carregar
    calcular();
  </script>
</body>
</html>
