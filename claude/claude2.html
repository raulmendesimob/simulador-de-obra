// ============================================
// SIMULADOR IMOBILI√ÅRIO PRO v16.2
// Gerador de PDF Completo e Profissional
// ============================================

const CONFIG = {
    REGIOES_S_SE_CO: ["SP", "RJ", "MG", "ES", "PR", "SC", "RS", "DF", "GO", "MT", "MS"],
    COMPROMETIMENTO: 0.30,
    LTV_MAX: 0.80,
    PRAZO_MAX_PADRAO: 420,
    IDADE_LIMITE_CAIXA: 80.5
};

let state = { 
    dadosDiagnostico: null, 
    prazoSelecionado: null, 
    simType: 'estimada', 
    ultimoCalculo: null,
    inccCalculado: false,
    jurosCalculado: false,
    dadosINCC: null,
    dadosJuros: null
};

document.addEventListener('DOMContentLoaded', () => { 
    lucide.createIcons(); 
    popularIdades(); 
    popularPrazosObra();
    setupEventListeners(); 
    setupMasks(); 
    document.getElementById('taxasAdm').value = formatMoney(65);
});

function popularIdades() {
    const selects = document.querySelectorAll('.select-idade');
    selects.forEach(select => {
        select.innerHTML = '<option value="">Selecione...</option>';
        for (let i = 18; i <= 70; i++) {
            const opt = document.createElement('option'); opt.value = i; opt.textContent = i + ' anos'; select.appendChild(opt);
        }
    });
}

function popularPrazosObra() {
    const select = document.getElementById('prazoObraDet');
    select.innerHTML = '<option value="">Selecione...</option>';
    for (let i = 1; i <= 40; i++) {
        const opt = document.createElement('option'); opt.value = i; opt.textContent = i; select.appendChild(opt);
    }
}

function generateDateOptions() {
    const options = [];
    const hoje = new Date();
    const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    for (let i = 1; i <= 60; i++) {
        const d = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
        const label = `${mesesNomes[d.getMonth()]}/${d.getFullYear().toString().substr(-2)}`;
        options.push(`<option value="${label}">${label}</option>`);
    }
    return options.join('');
}

function setupEventListeners() {
    document.getElementById('btnConcordo').onclick = () => { 
        document.getElementById('consentBlock').classList.add('hidden'); 
        document.getElementById('mainContent').classList.remove('hidden'); 
        window.scrollTo(0,0); 
    };
    
    document.getElementById('compraCom').addEventListener('change', (e) => {
        const val = e.target.value; 
        const isConjunto = val === 'conjunto';
        document.getElementById('boxIdades').classList.toggle('hidden', !val);
        document.getElementById('boxIdade2').classList.toggle('hidden', !isConjunto);
        document.getElementById('labelIdade1').textContent = isConjunto ? 'Idade Comprador 1' : 'Sua Idade';
        document.getElementById('labelRegime').textContent = isConjunto ? 'Algum dos compradores trabalha em Regime CLT h√° mais de 3 anos?' : 'Qual seu regime de trabalho?';
        checkStepFinanceiro();
    });
    
    ['idade1', 'idade2', 'estado'].forEach(id => { 
        document.getElementById(id).addEventListener('change', checkStepFinanceiro); 
    });
    
    ['renda1', 'renda2', 'temGuardado', 'valorGuardado'].forEach(id => { 
        document.getElementById(id).addEventListener('input', () => { checkStepTrabalho(); atualizarBotaoDiagnostico(); }); 
        document.getElementById(id).addEventListener('change', () => { checkStepTrabalho(); atualizarBotaoDiagnostico(); }); 
    });
    
    document.getElementById('temGuardado').addEventListener('change', (e) => { 
        document.getElementById('boxValorGuardado').classList.toggle('hidden', e.target.value !== 'sim'); 
    });
    
    document.getElementById('regimeTrabalho').addEventListener('change', (e) => {
        const isClt3 = e.target.value === 'clt3';
        document.getElementById('boxUsaFgts').classList.toggle('hidden', !isClt3);
        if(!isClt3) {
            document.getElementById('usaFgts').value = 'nao';
            document.getElementById('boxFgtsVal').classList.add('hidden');
            document.getElementById('fgtsVal').value = '';
        }
    });
    
    document.getElementById('usaFgts').addEventListener('change', (e) => { 
        document.getElementById('boxFgtsVal').classList.toggle('hidden', e.target.value !== 'sim'); 
        atualizarBotaoDiagnostico();
    });
    
    document.getElementById('fgtsVal').addEventListener('input', atualizarBotaoDiagnostico);
    document.getElementById('fgtsVal').addEventListener('change', atualizarBotaoDiagnostico);
    document.getElementById('regimeTrabalho').addEventListener('change', atualizarBotaoDiagnostico);
    
    document.getElementById('btnGerarDiagnostico').addEventListener('click', gerarDiagnostico);
    
    document.querySelectorAll('.prazo-btn').forEach(btn => {
        btn.addEventListener('click', () => { 
            document.querySelectorAll('.prazo-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            state.prazoSelecionado = parseInt(btn.dataset.meses); 
        });
    });
    
    document.getElementById('temInterDet').addEventListener('change', (e) => {
        const sim = e.target.value === 'sim';
        document.getElementById('boxQtdInter').classList.toggle('hidden', !sim);
        document.getElementById('containerInterItems').classList.toggle('hidden', !sim);
        if(sim) updateInterItems();
    });
    
    document.getElementById('qtdInterDet').addEventListener('change', updateInterItems);
    
    document.getElementById('temSubsidio').addEventListener('change', (e) => {
        document.getElementById('boxSubsidioVal').classList.toggle('hidden', e.target.value !== 'sim');
    });
    
    document.getElementById('valorAvaliacao').addEventListener('blur', (e) => {
        if (!state.dadosDiagnostico) return;
        let val = parseMoney(e.target.value);
        if (val > state.dadosDiagnostico.teto) {
            e.target.value = formatMoney(state.dadosDiagnostico.teto);
            document.getElementById('avisoTetoAval').style.display = 'block';
            document.getElementById('avisoTetoAval').textContent = `‚ö†Ô∏è Valor limitado ao teto da faixa (${formatMoney(state.dadosDiagnostico.teto)})`;
        } else {
            document.getElementById('avisoTetoAval').style.display = 'none';
        }
        
        const campoFin = document.getElementById('financiamentoAprovado');
        if (!campoFin.value || parseMoney(campoFin.value) === 0) {
            const finEst = Math.min(val * CONFIG.LTV_MAX, state.dadosDiagnostico.capFinanciamento, state.dadosDiagnostico.teto);
            campoFin.value = formatMoney(finEst);
        }
    });
    
    document.getElementById('financiamentoAprovado').addEventListener('blur', (e) => {
        if (!state.dadosDiagnostico) return;
        const valorAval = parseMoney(document.getElementById('valorAvaliacao').value);
        if (!valorAval) return;
        
        const finDigitado = parseMoney(e.target.value);
        const limiteMax = Math.min(valorAval * CONFIG.LTV_MAX, state.dadosDiagnostico.capFinanciamento, state.dadosDiagnostico.teto);
        
        if (finDigitado > limiteMax) {
            e.target.value = formatMoney(limiteMax);
            alert(`‚ö†Ô∏è O financiamento aprovado n√£o pode ultrapassar:\n\n‚Ä¢ 80% da Avalia√ß√£o: ${formatMoney(valorAval * CONFIG.LTV_MAX)}\n‚Ä¢ Capacidade pela Renda: ${formatMoney(state.dadosDiagnostico.capFinanciamento)}\n‚Ä¢ Teto da Faixa: ${formatMoney(state.dadosDiagnostico.teto)}\n\nValor ajustado para: ${formatMoney(limiteMax)}`);
        }
    });
    
    document.getElementById('valorImovel').addEventListener('blur', (e) => {
        if (!state.dadosDiagnostico) return;
        let val = parseMoney(e.target.value);
        if (val > state.dadosDiagnostico.teto) {
            e.target.value = formatMoney(state.dadosDiagnostico.teto);
            document.getElementById('avisoTetoImovel').style.display = 'block';
            document.getElementById('avisoTetoImovel').textContent = `‚ö†Ô∏è Valor limitado ao teto da faixa (${formatMoney(state.dadosDiagnostico.teto)}). Para valores maiores, use a Simula√ß√£o Detalhada.`;
        } else {
            document.getElementById('avisoTetoImovel').style.display = 'none';
        }
    });

    document.getElementById('btnCalcularEstimada').addEventListener('click', calcularFluxoEstimado);
    document.getElementById('btnCalcularDetalhada').addEventListener('click', calcularFluxoDetalhado);
    document.getElementById('btnLimpar').addEventListener('click', () => { 
        if(confirm('Deseja realmente reiniciar?')) location.reload(); 
    });
}

function updateInterItems() {
    const qtd = parseInt(document.getElementById('qtdInterDet').value);
    const container = document.getElementById('containerInterItems');
    const dateOpts = generateDateOptions();
    let html = '';
    for (let i = 1; i <= qtd; i++) {
        html += `
            <div class="inter-item">
                <div class="form-group">
                    <label>${i}¬∫ pagamento</label>
                    <select class="inter-date">${dateOpts}</select>
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="text" class="money-mask inter-val" placeholder="R$ 0,00">
                </div>
            </div>
        `;
    }
    container.innerHTML = html;
    setupMasks();
}

function selectSimType(type) {
    state.simType = type;
    document.getElementById('blocoEscolha').classList.add('hidden');
    document.getElementById('blocoSimulacaoEstimada').classList.toggle('hidden', type !== 'estimada');
    document.getElementById('blocoSimulacaoDetalhada').classList.toggle('hidden', type !== 'detalhada');
    const target = type === 'estimada' ? 'blocoSimulacaoEstimada' : 'blocoSimulacaoDetalhada';
    document.getElementById(target).scrollIntoView({ behavior: 'smooth' });
}

function backToChoice() {
    document.getElementById('blocoSimulacaoEstimada').classList.add('hidden');
    document.getElementById('blocoSimulacaoDetalhada').classList.add('hidden');
    document.getElementById('blocoEscolha').classList.remove('hidden');
    document.getElementById('fluxoResultado').classList.add('hidden');
    document.getElementById('blocosExtras').classList.add('hidden');
    state.inccCalculado = false;
    state.jurosCalculado = false;
}

function checkStepFinanceiro() {
    const comp = document.getElementById('compraCom').value; 
    const i1 = document.getElementById('idade1').value; 
    const i2 = document.getElementById('idade2').value;
    let valid = comp && i1; 
    if (comp === 'conjunto') valid = valid && i2;
    document.getElementById('boxEstado').classList.toggle('hidden', !valid);
    const est = document.getElementById('estado').value; 
    document.getElementById('stepFinanceiro').classList.toggle('hidden', !(valid && est));
}

function checkStepTrabalho() {
    const r1 = parseMoney(document.getElementById('renda1').value); 
    const comp = document.getElementById('compraCom').value; 
    const r2 = parseMoney(document.getElementById('renda2').value);
    const temG = document.getElementById('temGuardado').value; 
    const valG = parseMoney(document.getElementById('valorGuardado').value);
    let valid = r1 > 0 && temG; 
    if (comp === 'conjunto') valid = valid && r2 > 0; 
    if (temG === 'sim') valid = valid && valG > 0;
    document.getElementById('stepTrabalho').classList.toggle('hidden', !valid);
    document.getElementById('boxRenda2').classList.toggle('hidden', comp !== 'conjunto');
}

function getMCMVData(rendaTotal, cotista, uf) {
    const isS_SE_CO = CONFIG.REGIOES_S_SE_CO.includes(uf);
    let faixa, teto, taxa;
    if (rendaTotal <= 2850) {
        faixa = 1; teto = 190000;
        if (rendaTotal <= 2160) { 
            taxa = isS_SE_CO ? (cotista ? 4.33 : 4.84) : (cotista ? 4.07 : 4.59); 
        } else { 
            taxa = isS_SE_CO ? (cotista ? 4.59 : 5.12) : (cotista ? 4.33 : 4.84); 
        }
    } else if (rendaTotal <= 4700) {
        faixa = 2; teto = 264000;
        if (rendaTotal <= 3500) { 
            taxa = isS_SE_CO ? (cotista ? 5.12 : 5.64) : (cotista ? 4.84 : 5.38); 
        } else if (rendaTotal <= 4000) { 
            taxa = cotista ? 5.64 : 6.17; 
        } else { 
            taxa = cotista ? 6.70 : 7.23; 
        }
    } else if (rendaTotal <= 8600) { 
        faixa = 3; teto = 350000; taxa = cotista ? 7.93 : 8.46; 
    } else if (rendaTotal <= 12000) { 
        faixa = 4; teto = 500000; taxa = 11.03; 
    } else return null;
    return { faixa, teto, taxa };
}

function gerarDiagnostico() {
    const r1 = parseMoney(document.getElementById('renda1').value);
    const r2 = parseMoney(document.getElementById('renda2').value);
    const i1 = parseInt(document.getElementById('idade1').value);
    const i2 = parseInt(document.getElementById('idade2').value) || 0;
    const uf = document.getElementById('estado').value;
    const cotista = document.getElementById('regimeTrabalho').value === 'clt3';
    const fgts = parseMoney(document.getElementById('fgtsVal').value);
    const guardado = parseMoney(document.getElementById('valorGuardado').value);

    const rendaTotal = r1 + r2;
    const data = getMCMVData(rendaTotal, cotista, uf);
    if (!data) return alert("Renda fora dos limites do programa.");

    const { faixa, teto, taxa } = data;
    const idadeMedia = i2 > 0 ? Math.round((i1 + i2) / 2) : i1;
    const prazoMaximoIdade = Math.floor((CONFIG.IDADE_LIMITE_CAIXA - idadeMedia) * 12);
    const prazoFinalFinanciamento = Math.min(CONFIG.PRAZO_MAX_PADRAO, prazoMaximoIdade);

    if (prazoFinalFinanciamento <= 0) return alert("Idade incompat√≠vel com financiamento.");

    const parcelaMax = rendaTotal * CONFIG.COMPROMETIMENTO;
    const taxaMensal = Math.pow(1 + (taxa / 100), 1 / 12) - 1;
    const capFinanciamento = (parcelaMax * (Math.pow(1 + taxaMensal, prazoFinalFinanciamento) - 1)) / (taxaMensal * Math.pow(1 + taxaMensal, prazoFinalFinanciamento));

    state.dadosDiagnostico = { 
        faixa, taxa, rendaTotal, capFinanciamento, teto, fgts, guardado, parcelaMax, prazoFinalFinanciamento,
        r1, r2, i1, i2, uf, cotista
    };

    let html = `
        <div class="diag-item"><div class="diag-label">üè† Faixa do Minha Casa Minha Vida</div><div class="diag-value">Voc√™ faz parte da <strong>Faixa ${faixa}</strong> do Programa.</div></div>
        <div class="diag-item"><div class="diag-label">üí∞ Teto do Programa</div><div class="diag-value">Na sua faixa, √© poss√≠vel adquirir im√≥veis de <strong>at√© ${formatMoney(teto)} de avalia√ß√£o</strong>.</div></div>
        <div class="diag-item destaque"><div class="diag-label">üìà Taxa de Juros e Prazo</div><div class="diag-value">Taxa de <strong>${taxa.toFixed(2)}% ao ano</strong> com prazo m√°ximo de <strong>${prazoFinalFinanciamento} meses</strong>.</div></div>
        <div class="diag-item"><div class="diag-label">üìä Parcela</div><div class="diag-value">A sua parcela m√°xima de pagamento mensal do financiamento √© de <strong>${formatMoney(parcelaMax)}</strong>.</div></div>
    `;
    if (faixa <= 2) html += `<div class="diag-item subsidio"><div class="diag-label">üéÅ Subs√≠dio do Governo</div><div class="diag-value">Voc√™ pode ter direito a <strong>subs√≠dio</strong> (A ser verificado durante An√°lise Caixa).</div></div>`;

    document.getElementById('diagnosticoResumo').innerHTML = html;
    document.getElementById('diagnosticoContainer').classList.remove('hidden');
    document.getElementById('diagnosticoContainer').scrollIntoView({ behavior: 'smooth' });
    if (guardado > 0) {
        document.getElementById('valorAto').value = formatMoney(guardado);
        document.getElementById('valorAtoDet').value = formatMoney(guardado);
    }
    
    lucide.createIcons();
}

function calcularFluxoEstimado() {
    limparResultadosINCC_Juros();
    const d = state.dadosDiagnostico;
    if (!d) return alert('Gere a an√°lise de perfil primeiro.');
    if (!state.prazoSelecionado) return alert('Selecione o prazo de entrega');

    const valorImovel = parseMoney(document.getElementById('valorImovel').value);
    let valorAto = parseMoney(document.getElementById('valorAto').value);
    const usouAtoDefault = valorAto === 0;
    if (valorAto === 0) valorAto = 1000;
    
    if (!valorImovel) return alert('Informe o valor do im√≥vel');

    const financiamentoEstimado = Math.min(valorImovel * CONFIG.LTV_MAX, d.capFinanciamento, d.teto);
    const entradaTotal = valorImovel - financiamentoEstimado - d.fgts;
    
    const inputsTotal = financiamentoEstimado + d.fgts;
    const entradaUltrapassa = inputsTotal >= valorImovel;
    
    const prazo = state.prazoSelecionado;
    let qtdInter = 0;
    if (prazo === 12) qtdInter = 1;
    else if (prazo === 18 || prazo === 24) qtdInter = 2;
    else if (prazo === 30 || prazo === 36) qtdInter = 3;
    
    const valorInter = qtdInter > 0 ? d.rendaTotal : 0;
    const totalInter = valorInter * qtdInter;
    
    const saldoParaMensais = entradaTotal - valorAto - totalInter;
    const parcelaMensal = Math.max(0, saldoParaMensais / prazo);
    const ultrapassa = parcelaMensal > (d.rendaTotal * 0.30);
    
    const saldoRestante = ultrapassa ? (parcelaMensal - (d.rendaTotal * 0.30)) * prazo : 0;

    state.ultimoCalculo = {
        valorImovel, financiamento: financiamentoEstimado, fgts: d.fgts, entradaTotal, 
        ato: valorAto, mensal: parcelaMensal, prazo, ultrapassa,
        intermediarias: [], qtdInter, valorInter, saldoRestante, usouAtoDefault, entradaUltrapassa,
        tipo: 'estimada'
    };

    renderResultadoEstimado(valorImovel, financiamentoEstimado, d.fgts, entradaTotal, valorAto, parcelaMensal, prazo, qtdInter, valorInter, ultrapassa, saldoRestante, usouAtoDefault, entradaUltrapassa);
}

function renderResultadoEstimado(valorImovel, financiamento, fgts, entradaTotal, ato, mensal, prazo, qtdInter, valorInter, ultrapassa, saldoRestante, usouAtoDefault, entradaUltrapassa) {
    const resDiv = document.getElementById('fluxoResultado');
    const hoje = new Date();
    const previsao = new Date(hoje.getFullYear(), hoje.getMonth() + prazo, 1);
    const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const previsaoTexto = `${mesesNomes[previsao.getMonth()]}/${previsao.getFullYear().toString().substr(-2)}`;

    let interHtml = '';
    if (qtdInter > 0) {
        interHtml = `<div class="fluxo-row"><span class="fluxo-label">Intermedi√°rias/Anuais (${qtdInter}x)</span><span class="fluxo-valor">${formatMoney(valorInter)}</span></div>`;
    }

    resDiv.innerHTML = `
        <div class="fluxo-card fade-in">
            <div class="fluxo-header">
                <h4>üìã Fluxo de Pagamento - ${prazo} meses</h4>
                <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
            </div>
            <div class="fluxo-body">
                <div class="fluxo-row"><span class="fluxo-label">Valor do Im√≥vel</span><span class="fluxo-valor color-azul">${formatMoney(valorImovel)}</span></div>
                <div class="fluxo-row"><span class="fluxo-label">Financiamento Estimado</span><span class="fluxo-valor color-laranja">${formatMoney(financiamento)}</span></div>
                ${fgts > 0 ? `<div class="fluxo-row"><span class="fluxo-label">FGTS</span><span class="fluxo-valor color-laranja">${formatMoney(fgts)}</span></div>` : ''}
                
                <div class="fluxo-destaque">
                    <span class="label">Entrada Total - Parcelamento no Per√≠odo de Obras</span>
                    <span class="valor">${formatMoney(entradaTotal)}</span>
                </div>

                <div class="fluxo-secao">
                    <div class="fluxo-secao-titulo"><i data-lucide="credit-card"></i> Divis√£o do Pagamento</div>
                    <div class="fluxo-row"><span class="fluxo-label">Ato (Sinal)</span><span class="fluxo-valor">${formatMoney(ato)}</span></div>
                    ${interHtml}
                    <div class="fluxo-row"><span class="fluxo-label">Parcelas Mensais (${prazo}x)</span><span class="fluxo-valor">${entradaUltrapassa ? 'R$ 0,00' : formatMoney(mensal)}</span></div>
                    ${saldoRestante > 0 && !entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante (P√≥s-Chaves)</span><span class="fluxo-valor" style="color: var(--danger)">${formatMoney(saldoRestante)}</span></div>` : ''}
                    ${entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger); font-weight: 700;">Verificar P√≥s-Chaves</span></div>` : ''}
                </div>
                
                ${entradaUltrapassa ? `<div class="alerta-box" style="background: #fee2e2; border-color: #ef4444;">
                    <i data-lucide="alert-triangle" style="color: #ef4444;"></i>
                    <span style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è Fluxo de Entrada Ultrapassa o valor do im√≥vel. Verificar</span>
                </div>` : ''}

                <div class="alerta-box ${ultrapassa && !entradaUltrapassa ? 'aviso' : (!entradaUltrapassa ? 'sucesso' : '')}" ${entradaUltrapassa ? 'style="display: none;"' : ''}>
                    <i data-lucide="${ultrapassa ? 'alert-circle' : 'check-circle'}"></i>
                    ${ultrapassa 
                        ? '‚ö†Ô∏è Fluxo de Pagamento da Entrada ultrapassa o Per√≠odo de Obras. Verifique com corretor/construtora a possibilidade de Pagamento P√≥s-Chaves.' 
                        : '‚úÖ Fluxo de Pagamento da Entrada dentro do Per√≠odo de Obras.'}
                </div>
                
                <div class="obs-box">
                    <strong>üìå Observa√ß√µes:</strong>
                    <ul>
                        <li>Utilizando como limitadores: <strong>30% da renda</strong> para parcelas mensais e <strong>100% da renda</strong> para parcelas intermedi√°rias/anuais.</li>
                        ${usouAtoDefault ? '<li>Estipulado <strong>R$ 1.000,00</strong> de ato (valor m√≠nimo sugerido).</li>' : ''}
                        <li>Valores s√£o estimativas e para fins educativos. <strong>Consulte seu corretor para valores reais</strong>.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="btnResetarFluxo" class="btn btn-danger-real" style="max-width: 300px;">üîÑ RESETAR FLUXO</button>
        </div>
    `;
    resDiv.classList.remove('hidden');
    document.getElementById('blocosExtras').classList.remove('hidden');
    resDiv.scrollIntoView({ behavior: 'smooth' });
    lucide.createIcons();
    
    const btnReset = document.getElementById('btnResetarFluxo');
    if (btnReset) {
        btnReset.onclick = resetarFluxo;
    }
}

function calcularFluxoDetalhado() {
    limparResultadosINCC_Juros();
    const d = state.dadosDiagnostico;
    if (!d) return alert('Gere a an√°lise de perfil primeiro.');

    const valorReal = parseMoney(document.getElementById('valorReal').value);
    const valorAval = parseMoney(document.getElementById('valorAvaliacao').value);
    const financiamentoAprovado = parseMoney(document.getElementById('financiamentoAprovado').value);
    const subsidio = document.getElementById('temSubsidio').value === 'sim' ? parseMoney(document.getElementById('subsidioVal').value) : 0;
    const valorAto = parseMoney(document.getElementById('valorAtoDet').value);
    const prazo = parseInt(document.getElementById('prazoObraDet').value);
    const temInterm = document.getElementById('temInterDet').value === 'sim';
    const aceitaPos = document.getElementById('aceitaPosChaves').value === 'sim';

    if (!valorReal || !financiamentoAprovado || !prazo) return alert('Preencha os valores e selecione o prazo');

    const entradaTotal = valorReal - financiamentoAprovado - d.fgts - subsidio;
    
    const inputsTotal = financiamentoAprovado + d.fgts + subsidio;
    const entradaUltrapassa = inputsTotal >= valorReal;
    
    let somaInter = 0;
    let intermediarias = [];
    if (temInterm) {
        const dates = document.querySelectorAll('.inter-date');
        const vals = document.querySelectorAll('.inter-val');
        dates.forEach((dateEl, idx) => {
            const val = parseMoney(vals[idx].value);
            somaInter += val;
            intermediarias.push({ data: dateEl.value, valor: val });
        });
    }

    const saldoParaMensais = entradaTotal - valorAto - somaInter;
    const parcelaMensal = Math.max(0, saldoParaMensais / prazo);
    const ultrapassa = saldoParaMensais < 0;

    state.ultimoCalculo = {
        valorImovel: valorReal, financiamento: financiamentoAprovado, fgts: d.fgts, subsidio, entradaTotal, 
        ato: valorAto, mensal: parcelaMensal, prazo, ultrapassa, somaInter, aceitaPos, intermediarias, entradaUltrapassa,
        tipo: 'detalhada', valorAvaliacao: valorAval
    };

    renderResultadoDetalhado(valorReal, financiamentoAprovado, d.fgts, subsidio, entradaTotal, valorAto, parcelaMensal, prazo, intermediarias, ultrapassa, aceitaPos, entradaUltrapassa);
}

function renderResultadoDetalhado(valorImovel, financiamento, fgts, subsidio, entradaTotal, ato, mensal, prazo, intermediarias, ultrapassa, aceitaPos, entradaUltrapassa) {
    const resDiv = document.getElementById('fluxoResultado');
    const hoje = new Date();
    const previsao = new Date(hoje.getFullYear(), hoje.getMonth() + prazo, 1);
    const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const previsaoTexto = `${mesesNomes[previsao.getMonth()]}/${previsao.getFullYear().toString().substr(-2)}`;

    let interHtml = '';
    if (intermediarias.length > 0) {
        const valores = intermediarias.map(i => i.valor);
        const todosIguais = valores.every(v => v === valores[0]);
        const textoValores = todosIguais ? formatMoney(valores[0]) : valores.map(v => formatMoney(v)).join(' | ');
        interHtml = `<div class="fluxo-row"><span class="fluxo-label">Intermedi√°rias/Anuais (${intermediarias.length}x)</span><span class="fluxo-valor">${textoValores}</span></div>`;
    }

    resDiv.innerHTML = `
        <div class="fluxo-card fade-in">
            <div class="fluxo-header">
                <h4>üìã Fluxo de Pagamento - ${prazo} meses</h4>
                <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
            </div>
            <div class="fluxo-body">
                <div class="fluxo-row"><span class="fluxo-label">Valor do Im√≥vel</span><span class="fluxo-valor color-azul">${formatMoney(valorImovel)}</span></div>
                <div class="fluxo-row"><span class="fluxo-label">Financiamento Aprovado</span><span class="fluxo-valor color-laranja">${formatMoney(financiamento)}</span></div>
                ${fgts > 0 ? `<div class="fluxo-row"><span class="fluxo-label">FGTS</span><span class="fluxo-valor color-laranja">${formatMoney(fgts)}</span></div>` : ''}
                ${subsidio > 0 ? `<div class="fluxo-row"><span class="fluxo-label">Subs√≠dio</span><span class="fluxo-valor color-laranja">${formatMoney(subsidio)}</span></div>` : ''}
                
                <div class="fluxo-destaque">
                    <span class="label">Entrada Total - Parcelamento no Per√≠odo de Obras</span>
                    <span class="valor">${formatMoney(entradaTotal)}</span>
                </div>

                <div class="fluxo-secao">
                    <div class="fluxo-secao-titulo"><i data-lucide="credit-card"></i> Divis√£o do Pagamento</div>
                    ${ato > 0 ? `<div class="fluxo-row"><span class="fluxo-label">Ato (Sinal)</span><span class="fluxo-valor">${formatMoney(ato)}</span></div>` : ''}
                    ${interHtml}
                    <div class="fluxo-row"><span class="fluxo-label">Parcelas Mensais (${prazo}x)</span><span class="fluxo-valor">${entradaUltrapassa ? 'R$ 0,00' : formatMoney(mensal)}</span></div>
                    ${ultrapassa && !entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger)">Verificar P√≥s-Chaves</span></div>` : ''}
                    ${entradaUltrapassa ? `<div class="fluxo-row"><span class="fluxo-label">Saldo Restante</span><span class="fluxo-valor" style="color: var(--danger); font-weight: 700;">Verificar P√≥s-Chaves</span></div>` : ''}
                </div>
                
                ${entradaUltrapassa ? `<div class="alerta-box" style="background: #fee2e2; border-color: #ef4444;">
                    <i data-lucide="alert-triangle" style="color: #ef4444;"></i>
                    <span style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è Fluxo de Entrada Ultrapassa o valor do im√≥vel. Verificar</span>
                </div>` : ''}

                <div class="alerta-box ${ultrapassa && !entradaUltrapassa ? 'aviso' : (!entradaUltrapassa ? 'sucesso' : '')}" ${entradaUltrapassa ? 'style="display: none;"' : ''}>
                    <i data-lucide="${ultrapassa ? 'alert-circle' : 'check-circle'}"></i>
                    ${ultrapassa 
                        ? '‚ö†Ô∏è Fluxo de Pagamento da Entrada ultrapassa o Per√≠odo de Obras.' 
                        : '‚úÖ Fluxo de Pagamento da Entrada dentro do Per√≠odo de Obras.'}
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="btnResetarFluxo" class="btn btn-danger-real" style="max-width: 300px;">üîÑ RESETAR FLUXO</button>
        </div>
    `;
    resDiv.classList.remove('hidden');
    document.getElementById('blocosExtras').classList.remove('hidden');
    resDiv.scrollIntoView({ behavior: 'smooth' });
    lucide.createIcons();
    
    const btnReset = document.getElementById('btnResetarFluxo');
    if (btnReset) {
        btnReset.onclick = resetarFluxo;
    }
}

function toggleBloco(tipo) {
    const tipoMap = { 'incc': 'INCC', 'juros': 'Juros', 'pdf': 'PDF' };
    const tipoId = tipoMap[tipo];
    const conteudo = document.getElementById(`conteudo${tipoId}`);
    const toggle = document.getElementById(`toggle${tipoId}`);
    if (conteudo && toggle) {
        conteudo.classList.toggle('open');
        toggle.classList.toggle('open');
    }
}

function calcularINCC() {
    if (!state.ultimoCalculo) return alert('Calcule o fluxo de entrada primeiro.');
    
    const taxa = parseFloat(document.getElementById('inccTaxa').value) / 100 || 0.005;
    const { mensal, prazo, intermediarias = [], qtdInter = 0, valorInter = 0, ato, aceitaPos = false } = state.ultimoCalculo;
    
    const totalSemCorrecao = mensal * prazo;
    let saldo = totalSemCorrecao;
    let primeiraParcela = 0;
    let ultimaParcela = 0;
    let parcelaAnterior = mensal;
    let somaAumentos = 0;
    
    for (let mes = 1; mes <= prazo; mes++) {
        saldo = saldo * (1 + taxa);
        const parcelaMes = saldo / (prazo - mes + 1);
        if (mes === 1) primeiraParcela = parcelaMes;
        if (mes === prazo) ultimaParcela = parcelaMes;
        
        const aumentoMes = parcelaMes - parcelaAnterior;
        somaAumentos += aumentoMes;
        parcelaAnterior = parcelaMes;
        
        saldo -= parcelaMes;
    }
    
    const aumentoMedio = somaAumentos / prazo;
    
    let htmlInter = '';
    if (intermediarias.length > 0) {
        const hoje = new Date();
        let interCorrigidas = [];
        const totalInter = intermediarias.reduce((s, i) => s + i.valor, 0);
        let saldoInter = totalInter;
        const qtd = intermediarias.length;
        
        intermediarias.forEach((inter, idx) => {
            const [mesAno, anoAno] = inter.data.split('/');
            const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const mesIdx = mesesNomes.indexOf(mesAno);
            const ano = 2000 + parseInt(anoAno);
            const dataPgto = new Date(ano, mesIdx, 1);
            const mesesAteData = Math.max(0, Math.round((dataPgto - hoje) / (1000 * 60 * 60 * 24 * 30)));
            
            const saldoCorrigido = saldoInter * Math.pow(1 + taxa, mesesAteData);
            const parcelaCorrigida = saldoCorrigido / (qtd - idx);
            saldoInter -= inter.valor;
            
            interCorrigidas.push({ ordem: idx + 1, valor: inter.valor, corrigido: parcelaCorrigida });
        });
        
        const valoresContrato = interCorrigidas.map(ic => formatMoney(ic.valor)).join(' | ');
        
        htmlInter = `
            <div class="incc-secao">
                <div class="incc-secao-titulo"><i data-lucide="calendar-check"></i> Intermedi√°rias</div>
                <div class="incc-row"><span class="incc-label">Valor em Contrato</span><span class="incc-valor">${valoresContrato}</span></div>
        `;
        interCorrigidas.forEach(ic => {
            htmlInter += `<div class="incc-row"><span class="incc-label">${ic.ordem}¬™ Parcela Corrigida</span><span class="incc-valor">${formatMoney(ic.corrigido)}</span></div>`;
        });
        htmlInter += `</div>`;
    } else if (qtdInter > 0 && valorInter > 0) {
        let mesesCorrecao = [];
        if (prazo === 12) {
            mesesCorrecao = [12];
        } else if (prazo === 18) {
            mesesCorrecao = [12, 18];
        } else if (prazo === 24) {
            mesesCorrecao = [12, 24];
        } else if (prazo === 30) {
            mesesCorrecao = [12, 24, 30];
        } else if (prazo === 36) {
            mesesCorrecao = [12, 24, 36];
        }
        
        let interCorrigidas = [];
        for (let i = 0; i < qtdInter; i++) {
            const meses = mesesCorrecao[i] || 0;
            const valorCorrigido = valorInter * Math.pow(1 + taxa, meses);
            interCorrigidas.push({ ordem: i + 1, valor: valorInter, corrigido: valorCorrigido, meses });
        }
        
        const valoresContrato = interCorrigidas.map(ic => formatMoney(ic.valor)).join(' | ');
        
        htmlInter = `
            <div class="incc-secao">
                <div class="incc-secao-titulo"><i data-lucide="calendar-check"></i> Intermedi√°rias</div>
                <div class="incc-row"><span class="incc-label">Valor em Contrato</span><span class="incc-valor">${valoresContrato}</span></div>
        `;
        interCorrigidas.forEach(ic => {
            htmlInter += `<div class="incc-row"><span class="incc-label">${ic.ordem}¬™ Parcela Corrigida (${ic.meses} meses)</span><span class="incc-valor">${formatMoney(ic.corrigido)}</span></div>`;
        });
        htmlInter += `</div>`;
    }
    
    let htmlPosObra = '';
    if (aceitaPos) {
        htmlPosObra = `
            <div class="incc-secao">
                <div class="incc-secao-titulo"><i data-lucide="home"></i> Saldo P√≥s-Obra</div>
                <div class="incc-row"><span class="incc-label" style="font-size: 13px;">Verificar com corretor a forma de corre√ß√£o do saldo p√≥s-chaves.</span></div>
            </div>
        `;
    }
    
    const html = `
        <div class="incc-secao">
            <div class="incc-secao-titulo"><i data-lucide="calendar"></i> Parcelas Mensais</div>
            <div class="incc-row"><span class="incc-label">Valor em Contrato (cada)</span><span class="incc-valor">${formatMoney(mensal)}</span></div>
            <div class="incc-row"><span class="incc-label">Aumento m√©dio a cada nova parcela</span><span class="incc-valor">+${formatMoney(aumentoMedio)}</span></div>
            <div class="incc-row"><span class="incc-label">√öltima Parcela Estimada</span><span class="incc-valor">${formatMoney(ultimaParcela)}</span></div>
        </div>
        ${htmlInter}
        ${htmlPosObra}
        <div class="obs-box" style="margin-top: 16px;">
            * Valores aproximados para fins de simula√ß√£o e entendimento.<br>
            * INCC atualizado dispon√≠vel em: <a href="https://portal.fgv.br/noticias/incc-m-2025" target="_blank">portal.fgv.br/noticias/incc-m-2025</a>
        </div>
    `;
    
    // Armazena os dados do INCC para o PDF
    state.dadosINCC = {
        taxa: parseFloat(document.getElementById('inccTaxa').value),
        mensal,
        aumentoMedio,
        ultimaParcela,
        intermediarias: intermediarias.length > 0 ? intermediarias : (qtdInter > 0 ? Array(qtdInter).fill({valor: valorInter}) : [])
    };
    
    document.getElementById('resultadoINCC').innerHTML = html;
    document.getElementById('resultadoINCC').classList.remove('hidden');
    state.inccCalculado = true;
    checkPDFVisibility();
    lucide.createIcons();
}

function calcularJuros() {
    if (!state.ultimoCalculo) return alert('Calcule o fluxo de entrada primeiro.');
    
    const financiamento = state.ultimoCalculo.financiamento;
    const taxaEfetiva = state.dadosDiagnostico.taxa;
    const tr = parseFloat(document.getElementById('trTaxa').value) || 0;
    const taxas = parseMoney(document.getElementById('taxasAdm').value);
    const passo = parseInt(document.getElementById('passoTabela').value) || 10;
    
    const jurosMensal = (taxaEfetiva / 100) / 12;
    const trMensal = tr / 100;
    
    const percList = [];
    for (let p = passo; p <= 100; p += passo) percList.push(p);
    if (percList[percList.length - 1] !== 100) percList.push(100);
    
    const rows = percList.map(perc => {
        const liberado = financiamento * (perc / 100);
        const liberadoComTR = liberado * (1 + trMensal);
        const juros = liberadoComTR * jurosMensal;
        const parcela = juros + taxas;
        return { perc, parcela };
    });
    
    let html = `
        <table class="juros-table">
            <thead>
                <tr>
                    <th>% da Obra</th>
                    <th>Parcela Estimada (m√™s)</th>
                </tr>
            </thead>
            <tbody>
    `;
    rows.forEach(r => {
        html += `<tr><td><strong>${r.perc}%</strong></td><td>${formatMoney(r.parcela)}</td></tr>`;
    });
    html += `
            </tbody>
        </table>
        <div class="obs-box" style="margin-top: 16px;">
            * Valores aproximados para fins de simula√ß√£o e entendimento.<br>
            * Valor estimado de <strong>${formatMoney(taxas)}</strong> para taxas administrativas e seguros obrigat√≥rios (MIP/DFI).<br>
            * A TR possui varia√ß√£o mensal. Valor utilizado apenas para fins estimativos.<br>
            * Consulta da TR atualizada: <a href="https://www.debit.com.br/tabelas/tr-bacen" target="_blank">debit.com.br/tabelas/tr-bacen</a>
        </div>
    `;
    
    // Armazena os dados dos juros para o PDF
    state.dadosJuros = {
        financiamento,
        taxaEfetiva,
        tr,
        taxas,
        passo,
        rows
    };
    
    document.getElementById('resultadoJuros').innerHTML = html;
    document.getElementById('resultadoJuros').classList.remove('hidden');
    state.jurosCalculado = true;
    checkPDFVisibility();
}

function checkPDFVisibility() {
    if (state.inccCalculado && state.jurosCalculado) {
        document.getElementById('blocoPDF').classList.remove('hidden');
        document.getElementById('optionINCC').style.display = 'flex';
        document.getElementById('optionJuros').style.display = 'flex';
    }
}

function resetarFluxo() {
    document.getElementById('fluxoResultado').classList.add('hidden');
    document.getElementById('fluxoResultado').innerHTML = '';
    document.getElementById('blocosExtras').classList.add('hidden');
    
    state.ultimoCalculo = null;
    state.inccCalculado = false;
    state.jurosCalculado = false;
    state.dadosINCC = null;
    state.dadosJuros = null;
    
    document.getElementById('valorImovel').value = '';
    document.getElementById('valorReal').value = '';
    document.getElementById('valorAvaliacao').value = '';
    document.getElementById('financiamentoAprovado').value = '';
    document.getElementById('valorAto').value = '';
    document.getElementById('prazoObraDet').value = '';
    document.getElementById('temInterDet').value = 'nao';
    document.getElementById('boxQtdInter').classList.add('hidden');
    document.getElementById('containerInterItems').classList.add('hidden');
    document.getElementById('temSubsidio').value = 'nao';
    document.getElementById('boxSubsidioVal').classList.add('hidden');
    document.getElementById('aceitaPosChaves').value = 'nao';
    
    document.getElementById('blocoEscolha').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function limparResultadosINCC_Juros() {
    document.getElementById('resultadoINCC').innerHTML = '';
    document.getElementById('resultadoINCC').classList.add('hidden');
    document.getElementById('resultadoJuros').innerHTML = '';
    document.getElementById('resultadoJuros').classList.add('hidden');
    document.getElementById('blocoPDF').classList.add('hidden');
    
    state.inccCalculado = false;
    state.jurosCalculado = false;
    state.dadosINCC = null;
    state.dadosJuros = null;
}

// ============================================
// GERADOR DE PDF COMPLETO E PROFISSIONAL
// ============================================

function gerarPDF() {
    if (!state.ultimoCalculo) {
        return alert('Calcule o fluxo de entrada primeiro.');
    }
    
    if (!window.jspdf || !window.jspdf.jsPDF) {
        return alert('Biblioteca do PDF n√£o carregou. Atualize a p√°gina e tente novamente.');
    }
    
    // Verifica quais se√ß√µes incluir
    const incluirDiagnostico = document.getElementById('pdfDiagnostico').checked;
    const incluirFluxo = document.getElementById('pdfFluxo').checked;
    const incluirINCC = document.getElementById('pdfINCC').checked && state.inccCalculado;
    const incluirJuros = document.getElementById('pdfJuros').checked && state.jurosCalculado;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        unit: "mm",
        format: "a4",
        orientation: "portrait"
    });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const usableWidth = pageWidth - (margin * 2);
    let y = margin;
    
    // Cores do tema
    const primaryColor = [5, 150, 105]; // verde
    const secondaryColor = [59, 130, 246]; // azul
    const textColor = [30, 41, 59];
    const grayColor = [100, 116, 139];
    const lightGray = [241, 245, 249];
    
    // ============================================
    // CAPA / CABE√áALHO
    // ============================================
    
    doc.setFillColor(...primaryColor);
    doc.rect(0, 0, pageWidth, 50, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(24);
    doc.text("SIMULA√á√ÉO FINANCEIRA", pageWidth / 2, 20, { align: "center" });
    
    doc.setFontSize(14);
    doc.text("Minha Casa Minha Vida", pageWidth / 2, 30, { align: "center" });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const dataDoc = new Date().toLocaleDateString("pt-BR", { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
    });
    doc.text(`Gerado em ${dataDoc}`, pageWidth / 2, 40, { align: "center" });
    
    y = 60;
    doc.setTextColor(...textColor);
    
    // ============================================
    // INFORMA√á√ïES DO CORRETOR
    // ============================================
    
    doc.setFillColor(...lightGray);
    doc.rect(margin, y, usableWidth, 25, 'F');
    
    y += 8;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text("üì± Informa√ß√µes do Corretor", margin + 5, y);
    
    y += 7;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.text("Corretor(a): Raul Mendes", margin + 5, y);
    
    y += 5;
    doc.text("Instagram: @raulmendes.imob", margin + 5, y);
    
    y += 5;
    doc.text("Email: suporte@suporte.com", margin + 5, y);
    
    y += 15;
    
    // ============================================
    // SE√á√ÉO 1: AN√ÅLISE DE PERFIL MCMV
    // ============================================
    
    if (incluirDiagnostico && state.dadosDiagnostico) {
        const d = state.dadosDiagnostico;
        
        // Verifica se precisa de nova p√°gina
        if (y > pageHeight - 80) {
            doc.addPage();
            y = margin;
        }
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.text("üìä AN√ÅLISE DE PERFIL MCMV", margin, y);
        
        y += 2;
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.5);
        doc.line(margin, y, pageWidth - margin, y);
        
        y += 10;
        doc.setTextColor(...textColor);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        
        // Box da Faixa
        doc.setFillColor(236, 253, 245);
        doc.rect(margin, y, usableWidth, 12, 'F');
        doc.setFont("helvetica", "bold");
        doc.text(`Faixa MCMV: Faixa ${d.faixa}`, margin + 5, y + 8);
        
        y += 17;
        
        // Dados em duas colunas
        const col1X = margin + 5;
        const col2X = pageWidth / 2 + 5;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        // Coluna 1
        doc.setFont("helvetica", "bold");
        doc.text("Renda Familiar Total:", col1X, y);
        doc.setFont("helvetica", "normal");
        doc.text(formatMoney(d.rendaTotal), col1X + 45, y);
        
        y += 6;
        doc.setFont("helvetica", "bold");
        doc.text("Teto do Programa:", col1X, y);
        doc.setFont("helvetica", "normal");
        doc.text(formatMoney(d.teto), col1X + 45, y);
        
        y += 6;
        doc.setFont("helvetica", "bold");
        doc.text("Taxa de Juros:", col1X, y);
        doc.setFont("helvetica", "normal");
        doc.text(`${d.taxa.toFixed(2)}% ao ano`, col1X + 45, y);
        
        // Coluna 2
        y -= 12;
        doc.setFont("helvetica", "bold");
        doc.text("Prazo M√°ximo:", col2X, y);
        doc.setFont("helvetica", "normal");
        doc.text(`${d.prazoFinalFinanciamento} meses`, col2X + 35, y);
        
        y += 6;
        doc.setFont("helvetica", "bold");
        doc.text("Capacidade Financ.:", col2X, y);
        doc.setFont("helvetica", "normal");
        doc.text(formatMoney(d.capFinanciamento), col2X + 35, y);
        
        y += 6;
        doc.setFont("helvetica", "bold");
        doc.text("Parcela M√°xima:", col2X, y);
        doc.setFont("helvetica", "normal");
        doc.text(formatMoney(d.parcelaMax), col2X + 35, y);
        
        y += 12;
        
        if (d.faixa <= 2) {
            doc.setFillColor(255, 251, 235);
            doc.rect(margin, y, usableWidth, 10, 'F');
            doc.setFont("helvetica", "italic");
            doc.setFontSize(8);
            doc.text("üí° Voc√™ pode ter direito a subs√≠dio do governo (verificar na an√°lise da Caixa)", margin + 5, y + 6);
            y += 15;
        }
        
        y += 10;
    }
    
    // ============================================
    // SE√á√ÉO 2: FLUXO DE PAGAMENTO
    // ============================================
    
    if (incluirFluxo && state.ultimoCalculo) {
        const calc = state.ultimoCalculo;
        
        // Verifica se precisa de nova p√°gina
        if (y > pageHeight - 100) {
            doc.addPage();
            y = margin;
        }
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(...secondaryColor);
        doc.text("üí∞ FLUXO DE PAGAMENTO (ENTRADA)", margin, y);
        
        y += 2;
        doc.setDrawColor(...secondaryColor);
        doc.setLineWidth(0.5);
        doc.line(margin, y, pageWidth - margin, y);
        
        y += 10;
        doc.setTextColor(...textColor);
        
        // Tipo de simula√ß√£o
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.text(`Tipo: Simula√ß√£o ${calc.tipo === 'estimada' ? 'Estimada' : 'Detalhada'}`, margin, y);
        y += 7;
        
        // Box destacado - Entrada Total
        doc.setFillColor(240, 253, 244);
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(1);
        doc.rect(margin, y, usableWidth, 20, 'FD');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.setTextColor(...grayColor);
        doc.text("ENTRADA TOTAL - PER√çODO DE OBRAS", pageWidth / 2, y + 7, { align: "center" });
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        doc.text(formatMoney(calc.entradaTotal), pageWidth / 2, y + 15, { align: "center" });
        
        y += 28;
        doc.setTextColor(...textColor);
        
        // Composi√ß√£o do Im√≥vel
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("Composi√ß√£o do Im√≥vel:", margin, y);
        y += 7;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        const composicaoItems = [
            { label: "Valor do Im√≥vel:", valor: formatMoney(calc.valorImovel), cor: secondaryColor },
            { label: "(-) Financiamento:", valor: formatMoney(calc.financiamento), cor: textColor },
        ];
        
        if (calc.fgts > 0) {
            composicaoItems.push({ label: "(-) FGTS:", valor: formatMoney(calc.fgts), cor: textColor });
        }
        
        if (calc.subsidio > 0) {
            composicaoItems.push({ label: "(-) Subs√≠dio:", valor: formatMoney(calc.subsidio), cor: textColor });
        }
        
        composicaoItems.forEach(item => {
            doc.setTextColor(...item.cor);
            doc.text(item.label, margin + 5, y);
            doc.text(item.valor, pageWidth - margin - 5, y, { align: "right" });
            y += 5;
        });
        
        y += 5;
        
        // Divis√£o do Pagamento
        doc.setTextColor(...textColor);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("Divis√£o do Pagamento:", margin, y);
        y += 7;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        if (calc.ato > 0) {
            doc.text("Ato (Sinal):", margin + 5, y);
            doc.text(formatMoney(calc.ato), pageWidth - margin - 5, y, { align: "right" });
            y += 5;
        }
        
        // Intermedi√°rias
        if (calc.intermediarias && calc.intermediarias.length > 0) {
            doc.text(`Intermedi√°rias (${calc.intermediarias.length}x):`, margin + 5, y);
            const valoresInter = calc.intermediarias.map(i => i.valor);
            const todosIguais = valoresInter.every(v => v === valoresInter[0]);
            const textoInter = todosIguais ? formatMoney(valoresInter[0]) : "Valores variados";
            doc.text(textoInter, pageWidth - margin - 5, y, { align: "right" });
            y += 5;
        } else if (calc.qtdInter > 0) {
            doc.text(`Intermedi√°rias (${calc.qtdInter}x):`, margin + 5, y);
            doc.text(formatMoney(calc.valorInter), pageWidth - margin - 5, y, { align: "right" });
            y += 5;
        }
        
        doc.text(`Parcelas Mensais (${calc.prazo}x):`, margin + 5, y);
        doc.text(formatMoney(calc.mensal), pageWidth - margin - 5, y, { align: "right" });
        y += 5;
        
        if (calc.saldoRestante > 0) {
            doc.setTextColor(239, 68, 68);
            doc.text("Saldo Restante (P√≥s-Chaves):", margin + 5, y);
            doc.text(formatMoney(calc.saldoRestante), pageWidth - margin - 5, y, { align: "right" });
            y += 5;
            doc.setTextColor(...textColor);
        }
        
        y += 10;
        
        // Status do Fluxo
        if (!calc.ultrapassa && !calc.entradaUltrapassa) {
            doc.setFillColor(240, 253, 244);
            doc.rect(margin, y, usableWidth, 10, 'F');
            doc.setFont("helvetica", "bold");
            doc.setFontSize(8);
            doc.setTextColor(...primaryColor);
            doc.text("‚úÖ Fluxo de Entrada dentro do Per√≠odo de Obras", margin + 5, y + 6);
        } else {
            doc.setFillColor(254, 243, 199);
            doc.rect(margin, y, usableWidth, 10, 'F');
            doc.setFont("helvetica", "bold");
            doc.setFontSize(8);
            doc.setTextColor(146, 64, 14);
            doc.text("‚ö†Ô∏è Fluxo pode ultrapassar per√≠odo - Verificar possibilidade de P√≥s-Chaves", margin + 5, y + 6);
        }
        
        y += 20;
    }
    
    // ============================================
    // SE√á√ÉO 3: ESTIMATIVA DE INCC
    // ============================================
    
    if (incluirINCC && state.dadosINCC) {
        // Verifica se precisa de nova p√°gina
        if (y > pageHeight - 80) {
            doc.addPage();
            y = margin;
        }
        
        const incc = state.dadosINCC;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(217, 119, 6);
        doc.text("üìà ESTIMATIVA DE INCC", margin, y);
        
        y += 2;
        doc.setDrawColor(217, 119, 6);
        doc.setLineWidth(0.5);
        doc.line(margin, y, pageWidth - margin, y);
        
        y += 10;
        doc.setTextColor(...textColor);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.text(`Taxa mensal aplicada: ${incc.taxa.toFixed(2)}%`, margin, y);
        y += 7;
        
        // Parcelas Mensais
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("Parcelas Mensais:", margin, y);
        y += 7;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        doc.text("Valor em Contrato (cada):", margin + 5, y);
        doc.text(formatMoney(incc.mensal), pageWidth - margin - 5, y, { align: "right" });
        y += 5;
        
        doc.text("Aumento m√©dio por parcela:", margin + 5, y);
        doc.text(`+${formatMoney(incc.aumentoMedio)}`, pageWidth - margin - 5, y, { align: "right" });
        y += 5;
        
        doc.text("√öltima Parcela Estimada:", margin + 5, y);
        doc.setFont("helvetica", "bold");
        doc.text(formatMoney(incc.ultimaParcela), pageWidth - margin - 5, y, { align: "right" });
        
        y += 12;
        
        // Intermedi√°rias (se houver)
        if (incc.intermediarias && incc.intermediarias.length > 0) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text("Intermedi√°rias Corrigidas:", margin, y);
            y += 7;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            incc.intermediarias.forEach((inter, idx) => {
                if (y > pageHeight - 20) {
                    doc.addPage();
                    y = margin;
                }
                
                doc.text(`${idx + 1}¬™ Parcela:`, margin + 5, y);
                doc.text(formatMoney(inter.valor), pageWidth - margin - 5, y, { align: "right" });
                y += 5;
            });
        }
        
        y += 10;
        
        // Observa√ß√£o
        doc.setFillColor(255, 251, 235);
        doc.rect(margin, y, usableWidth, 12, 'F');
        doc.setFont("helvetica", "italic");
        doc.setFontSize(7);
        doc.text("* Valores aproximados para fins de simula√ß√£o. INCC pode variar mensalmente.", margin + 5, y + 4);
        doc.text("Consulte: portal.fgv.br/noticias/incc-m-2025", margin + 5, y + 8);
        
        y += 20;
    }
    
    // ============================================
    // SE√á√ÉO 4: TABELA DE JUROS DE OBRA
    // ============================================
    
    if (incluirJuros && state.dadosJuros) {
        // Verifica se precisa de nova p√°gina
        if (y > pageHeight - 100) {
            doc.addPage();
            y = margin;
        }
        
        const juros = state.dadosJuros;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(217, 119, 6);
        doc.text("üìä TABELA DE JUROS DE OBRA", margin, y);
        
        y += 2;
        doc.setDrawColor(217, 119, 6);
        doc.setLineWidth(0.5);
        doc.line(margin, y, pageWidth - margin, y);
        
        y += 10;
        doc.setTextColor(...textColor);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.text(`Financiamento: ${formatMoney(juros.financiamento)} | Taxa: ${juros.taxaEfetiva.toFixed(2)}% a.a. | TR: ${juros.tr.toFixed(2)}%`, margin, y);
        doc.text(`Taxas Adm + Seguros: ${formatMoney(juros.taxas)}`, margin, y + 4);
        y += 12;
        
        // Cabe√ßalho da tabela
        doc.setFillColor(...lightGray);
        doc.rect(margin, y, usableWidth, 8, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.text("% da Obra", margin + usableWidth * 0.3, y + 5, { align: "center" });
        doc.text("Parcela Mensal", margin + usableWidth * 0.7, y + 5, { align: "center" });
        
        y += 10;
        
        // Linhas da tabela
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        
        juros.rows.forEach((row, idx) => {
            if (y > pageHeight - 15) {
                doc.addPage();
                y = margin;
            }
            
            if (idx % 2 === 0) {
                doc.setFillColor(248, 250, 252);
                doc.rect(margin, y - 3, usableWidth, 6, 'F');
            }
            
            doc.text(`${row.perc}%`, margin + usableWidth * 0.3, y, { align: "center" });
            doc.text(formatMoney(row.parcela), margin + usableWidth * 0.7, y, { align: "center" });
            
            y += 6;
        });
        
        y += 10;
        
        // Observa√ß√£o
        doc.setFillColor(255, 251, 235);
        doc.rect(margin, y, usableWidth, 15, 'F');
        doc.setFont("helvetica", "italic");
        doc.setFontSize(7);
        doc.text("* Valores aproximados considerando TR fixa. Na pr√°tica, a TR varia mensalmente.", margin + 5, y + 4);
        doc.text("* Juros calculados sobre saldo devedor do financiamento.", margin + 5, y + 8);
        doc.text("Consulte TR atualizada: debit.com.br/tabelas/tr-bacen", margin + 5, y + 12);
        
        y += 20;
    }
    
    // ============================================
    // RODAP√â / AVISO LEGAL
    // ============================================
    
    doc.addPage();
    y = margin;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text("‚ö†Ô∏è AVISO IMPORTANTE", pageWidth / 2, y, { align: "center" });
    
    y += 10;
    
    doc.setFillColor(255, 251, 235);
    doc.rect(margin, y, usableWidth, 100, 'F');
    
    y += 8;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(...textColor);
    doc.text("Este documento √© uma SIMULA√á√ÉO para fins educativos", margin + 5, y);
    
    y += 10;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    
    const avisos = [
        "‚Ä¢ Os valores apresentados s√£o ESTIMATIVAS baseadas em c√°lculos padronizados;",
        "‚Ä¢ Os c√°lculos utilizam a Tabela Price do programa Minha Casa Minha Vida;",
        "‚Ä¢ Valores reais, condi√ß√µes de pagamento e aprova√ß√£o dependem de an√°lise da Caixa;",
        "‚Ä¢ INCC, TR e outras taxas podem variar mensalmente;",
        "‚Ä¢ Este documento N√ÉO substitui uma proposta oficial ou contrato;",
        "‚Ä¢ Para informa√ß√µes definitivas, consulte seu corretor ou a institui√ß√£o financeira."
    ];
    
    avisos.forEach(aviso => {
        doc.text(aviso, margin + 5, y);
        y += 7;
    });
    
    y += 15;
    
    doc.setFillColor(...lightGray);
    doc.rect(margin, y, usableWidth, 30, 'F');
    
    y += 8;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text("üì± Contato para mais informa√ß√µes:", margin + 5, y);
    
    y += 8;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.text("Corretor(a): Raul Mendes", margin + 5, y);
    
    y += 6;
    doc.text("Instagram: @raulmendes.imob", margin + 5, y);
    
    y += 6;
    doc.text("Email: suporte@suporte.com", margin + 5, y);
    
    // ============================================
    // SALVAR PDF
    // ============================================
    
    const nomeArquivo = `Simulacao_MCMV_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(nomeArquivo);
    
    alert('‚úÖ PDF gerado com sucesso!');
}

// ============================================
// FUN√á√ïES AUXILIARES
// ============================================

function setupMasks() {
    document.querySelectorAll('.money-mask').forEach(input => {
        input.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (!value) { e.target.value = ''; return; }
            value = (value / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            e.target.value = value;
        });
    });
}

function parseMoney(text) { 
    if (!text) return 0; 
    return parseFloat(text.replace(/[^\d,]/g, '').replace(',', '.')) || 0; 
}

function formatMoney(value) { 
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); 
}

function validarCamposDiagnostico() {
    const r1 = parseMoney(document.getElementById('renda1').value);
    const estado = document.getElementById('estado').value;
    const regime = document.getElementById('regimeTrabalho').value;
    
    if (!r1 || r1 === 0) return false;
    if (!estado) return false;
    if (!regime) return false;
    
    if (regime === 'clt3') {
        const usaFgts = document.getElementById('usaFgts').value;
        if (!usaFgts) return false;
        
        if (usaFgts === 'sim') {
            const fgts = parseMoney(document.getElementById('fgtsVal').value);
            if (!fgts || fgts === 0) return false;
        }
    }
    
    return true;
}

function atualizarBotaoDiagnostico() {
    const btn = document.getElementById('btnGerarDiagnostico');
    if (validarCamposDiagnostico()) {
        btn.classList.remove('hidden');
    } else {
        btn.classList.add('hidden');
    }
}
