<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador Imobili√°rio - M√≥dulo Comprador</title>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
  background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #10b981 100%);
  min-height: 100vh;
  color: #1e293b;
  line-height: 1.6;
  padding: 20px 0;
}

header {
  background: linear-gradient(135deg, rgba(5, 150, 105, 0.95), rgba(6, 95, 70, 0.95));
  color: #fff;
  text-align: center;
  padding: 40px 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  margin-bottom: 30px;
}

header h1 {
  font-size: clamp(24px, 5vw, 36px);
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

header p {
  font-size: clamp(14px, 3vw, 18px);
  opacity: 0.95;
}

main {
  max-width: 1100px;
  margin: 0 auto;
  background: #ffffff;
  padding: 35px;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
}

.section-title {
  color: #059669;
  margin-bottom: 20px;
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.box {
  border: 2px solid #d1fae5;
  border-radius: 16px;
  padding: 24px;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  margin-bottom: 24px;
  transition: all 0.3s ease;
}

.box:hover {
  box-shadow: 0 8px 20px rgba(5, 150, 105, 0.1);
  transform: translateY(-2px);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 18px;
}

.campo {
  display: flex;
  flex-direction: column;
}

.campo label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  color: #065f46;
}

.campo input,
.campo select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #a7f3d0;
  border-radius: 12px;
  font-size: 15px;
  transition: all 0.3s ease;
  background: #ffffff;
}

.campo input:focus,
.campo select:focus {
  outline: none;
  border-color: #059669;
  box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.btn {
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 14px 28px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  margin: 8px;
}

.btn:hover {
  background: linear-gradient(135deg, #047857, #065f46);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn-danger {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #b91c1c, #991b1b);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
}

.btn-large {
  width: 100%;
  max-width: 500px;
  padding: 20px;
  font-size: 18px;
  border-radius: 14px;
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
  box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
  margin: 20px auto;
  display: block;
}

.btn-large:hover {
  background: linear-gradient(135deg, #047857, #065f46);
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(5, 150, 105, 0.4);
}

.btn-select {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  padding: 10px 20px;
  font-size: 14px;
}

.btn-select:hover {
  background: linear-gradient(135deg, #1d4ed8, #1e40af);
  box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}

.btn-select.selected {
  background: linear-gradient(135deg, #16a34a, #15803d);
  box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
}

#boxAcao {
  text-align: center;
  margin-top: 30px;
  padding: 20px;
}

#diagnosticoContainer {
  display: none;
  margin-top: 40px;
  padding: 35px;
  border-radius: 20px;
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  border: 2px solid #93c5fd;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#diagnosticoContainer h3 {
  color: #1e40af;
  font-size: 22px;
  margin-bottom: 8px;
  text-align: center;
}

.diagnostico-intro {
  text-align: center;
  color: #475569;
  font-size: 15px;
  margin-bottom: 24px;
}

#diagnosticoConteudo {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.diagnostico-item {
  background: #ffffff;
  border-left: 4px solid #3b82f6;
  padding: 16px 20px;
  margin-bottom: 12px;
  border-radius: 0 12px 12px 0;
  box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08);
  transition: all 0.3s ease;
}

.diagnostico-item:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
}

.diagnostico-item .label {
  font-size: 12px;
  color: #64748b;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.diagnostico-item .valor {
  font-size: 15px;
  color: #1e293b;
  line-height: 1.5;
}

.diagnostico-item .valor strong {
  color: #1e40af;
  font-weight: 700;
}

.diagnostico-item.destaque {
  border-left-color: #059669;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.diagnostico-item.destaque .valor strong {
  color: #059669;
}

#estimativaContainer {
  display: none;
  margin-top: 40px;
  padding: 35px;
  border-radius: 20px;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 2px solid #86efac;
  animation: fadeIn 0.5s ease;
}

#estimativaContainer h3 {
  color: #166534;
  font-size: 22px;
  margin-bottom: 24px;
  text-align: center;
}

#boxValorImovel {
  display: none;
  margin-top: 24px;
  padding: 28px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  border: 1px solid #e2e8f0;
}

.campo-destaque {
  max-width: 450px;
  margin: 0 auto;
  text-align: center;
}

.campo-destaque label {
  display: block;
  font-size: 16px;
  font-weight: 700;
  color: #065f46;
  margin-bottom: 12px;
}

.campo-destaque input {
  width: 100%;
  padding: 16px 20px;
  border: 3px solid #059669;
  border-radius: 14px;
  font-size: 20px;
  font-weight: 700;
  text-align: center;
  color: #065f46;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  transition: all 0.3s ease;
}

.campo-destaque input:focus {
  outline: none;
  border-color: #047857;
  box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.2);
}

.campo-destaque input::placeholder {
  color: #86efac;
  font-weight: 500;
}

/* Cen√°rio √∫nico em bloco */
.cenario-unico {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border: 2px solid #fca5a5;
  border-radius: 16px;
  padding: 28px;
  margin-top: 24px;
}

.cenario-unico.ok {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border-color: #86efac;
}

.cenario-header-unico {
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
}

.cenario-header-unico h4 {
  font-size: 18px;
  color: #1e293b;
  margin: 0 0 8px 0;
}

.cenario-header-unico p {
  font-size: 14px;
  color: #64748b;
  margin: 0;
}

.cenario-linha {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px dashed #e2e8f0;
}

.cenario-linha:last-child {
  border-bottom: none;
}

.cenario-linha .label {
  font-size: 14px;
  color: #475569;
}

.cenario-linha .valor {
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
}

.cenario-linha.destaque {
  background: rgba(255,255,255,0.6);
  margin: 8px -12px;
  padding: 12px;
  border-radius: 8px;
  border-bottom: none;
}

.cenario-linha.destaque .valor {
  color: #059669;
  font-size: 16px;
}

.cenario-linha.alerta .valor {
  color: #dc2626;
}

/* Blocos coloridos para o resultado */
.resultado-bloco {
  border-radius: 12px;
  padding: 16px;
  margin: 12px 0;
}

.resultado-bloco-branco {
  background: #ffffff;
  border: 1px solid #e2e8f0;
}

.resultado-bloco-azul {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border: 1px solid #93c5fd;
}

.resultado-bloco-amarelo {
  background: linear-gradient(135deg, #fefce8, #fef9c3);
  border: 1px solid #fde047;
}

.resultado-bloco-verde {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 1px solid #86efac;
}

.resultado-bloco .bloco-titulo {
  font-size: 11px;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px dashed rgba(0,0,0,0.1);
}

.resultado-bloco-azul .bloco-titulo {
  color: #1e40af;
}

.resultado-bloco-amarelo .bloco-titulo {
  color: #a16207;
}

.resultado-bloco-verde .bloco-titulo {
  color: #166534;
}

.resultado-linha {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.resultado-linha:last-child {
  padding-bottom: 0;
}

.resultado-linha .label {
  font-size: 14px;
  color: #475569;
}

.resultado-linha .valor {
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
}

.cenario-obs {
  font-size: 12px;
  color: #64748b;
  font-style: italic;
  margin-top: 4px;
}

.cenario-alerta-box {
  background: rgba(220, 38, 38, 0.1);
  border: 1px solid #fca5a5;
  border-radius: 10px;
  padding: 14px;
  margin-top: 16px;
}

.cenario-alerta-box.ok {
  background: rgba(34, 197, 94, 0.1);
  border-color: #86efac;
}

.cenario-alerta-box p {
  margin: 0;
  font-size: 14px;
  color: #991b1b;
  font-weight: 600;
}

.cenario-alerta-box.ok p {
  color: #166534;
}

.cenario-botoes {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.btn-limpar-fluxo {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
}

.btn-limpar-fluxo:hover {
  background: linear-gradient(135deg, #b91c1c, #991b1b);
  transform: translateY(-2px);
}

/* Se√ß√£o de sele√ß√£o de prazo */
.prazo-selector {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.prazo-selector label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 10px;
}

.prazo-options {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.prazo-option {
  flex: 1;
  min-width: 100px;
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  background: #f9fafb;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s ease;
}

.prazo-option:hover {
  border-color: #3b82f6;
  background: #eff6ff;
}

.prazo-option.selected {
  border-color: #059669;
  background: #dcfce7;
}

.prazo-option span {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
}

.prazo-option small {
  font-size: 11px;
  color: #64748b;
}

/* Se√ß√£o de detalhamento */
#detalhamentoContainer {
  display: none;
  margin-top: 40px;
  padding: 35px;
  border-radius: 20px;
  background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
  border: 2px solid #c084fc;
  animation: fadeIn 0.5s ease;
}

#detalhamentoContainer h3 {
  color: #7c3aed;
  font-size: 22px;
  margin-bottom: 24px;
  text-align: center;
}

.detalhe-resumo {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
}

.detalhe-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.detalhe-item {
  text-align: center;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
}

.detalhe-item label {
  display: block;
  font-size: 12px;
  color: #64748b;
  margin-bottom: 6px;
  text-transform: uppercase;
}

.detalhe-item span {
  font-size: 20px;
  font-weight: 700;
  color: #7c3aed;
}

.intermediarias-box {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-top: 20px;
}

.intermediarias-box h4 {
  color: #7c3aed;
  margin-bottom: 16px;
  font-size: 16px;
}

@media (max-width: 768px) {
  main {
    padding: 20px;
  }

  .grid {
    grid-template-columns: 1fr;
  }

  .btn-large {
    font-size: 16px;
    padding: 16px;
  }

  #diagnosticoConteudo {
    grid-template-columns: 1fr;
  }
  
  .cenario-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .cenario-header {
    flex-direction: column;
    align-items: flex-start;
  }
}

.info-banner {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border-left: 4px solid #0ea5e9;
  padding: 16px;
  border-radius: 8px;
  margin: 20px 0;
  font-size: 14px;
  color: #0c4a6e;
}

.info-banner strong {
  display: block;
  margin-bottom: 8px;
  color: #075985;
}

.info-banner.warning {
  background: linear-gradient(135deg, #fefce8, #fef9c3);
  border-left-color: #eab308;
  color: #713f12;
}

.info-banner.warning strong {
  color: #a16207;
}
</style>
</head>

<body>
<header>
  <h1>üè° Simulador Imobili√°rio - M√≥dulo Comprador</h1>
  <p>Descubra quanto voc√™ pode financiar e estime sua entrada com precis√£o</p>
</header>

<main>
  <!-- Identifica√ß√£o -->
  <div class="box">
    <h3 class="section-title">üë§ Identifica√ß√£o do(s) Comprador(es)</h3>
    <div class="grid">
      <div class="campo">
        <label>Pretende adquirir sozinho(a) ou com algu√©m?</label>
        <select id="compraCom" onchange="onChangeComposicao()">
          <option value="">Selecione...</option>
          <option value="sozinho">Sozinho(a)</option>
          <option value="namorado">Com namorado(a)</option>
          <option value="noivo">Com noivo(a)</option>
          <option value="conjuge">Com c√¥njuge</option>
          <option value="familiar">Com familiar</option>
        </select>
      </div>

      <!-- Comprador 1 -->
      <div class="campo" id="boxIdade1" style="display:none;">
        <label id="labelIdade1">üéÇ Qual a sua idade?</label>
        <select id="idade1">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="campo" id="boxRenda1" style="display:none;">
        <label id="labelRenda1">üí∞ Qual a sua renda mensal?</label>
        <input id="renda1" oninput="formatarMoeda(this)" placeholder="R$ 0,00" />
      </div>

      <!-- Comprador 2 -->
      <div class="campo" id="boxIdade2" style="display:none;">
        <label>üéÇ Idade do comprador 2</label>
        <select id="idade2">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="campo" id="boxRenda2" style="display:none;">
        <label>üí∞ Renda mensal do comprador 2</label>
        <input id="renda2" oninput="formatarMoeda(this)" placeholder="R$ 0,00" />
      </div>

      <div class="campo" id="boxEstado" style="display:none;">
        <label>üìç Em qual estado ser√° o empreendimento?</label>
        <select id="estado" onchange="onEstadoSelecionado()">
          <option value="">Selecione...</option>
          <option value="MA">MA - Maranh√£o</option>
          <option value="PI">PI - Piau√≠</option>
          <option value="CE">CE - Cear√°</option>
          <option value="RN">RN - Rio Grande do Norte</option>
          <option value="PB">PB - Para√≠ba</option>
          <option value="PE">PE - Pernambuco</option>
          <option value="AL">AL - Alagoas</option>
          <option value="SE">SE - Sergipe</option>
          <option value="BA">BA - Bahia</option>
          <option value="SP">SP - S√£o Paulo</option>
          <option value="RJ">RJ - Rio de Janeiro</option>
          <option value="MG">MG - Minas Gerais</option>
          <option value="PR">PR - Paran√°</option>
          <option value="SC">SC - Santa Catarina</option>
          <option value="RS">RS - Rio Grande do Sul</option>
          <option value="GO">GO - Goi√°s</option>
          <option value="DF">DF - Distrito Federal</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Tipo de renda -->
  <div class="box" id="boxProf" style="display:none;">
    <h3 class="section-title">üíº Tipo de Renda e Valores para Entrada</h3>
    <div class="grid">
      <div class="campo" id="boxSing" style="display:none;">
        <label>Qual o seu regime de trabalho?</label>
        <select id="tipoSing" onchange="onTipoSing()">
          <option value="">Selecione...</option>
          <option value="clt3">Trabalho CLT h√° mais de 3 anos</option>
          <option value="cltmenos">Trabalho CLT h√° menos de 3 anos</option>
          <option value="pj">Sou PJ / Aut√¥nomo</option>
        </select>
      </div>
      <div class="campo" id="boxFgts" style="display:none;">
        <label>üí∞ Possui FGTS e pretende usar?</label>
        <select id="usaFgts" onchange="toggleFgts()">
          <option value="">Selecione...</option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="campo" id="boxFgtsVal" style="display:none;">
        <label>üí∞ Valor estimado do FGTS</label>
        <input id="fgtsVal" oninput="formatarMoeda(this)" placeholder="R$ 0,00" />
      </div>
      <div class="campo" id="boxCap" style="display:none;">
        <label>Possui algum valor guardado para entrada?</label>
        <select id="temGuardado" onchange="mostrarValorGuardado()">
          <option value="">Selecione...</option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="campo" id="boxGuardado" style="display:none;">
        <label>üí∏ Valor guardado (Ato)</label>
        <input id="valorGuardado" oninput="formatarMoeda(this)" placeholder="R$ 0,00" />
      </div>
    </div>
    
    <div class="info-banner">
      <strong>üí° Dica importante:</strong>
      Para CLT com mais de 3 anos, voc√™ pode usar o FGTS para entrada e reduzir juros (cotista).
    </div>
  </div>

  <div id="boxAcao" style="display:none;">
    <button class="btn" id="btnDiagnostico">üìä Gerar Diagn√≥stico Financeiro</button>
    <button class="btn btn-danger" onclick="limparTudo()">üßπ Limpar Todos os Valores</button>
  </div>

  <!-- Diagn√≥stico -->
  <div id="diagnosticoContainer">
    <h3>üìã Seu Diagn√≥stico Financeiro</h3>
    <p class="diagnostico-intro">Levando em considera√ß√£o as informa√ß√µes preenchidas, segue o diagn√≥stico:</p>
    <div id="diagnosticoConteudo"></div>
  </div>

  <!-- Estimativa -->
  <div id="estimativaContainer">
    <h3>üìä Simula√ß√£o de Entrada</h3>

    <div id="boxValorImovel">
      <div class="campo-destaque">
        <label>üíé Valor do Im√≥vel Pretendido (R$)</label>
        <input id="valorImovel" oninput="formatarMoeda(this)" placeholder="R$ 0,00" />
        <small id="avisoTeto" style="color: #dc2626; font-size: 12px; display: none; margin-top: 6px;"></small>
      </div>
      
      <!-- Seletor de prazo -->
      <div class="prazo-selector" style="margin-top: 24px;">
        <label>‚è±Ô∏è Escolha o prazo m√©dio da obra:</label>
        <div class="prazo-options">
          <div class="prazo-option" data-meses="12" onclick="selecionarPrazo(this, 12)">
            <span>12 meses</span>
            <small>Curto prazo</small>
          </div>
          <div class="prazo-option" data-meses="18" onclick="selecionarPrazo(this, 18)">
            <span>18 meses</span>
            <small>M√©dio prazo</small>
          </div>
          <div class="prazo-option" data-meses="24" onclick="selecionarPrazo(this, 24)">
            <span>24 meses</span>
            <small>M√©dio prazo</small>
          </div>
          <div class="prazo-option" data-meses="30" onclick="selecionarPrazo(this, 30)">
            <span>30 meses</span>
            <small>Longo prazo</small>
          </div>
          <div class="prazo-option" data-meses="36" onclick="selecionarPrazo(this, 36)">
            <span>36 meses</span>
            <small>Longo prazo</small>
          </div>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:24px;">
        <button class="btn" onclick="calcularCenario()">‚ú® Calcular Fluxo de Entrada</button>
      </div>
      
      <!-- Resultado do cen√°rio -->
      <div id="cenarioResultado"></div>
    </div>
  </div>
  
  <!-- Detalhamento do cen√°rio escolhido -->
  <div id="detalhamentoContainer">
    <h3>üìã Detalhamento do Fluxo de Pagamento</h3>
    <div id="detalhamentoConteudo"></div>
  </div>
</main>

<script>
// ==========================================
// INICIALIZA√á√ÉO - Popular dropdowns de idade
// ==========================================
function popularIdades() {
  const selects = [document.getElementById('idade1'), document.getElementById('idade2')];
  selects.forEach(select => {
    for (let i = 18; i <= 70; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${i} anos`;
      select.appendChild(option);
    }
  });
}
popularIdades();

// ==========================================
// FORMATA√á√ÉO DE MOEDA
// ==========================================
function formatarMoeda(input) {
  let valor = (input.value || "").replace(/\D/g, "");
  if (!valor) {
    input.value = "";
    return;
  }
  valor = (parseInt(valor, 10) / 100).toFixed(2).replace(".", ",");
  valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  input.value = "R$ " + valor;
}

function limparMoeda(valor) {
  return parseFloat((valor || "").replace(/[R$\.\s]/g, "").replace(",", ".")) || 0;
}

function moeda(v) {
  if (!Number.isFinite(v)) return "R$ 0,00";
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

// ==========================================
// CONTROLES DE INTERFACE
// ==========================================
function onChangeComposicao() {
  const modo = compraCom.value;
  const emConjunto = modo !== "sozinho" && modo !== "";
  
  if (modo) {
    boxIdade1.style.display = "block";
    boxRenda1.style.display = "block";
    boxEstado.style.display = "block";
    
    if (emConjunto) {
      labelIdade1.textContent = "üéÇ Idade do comprador 1";
      labelRenda1.textContent = "üí∞ Renda mensal do comprador 1";
      boxIdade2.style.display = "block";
      boxRenda2.style.display = "block";
    } else {
      labelIdade1.textContent = "üéÇ Qual a sua idade?";
      labelRenda1.textContent = "üí∞ Qual a sua renda mensal?";
      boxIdade2.style.display = "none";
      boxRenda2.style.display = "none";
    }
  }
}

function onEstadoSelecionado() {
  if (estado.value) {
    boxProf.style.display = "block";
    boxSing.style.display = "block";
  }
}

function onTipoSing() {
  const tipo = tipoSing.value;
  if (tipo === "clt3") {
    boxFgts.style.display = "block";
  } else {
    boxFgts.style.display = "none";
    boxFgtsVal.style.display = "none";
  }
  boxCap.style.display = "block";
}

function toggleFgts() {
  boxFgtsVal.style.display = usaFgts.value === "sim" ? "block" : "none";
}

function mostrarValorGuardado() {
  if (temGuardado.value === "sim") {
    boxGuardado.style.display = "block";
  } else {
    boxGuardado.style.display = "none";
  }
  boxAcao.style.display = "block";
}

// ==========================================
// DADOS DO MCMV
// ==========================================
const tetoFaixa = {
  "1": 190000,
  "2": 264000,
  "3": 350000,
  "4": 500000
};

function getTaxaMCMV(renda, cotista, estado) {
  const nordeste = ["MA", "PI", "CE", "RN", "PB", "PE", "AL", "SE", "BA"];
  const regiao = nordeste.includes(estado) ? "no_ne" : "sul_se_co";
  
  let faixa;
  if (renda <= 2850) faixa = "1";
  else if (renda <= 4700) faixa = "2";
  else if (renda <= 8600) faixa = "3";
  else faixa = "4";
  
  const tabela = {
    "1": { no_ne: { cot: 4.07, nao: 4.59 }, sul_se_co: { cot: 4.33, nao: 4.85 } },
    "2": { no_ne: { cot: 6.69, nao: 7.23 }, sul_se_co: { cot: 6.69, nao: 7.23 } },
    "3": { no_ne: { cot: 7.93, nao: 8.46 }, sul_se_co: { cot: 7.93, nao: 8.46 } },
    "4": { no_ne: { cot: 11.03, nao: 11.03 }, sul_se_co: { cot: 11.03, nao: 11.03 } }
  };
  
  const taxa = tabela[faixa][regiao][cotista ? "cot" : "nao"];
  return { faixa, taxa, regiao };
}

// ==========================================
// VARI√ÅVEIS GLOBAIS
// ==========================================
let dadosDiagnostico = {
  faixa: null,
  taxa: null,
  rendaTotal: null,
  valorMaxFinanciavel: null,
  fgts: 0,
  ato: 0,
  parcelaMaxima: 0,
  idadeMedia: 0
};

let cenarioSelecionado = null;

// ==========================================
// GERAR DIAGN√ìSTICO
// ==========================================
document.getElementById("btnDiagnostico").addEventListener("click", () => {
  const r1 = limparMoeda(renda1.value);
  const r2 = limparMoeda(renda2.value);
  const rendaTotal = r1 + r2;
  const estadoV = estado.value;
  const cotista = tipoSing.value === "clt3";
  
  const id1 = parseInt(idade1.value) || 0;
  const id2 = parseInt(idade2.value) || 0;
  const idadeMedia = id2 > 0 ? Math.round((id1 + id2) / 2) : id1;
  
  const { faixa, taxa, regiao } = getTaxaMCMV(rendaTotal, cotista, estadoV);
  
  // Calcular valor m√°ximo financi√°vel baseado na renda (30% comprometimento)
  const parcelaMaxima = rendaTotal * 0.30;
  const i = taxa / 12 / 100;
  const n = 420; // 35 anos
  const valorMaxRenda = (parcelaMaxima * (1 - Math.pow(1 + i, -n))) / i;
  const valorMaxFinanciavel = Math.min(valorMaxRenda, tetoFaixa[faixa]);
  
  // Salvar dados globais
  dadosDiagnostico = {
    faixa,
    taxa,
    rendaTotal,
    valorMaxFinanciavel,
    fgts: limparMoeda(fgtsVal.value),
    ato: limparMoeda(valorGuardado.value),
    parcelaMaxima,
    idadeMedia
  };
  
  diagnosticoConteudo.innerHTML = `
    <div class="diagnostico-item">
      <div class="label">üè† Faixa do Minha Casa Minha Vida</div>
      <div class="valor">Voc√™ faz parte da <strong>Faixa ${faixa}</strong> do Programa.</div>
    </div>
    
    <div class="diagnostico-item">
      <div class="label">üí∞ Teto do Programa</div>
      <div class="valor">Na sua faixa, √© poss√≠vel adquirir im√≥veis de <strong>at√© ${moeda(tetoFaixa[faixa])}</strong>.</div>
    </div>
    
    <div class="diagnostico-item destaque">
      <div class="label">üìä Capacidade de Financiamento</div>
      <div class="valor">Pela sua renda, √© poss√≠vel um financiamento estimado de <strong>at√© ${moeda(valorMaxFinanciavel)}</strong>.</div>
    </div>
    
    <div class="diagnostico-item">
      <div class="label">üìà Taxa de Juros</div>
      <div class="valor">Financiamento com taxa estimada de <strong>${taxa.toFixed(2)}% ao ano</strong>.</div>
    </div>
  `;
  
  diagnosticoContainer.style.display = "block";
  estimativaContainer.style.display = "block";
  document.getElementById("boxValorImovel").style.display = "block";
  
  diagnosticoContainer.scrollIntoView({ behavior: "smooth", block: "center" });
});

// ==========================================
// VALIDAR VALOR DO IM√ìVEL
// ==========================================
document.getElementById("valorImovel").addEventListener("blur", function() {
  const valor = limparMoeda(this.value);
  const teto = tetoFaixa[dadosDiagnostico.faixa];
  const avisoEl = document.getElementById("avisoTeto");
  
  if (valor > teto) {
    avisoEl.textContent = `‚ö†Ô∏è Valor acima do teto da Faixa ${dadosDiagnostico.faixa} (m√°x: ${moeda(teto)}). O c√°lculo ser√° limitado.`;
    avisoEl.style.display = "block";
  } else {
    avisoEl.style.display = "none";
  }
});

// ==========================================
// SELECIONAR PRAZO
// ==========================================
let prazoSelecionado = null;

function selecionarPrazo(elemento, meses) {
  // Remove sele√ß√£o anterior
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  // Adiciona sele√ß√£o atual
  elemento.classList.add('selected');
  prazoSelecionado = meses;
}

// ==========================================
// CALCULAR CEN√ÅRIO √öNICO
// ==========================================
function calcularCenario() {
  let valorImovelVal = limparMoeda(document.getElementById("valorImovel").value);
  
  if (!valorImovelVal) {
    alert("Por favor, informe o valor do im√≥vel!");
    return;
  }
  
  if (!prazoSelecionado) {
    alert("Por favor, selecione um prazo para a obra!");
    return;
  }
  
  const { faixa, fgts, ato, rendaTotal, valorMaxFinanciavel, parcelaMaxima } = dadosDiagnostico;
  const teto = tetoFaixa[faixa];
  
  // Validar teto da faixa
  if (valorImovelVal > teto) {
    alert(`O valor do im√≥vel (${moeda(valorImovelVal)}) ultrapassa o teto da Faixa ${faixa} (${moeda(teto)}).\n\nPor favor, informe um valor dentro do limite do programa.`);
    return;
  }
  
  // Calcular LTV (80% do valor do im√≥vel)
  const maxLTV = valorImovelVal * 0.80;
  
  // O financiamento √© o MENOR entre: capacidade por renda OU 80% do im√≥vel
  const financiamentoReal = Math.min(valorMaxFinanciavel, maxLTV);
  
  // Entrada = Valor do im√≥vel - Financiamento
  const entradaTotal = valorImovelVal - financiamentoReal;
  
  // Recursos dispon√≠veis
  const disponivel = fgts + ato;
  const faltante = Math.max(0, entradaTotal - disponivel);
  
  // Calcular parcela mensal
  const parcelaMensal = faltante > 0 ? faltante / prazoSelecionado : 0;
  const ultrapassaLimite = parcelaMensal > parcelaMaxima;
  
  // Calcular saldo restante se ultrapassar limite
  let saldoRestante = 0;
  let parcelaAjustada = parcelaMensal;
  
  if (ultrapassaLimite) {
    parcelaAjustada = parcelaMaxima;
    const totalPossivelMensal = parcelaMaxima * prazoSelecionado;
    saldoRestante = faltante - totalPossivelMensal;
  }
  
  // Calcular previs√£o de entrega baseada no prazo selecionado
  const hoje = new Date();
  const previsaoData = new Date(hoje.getFullYear(), hoje.getMonth() + prazoSelecionado, 1);
  const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
  const previsaoTexto = `${meses[previsaoData.getMonth()]}/${previsaoData.getFullYear()}`;
  
  // Gerar HTML do resultado
  let html = `
    <div class="cenario-unico ${ultrapassaLimite ? '' : 'ok'}">
      <div class="cenario-header-unico">
        <h4>üìã Fluxo de Entrada - ${prazoSelecionado} meses</h4>
        <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
      </div>
      
      <!-- Bloco Branco - Valor do Im√≥vel -->
      <div class="resultado-bloco resultado-bloco-branco">
        <div class="resultado-linha">
          <span class="label">Valor do Im√≥vel Pretendido</span>
          <span class="valor">${moeda(valorImovelVal)}</span>
        </div>
      </div>
      
      <!-- Bloco Azul - Financiamento e FGTS -->
      <div class="resultado-bloco resultado-bloco-azul">
        <div class="bloco-titulo">üìä Composi√ß√£o do Financiamento</div>
        <div class="resultado-linha">
          <span class="label">Financiamento Estimado</span>
          <span class="valor">${moeda(financiamentoReal)}</span>
        </div>
        ${fgts > 0 ? `
        <div class="resultado-linha">
          <span class="label">FGTS</span>
          <span class="valor">${moeda(fgts)}</span>
        </div>
        ` : ''}
      </div>
      
      <!-- Bloco Verde - Entrada Total (destaque) -->
      <div class="resultado-bloco resultado-bloco-verde">
        <div class="resultado-linha">
          <span class="label" style="font-weight: 700; color: #166534;">Entrada Total</span>
          <span class="valor" style="font-size: 18px; color: #059669;">${moeda(entradaTotal)}</span>
        </div>
      </div>
      
      <!-- Bloco Amarelo - Ato e Mensais -->
      <div class="resultado-bloco resultado-bloco-amarelo">
        <div class="bloco-titulo">üí≥ Forma de Pagamento da Entrada</div>
        <div class="resultado-linha">
          <span class="label">Ato (Sinal)</span>
          <span class="valor">${moeda(ato)}</span>
        </div>
        <div class="resultado-linha">
          <span class="label">Mensais (${prazoSelecionado}x)</span>
          <span class="valor" style="color: ${ultrapassaLimite ? '#dc2626' : '#1e293b'};">${moeda(ultrapassaLimite ? parcelaAjustada : parcelaMensal)}</span>
        </div>
      </div>
      
      <p class="cenario-obs">* Considerado limite de 30% da renda familiar para parcelas mensais.</p>
      <p class="cenario-obs">* Financiamento limitado a at√© 80% do valor do im√≥vel.</p>
  `;
  
  if (ultrapassaLimite && saldoRestante > 0) {
    html += `
      <div class="resultado-bloco" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fca5a5; margin-top: 16px;">
        <div class="resultado-linha">
          <span class="label" style="font-weight: 700; color: #991b1b;">Saldo Restante</span>
          <span class="valor" style="color: #dc2626;">${moeda(saldoRestante)}</span>
        </div>
      </div>
      
      <div class="cenario-alerta-box">
        <p>‚ö†Ô∏è Valor de entrada ultrapassa os limites de parcelamento dentro do per√≠odo informado.</p>
      </div>
    `;
  } else {
    html += `
      <div class="cenario-alerta-box ok">
        <p>‚úÖ Fluxo dentro do limite! Parcelas cabem nos 30% da renda.</p>
      </div>
    `;
  }
  
  html += `
      <div class="cenario-botoes">
        <button class="btn-limpar-fluxo" onclick="limparFluxo()">LIMPAR FLUXO DE ENTRADA</button>
      </div>
    </div>
  `;
  
  document.getElementById("cenarioResultado").innerHTML = html;
  document.getElementById("cenarioResultado").scrollIntoView({ behavior: "smooth", block: "center" });
}

// ==========================================
// LIMPAR FLUXO
// ==========================================
function limparFluxo() {
  document.getElementById("cenarioResultado").innerHTML = "";
  document.getElementById("valorImovel").value = "";
  document.getElementById("avisoTeto").style.display = "none";
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  prazoSelecionado = null;
}

// ==========================================
// LIMPAR TUDO
// ==========================================
function limparTudo() {
  if (!confirm("Deseja realmente limpar todos os valores?")) {
    return;
  }
  
  document.querySelectorAll("input, select").forEach(el => el.value = "");
  document.querySelectorAll("#boxIdade1, #boxIdade2, #boxRenda1, #boxRenda2, #boxEstado, #boxProf, #boxSing, #boxFgts, #boxFgtsVal, #boxCap, #boxGuardado, #boxAcao, #diagnosticoContainer, #estimativaContainer, #boxValorImovel, #detalhamentoContainer")
    .forEach(e => e.style.display = "none");
  
  diagnosticoConteudo.innerHTML = "";
  document.getElementById("cenarioResultado").innerHTML = "";
  document.getElementById("detalhamentoConteudo").innerHTML = "";
  document.getElementById("avisoTeto").style.display = "none";
  
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  prazoSelecionado = null;
  
  dadosDiagnostico = {
    faixa: null,
    taxa: null,
    rendaTotal: null,
    valorMaxFinanciavel: null,
    fgts: 0,
    ato: 0,
    parcelaMaxima: 0,
    idadeMedia: 0
  };
  
  cenarioSelecionado = null;
  
  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>
</body>
</html>
