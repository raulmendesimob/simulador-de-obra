<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador Imobili√°rio - M√≥dulo Comprador</title>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
  background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #10b981 100%);
  min-height: 100vh;
  color: #1e293b;
  line-height: 1.6;
  padding: 15px 10px;
}

header {
  background: linear-gradient(135deg, rgba(5, 150, 105, 0.95), rgba(6, 95, 70, 0.95));
  color: #fff;
  text-align: center;
  padding: 30px 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
  border-radius: 12px;
}

header h1 {
  font-size: clamp(20px, 5vw, 32px);
  font-weight: 700;
  margin-bottom: 8px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

header p {
  font-size: clamp(13px, 3vw, 16px);
  opacity: 0.95;
}

main {
  max-width: 900px;
  margin: 0 auto;
  background: #ffffff;
  padding: clamp(20px, 5vw, 35px);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
}

.section-title {
  color: #059669;
  margin-bottom: 16px;
  font-size: clamp(16px, 4vw, 20px);
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.box {
  border: 2px solid #d1fae5;
  border-radius: 12px;
  padding: clamp(16px, 4vw, 24px);
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.box:hover {
  box-shadow: 0 6px 16px rgba(5, 150, 105, 0.1);
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 600px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
}

.campo {
  display: flex;
  flex-direction: column;
}

.campo label {
  font-weight: 600;
  font-size: clamp(13px, 3vw, 15px);
  margin-bottom: 8px;
  color: #065f46;
  display: flex;
  align-items: center;
  gap: 6px;
}

.campo input,
.campo select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #a7f3d0;
  border-radius: 10px;
  font-size: clamp(14px, 3.5vw, 16px);
  transition: all 0.3s ease;
  background: #ffffff;
}

.campo input:focus,
.campo select:focus {
  outline: none;
  border-color: #059669;
  box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.btn {
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 14px 24px;
  cursor: pointer;
  font-size: clamp(14px, 3.5vw, 16px);
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  margin: 8px;
}

.btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #047857, #065f46);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

.btn-danger {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.btn-danger:hover:not(:disabled) {
  background: linear-gradient(135deg, #b91c1c, #991b1b);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
}

.btn-large {
  width: 100%;
  max-width: 450px;
  padding: 18px;
  font-size: clamp(16px, 4vw, 18px);
  border-radius: 12px;
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
  box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
  margin: 20px auto;
  display: block;
}

.btn-large:hover:not(:disabled) {
  background: linear-gradient(135deg, #047857, #065f46);
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(5, 150, 105, 0.4);
}

#boxAcao {
  text-align: center;
  margin-top: 24px;
  padding: 16px;
}

#diagnosticoContainer {
  display: none;
  margin-top: 30px;
  padding: clamp(20px, 5vw, 35px);
  border-radius: 16px;
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  border: 2px solid #93c5fd;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#diagnosticoContainer h3 {
  color: #1e40af;
  font-size: clamp(18px, 4vw, 22px);
  margin-bottom: 8px;
  text-align: center;
}

.diagnostico-intro {
  text-align: center;
  color: #475569;
  font-size: clamp(13px, 3vw, 15px);
  margin-bottom: 20px;
}

#diagnosticoConteudo {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.diagnostico-item {
  background: #ffffff;
  border-left: 4px solid #3b82f6;
  padding: 14px 16px;
  margin-bottom: 10px;
  border-radius: 0 10px 10px 0;
  box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08);
  transition: all 0.3s ease;
}

.diagnostico-item:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
}

.diagnostico-item .label {
  font-size: clamp(11px, 2.5vw, 12px);
  color: #64748b;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.diagnostico-item .valor {
  font-size: clamp(14px, 3.5vw, 16px);
  color: #1e293b;
  line-height: 1.5;
}

.diagnostico-item .valor strong {
  color: #1e40af;
  font-weight: 700;
}

.diagnostico-item.destaque {
  border-left-color: #059669;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.diagnostico-item.destaque .valor strong {
  color: #059669;
}

#estimativaContainer {
  display: none;
  margin-top: 30px;
  padding: clamp(20px, 5vw, 35px);
  border-radius: 16px;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 2px solid #86efac;
  animation: fadeIn 0.5s ease;
}

#estimativaContainer h3 {
  color: #166534;
  font-size: clamp(18px, 4vw, 22px);
  margin-bottom: 20px;
  text-align: center;
}

#boxValorImovel {
  display: none;
  margin-top: 20px;
  padding: clamp(18px, 4vw, 28px);
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  border: 1px solid #e2e8f0;
}

.campo-destaque {
  max-width: 100%;
  margin: 0 auto 20px;
  text-align: center;
}

.campo-destaque label {
  display: block;
  font-size: clamp(14px, 3.5vw, 16px);
  font-weight: 700;
  color: #065f46;
  margin-bottom: 12px;
}

.campo-destaque input {
  width: 100%;
  padding: 16px;
  border: 3px solid #059669;
  border-radius: 12px;
  font-size: clamp(16px, 4vw, 20px);
  font-weight: 700;
  text-align: center;
  color: #065f46;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  transition: all 0.3s ease;
}

.campo-destaque input:focus {
  outline: none;
  border-color: #047857;
  box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.2);
}

.aviso-teto {
  display: none;
  background: #fef2f2;
  border: 1px solid #fca5a5;
  color: #991b1b;
  padding: 12px;
  border-radius: 8px;
  margin-top: 12px;
  font-size: clamp(12px, 3vw, 14px);
  font-weight: 600;
  text-align: center;
}

/* Seletor de prazo - MOBILE FIRST */
.prazo-selector {
  background: white;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
}

.prazo-selector label {
  display: block;
  font-size: clamp(13px, 3vw, 14px);
  font-weight: 600;
  color: #374151;
  margin-bottom: 12px;
}

.prazo-options {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

@media (min-width: 600px) {
  .prazo-options {
    grid-template-columns: repeat(4, 1fr);
  }
}

.prazo-option {
  padding: 14px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  background: #f9fafb;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s ease;
}

.prazo-option:hover {
  border-color: #3b82f6;
  background: #eff6ff;
}

.prazo-option.selected {
  border-color: #059669;
  background: #dcfce7;
  box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

.prazo-option span {
  display: block;
  font-size: clamp(13px, 3.5vw, 15px);
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 4px;
}

.prazo-option small {
  font-size: clamp(10px, 2.5vw, 11px);
  color: #64748b;
}

/* Resultado - MOBILE OPTIMIZED */
.resultado-card {
  background: white;
  border-radius: 12px;
  padding: clamp(16px, 4vw, 20px);
  margin: 16px 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.resultado-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e2e8f0;
}

.resultado-header h4 {
  font-size: clamp(16px, 4vw, 18px);
  color: #1e293b;
  margin: 0 0 6px 0;
}

.resultado-header p {
  font-size: clamp(12px, 3vw, 14px);
  color: #64748b;
  margin: 0;
}

.resultado-linha {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  gap: 12px;
}

.resultado-linha .label {
  font-size: clamp(13px, 3vw, 14px);
  color: #475569;
  flex: 1;
}

.resultado-linha .valor {
  font-size: clamp(15px, 3.5vw, 17px);
  font-weight: 700;
  color: #1e293b;
  text-align: right;
}

.resultado-separador {
  height: 1px;
  background: #e2e8f0;
  margin: 8px 0;
}

.resultado-destaque {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 2px solid #86efac;
  padding: 16px;
  border-radius: 10px;
  margin: 16px 0;
}

.resultado-destaque .label {
  font-weight: 700;
  color: #166534;
}

.resultado-destaque .valor {
  color: #059669;
  font-size: clamp(18px, 4.5vw, 20px);
}

.resultado-secao {
  background: #f8fafc;
  padding: 14px;
  border-radius: 8px;
  margin: 12px 0;
  border-left: 3px solid #3b82f6;
}

.resultado-secao-titulo {
  font-size: clamp(11px, 2.5vw, 12px);
  text-transform: uppercase;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 10px;
  letter-spacing: 0.5px;
}

.alerta-box {
  background: rgba(220, 38, 38, 0.1);
  border: 2px solid #fca5a5;
  border-radius: 10px;
  padding: 14px;
  margin: 16px 0;
}

.alerta-box.sucesso {
  background: rgba(34, 197, 94, 0.1);
  border-color: #86efac;
}

.alerta-box p {
  margin: 0;
  font-size: clamp(13px, 3vw, 14px);
  color: #991b1b;
  font-weight: 600;
  text-align: center;
}

.alerta-box.sucesso p {
  color: #166534;
}

.obs-texto {
  font-size: clamp(11px, 2.5vw, 12px);
  color: #64748b;
  font-style: italic;
  margin-top: 8px;
  line-height: 1.5;
}

.botoes-acao {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.btn-secundario {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  font-size: clamp(13px, 3vw, 14px);
  font-weight: 700;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
}

.btn-secundario:hover {
  background: linear-gradient(135deg, #b91c1c, #991b1b);
  transform: translateY(-2px);
}

/* Tooltip helper */
.tooltip {
  position: relative;
  display: inline-block;
  cursor: help;
  font-size: 14px;
  color: #3b82f6;
  margin-left: 4px;
}

.tooltip:hover::after {
  content: attr(data-tip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  margin-bottom: 5px;
}

/* Ajustes mobile espec√≠ficos */
@media (max-width: 600px) {
  main {
    border-radius: 12px;
  }
  
  .resultado-linha {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .resultado-linha .valor {
    text-align: left;
    font-size: 16px;
  }
}
</style>
</head>
<body>

<header>
  <h1>üè° Simulador Imobili√°rio</h1>
  <p>M√≥dulo Comprador - Minha Casa Minha Vida</p>
</header>

<main>

<!-- Composi√ß√£o -->
<div class="box">
  <h3 class="section-title">üë• Composi√ß√£o da Compra</h3>
  <div class="grid">
    <div class="campo">
      <label for="compraCom">Quem comprar√° o im√≥vel?</label>
      <select id="compraCom" onchange="onChangeComposicao()">
        <option value="">Selecione...</option>
        <option value="sozinho">Sozinho(a)</option>
        <option value="conjunto">Em conjunto</option>
      </select>
    </div>
  </div>
</div>

<!-- Idade comprador 1 -->
<div class="box" id="boxIdade1" style="display:none;">
  <h3 class="section-title">üéÇ Idade</h3>
  <div class="grid">
    <div class="campo">
      <label id="labelIdade1" for="idade1">Qual a sua idade?</label>
      <input type="number" id="idade1" min="18" max="100" placeholder="Ex: 35" />
    </div>
  </div>
</div>

<!-- Idade comprador 2 -->
<div class="box" id="boxIdade2" style="display:none;">
  <h3 class="section-title">üéÇ Idade do Comprador 2</h3>
  <div class="grid">
    <div class="campo">
      <label for="idade2">Qual a idade do segundo comprador?</label>
      <input type="number" id="idade2" min="18" max="100" placeholder="Ex: 32" />
    </div>
  </div>
</div>

<!-- Renda comprador 1 -->
<div class="box" id="boxRenda1" style="display:none;">
  <h3 class="section-title">üí∞ Renda Mensal</h3>
  <div class="grid">
    <div class="campo">
      <label id="labelRenda1" for="renda1">Qual a sua renda mensal?</label>
      <input id="renda1" oninput="aplicarMascara(this)" placeholder="R$ 0,00" />
    </div>
  </div>
</div>

<!-- Renda comprador 2 -->
<div class="box" id="boxRenda2" style="display:none;">
  <h3 class="section-title">üí∞ Renda Mensal do Comprador 2</h3>
  <div class="grid">
    <div class="campo">
      <label for="renda2">Qual a renda mensal do segundo comprador?</label>
      <input id="renda2" oninput="aplicarMascara(this)" placeholder="R$ 0,00" />
    </div>
  </div>
</div>

<!-- Estado -->
<div class="box" id="boxEstado" style="display:none;">
  <h3 class="section-title">üìç Localiza√ß√£o</h3>
  <div class="grid">
    <div class="campo">
      <label for="estado">Em qual estado ser√° a compra?</label>
      <select id="estado" onchange="onEstadoSelecionado()">
        <option value="">Selecione...</option>
        <option value="DF">Distrito Federal</option>
        <option value="SP">S√£o Paulo</option>
        <option value="RJ">Rio de Janeiro</option>
        <option value="MG">Minas Gerais</option>
        <option value="ES">Esp√≠rito Santo</option>
        <option value="PR">Paran√°</option>
        <option value="SC">Santa Catarina</option>
        <option value="RS">Rio Grande do Sul</option>
        <option value="GO">Goi√°s</option>
        <option value="MT">Mato Grosso</option>
        <option value="MS">Mato Grosso do Sul</option>
        <option value="BA">Bahia</option>
        <option value="SE">Sergipe</option>
        <option value="AL">Alagoas</option>
        <option value="PE">Pernambuco</option>
        <option value="PB">Para√≠ba</option>
        <option value="RN">Rio Grande do Norte</option>
        <option value="CE">Cear√°</option>
        <option value="PI">Piau√≠</option>
        <option value="MA">Maranh√£o</option>
        <option value="PA">Par√°</option>
        <option value="AP">Amap√°</option>
        <option value="RR">Roraima</option>
        <option value="AM">Amazonas</option>
        <option value="AC">Acre</option>
        <option value="RO">Rond√¥nia</option>
        <option value="TO">Tocantins</option>
      </select>
    </div>
  </div>
</div>

<!-- Tipo de renda e valores -->
<div class="box" id="boxProf" style="display:none;">
  <h3 class="section-title">üíº Tipo de Renda e Valores</h3>
  <div class="grid">

    <!-- NOVO: Se for SOZINHO -->
    <div class="campo" id="boxSing" style="display:none;">
      <label>Qual o seu regime de trabalho?</label>
      <select id="tipoSing" onchange="onTipoSing()">
        <option value="">Selecione...</option>
        <option value="clt3">Trabalho CLT h√° mais de 3 anos</option>
        <option value="cltmenos">Trabalho CLT h√° menos de 3 anos</option>
        <option value="pj">Sou PJ / Aut√¥nomo</option>
      </select>
    </div>

    <!-- NOVO: Se for EM CONJUNTO -->
    <div class="campo" id="boxPlur" style="display:none;">
      <label>Algum dos compradores √© CLT h√° mais de 3 anos?</label>
      <select id="tipoPlur" onchange="onTipoPlur()">
        <option value="">Selecione...</option>
        <option value="sim">Sim</option>
        <option value="nao">N√£o</option>
      </select>
    </div>

    <!-- FGTS -->
    <div class="campo" id="boxFgts" style="display:none;">
      <label>Possui FGTS e pretende usar?</label>
      <select id="usaFgts" onchange="toggleFgts()">
        <option value="">Selecione...</option>
        <option value="sim">Sim</option>
        <option value="nao">N√£o</option>
      </select>
    </div>

    <!-- Valor FGTS -->
    <div class="campo" id="boxFgtsVal" style="display:none;">
      <label>Valor dispon√≠vel no FGTS 
        <span class="tooltip" data-tip="Saldo total que pode ser usado como entrada">‚ÑπÔ∏è</span>
      </label>
      <input id="fgtsVal" oninput="aplicarMascara(this)" placeholder="R$ 0,00" />
    </div>

    <!-- Valor guardado -->
    <div class="campo" id="boxCap" style="display:none;">
      <label>Possui algum valor guardado para entrada?</label>
      <select id="temGuardado" onchange="mostrarValorGuardado()">
        <option value="">Selecione...</option>
        <option value="sim">Sim</option>
        <option value="nao">N√£o</option>
      </select>
    </div>

    <div class="campo" id="boxGuardado" style="display:none;">
      <label>Valor guardado (Sinal)</label>
      <input id="valorGuardado" oninput="aplicarMascara(this)" placeholder="R$ 0,00" />
    </div>

  </div>
</div>

<!-- Bot√£o Gerar Diagn√≥stico -->
<div id="boxAcao" style="display:none;">
  <button class="btn-large" onclick="gerarDiagnostico()">GERAR DIAGN√ìSTICO</button>
</div>

<!-- Diagn√≥stico -->
<div id="diagnosticoContainer">
  <h3>üìä Seu Diagn√≥stico MCMV</h3>
  <p class="diagnostico-intro">Baseado nas informa√ß√µes fornecidas</p>
  <div id="diagnosticoConteudo"></div>
</div>

<!-- Estimativa -->
<div id="estimativaContainer">
  <h3>üí° Simular Fluxo de Entrada</h3>
  
  <!-- Valor do im√≥vel -->
  <div id="boxValorImovel">
    <div class="campo-destaque">
      <label for="valorImovel">üí∞ Valor do Im√≥vel Pretendido</label>
      <input id="valorImovel" oninput="aplicarMascara(this); validarValorImovel()" placeholder="R$ 0,00" />
    </div>
    <div id="avisoTeto" class="aviso-teto"></div>
    
    <!-- Seletor de prazo -->
    <div class="prazo-selector">
      <label>‚è±Ô∏è Prazo estimado de entrega da obra:</label>
      <div class="prazo-options">
        <div class="prazo-option" onclick="selecionarPrazo(this, 12)">
          <span>12 meses</span>
          <small>1 ano</small>
        </div>
        <div class="prazo-option" onclick="selecionarPrazo(this, 24)">
          <span>24 meses</span>
          <small>2 anos</small>
        </div>
        <div class="prazo-option" onclick="selecionarPrazo(this, 36)">
          <span>36 meses</span>
          <small>3 anos</small>
        </div>
        <div class="prazo-option" onclick="selecionarPrazo(this, 48)">
          <span>48 meses</span>
          <small>4 anos</small>
        </div>
      </div>
    </div>
    
    <button class="btn-large" id="btnCalcular" onclick="calcularCenario()">CALCULAR FLUXO DE ENTRADA</button>
  </div>
  
  <!-- Resultado -->
  <div id="cenarioResultado"></div>
</div>

<!-- Bot√£o Limpar Tudo -->
<div style="text-align: center; margin-top: 30px;">
  <button class="btn btn-danger" onclick="limparTudo()">üóëÔ∏è LIMPAR TUDO</button>
</div>

</main>

<script>
// ==========================================
// VARI√ÅVEIS GLOBAIS
// ==========================================
const compraCom = document.getElementById("compraCom");
const boxIdade1 = document.getElementById("boxIdade1");
const boxIdade2 = document.getElementById("boxIdade2");
const boxRenda1 = document.getElementById("boxRenda1");
const boxRenda2 = document.getElementById("boxRenda2");
const boxEstado = document.getElementById("boxEstado");
const boxProf = document.getElementById("boxProf");
const boxSing = document.getElementById("boxSing");
const boxPlur = document.getElementById("boxPlur");
const boxFgts = document.getElementById("boxFgts");
const boxFgtsVal = document.getElementById("boxFgtsVal");
const boxCap = document.getElementById("boxCap");
const boxGuardado = document.getElementById("boxGuardado");
const boxAcao = document.getElementById("boxAcao");
const labelIdade1 = document.getElementById("labelIdade1");
const labelRenda1 = document.getElementById("labelRenda1");

const idade1 = document.getElementById("idade1");
const idade2 = document.getElementById("idade2");
const renda1 = document.getElementById("renda1");
const renda2 = document.getElementById("renda2");
const estado = document.getElementById("estado");
const tipoSing = document.getElementById("tipoSing");
const tipoPlur = document.getElementById("tipoPlur");
const usaFgts = document.getElementById("usaFgts");
const fgtsVal = document.getElementById("fgtsVal");
const temGuardado = document.getElementById("temGuardado");
const valorGuardado = document.getElementById("valorGuardado");

const diagnosticoContainer = document.getElementById("diagnosticoContainer");
const diagnosticoConteudo = document.getElementById("diagnosticoConteudo");
const estimativaContainer = document.getElementById("estimativaContainer");

let dadosDiagnostico = {
  faixa: null,
  taxa: null,
  rendaTotal: null,
  valorMaxFinanciavel: null,
  fgts: 0,
  ato: 0,
  parcelaMaxima: 0,
  idadeMedia: 0
};

let prazoSelecionado = null;

// ==========================================
// M√ÅSCARAS E UTILIT√ÅRIOS
// ==========================================
function aplicarMascara(input) {
  let valor = input.value.replace(/\D/g, '');
  if (valor === '') {
    input.value = '';
    return;
  }
  
  valor = (parseInt(valor) / 100).toFixed(2);
  valor = valor.replace('.', ',');
  valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  input.value = 'R$ ' + valor;
}

function limparMoeda(valor) {
  if (!valor) return 0;
  const numero = valor.replace(/[^\d,]/g, '').replace(',', '.');
  return parseFloat(numero) || 0;
}

function moeda(valor) {
  if (isNaN(valor) || valor === null) return 'R$ 0,00';
  return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

// ==========================================
// TETOS E TAXAS MCMV
// ==========================================
const tetoFaixa = {
  1: 190000,
  1.5: 264000,
  2: 350000,
  3: 450000
};

function getTaxaMCMV(rendaTotal, cotista, uf) {
  let faixa, taxa, regiao;
  
  const regiaoSudeste = ["SP", "RJ", "MG", "ES"];
  const regiaoSul = ["PR", "SC", "RS"];
  const regiaoCentroOeste = ["DF", "GO", "MT", "MS"];
  
  if (regiaoSudeste.includes(uf) || regiaoSul.includes(uf) || regiaoCentroOeste.includes(uf)) {
    regiao = "privilegiada";
  } else {
    regiao = "demais";
  }
  
  if (rendaTotal <= 2640) {
    faixa = 1;
    taxa = cotista ? 4.00 : 5.00;
  } else if (rendaTotal <= 4400) {
    faixa = 1.5;
    taxa = cotista ? 5.50 : 6.50;
  } else if (rendaTotal <= 8000) {
    faixa = 2;
    taxa = cotista ? 7.66 : 8.16;
  } else {
    faixa = 3;
    taxa = regiao === "privilegiada" ? 9.16 : 8.16;
  }
  
  return { faixa, taxa, regiao };
}

// ==========================================
// FLUXO DE TELAS
// ==========================================
function onChangeComposicao() {
  const modo = compraCom.value;
  const emConjunto = modo !== "sozinho";

  boxIdade1.style.display = "block";
  boxRenda1.style.display = "block";
  boxEstado.style.display = "block";

  labelIdade1.textContent = emConjunto ? "Idade do comprador 1" : "Qual a sua idade?";
  labelRenda1.textContent = emConjunto ? "Renda mensal do comprador 1" : "Qual a sua renda mensal?";

  boxIdade2.style.display = emConjunto ? "block" : "none";
  boxRenda2.style.display = emConjunto ? "block" : "none";
}

function onEstadoSelecionado() {
  boxProf.style.display = "block";
  const sozinho = compraCom.value === "sozinho";
  boxSing.style.display = sozinho ? "block" : "none";
  boxPlur.style.display = sozinho ? "none" : "block";
}

function onTipoSing() {
  if (tipoSing.value === "clt3") {
    boxFgts.style.display = "block";
  } else {
    boxFgts.style.display = "none";
    boxFgtsVal.style.display = "none";
  }
  boxCap.style.display = "block";
}

function onTipoPlur() {
  if (tipoPlur.value === "sim") {
    boxFgts.style.display = "block";
  } else {
    boxFgts.style.display = "none";
    boxFgtsVal.style.display = "none";
  }
  boxCap.style.display = "block";
}

function toggleFgts() {
  boxFgtsVal.style.display = usaFgts.value === "sim" ? "block" : "none";
  mostrarBotao();
}

function mostrarValorGuardado() {
  boxGuardado.style.display = temGuardado.value === "sim" ? "block" : "none";
  mostrarBotao();
}

function mostrarBotao() {
  const r1 = limparMoeda(renda1.value);
  const r2 = limparMoeda(renda2.value);
  const estadoV = estado.value;
  
  // Verificar se campos obrigat√≥rios est√£o preenchidos
  const temRenda = r1 > 0 || r2 > 0;
  const temEstado = estadoV !== "";
  
  // Verificar tipo de trabalho
  const sozinho = compraCom.value === "sozinho";
  const temTipoTrabalho = sozinho ? tipoSing.value !== "" : tipoPlur.value !== "";
  
  // FGTS
  const fgtsObrigatorio = (sozinho && tipoSing.value === "clt3") || (!sozinho && tipoPlur.value === "sim");
  const fgtsPreenchido = !fgtsObrigatorio || usaFgts.value !== "";
  
  // Valor guardado
  const guardadoPreenchido = temGuardado.value !== "";
  
  if (temRenda && temEstado && temTipoTrabalho && fgtsPreenchido && guardadoPreenchido) {
    boxAcao.style.display = "block";
  }
}

// Adicionar listeners nos campos de entrada para mostrar bot√£o
renda1.addEventListener("input", mostrarBotao);
renda2.addEventListener("input", mostrarBotao);

// ==========================================
// GERAR DIAGN√ìSTICO
// ==========================================
function gerarDiagnostico() {
  const r1 = limparMoeda(renda1.value);
  const r2 = limparMoeda(renda2.value);
  const rendaTotal = r1 + r2;
  const estadoV = estado.value;
  
  // Determinar se √© cotista
  const sozinho = compraCom.value === "sozinho";
  const cotista = sozinho ? (tipoSing.value === "clt3") : (tipoPlur.value === "sim");
  
  const id1 = parseInt(idade1.value) || 0;
  const id2 = parseInt(idade2.value) || 0;
  const idadeMedia = id2 > 0 ? Math.round((id1 + id2) / 2) : id1;
  
  const { faixa, taxa, regiao } = getTaxaMCMV(rendaTotal, cotista, estadoV);
  
  // ‚ö†Ô∏è FIX CR√çTICO: Calcular valor m√°ximo considerando TAMB√âM 80% do teto da faixa
  const parcelaMaxima = rendaTotal * 0.30;
  const i = taxa / 12 / 100;
  
  // Considerar prazo m√°ximo por idade
  const prazoMaximoIdade = Math.max(0, (80 - idadeMedia) * 12);
  const n = Math.min(420, prazoMaximoIdade); // Usa o menor entre 35 anos e prazo por idade
  
  const valorMaxRenda = (parcelaMaxima * (1 - Math.pow(1 + i, -n))) / i;
  
  // ‚ö†Ô∏è FIX: Limitar TAMB√âM a 80% do teto da faixa
  const ltv80Teto = tetoFaixa[faixa] * 0.80;
  const valorMaxFinanciavel = Math.min(valorMaxRenda, ltv80Teto);
  
  // Salvar dados globais
  dadosDiagnostico = {
    faixa,
    taxa,
    rendaTotal,
    valorMaxFinanciavel,
    fgts: limparMoeda(fgtsVal.value),
    ato: limparMoeda(valorGuardado.value),
    parcelaMaxima,
    idadeMedia
  };
  
  diagnosticoConteudo.innerHTML = `
    <div class="diagnostico-item">
      <div class="label">üè† Faixa do Minha Casa Minha Vida</div>
      <div class="valor">Voc√™ faz parte da <strong>Faixa ${faixa}</strong> do Programa.</div>
    </div>
    
    <div class="diagnostico-item">
      <div class="label">üí∞ Teto do Programa</div>
      <div class="valor">Na sua faixa, √© poss√≠vel adquirir im√≥veis de <strong>at√© ${moeda(tetoFaixa[faixa])}</strong>.</div>
    </div>
    
    <div class="diagnostico-item destaque">
      <div class="label">üìä Capacidade de Financiamento</div>
      <div class="valor">Pela sua renda e idade, √© poss√≠vel um financiamento estimado de <strong>at√© ${moeda(valorMaxFinanciavel)}</strong>.</div>
    </div>
    
    <div class="diagnostico-item">
      <div class="label">üìà Taxa de Juros</div>
      <div class="valor">Financiamento com taxa estimada de <strong>${taxa.toFixed(2)}% ao ano</strong>.</div>
    </div>
  `;
  
  diagnosticoContainer.style.display = "block";
  estimativaContainer.style.display = "block";
  document.getElementById("boxValorImovel").style.display = "block";
  
  diagnosticoContainer.scrollIntoView({ behavior: "smooth", block: "center" });
}

// ==========================================
// VALIDAR VALOR DO IM√ìVEL
// ==========================================
function validarValorImovel() {
  const valor = limparMoeda(document.getElementById("valorImovel").value);
  const teto = tetoFaixa[dadosDiagnostico.faixa];
  const avisoEl = document.getElementById("avisoTeto");
  
  if (valor > teto) {
    avisoEl.textContent = `‚ö†Ô∏è Valor acima do teto da Faixa ${dadosDiagnostico.faixa} (m√°x: ${moeda(teto)}).`;
    avisoEl.style.display = "block";
  } else {
    avisoEl.style.display = "none";
  }
}

// ==========================================
// SELECIONAR PRAZO
// ==========================================
function selecionarPrazo(elemento, meses) {
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  elemento.classList.add('selected');
  prazoSelecionado = meses;
}

// ==========================================
// CALCULAR CEN√ÅRIO
// ==========================================
function calcularCenario() {
  let valorImovelVal = limparMoeda(document.getElementById("valorImovel").value);
  
  if (!valorImovelVal) {
    alert("Por favor, informe o valor do im√≥vel!");
    return;
  }
  
  if (!prazoSelecionado) {
    alert("Por favor, selecione um prazo para a obra!");
    return;
  }
  
  const { faixa, fgts, ato, rendaTotal, valorMaxFinanciavel, parcelaMaxima } = dadosDiagnostico;
  const teto = tetoFaixa[faixa];
  
  // Validar teto da faixa
  if (valorImovelVal > teto) {
    alert(`O valor do im√≥vel (${moeda(valorImovelVal)}) ultrapassa o teto da Faixa ${faixa} (${moeda(teto)}).\n\nPor favor, informe um valor dentro do limite do programa.`);
    return;
  }
  
  // Loading state
  const btnCalcular = document.getElementById("btnCalcular");
  btnCalcular.disabled = true;
  btnCalcular.textContent = "Calculando...";
  
  // Calcular LTV (80% do valor do im√≥vel)
  const maxLTV = valorImovelVal * 0.80;
  
  // O financiamento √© o MENOR entre: capacidade por renda OU 80% do im√≥vel
  const financiamentoReal = Math.min(valorMaxFinanciavel, maxLTV);
  
  // Entrada = Valor do im√≥vel - Financiamento
  const entradaTotal = valorImovelVal - financiamentoReal;
  
  // Recursos dispon√≠veis
  const disponivel = fgts + ato;
  const faltante = Math.max(0, entradaTotal - disponivel);
  
  // ‚ö†Ô∏è FIX: Valida√ß√£o de divis√£o por zero
  const parcelaMensal = (faltante > 0 && prazoSelecionado > 0) ? faltante / prazoSelecionado : 0;
  const ultrapassaLimite = parcelaMensal > parcelaMaxima;
  
  // Calcular saldo restante se ultrapassar limite
  let saldoRestante = 0;
  let parcelaAjustada = parcelaMensal;
  
  if (ultrapassaLimite) {
    parcelaAjustada = parcelaMaxima;
    const totalPossivelMensal = parcelaMaxima * prazoSelecionado;
    saldoRestante = faltante - totalPossivelMensal;
  }
  
  // Calcular previs√£o de entrega
  const hoje = new Date();
  const previsaoData = new Date(hoje.getFullYear(), hoje.getMonth() + prazoSelecionado, 1);
  const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
  const previsaoTexto = `${meses[previsaoData.getMonth()]}/${previsaoData.getFullYear()}`;
  
  // Gerar HTML do resultado - LAYOUT MOBILE OPTIMIZED
  let html = `
    <div class="resultado-card">
      <div class="resultado-header">
        <h4>üìã Fluxo de Entrada - ${prazoSelecionado} meses</h4>
        <p>üìÖ Previs√£o estimada de entrega: <strong>${previsaoTexto}</strong></p>
      </div>
      
      <div class="resultado-linha">
        <span class="label">Valor do Im√≥vel</span>
        <span class="valor">${moeda(valorImovelVal)}</span>
      </div>
      
      <div class="resultado-separador"></div>
      
      <div class="resultado-secao">
        <div class="resultado-secao-titulo">üìä Financiamento</div>
        <div class="resultado-linha">
          <span class="label">Valor Financiado</span>
          <span class="valor">${moeda(financiamentoReal)}</span>
        </div>
        ${fgts > 0 ? `
        <div class="resultado-linha">
          <span class="label">FGTS Utilizado</span>
          <span class="valor">${moeda(fgts)}</span>
        </div>
        ` : ''}
      </div>
      
      <div class="resultado-destaque">
        <div class="resultado-linha">
          <span class="label">Entrada Total</span>
          <span class="valor">${moeda(entradaTotal)}</span>
        </div>
      </div>
      
      <div class="resultado-secao">
        <div class="resultado-secao-titulo">üí≥ Pagamento da Entrada</div>
        <div class="resultado-linha">
          <span class="label">Sinal (Ato)</span>
          <span class="valor">${moeda(ato)}</span>
        </div>
        <div class="resultado-linha">
          <span class="label">Parcelas Mensais (${prazoSelecionado}x)</span>
          <span class="valor" style="color: ${ultrapassaLimite ? '#dc2626' : '#1e293b'};">${moeda(ultrapassaLimite ? parcelaAjustada : parcelaMensal)}</span>
        </div>
      </div>
      
      <p class="obs-texto">* Limite de 30% da renda familiar para parcelas mensais.</p>
      <p class="obs-texto">* Financiamento limitado a 80% do valor do im√≥vel.</p>
  `;
  
  if (ultrapassaLimite && saldoRestante > 0) {
    html += `
      <div class="resultado-separador" style="margin: 16px 0;"></div>
      <div class="resultado-linha">
        <span class="label" style="font-weight: 700; color: #991b1b;">‚ö†Ô∏è Saldo Restante</span>
        <span class="valor" style="color: #dc2626;">${moeda(saldoRestante)}</span>
      </div>
      
      <div class="alerta-box">
        <p>‚ö†Ô∏è Valor de entrada ultrapassa os limites de parcelamento no per√≠odo informado.</p>
      </div>
    `;
  } else {
    html += `
      <div class="alerta-box sucesso">
        <p>‚úÖ Fluxo aprovado! Parcelas cabem nos 30% da renda.</p>
      </div>
    `;
  }
  
  html += `
      <div class="botoes-acao">
        <button class="btn-secundario" onclick="limparFluxo()">Limpar Fluxo</button>
      </div>
    </div>
  `;
  
  document.getElementById("cenarioResultado").innerHTML = html;
  
  // Restaurar bot√£o
  btnCalcular.disabled = false;
  btnCalcular.textContent = "CALCULAR FLUXO DE ENTRADA";
  
  // Scroll suave
  setTimeout(() => {
    document.getElementById("cenarioResultado").scrollIntoView({ behavior: "smooth", block: "start" });
  }, 100);
}

// ==========================================
// LIMPAR FLUXO
// ==========================================
function limparFluxo() {
  document.getElementById("cenarioResultado").innerHTML = "";
  document.getElementById("valorImovel").value = "";
  document.getElementById("avisoTeto").style.display = "none";
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  prazoSelecionado = null;
}

// ==========================================
// LIMPAR TUDO
// ==========================================
function limparTudo() {
  if (!confirm("Deseja realmente limpar todos os valores?")) {
    return;
  }
  
  document.querySelectorAll("input, select").forEach(el => el.value = "");
  document.querySelectorAll("#boxIdade1, #boxIdade2, #boxRenda1, #boxRenda2, #boxEstado, #boxProf, #boxSing, #boxPlur, #boxFgts, #boxFgtsVal, #boxCap, #boxGuardado, #boxAcao, #diagnosticoContainer, #estimativaContainer, #boxValorImovel")
    .forEach(e => e.style.display = "none");
  
  diagnosticoConteudo.innerHTML = "";
  document.getElementById("cenarioResultado").innerHTML = "";
  document.getElementById("avisoTeto").style.display = "none";
  
  document.querySelectorAll('.prazo-option').forEach(el => el.classList.remove('selected'));
  prazoSelecionado = null;
  
  dadosDiagnostico = {
    faixa: null,
    taxa: null,
    rendaTotal: null,
    valorMaxFinanciavel: null,
    fgts: 0,
    ato: 0,
    parcelaMaxima: 0,
    idadeMedia: 0
  };
  
  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>
</body>
</html>
